<!-- build time:Wed Apr 17 2024 14:01:09 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="水文 & 摄影" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="水文 & 摄影" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="水文 & 摄影" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="http://example.com/project/railway/12306%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><title>12306项目学习笔记 - railway - 项目 | fantedong = 水文 & 摄影 = 为了能更好地查看图片，你需要一点魔法</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">12306项目学习笔记</h1><div class="meta"><span class="item" title="创建时间：2024-01-18 20:27:39"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-01-18T20:27:39+08:00">2024-01-18</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>298k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>4:31</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">fantedong</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/12306-base-biz-20230801.png"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/project/" itemprop="item" rel="index" title="分类于 项目"><span itemprop="name">项目</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/project/railway/" itemprop="item" rel="index" title="分类于 railway"><span itemprop="name">railway</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/project/railway/12306%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="范特东东东"><meta itemprop="description" content="为了能更好地查看图片，你需要一点魔法, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="水文 & 摄影"></span><div class="body md" itemprop="articleBody"><h1 id="项目介绍"><a class="anchor" href="#项目介绍">#</a> 项目介绍</h1><h2 id="项目简介"><a class="anchor" href="#项目简介">#</a> 项目简介</h2><p>提供了两种版本：</p><ul><li><strong>SpringBoot 聚合服务版本</strong>：适合测试和部署，可以直接启动 <code>aggregation-service</code> 聚合服务和网关服务。</li><li><strong>SpringCloud 微服务版本</strong>：适合学习微服务设计，可以分别启动支付、订单、用户、购票和网关服务。</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/12306-base-biz-20230801.png" alt="img"></p><center>12306基础业务</center><p>在系统设计中，采用最新 JDK17 + SpringBoot3&amp;SpringCloud <strong>微服务架构</strong>，构建高并发、大数据量下仍然能提供高效可靠的 12306 购票服务。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1676637853202-c2af9e93-fe03-4c01-9fed-20ca07263476.png" alt="img"></p><center>常见的微服务架构</center><p>下方的<strong>架构图</strong>全面描述了项目的服务集合、组件库列表和基础设置层等要素，有助于用户快速了解 12306 平台的顶层设计和业务细节，从零到一进行构建。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20230802104007774.png" alt="img"></p><center>12306项目架构图</center><p>项目中的文档包括三部分，<strong>快速开始</strong>、<strong>核心技术文档</strong>以及<strong>从零到一开发</strong>。可根据自己的兴趣选择深入了解核心技术或从零到一复刻系统。</p><p><img data-src="https://images-machen.oss-cn-beijing.aliyuncs.com/12306%E6%96%87%E7%AB%A0%E7%BB%93%E6%9E%84-20230917.png" alt="img"></p><center>12306文章结构</center><h2 id="技术架构选型"><a class="anchor" href="#技术架构选型">#</a> 技术架构选型</h2><h2 id="接口文档"><a class="anchor" href="#接口文档">#</a> 接口文档</h2><p><span class="exturl" data-url="aHR0cHM6Ly9hcGlmb3guY29tL2FwaWRvYy9zaGFyZWQtODZkOWQzYmUtOGExNS00NTNmLTg1YTYtNDQyMDE4MGE5MTVlL2FwaS04NTYyNzc3OA==">用户登录 - 12306 (apifox.com)</span></p><h2 id="学习路线"><a class="anchor" href="#学习路线">#</a> 学习路线</h2><p>12306 铁路购票系统的学习主要分为三块：</p><ul><li><strong>组件库开发</strong></li><li><strong>业务梳理</strong></li><li><strong>业务系统开发</strong></li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240119014418408.png" alt="image-20240119014418408"></p><h3 id="组件库开发"><a class="anchor" href="#组件库开发">#</a> 组件库开发</h3><p>组件库的产出源于 <font color="red">对公共功能的封装 </font>，避免了在不同项目之间相互复制代码的情况。当然，如果这种复制代码的方式出现问题，那么需要同时对所有项目进行改造，从成本和优雅设计的角度来看并不可取。</p><p>为了统一各个项目可能使用的公共内容，我们在这里规划了常用且通用的功能点，供大家使用，以提高编码效率。如果有一些好的想法，在通用的前提下，可以联系我们将其加入到各自语义的起始包中。</p><p>组件库的开发宗旨是汇总资源，更高效地提供业务敏捷开发的能力，后续的迭代也将遵循这一原则。目前，这只是一个起点，是整体规划的一部分，还有许多可以提升的空间。</p><p>目前 <font color="red">已有组件如下 </font>，可能新增加的组件更新不及时，实际以代码库 <code>/frameworks</code> 目录下为准。</p><p><img data-src="https://user-images.githubusercontent.com/77398366/229265310-7fa8b406-b621-4334-91d6-911c0b95dce3.png" alt="img"></p><h3 id="业务梳理"><a class="anchor" href="#业务梳理">#</a> 业务梳理</h3><p>在 12306 铁路购票系统中，包括会员、购票、订单、支付以及网关服务。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/12306_biz_20230720-1.png" alt="img"></p><h3 id="系统开发"><a class="anchor" href="#系统开发">#</a> 系统开发</h3><p>当你对 12306 系统的业务有了初步认识，就可以考虑对这个系统进行从零到一的开发。</p><p>在正式开发框架之前，你需要把一些<strong>前置技术</strong>都有一定的掌握。不然极有可能是稀里糊涂的写，虽然写完了，但是吸收情况达不到最终的理想效果。</p><table><thead><tr><th></th><th>技术</th><th>名称</th><th>版本</th><th>官网</th></tr></thead><tbody><tr><td>1</td><td>Spring Boot</td><td>基础框架</td><td>3.0.7</td><td><span class="exturl" data-url="aHR0cHM6Ly9zcHJpbmcuaW8vcHJvamVjdHMvc3ByaW5nLWJvb3Q=">https://spring.io/projects/spring-boot(opens new window)</span></td></tr><tr><td>2</td><td>MyBatis-Plus</td><td>持久层框架</td><td>3.5.3.1</td><td><span class="exturl" data-url="aHR0cHM6Ly9iYW9taWRvdS5jb20v">https://baomidou.com(opens new window)</span></td></tr><tr><td>3</td><td>HikariCP</td><td>数据库连接池</td><td>5.0.1</td><td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyZXR0d29vbGRyaWRnZS9IaWthcmlDUA==">https://github.com/brettwooldridge/HikariCP(opens new window)</span></td></tr><tr><td>4</td><td>Redis</td><td>分布式缓存数据库</td><td>Latest</td><td><span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby8=">https://redis.io(opens new window)</span></td></tr><tr><td>5</td><td>RocketMQ</td><td>消息队列</td><td>2.2.3</td><td><span class="exturl" data-url="aHR0cHM6Ly9yb2NrZXRtcS5hcGFjaGUub3JnLw==">https://rocketmq.apache.org(opens new window)</span></td></tr><tr><td>6</td><td>ShardingSphere</td><td>数据库生态系统</td><td>5.3.2</td><td><span class="exturl" data-url="aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnLw==">https://shardingsphere.apache.org(opens new window)</span></td></tr><tr><td>7</td><td>SpringCloud Alibaba</td><td>分布式框架</td><td>2022.0.0.0-RC2</td><td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvc3ByaW5nLWNsb3VkLWFsaWJhYmE=">https://github.com/alibaba/spring-cloud-alibaba(opens new window)</span></td></tr><tr><td>8</td><td>SpringCloud Gateway</td><td>网关框架</td><td>2022.0.3</td><td><span class="exturl" data-url="aHR0cHM6Ly9zcHJpbmcuaW8vcHJvamVjdHMvc3ByaW5nLWNsb3VkLWdhdGV3YXk=">https://spring.io/projects/spring-cloud-gateway(opens new window)</span></td></tr><tr><td>9</td><td>FastJson2</td><td>JSON 序列化工具</td><td>2.0.36</td><td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvZmFzdGpzb24y">https://github.com/alibaba/fastjson2(opens new window)</span></td></tr><tr><td>10</td><td>Canal</td><td>BinLog 订阅组件</td><td>1.1.6</td><td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvY2FuYWw=">https://github.com/alibaba/canal(opens new window)</span></td></tr><tr><td>11</td><td>HuTool</td><td>小而全的工具集项目</td><td>5.8.2</td><td><span class="exturl" data-url="aHR0cHM6Ly9odXRvb2wuY24v">https://hutool.cn(opens new window)</span></td></tr><tr><td>12</td><td>Swagger3</td><td>项目 API 文档框架</td><td>3.x</td><td><span class="exturl" data-url="aHR0cDovL3N3YWdnZXIuaW8v">http://swagger.io(opens new window)</span></td></tr><tr><td>13</td><td>Knife4j</td><td>Swagger 增强框架</td><td>3.x</td><td><span class="exturl" data-url="aHR0cHM6Ly9kb2MueGlhb21pbmZvLmNvbS8=">https://doc.xiaominfo.com(opens new window)</span></td></tr><tr><td>14</td><td>Maven</td><td>项目构建管理</td><td>3.9.1</td><td><span class="exturl" data-url="aHR0cDovL21hdmVuLmFwYWNoZS5vcmcv">http://maven.apache.org(opens new window)</span></td></tr><tr><td>15</td><td>Redisson</td><td>Redis Java 客户端</td><td>3.21.3</td><td><span class="exturl" data-url="aHR0cHM6Ly9yZWRpc3Nvbi5vcmcv">https://redisson.org(opens new window)</span></td></tr><tr><td>16</td><td>Sentinel</td><td>流控防护框架</td><td>1.8.6</td><td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvU2VudGluZWw=">https://github.com/alibaba/Sentinel(opens new window)</span></td></tr><tr><td>17</td><td>Hippo4j</td><td>动态线程池框架</td><td>1.5.0</td><td><span class="exturl" data-url="aHR0cHM6Ly9oaXBwbzRqLmNuLw==">https://hippo4j.cn(opens new window)</span></td></tr><tr><td>18</td><td>XXL-Job</td><td>分布式定时任务框架</td><td>2.4.0</td><td><span class="exturl" data-url="aHR0cDovL3d3dy54dXh1ZWxpLmNvbS94eGwtam9i">http://www.xuxueli.com/xxl-job(opens new window)</span></td></tr><tr><td>19</td><td>SkyWalking</td><td>分布式链路追踪框架</td><td>9.5.0</td><td><span class="exturl" data-url="aHR0cHM6Ly9za3l3YWxraW5nLmFwYWNoZS5vcmcv">https://skywalking.apache.org(opens new window)</span></td></tr><tr><td>20</td><td>JetCache</td><td>Java 缓存框架</td><td>2.7.3</td><td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvamV0Y2FjaGU=">https://github.com/alibaba/jetcache(opens new window)</span></td></tr><tr><td>21</td><td>TTL</td><td>增强版 ThreadLocal</td><td>2.14.3</td><td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvdHJhbnNtaXR0YWJsZS10aHJlYWQtbG9jYWw=">https://github.com/alibaba/transmittable-thread-local(opens new window)</span></td></tr></tbody></table><p>另外，我们在手摸手从零到一开发章节中，会有非常详细的系列教程，帮助大家梳理以及开发。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20230917193923363.png" alt="img"></p><h1 id="快速开始"><a class="anchor" href="#快速开始">#</a> 快速开始</h1><h2 id="克隆项目"><a class="anchor" href="#克隆项目">#</a> 克隆项目</h2><h3 id="拉取项目"><a class="anchor" href="#拉取项目">#</a> 拉取项目</h3><p>打开 Gitee 项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vbmFnZW9mZmVyLzEyMzA2">https://gitee.com/nageoffer/12306</span> 复制对应的 SSH 或 HTTP 克隆地址。</p><p>12306 现在的代码还在不断更新迭代，每次打开项目都可以选择 <code>Pull</code> 下最新代码。</p><p>打开 IntelliJ IDEA，菜单栏顶部找到 <code>Git -&gt; Clone</code> 选项，等待克隆及 Maven 初始化即可。</p><p>拉下来后，可在项目根目录执行 <code>mvn clean install</code> 测试是否具备运行环境。</p><p><strong>⚠️</strong> <strong>重要提示。</strong></p><p><font color="red">建议大家在打开项目时，都执行下 <code>Update Project</code> 流程 </font>，因为代码目前还在快速迭代中，避免错过新功能。</p><h3 id="服务模块列表"><a class="anchor" href="#服务模块列表">#</a> 服务模块列表</h3><h4 id="springboot-单体版本"><a class="anchor" href="#springboot-单体版本">#</a> SpringBoot 单体版本</h4><p>如果你想 <font color="red">以小成本启动前后端系统 </font>，后端项目仅启动 <code>aggregation-service</code> 和 <code>gateway-service</code> 服务即可。</p><blockquote><p>Q： <code>aggregation-service</code> 服务是做什么的？</p><p>A：为了减少大家本地启动内存压力以及服务器部署压力，将订单、支付、用户以及购票系统进行了聚合，启动网关和 <code>aggregation-service</code> 服务即可享受 12306 购票系统全部功能。</p></blockquote><h4 id="springcloud-分布式版本"><a class="anchor" href="#springcloud-分布式版本">#</a> SpringCloud 分布式版本</h4><p>如果你是想跑 <font color="red">微服务全流程 </font>，需依次启动 <code>pay-service</code> 、 <code>order-service</code> 、 <code>ticket-service</code> 、 <code>user-service</code> 以及 <code>gateway-service</code> 等服务。</p><figure class="highlight plain"><figcaption data-lang="plain"></figcaption><table><tr><td data-num="1"></td><td><pre>.</pre></td></tr><tr><td data-num="2"></td><td><pre>├── aggregation-service  || -- # 聚合服务</pre></td></tr><tr><td data-num="3"></td><td><pre>├── gateway-service  || -- # 网关服务</pre></td></tr><tr><td data-num="4"></td><td><pre>├── order-service  || -- # 订单服务</pre></td></tr><tr><td data-num="5"></td><td><pre>├── pay-service  || -- # 支付服务</pre></td></tr><tr><td data-num="6"></td><td><pre>├── ticket-service  || -- # 购票服务</pre></td></tr><tr><td data-num="7"></td><td><pre>└── user-service  || -- # 用户服务</pre></td></tr></table></figure><h3 id="项目工程的目录结构"><a class="anchor" href="#项目工程的目录结构">#</a> 项目工程的目录结构</h3><blockquote><p>-&gt;<a href="#%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"> 工程目录结构设计</a></p></blockquote><h3 id="设置-jdk-版本"><a class="anchor" href="#设置-jdk-版本">#</a> 设置 JDK 版本</h3><p>12306 系统框架底层依赖 SpringBoot3，而这个版本对 JDK 的要求最低是 17。所以，我们需要 **<font color="red">将项目的 JDK 修改为 17 版本 </font>**，避免项目编译或运行报错。</p><h2 id="数据库初始化"><a class="anchor" href="#数据库初始化">#</a> 数据库初始化</h2><blockquote><p>下文中 Linux 路径中出现的符号 <code>~</code> 表示根路径 <code>$&#123;HOME&#125;</code></p></blockquote><h3 id="安装-mysql-5736"><a class="anchor" href="#安装-mysql-5736">#</a> 安装 MySQL 5.7.36</h3><blockquote><p>如本地已有 MySQL 可跳过，即使是 8 也没问题。</p></blockquote><p>Windows、Linux 以及 Mac M1 以下电脑通过以下 Docker 命令下载 MySQL 镜像，并启动 MySQL 容器：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">--name</span> mysql <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_HOST</span><span class="token operator">=</span><span class="token string">'%'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-d</span> mysql:5.7.36</pre></td></tr></table></figure><ul><li><code>--name mysql</code> ：指定容器的名称为 mysql。</li><li><code>-p 3306:3306</code> ：将容器的 3306 端口挂载到宿主机的 3306 端口上。</li><li><code>-e MYSQL_ROOT_HOST='%'</code> ：允许 root 用户在任何主机访问。</li><li><code>-e MYSQL_ROOT_PASSWORD=root</code> ：指定 MySQL 的 root 用户的密码为 root。</li><li><code>-d</code> ：以后台的方式运行，后面是 <code>Image:Tag</code> 。</li></ul><p>将 MySQL 容器内的配置文件复制到 Linux 中：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在 Linux 中新建本地目录～/docker/software/mysql/conf。-p 表示没有该目录则自动创建。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/docker/software/mysql/conf</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 将 MySQL 容器内的配置文件复制到 Linux 本地目录中</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">docker</span> <span class="token function">cp</span> mysql:/etc/mysql/mysql.conf.d/mysqld.cnf ~/docker/software/mysql/conf</pre></td></tr></table></figure><p>在 Linux 中打开 <code>~/docker/software/mysql/conf</code> mysqld.cnf 文件，增加以下内容：</p><blockquote><p>为了后续 Canal 对接，这里直接开启 BinLog 相关配置</p></blockquote><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在 Linux 中打开配置文件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">vim</span> ~/docker/software/mysql/conf/mysqld.cnf</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 向配置文件中添加如下内容，注意是在在 [mysqld] 目录中</span></pre></td></tr><tr><td data-num="5"></td><td><pre>log-bin<span class="token operator">=</span>mysql-bin  <span class="token comment"># 开启 binlog</span></pre></td></tr><tr><td data-num="6"></td><td><pre>binlog-format<span class="token operator">=</span>ROW  <span class="token comment"># 选择 ROW 模式</span></pre></td></tr><tr><td data-num="7"></td><td><pre>server-id<span class="token operator">=</span><span class="token number">1</span> <span class="token comment"># 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span></pre></td></tr></table></figure><p>删除原 MySQL 容器，通过新配置创建新的容器：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 删除运行中的 MySQL 容器</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> mysql</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 运行 Docker 容器命令</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">--name</span> mysql <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">-v</span> /etc/localtime:/etc/localtime <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token parameter variable">-v</span> ~/docker/software/mysql/conf:/etc/mysql/mysql.conf.d <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token parameter variable">-v</span> ~/docker/software/mysql/log:/var/log/mysql <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token parameter variable">-v</span> ~/docker/software/mysql/data:/var/lib/mysql <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token parameter variable">-d</span> mysql:5.7.36</pre></td></tr></table></figure><ul><li><code>/etc/localtime</code> ：时间同步</li><li><code>/docker/software/mysql/conf</code> ：同步 MySQL 配置文件，上面配置的内容就会覆盖容器中的配置文件</li><li><code>/docker/software/mysql/log</code> ：同步 MySQL 日志目录</li><li><code>/docker/software/mysql/data</code> ：同步 MySQL 的一些文件内容（对数据进行备份）</li><li><code>MYSQL_ROOT_PASSWORD=root</code> ：默认 root 的密码是 root</li></ul><p>进入到 MySQL 的命令行模式来给 root 账号授权所有 ip 能够访问。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 使用 MySQL 容器中的命令行</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql /bin/bash</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 使用 MySQL 命令打开客户端：</span></pre></td></tr><tr><td data-num="5"></td><td><pre>mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-proot</span> --default-character-set<span class="token operator">=</span>utf8</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 接着创建一个账户，该账号所有 IP 都能够访问</span></pre></td></tr><tr><td data-num="8"></td><td><pre>grant all privileges on *.* to <span class="token string">'root'</span> @<span class="token string">'%'</span> identified by <span class="token string">'root'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 刷新生效</span></pre></td></tr><tr><td data-num="11"></td><td><pre>FLUSH PRIVILEGES<span class="token punctuation">;</span></pre></td></tr></table></figure><p>查看 binlog 日志是否已经开启。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 binlog 日志是否开启</span></pre></td></tr><tr><td data-num="2"></td><td><pre>show variables like <span class="token string">'log_%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查看主结点当前状态</span></pre></td></tr><tr><td data-num="5"></td><td><pre>show master status<span class="token punctuation">;</span></pre></td></tr></table></figure><p>如果 log_bin 为 ON，即为开启状态。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1670219063740-9658993e-ac4f-42dc-9634-d716a07dc08c.png" alt="img"></p><p>为了避免以后每次启动 Linux 服务器都需要手动运行 MySQL 等容器，可以将其修改为 **<font color="red">开机时自动运行 </font>**：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> update mysql <span class="token parameter variable">--restart</span><span class="token operator">=</span>always</pre></td></tr></table></figure><p>重启 Linux 后，通过 <code>sudo docker ps</code> 命令验证 MySQL 已经自动运行。</p><h3 id="通过-navicat-idea-建立数据库连接"><a class="anchor" href="#通过-navicat-idea-建立数据库连接">#</a> 通过 Navicat / IDEA 建立数据库连接</h3><p>自定义连接名，<strong>IP 填写 本地 / Linux 的 IP 地址（具体看你是连接本地的 MySQL 还是 Linux 服务器中的 MySQL）</strong>，端口号默认为 3306，用户名和密码默认为 root（<strong>但本地 MySQL 大概率是你自定义的密码</strong>）。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240124161737463.png" alt="image-20240124161737463"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240124162008565.png" alt="image-20240124162008565"></p><h3 id="建库建表-初始化数据"><a class="anchor" href="#建库建表-初始化数据">#</a> 建库建表 &amp; 初始化数据</h3><p>两种启动模式分别对应不同的数据库表模式：</p><ul><li>SpringBoot 模式：仅分表，不分库。数据库名称是统一的 <code>12306</code> 。</li><li>**<font color="red">SpringCloud 模式：分库又分表 &lt;/f <code>**。数据库名称是</code> 12306_业务_分库数 `。</font></li></ul><p>两种模式的分表模式一致。所以说，启动 SpringBoot 模式时，导入 12306 数据库。<font color="red">启动 SpringCloud 时，需要创建与 12306 相关的数据库及表结构 </font>。</p><p>这里启动 SpringCloud 模式，执行数据库建表语句和初始化数据 SQL 文件，文件夹地址： <code>/resources/&#123;data or db&#125;/12306-springcloud-xx.sql</code> ，如果后续遇到代码中关于数据库相关的报错，重新执行下对应库的 SQL 文件。</p><p>MySQL 数据库中创建多个 12306 业务相关 DB，以下<strong>建库 SQL 可以在 IDEA 插件 “数据库” 中通过新建 “查询控制台” 执行</strong>：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240124162134366.png" alt="image-20240124162134366"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240124162215075.png" alt="image-20240124162215075"></p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span> <span class="token identifier"><span class="token punctuation">`</span>12306_ticket<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span> <span class="token identifier"><span class="token punctuation">`</span>12306_order_0<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span> <span class="token identifier"><span class="token punctuation">`</span>12306_order_1<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span> <span class="token identifier"><span class="token punctuation">`</span>12306_pay_0<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span> <span class="token identifier"><span class="token punctuation">`</span>12306_pay_1<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span> <span class="token identifier"><span class="token punctuation">`</span>12306_user_0<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span> <span class="token identifier"><span class="token punctuation">`</span>12306_user_1<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>1）进入 <code>12306_ticket</code> 数据库 **<font color="red">依次导入 </font>** 项目中下述建表 SQL 语句。</p><blockquote><p>最好在 Navicat 中执行以下 SQL 文件，因为在 IDEA 中可能会遇到最大堆空间不足的问题。</p></blockquote><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>resources/db/12306-springcloud-ticket.sql</pre></td></tr><tr><td data-num="2"></td><td><pre>resources/data/12306-springcloud-ticket.sql</pre></td></tr></table></figure><p>2）进入 <code>12306_user_0</code> 数据库 **<font color="red">依次导入 </font>** 项目中下述建表 SQL 语句，该 SQL 文件包含了 <code>12306_user_0</code> 和 <code>12306_user_1</code> 两个数据库的数据。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>resources/db/12306-springcloud-user.sql</pre></td></tr><tr><td data-num="2"></td><td><pre>resources/data/12306-springcloud-user.sql</pre></td></tr></table></figure><p>3）进入 <code>12306_pay_0</code> 数据库导入项目中下述建表 SQL 语句，该 SQL 文件包含了 <code>12306_pay_0</code> 和 <code>12306_pay_1</code> 两个数据库的数据。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>resources/db/12306-springcloud-pay.sql</pre></td></tr></table></figure><p>4）进入 <code>12306_order_0</code> 数据库导入项目中下述建表 SQL 语句，该 SQL 文件包含了 <code>12306_order_0</code> 和 <code>12306_order_1</code> 两个数据库的数据。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>resources/db/12306-springcloud-order.sql</pre></td></tr></table></figure><h3 id="修改项目代码中与-mysql-相关的配置"><a class="anchor" href="#修改项目代码中与-mysql-相关的配置">#</a> 修改项目代码中与 MySQL 相关的配置</h3><blockquote><p><strong>如果使用的是本地 MySQL 只需要修改 <code>password</code> 即可。</strong></p></blockquote><p><strong><font color="red">在 Linux 服务器中创建好 MySQL 后，由于项目中默认的配置信息是连接到本地的 MySQL 上，因此默认的 IP 全是 127.0.0.1，需要修改成自己的 Linux 服务器 IP，即 192.168.0.2 </font></strong>。需要修改项目的数据库配置信息，缺点是在之后 update project 时可能冲突：</p><blockquote><p>主要是确认三个配置参数 <code>jdbcUrl</code> 、 <code>username</code> 、 <code>password</code> ，主要是 <strong>IP 地址、端口号、数据库名称、用户名、密码</strong>，如果不一致请记得修改。</p><p>特别地，如果 <strong><font color="red">MySQL/Redis/Nacos/RocketMQ </font></strong>是安装在 Linux 中，那么需要将 <code>127.0.0.1</code> 修改为 Linux 的 IP 地址，例如我的是 <code>192.168.0.2</code> ，后续会说明。</p></blockquote><p>以 SpringBoot 单体服务举例，修改 <code>aggregation-service</code> 目录中的 <code>shardingsphere-config-dev.yaml</code> 即可：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691894880930-7aee6932-b5a5-458f-84bb-dacf70fe4b78.png" alt="image.png"></p><p>以 SpringCloud 微服务举例：</p><ul><li><p><code>aggregation-service</code> ：由于我采用的 SpringCloud 微服务模式不涉及该 service，因此不用修改相关配置文件。</p></li><li><p><code>gateway-service</code> ：该 service 不涉及 MySQL 配置，不用修改。</p></li><li><p><code>order-service</code> 、 <code>pay-service</code> 、 <code>user-service</code> ：修改各自目录下的 <code>shardingsphere-config.yaml</code> 文件，<font color="red">主要是 jdbcUrl 参数，将其中的 127.0.0.1 修改成 Linux 服务器 IP，即 192.168.0.2 </font>：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240124235121774.png" alt="image-20240124235121774"></p></li><li><p><code>ticket-service</code> ：修改目录下的 <code>application.yaml</code> 文件，<font color="red">将 spring.datasource.url 中的 127.0.0.1 修改为 192.168.0.2 </font>：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240124235317255.png" alt="image-20240124235317255"></p></li></ul><h2 id="安装后端环境中间件"><a class="anchor" href="#安装后端环境中间件">#</a> 安装后端环境（中间件）</h2><h3 id="方式一云中间件环境"><a class="anchor" href="#方式一云中间件环境">#</a> 方式一：云中间件环境</h3><h4 id="获取云中间件的域名"><a class="anchor" href="#获取云中间件的域名">#</a> 获取云中间件的域名</h4><ul><li>Redis： <code>common-redis-dev.magestack.cn</code></li><li>RocketMQ： <code>common-rocketmq-dev.magestack.cn:9876</code></li><li>Nacos： <code>common-nacos-dev.magestack.cn:8848</code></li></ul><h4 id="添加-vm-参数"><a class="anchor" href="#添加-vm-参数">#</a> 添加 VM 参数</h4><p><strong><font color="red">通过添加 VM options（JVM 参数）修改各 service 的配置信息，好处是不需要修改项目代码，不会冲突 </font></strong>。</p><ul><li><p>VM options 添加方法：</p><ul><li>规则 1：-D 开头 + 参数名 = 参数值</li><li>规则 2：= 两侧没有空格</li><li>规则 3：不同参数之间空格分隔</li></ul><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>// 如下所示我们增加两个参数 Env 和 Name</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-DEnv</span><span class="token operator">=</span>prod <span class="token parameter variable">-DName</span><span class="token operator">=</span>zhangsan</pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/42bafc4558f74e6b83e543042cecca90.png" alt="在这里插入图片描述"></p></li><li><p>VM options 获取方法：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// System.getProperty ("参数名")</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"Env"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul><p><strong><font color="red">由此得知，VM options 可以任意设置，即使是无用的参数也没有关系！</font></strong></p><p>获取到 Redis、RocketMQ 以及 Nacos 域名后，替换到下述文本中：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.password</span><span class="token operator">=</span>Sm9sVXBOYJjI030b5tz0trjpzvZzRhtZmEbv0uOImcD1wEDOPfeaqNU4PxHob/Wp</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.port</span><span class="token operator">=</span><span class="token number">19389</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-Dunique-name<span class="token operator">=</span>-自定义名称，可以切换为自己的名称</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-Dframework.cache.redis.prefix</span><span class="token operator">=</span>自定义名称，可以切换为自己的名称:</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span>Redis域名</pre></td></tr><tr><td data-num="6"></td><td><pre>-Drocketmq.name-server<span class="token operator">=</span>RocketMQ域名</pre></td></tr><tr><td data-num="7"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>Nacos域名</pre></td></tr></table></figure><p>得到真实的 VM 参数：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.password</span><span class="token operator">=</span>Sm9sVXBOYJjI030b5tz0trjpzvZzRhtZmEbv0uOImcD1wEDOPfeaqNU4PxHob/Wp</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.port</span><span class="token operator">=</span><span class="token number">19389</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-Dunique-name<span class="token operator">=</span>-fantedong</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-Dframework.cache.redis.prefix</span><span class="token operator">=</span>fantedong:</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span>common-redis-dev.magestack.cn</pre></td></tr><tr><td data-num="6"></td><td><pre>-Drocketmq.name-server<span class="token operator">=</span>common-rocketmq-dev.magestack.cn:9876</pre></td></tr><tr><td data-num="7"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>common-nacos-dev.magestack.cn:8848</pre></td></tr></table></figure><blockquote><p>注意， <code>-Dunique-name=-mading</code> 中 mading 前面有个中划线， <code>-Dframework.cache.redis.prefix</code> 中 mading 后面有个冒号。</p><p><strong>unique-name 和 framework.cache.redis.prefix 不要再使用 mading，可以替换为自己的名字或代号，不然的话会和其他同学调用混乱。！！！强烈建议加上随机字符，比如 mading0924xxx 等等，避免冲突。</strong></p></blockquote><p>如果实在不清楚如何如何添加 VM 参数，将上述这些配置直接替换服务中的配置文件也可以。</p><p>将上述 VM 参数赋值到各个服务的 VM options 文本框中：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240324110852119.png" alt="image-20240324110852119"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240324110949893.png" alt="image-20240324110949893"></p><p>全部配置完成，点击 OK。</p><h3 id="方式二在-linux-服务器上安装"><a class="anchor" href="#方式二在-linux-服务器上安装">#</a> 方式二：在 Linux 服务器上安装</h3><blockquote><p><strong>啊啊啊啊啊啊啊 Linux 虚拟机的空间不够，发出尖锐的爆鸣声！！！</strong></p></blockquote><h4 id="redis-latest"><a class="anchor" href="#redis-latest">#</a> Redis Latest</h4><p>通过简易版方式安装，主打的就是有问题铲了重装。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">6379</span>:6379 <span class="token parameter variable">--name</span> redis  <span class="token parameter variable">-d</span> redis redis-server <span class="token parameter variable">--requirepass</span> <span class="token string">"123456"</span></pre></td></tr></table></figure><p>同样地，也将 Redis 修改为 **<font color="red">开机时自动运行 </font>**：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> update redis <span class="token parameter variable">--restart</span><span class="token operator">=</span>always</pre></td></tr></table></figure><h4 id="rocketmq-451"><a class="anchor" href="#rocketmq-451">#</a> RocketMQ 4.5.1</h4><h5 id="安装-nameserver"><a class="anchor" href="#安装-nameserver">#</a> 安装 NameServer</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">9876</span>:9876 <span class="token parameter variable">--name</span> rmqnamesrv foxiswho/rocketmq:server-4.5.1</pre></td></tr></table></figure><h5 id="安装-brocker"><a class="anchor" href="#安装-brocker">#</a> 安装 Brocker</h5><p>1）新建配置目录</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/docker/software/rocketmq/conf</pre></td></tr></table></figure><p>2）新建配置文件 broker.conf</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>brokerClusterName <span class="token operator">=</span> DefaultCluster</pre></td></tr><tr><td data-num="2"></td><td><pre>brokerName <span class="token operator">=</span> broker-a</pre></td></tr><tr><td data-num="3"></td><td><pre>brokerId <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="4"></td><td><pre>deleteWhen <span class="token operator">=</span> 04</pre></td></tr><tr><td data-num="5"></td><td><pre>fileReservedTime <span class="token operator">=</span> <span class="token number">48</span></pre></td></tr><tr><td data-num="6"></td><td><pre>brokerRole <span class="token operator">=</span> ASYNC_MASTER</pre></td></tr><tr><td data-num="7"></td><td><pre>flushDiskType <span class="token operator">=</span> ASYNC_FLUSH</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 此处为本地 ip, 如果部署服务器，需要填写服务器外网 ip, 例如 192.168.0.2</span></pre></td></tr><tr><td data-num="9"></td><td><pre>brokerIP1 <span class="token operator">=</span> xx.xx.xx.xx</pre></td></tr></table></figure><p>3）创建容器</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">10911</span>:10911 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">10909</span>:10909 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">--name</span> rmqbroker <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">--link</span> rmqnamesrv:namesrv <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-v</span> ~/docker/software/rocketmq/conf/broker.conf:/etc/rocketmq/broker.conf <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">-e</span> <span class="token string">"NAMESRV_ADDR=namesrv:9876"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token parameter variable">-e</span> <span class="token string">"JAVA_OPTS=-Duser.home=/opt"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token parameter variable">-e</span> <span class="token string">"JAVA_OPT_EXT=-server -Xms512m -Xmx512m"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>foxiswho/rocketmq:broker-4.5.1</pre></td></tr></table></figure><h5 id="安装-rocketmq-控制台"><a class="anchor" href="#安装-rocketmq-控制台">#</a> 安装 rocketmq 控制台</h5><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> pull apacherocketmq/rocketmq-dashboard</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">--link</span> rmqnamesrv:namesrv <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-e</span> <span class="token string">"JAVA_OPTS=-Drocketmq.config.namesrvAddr=namesrv:9876 -Drocketmq.config.isVIPChannel=false"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">--name</span> rmqconsole <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">8088</span>:8080 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">-t</span> apacherocketmq/rocketmq-dashboard</pre></td></tr></table></figure><p>运行成功，稍等几秒启动时间，浏览器输入 <code>localhost:8088</code> 查看。</p><p>同样地，也将 NameServer、Brocker、rocketmq 控制台 修改为 **<font color="red">开机时自动运行 </font>**：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> update rmqnamesrv <span class="token parameter variable">--restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> update rmqbroker <span class="token parameter variable">--restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> update rmqconsole <span class="token parameter variable">--restart</span><span class="token operator">=</span>always</pre></td></tr></table></figure><h4 id="nacos-212"><a class="anchor" href="#nacos-212">#</a> Nacos 2.1.2</h4><p>通过简易版方式安装，主打的就是有问题铲了重装。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">8848</span>:8848 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">9848</span>:9848 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">--name</span> nacos2 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-e</span> <span class="token assign-left variable">MODE</span><span class="token operator">=</span>standalone <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-e</span> <span class="token assign-left variable">TIME_ZONE</span><span class="token operator">=</span><span class="token string">'Asia/Shanghai'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>nacos/nacos-server:v2.1.2</pre></td></tr></table></figure><p>运行成功，稍等几秒启动时间，浏览器输入 <code>http://localhost:8848/nacos/index.html</code> 查看控制台，用户名和密码均为 nacos。</p><p>同样地，也将 Nacos2 修改为 **<font color="red">开机时自动运行 </font>**：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> update nacos2 <span class="token parameter variable">--restart</span><span class="token operator">=</span>always</pre></td></tr></table></figure><h4 id="添加-vm-启动参数"><a class="anchor" href="#添加-vm-启动参数">#</a> 添加 VM 启动参数</h4><blockquote><p>修改中间件相关的项目配置</p></blockquote><p>如果 <strong><font color="red">Redis/Nacos/RocketMQ </font></strong>是安装在 Linux 中，那么需要修改项目中的配置信息。</p><p>首先，参考以下 VM options 示例模板，根据实际情况给出各个 service 的具体 VM 参数：</p><pre><code class="language-Shell">-Dspring.data.redis.password=Sm9sVXBOYJjI030b5tz0trjpzvZzRhtZmEbv0uOImcD1wEDOPfeaqNU4PxHob/Wp
-Dspring.data.redis.port=19389
-Dunique-name=-自定义名称，可以切换为自己的名称
-Dframework.cache.redis.prefix=自定义名称，可以切换为自己的名称:
-Dspring.data.redis.host=Redis域名
-Drocketmq.name-server=RocketMQ域名
-Dspring.cloud.nacos.discovery.server-addr=Nacos域名
</code></pre><ul><li><p><code>aggregation-service</code> ：SpringCloud 微服务模式并不使用该 service，因此不用修改。</p></li><li><p><code>gateway-service</code> ：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>-Dunique-name<span class="token operator">=</span>-fantedong</pre></td></tr><tr><td data-num="2"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span><span class="token number">192.168</span>.0.2:8848</pre></td></tr></table></figure></li><li><p><code>order-service</code> 、 <code>pay-service</code> 、 <code>ticket-service</code> ：对我而言，Redis 在安装时设定的 password 正好是项目中配置的原始密码 123456，port 也正好是 6379，因此这两个参数不需要修改。设置自定义名称 unique-name 为 fantedong 。然后因为 Redis 是在自己的 Linux 服务器中的，所以不需要设置 framework.cache.redis.prefix 。<strong><font color="red">由于 Redis/RocketMQ/Nacos 都是安装在 Linux 服务器中，因此需要修改填写服务器的 IP 地址，即 192.168.0.2 </font></strong>。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>-Dunique-name<span class="token operator">=</span>-fantedong</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span><span class="token number">192.168</span>.0.2</pre></td></tr><tr><td data-num="3"></td><td><pre>-Drocketmq.name-server<span class="token operator">=</span><span class="token number">192.168</span>.0.2:9876</pre></td></tr><tr><td data-num="4"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span><span class="token number">192.168</span>.0.2:8848</pre></td></tr></table></figure></li><li><p><code>user-service</code> ：没有用到 RocketMQ 。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>-Dunique-name<span class="token operator">=</span>-fantedong</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span><span class="token number">192.168</span>.0.2</pre></td></tr><tr><td data-num="3"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span><span class="token number">192.168</span>.0.2:8848</pre></td></tr></table></figure></li></ul><p>然后，因为 VM options 可以任意设置，图个方便省事，这里为 <code>gateway-service</code> 、 <code>order-service</code> 、 <code>pay-service</code> 、 <code>ticket-service</code> 、 <code>user-service</code> 均添加以下 VM options：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>-Dunique-name<span class="token operator">=</span>-fantedong</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span><span class="token number">192.168</span>.0.2</pre></td></tr><tr><td data-num="3"></td><td><pre>-Drocketmq.name-server<span class="token operator">=</span><span class="token number">192.168</span>.0.2:9876</pre></td></tr><tr><td data-num="4"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span><span class="token number">192.168</span>.0.2:8848</pre></td></tr></table></figure><h2 id="启动后端"><a class="anchor" href="#启动后端">#</a> 启动后端</h2><h3 id="将-gateway-service-配置为分布式方式启动"><a class="anchor" href="#将-gateway-service-配置为分布式方式启动">#</a> 将 gateway-service 配置为分布式方式启动</h3><p><code>gateway-service</code> 配置中默认是 SpringBoot 单体模式，如果是以分布式方式启动，需要修改 <code>application.yaml</code> 配置文件中的属性。</p><p>SpringBoot 单体模式：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> index12306<span class="token punctuation">-</span>gateway$<span class="token punctuation">&#123;</span>unique<span class="token punctuation">-</span>name<span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">profiles</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">active</span><span class="token punctuation">:</span> aggregation</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment"># active: dev</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span></pre></td></tr></table></figure><p>SpringCloud 分布式模式：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> index12306<span class="token punctuation">-</span>gateway$<span class="token punctuation">&#123;</span>unique<span class="token punctuation">-</span>name<span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">profiles</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment"># active: aggregation</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span></pre></td></tr></table></figure><p>可以看到，我们将 <code>spring.profiles.active</code> 从 aggregation 修改为了 dev。</p><p>aggregation 代表着聚合模式也就是 SpringBoot 单体模式，dev 是分布式模式，分别对应两个配置文件。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691039852586-c1cadfec-3770-4eb0-89b1-7625d640c559.png" alt="img"></p><p>通过 Spring 机制，加载不同的配置文件，起到网关调用不同模式服务的作用。</p><p>星球小伙伴修改网关配置后，问题得到解决。</p><p>实际上，<strong><font color="red">还是建议通过添加 VM options 的方式更改此配置 </font></strong>，只需在 VM options 基础上添加一行 <code>-Dspring.profiles.active=dev</code> 即可：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.password</span><span class="token operator">=</span>Sm9sVXBOYJjI030b5tz0trjpzvZzRhtZmEbv0uOImcD1wEDOPfeaqNU4PxHob/Wp</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.port</span><span class="token operator">=</span><span class="token number">19389</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-Dunique-name<span class="token operator">=</span>-fantedong</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-Dframework.cache.redis.prefix</span><span class="token operator">=</span>fantedong:</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span>common-redis-dev.magestack.cn</pre></td></tr><tr><td data-num="6"></td><td><pre>-Drocketmq.name-server<span class="token operator">=</span>common-rocketmq-dev.magestack.cn:9876</pre></td></tr><tr><td data-num="7"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>common-nacos-dev.magestack.cn:8848</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token parameter variable">-Dspring.profiles.active</span><span class="token operator">=</span>dev</pre></td></tr></table></figure><p>仅修改 GatewayServiceApplication 的运行配置即可。</p><h3 id="启动后端服务"><a class="anchor" href="#启动后端服务">#</a> 启动后端服务</h3><p>如果你想 <font color="red">以小成本启动前后端系统（SpringBoot）</font>，后端项目仅启动 <code>aggregation-service</code> 和 <code>gateway-service</code> 服务即可。</p><blockquote><p>Q： <code>aggregation-service</code> 服务是做什么的？</p><p>A：为了减少大家本地启动内存压力以及服务器部署压力，将订单、支付、用户以及购票系统进行了聚合，启动网关和 <code>aggregation-service</code> 服务即可享受 12306 购票系统全部功能。</p></blockquote><p>如果你是想跑 <font color="red">微服务全流程（SpringCloud）</font>，需依次启动 <code>pay-service</code> 、 <code>order-service</code> 、 <code>ticket-service</code> 、 <code>user-service</code> 以及 <code>gateway-service</code> 等服务。</p><p>过程中如果遇到任何问题可以跳转到<a href="#%E9%97%AE%E9%A2%98%E8%B0%83%E8%AF%95">问题调试</a>和<a href="#%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">项目启动中的常见问题</a>查找解决方法。</p><figure class="highlight plain"><figcaption data-lang="plain"></figcaption><table><tr><td data-num="1"></td><td><pre>.</pre></td></tr><tr><td data-num="2"></td><td><pre>├── aggregation-service  || -- # 聚合服务</pre></td></tr><tr><td data-num="3"></td><td><pre>├── gateway-service  || -- # 网关服务</pre></td></tr><tr><td data-num="4"></td><td><pre>├── order-service  || -- # 订单服务</pre></td></tr><tr><td data-num="5"></td><td><pre>├── pay-service  || -- # 支付服务</pre></td></tr><tr><td data-num="6"></td><td><pre>├── ticket-service  || -- # 购票服务</pre></td></tr><tr><td data-num="7"></td><td><pre>└── user-service  || -- # 用户服务</pre></td></tr></table></figure><h3 id="登录中间件控制台"><a class="anchor" href="#登录中间件控制台">#</a> 登录中间件控制台</h3><p>Nacos：<span class="exturl" data-url="aHR0cDovL2NvbW1vbi1uYWNvcy1kZXYubWFnZXN0YWNrLmNuOjg4NDgvbmFjb3MvaW5kZXguaHRtbA==">http://common-nacos-dev.magestack.cn:8848/nacos/index.html</span></p><p>用户名 / 密码：nacos</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240324111909004.png" alt="image-20240324111909004"></p><p>RocketMQ：<span class="exturl" data-url="aHR0cDovL2NvbW1vbi1yb2NrZXRtcS1kZXYubWFnZXN0YWNrLmNuOjgwODgvIy8=">http://common-rocketmq-dev.magestack.cn:8088/#/</span></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240324111853322.png" alt="image-20240324111853322"></p><h2 id="安装前端环境nodejs"><a class="anchor" href="#安装前端环境nodejs">#</a> 安装前端环境（Nodejs）</h2><blockquote><p>参考：<span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL21hZ2VzdGFjay8xMjMwNi9vZ3BieXAzb290ZzlhMnNr">快速启动之前端项目 (yuque.com)</span>，密码 gv4g</p><p>因为我本地已经安装，且版本在 16.20.0 以上，故略过该内容。</p></blockquote><h2 id="启动前端"><a class="anchor" href="#启动前端">#</a> 启动前端</h2><p>Windows 用户通过 cmd 工具进入 <code>12306/console-vue</code> 目录执行，依次执行下述命令：</p><p>1）安装 yarn</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> <span class="token function">yarn</span></pre></td></tr></table></figure><p>2）下载依赖</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">yarn</span> <span class="token function">install</span></pre></td></tr></table></figure><p>3）前端调用本地</p><p>检查 vue.config.js 配置文件中 target 是否为： <code>http://127.0.0.1:9000</code> ，如果不是需要修改。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690859640845-75424af8-057c-4833-a03b-ffd32fc4bf00.png" alt="img"></p><p>4）启动项目</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">yarn</span> serve</pre></td></tr></table></figure><p>启动成功后，会出现以下信息，访问任意一个都可以登录 12306 Web 控制台。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690105184349-91b68fe7-7978-4fa4-85fe-4dfbdb9e25c0.png" alt="img"></p><p>首页查询车次信息是不涉及登录的，但是如果想体验购票，需要用户登录操作。</p><p>默认用户名和密码：admin/admin123456</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690615839081-d8103138-9e4d-4424-8976-2c36490835d3.png" alt="img"></p><h2 id="问题调试"><a class="anchor" href="#问题调试">#</a> 问题调试</h2><h3 id="pay-service-目录下的-payserviceapplicationjava-启动类无法识别"><a class="anchor" href="#pay-service-目录下的-payserviceapplicationjava-启动类无法识别">#</a> pay-service 目录下的 PayServiceApplication.java 启动类无法识别</h3><p>解决方法是右键该目录下的 java 文件夹，标记为 <code>sources root</code> 目录，然后右键 pay-service 目录，选择 <code>maven-重新加载项目</code> ，解决。</p><h3 id="启动-pay-service-时遇到-tomcat-版本不兼容的-erroran-incompatible-version-1231-of-the-apache-tomcat-native-library-is-installed-while-tomcat-requires-version-1234"><a class="anchor" href="#启动-pay-service-时遇到-tomcat-版本不兼容的-erroran-incompatible-version-1231-of-the-apache-tomcat-native-library-is-installed-while-tomcat-requires-version-1234">#</a> 启动 pay-service 时遇到 Tomcat 版本不兼容的 ERROR：An incompatible version [1.2.31] of the Apache Tomcat Native library is installed, while Tomcat requires version [1.2.34]</h3><p>解决方法：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzUzMzczMi9hcnRpY2xlL2RldGFpbHMvMTEzNzM3OTQx">https://blog.csdn.net/weixin_43533732/article/details/113737941</span></p><h3 id="启动-pay-service-时在初始化-hikari-池时遇到-errorhikaripool-3-exception-during-pool-initialization"><a class="anchor" href="#启动-pay-service-时在初始化-hikari-池时遇到-errorhikaripool-3-exception-during-pool-initialization">#</a> 启动 pay-service 时在初始化 hikari 池时遇到 ERROR：HikariPool-3 - Exception during pool initialization.</h3><p>具体信息： <code>java.sql.SQLException: Access denied for user 'root'@'localhost' (using password: YES)</code></p><p>解决方法：密码错了啊魂淡！要修改各个服务下中涉及 MySQL 密码的 yaml 文件，将密码从 root 改为自己的密码。</p><h3 id="windows-系统启动支付服务时报错-command-line-is-too-long-shorten-the-command-line-and-rerun"><a class="anchor" href="#windows-系统启动支付服务时报错-command-line-is-too-long-shorten-the-command-line-and-rerun">#</a> Windows 系统启动支付服务时报错 Command line is too long Shorten the command line and rerun</h3><p>该问题仅 Windows 系统电脑会出现。</p><p>问题现状：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691204207160-af495b10-eb96-4ea4-976f-f2bbc4575324.png" alt="img"></p><p>解决方法：</p><p>1）打开服务控制器</p><p>2）选择支付服务 PayServiceApplication，点击 Modify options，点击 shorten command line</p><p>3）选择 JAR manifest</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240125031400152.png" alt="image-20240125031400152"></p><h3 id="linux-服务器的磁盘空间不足无法通过-docker-运行-mysql"><a class="anchor" href="#linux-服务器的磁盘空间不足无法通过-docker-运行-mysql">#</a> Linux 服务器的磁盘空间不足，无法通过 docker 运行 MySQL</h3><p>** 痛！！！太痛辣！！** 目前想法是转到 Windows 本地运行 MySQL 。</p><h2 id="如何将-12306-部署在云服务器上"><a class="anchor" href="#如何将-12306-部署在云服务器上">#</a> 如何将 12306 部署在云服务器上？</h2><h3 id="准备云服务器"><a class="anchor" href="#准备云服务器">#</a> 准备云服务器</h3><p>部署 12306 项目前，需要准备 <font color="red">一个可被公网访问的云服务器 </font>。在这里我推荐阿里云或者腾讯云的轻量云服务器，新用户购买个 <strong>2C4G</strong> 的配置，一年大概 300 多元。</p><p>咱们这里以阿里云为例。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695608526189-83554bec-d432-4e4f-bdb5-fbe255b263fa.png" alt="img"></p><p>如果没有云服务器用户，可以选择购买阿里云服务器，购买轻量云服务器地址：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYWxpeXVuLmNvbS9kYWlseS1hY3QvZWNzL2Vjc190cmlhbF9iZW5lZml0cz91c2VyQ29kZT11ZHk5b2V2Mg==">返利地址购买</span>。因为我是老用户，新用户通过我这个地址购买会给我返利，你购买后告诉我一声，返利的钱如数奉还。</p><h3 id="开放防火墙端口"><a class="anchor" href="#开放防火墙端口">#</a> 开放防火墙端口</h3><p>需要保证云服务器的 <font color="red">80、3306、9000 端口 </font>对所有地址开放，因为我们会使用这些端口进行转发访问相关资源。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695650059835-5ff8da14-88e5-4a6c-88a1-7925158d5c09.png" alt="img"></p><h3 id="云服务器环境安装"><a class="anchor" href="#云服务器环境安装">#</a> 云服务器环境安装</h3><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695613689285-05337592-87f2-4f52-9e54-0b1b668041c2.png" alt="img"></p><h4 id="jdk-环境"><a class="anchor" href="#jdk-环境">#</a> JDK 环境</h4><p>使用夸克网盘下载 JDK17，并上传到云服务器，链接：<span class="exturl" data-url="aHR0cHM6Ly9wYW4ucXVhcmsuY24vcy85NDRjNGE0ZDM3M2YlRTMlODAlODI=">https://pan.quark.cn/s/944c4a4d373f。</span></p><p>进入 <code>/usr/local</code> 目录，创建 java 文件夹。并将 JDK17 上传到 java 目录下。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695615898278-9b6c405f-0986-4e68-8119-117002067fa7.png" alt="img"></p><p>上传成功后，解压 JDK17 压缩包，命令 <code>unzip zulu17.44.53-ca-jdk17.0.8.1-linux_x64.zip</code> 。</p><p>如果报错说 unzip 命令不存在，安装该命令： <code>yum install -y unzip zip</code> 。</p><p>解压后的目录如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695624120348-765c7f16-b82f-483e-8f3a-3647a03ccb98.png" alt="img"></p><p>为了简单，就不配置环境变量了，直接拿实际引用执行 Java 相关命令。</p><h4 id="nginx-软件"><a class="anchor" href="#nginx-软件">#</a> Nginx 软件</h4><p>更新系统软件包列表。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> yum update</pre></td></tr></table></figure><p>安装 Nginx 命令。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> yum <span class="token function">install</span> nginx</pre></td></tr></table></figure><p>安装完成后，可以使用以下命令启动 Nginx。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl start nginx</pre></td></tr></table></figure><p>同时还需要设置 Nginx 开机自启。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> nginx</pre></td></tr></table></figure><h3 id="项目打包上传"><a class="anchor" href="#项目打包上传">#</a> 项目打包上传</h3><h4 id="聚合网关项目"><a class="anchor" href="#聚合网关项目">#</a> 聚合 &amp; 网关项目</h4><p>Maven 执行 clean install 逻辑，将 SpringBoot 可执行 Jar 生成。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695627472305-2d163a28-2847-4b35-9697-f958843bd8d6.png" alt="img"></p><p>通过命令创建 /home/12306 文件夹。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/12306</pre></td></tr></table></figure><p>将 <code>index12306-aggregation-service.jar</code> 、 <code>index12306-gateway-service.jar</code> 上传到云服务器 <code>/home/12306</code> 文件夹下。</p><p>上传后的目录如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695633481292-9faaa212-4ca9-4662-8747-71258998278b.png" alt="img"></p><h4 id="前端项目"><a class="anchor" href="#前端项目">#</a> 前端项目</h4><p>进入到 <code>console-vue</code> 目录下，执行 <code>yarn build</code> 命令。如果是 Windows 系统用户，记得去 CMD 命令行里执行。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695629376261-193796e4-9933-4fbd-b11d-7882853eff4c.png" alt="img"></p><p>将该 dist 目录上传到云服务器 <code>/home/12306</code> 目录下。上传前记得压缩下 dist 目录，上传方便些，上传成功后再解压。</p><p>上传后的目录如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695633526189-f4b53139-058e-463f-b3ab-0b110cfa6b49.png" alt="img"></p><p>执行解压缩命令： <code>unzip dist.zip</code> 完成压缩包解压。</p><h4 id="安装中间件环境"><a class="anchor" href="#安装中间件环境">#</a> 安装中间件环境</h4><p>和咱们本地启动模式一样，<font color="red">只有 MySQL 是大家必须安装的，这里采用极简模式，让大家其它中间件使用星球云中间件环境 </font>。</p><p>MySQL 服务安装以及数据库初始化参考：<span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL21hZ2VzdGFjay8xMjMwNi9rd3R4cGUwY2J1Z2VrOXVl">手摸手之初始数据库表信息</span>。</p><h3 id="启动项目"><a class="anchor" href="#启动项目">#</a> 启动项目</h3><h4 id="启动后端项目"><a class="anchor" href="#启动后端项目">#</a> 启动后端项目</h4><p>在 12306 目录下创建 logs 文件夹。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/12306/logs</pre></td></tr></table></figure><p>进入 <code>/home/12306</code> 文件夹下，开始启动后端项目。</p><p>先启动聚合服务。下面需要替换的配置项从 <span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL21hZ2VzdGFjay8xMjMwNi9ndThkNHV2bjVjZHp1aWc5">安装中间件环境</span> 文章中获取。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">nohup</span> /usr/local/java/zulu17.44.53-ca-jdk17.0.8.1-linux_x64/bin/java <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Xms2048m</span> <span class="token parameter variable">-Xmx2048m</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-Dunique-name<span class="token operator">=</span>-xxx <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-Dframework.cache.redis.prefix</span><span class="token operator">=</span>xxx: <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.password</span><span class="token operator">=</span>Sm9sVXBOYJjI030b5tz0trjpzvZzRhtZmEbv0uOImcD1wEDOPfeaqNU4PxHob/Wp <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.port</span><span class="token operator">=</span><span class="token number">19389</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span>xxx <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>-Drocketmq.name-server<span class="token operator">=</span>xxx <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>xxx <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>-Dpay.alipay.notify-url<span class="token operator">=</span>http://服务器外网IP:9000/api/pay-service/callback/alipay <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token parameter variable">-jar</span> /home/12306/index12306-aggregation-service.jar <span class="token operator">></span> logs/index12306-aggregation-service.file <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span></pre></td></tr></table></figure><p>执行 <code>tail -f logs/index12306-aggregation-service.file</code> 命令查看日志是否启动成功。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695650173346-2344f661-7b3f-4a47-81b0-ff84d227bc39.png" alt="img"></p><p>依次启动网关项目。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">nohup</span> /usr/local/java/zulu17.44.53-ca-jdk17.0.8.1-linux_x64/bin/java <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-Xms2048m</span> <span class="token parameter variable">-Xmx2048m</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-Dunique-name<span class="token operator">=</span>-xxx <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-Dframework.cache.redis.prefix</span><span class="token operator">=</span>xxx: <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.password</span><span class="token operator">=</span>Sm9sVXBOYJjI030b5tz0trjpzvZzRhtZmEbv0uOImcD1wEDOPfeaqNU4PxHob/Wp <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.port</span><span class="token operator">=</span><span class="token number">19389</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">-Dspring.data.redis.host</span><span class="token operator">=</span>xxx <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>-Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>xxx <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token parameter variable">-jar</span> /home/12306/index12306-gateway-service.jar <span class="token operator">></span> logs/index12306-gateway-service.file <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span></pre></td></tr></table></figure><p>执行 <code>tail -f logs/index12306-gateway-service.file</code> 命令查看网关服务是否启动成功。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695650383673-cd93e5ba-d788-4943-863c-3ee555689765.png" alt="img"></p><h4 id="nginx-挂载前端项目"><a class="anchor" href="#nginx-挂载前端项目">#</a> Nginx 挂载前端项目</h4><p>修改 Nginx 的配置，让前端可以访问。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">vim</span> /etc/nginx/nginx.conf</pre></td></tr></table></figure><p>将默认 Nginx <code>http/server</code> 配置改为下述配置：</p><figure class="highlight nginx"><figcaption data-lang="nginx"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment"># 只要保证 server 里的配置在 nginx 的 http 配置下就好</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>         <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token directive"><span class="token keyword">root</span>   /home/12306/dist</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token directive"><span class="token keyword">location</span> /api</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">10s</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:9000/api</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695650938526-967d4a5b-080f-4e02-96be-e54d18bda18f.png" alt="img"></p><p>保存退出文件编辑状态，重载 Nginx 的配置。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl reload nginx</pre></td></tr></table></figure><p>如果前端访问不生效，检查配置文件中这个配置是否被注释，没有的话需要注释掉。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1697248998602-970e2b99-8b62-4b22-9575-59101fe44b46.png" alt="img"></p><h3 id="公网访问"><a class="anchor" href="#公网访问">#</a> 公网访问</h3><p>浏览器访问： <code>http://公网IP</code> 即可看到对应的前端页面。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1695650868192-b009010b-4de9-47f4-bf70-48dea5af58a7.png" alt="img"></p><h1 id="用户体系建设概要"><a class="anchor" href="#用户体系建设概要">#</a> 用户体系建设概要</h1><h2 id="业务分析"><a class="anchor" href="#业务分析">#</a> 业务分析</h2><p>12306 铁路购票系统中，存在两类用户，分别是：<strong>会员</strong>（即当前账户登录用户）以及<strong>乘车人</strong>。</p><h3 id="会员用户"><a class="anchor" href="#会员用户">#</a> 会员用户</h3><p>会员支持在系统中自行 <font color="red">注册 </font>，需要注册者提供用户名、密码、证件类型、证件号、真实姓名、手机号、邮箱以及旅客类型。</p><p>其中，用户名和证件号码全局唯一，不允许注册者重复使用。</p><p>会员 <font color="red">登录 </font>系统时，支持用户名 / 邮箱 / 手机号码三种登录方式，搭配密码完成系统用户登录行为。</p><h3 id="乘车人"><a class="anchor" href="#乘车人">#</a> 乘车人</h3><p>一个注册会员可以添加多个乘车人。<font color="red">添加乘车人 </font>时需要填写真实姓名、身份证、手机号等，新增乘车人需要通过实名认证审核，审核通过方可成功。</p><p>会员选择交通工具（火车、高铁等）进行买票时，可以选择多个乘车人进行 <font color="red">购票 </font>。</p><p>会员可以通过已支付订单查看所有订单信息，乘车人也可通过订单标签页中本人车票 <font color="red">查看自己或其他会员购买为自己购买的订单信息 </font>。</p><h2 id="业务难点"><a class="anchor" href="#业务难点">#</a> 业务难点</h2><p>由于篇幅所限，本文无法详尽解答以下业务难点，但这些问题都会在后续的手摸手教学系列中逐一阐述，并给出较优解决方案。</p><h3 id="如何确定信息真实"><a class="anchor" href="#如何确定信息真实">#</a> 如何确定信息真实</h3><p>当用户在 12306 网站注册新账号或者为自己的账号添加新的乘车人时，系统需要确保用户提交的各项信息是真实准确的，而不是虚假的。</p><p>这其中就涉及到一个很重要的概念 —— 用户信息的认证。对用户提交的信息进行认证，就是要验证信息的真实性，确认这确实是本人自愿提交的真实信息，不是其他人冒充的。</p><p>那么如何进行有效的用户信息认证呢？这个问题可以简化为一个核心点：<strong><font color="red">你需要向系统证明你就是你本人，你提供的信息都是真的。</font></strong></p><p>举个简单的例子，在注册时，你提交了自己的身份证号码。但是系统怎么确认你提交的身份证号码真的属于你自己，而是通过非法途径获取然后冒充他人的呢？这就需要进行用户认证。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689686443768-96ffcb9d-8062-45f5-b37f-abc2f7ecd418.png" alt="img"></p><p>许多云服务提供商开放了 <font color="red">收费的身份验证接口 </font>，这些接口底层主要调用公安部门的身份核验系统，并 <font color="red">在云服务端增加缓存层 </font>。</p><p>12306 中的信息准确性校验主要包括：</p><ul><li>注册会员时，校验用户名、证件号、手机号是否匹配，确保账号信息真实有效。</li><li>添加乘车人时，校验乘车人姓名、身份证号是否真实匹配，并校验手机号可用性。</li></ul><p>如果 12306 的用户验证依赖收费的云服务或公安接口，为了优化成本和性能，其底层系统很可能采用缓存机制来减少对外部服务的直接调用。</p><h3 id="数十亿级数据量"><a class="anchor" href="#数十亿级数据量">#</a> 数十亿级数据量</h3><p>根据 2022 年的全国人口统计数据，现有 14 亿多总人口，每年新生人口约 956 万。为便于后续业务数据规模的判断，本文先基于这一人口总量和增长数据进行估算。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689686443741-a20b8648-5921-4888-8179-30a21c17f93e.png" alt="img"></p><p>根据系统设计的假设，12306 的注册用户规模约为 10 亿，每年新增用户约 500 万。</p><p>考虑到会员可添加多名乘车人，且一家多人可能分别拥有账号，估算乘车人数据量大约为注册用户的 2-3 倍，粗略估算约 30 亿左右。</p><p>鉴于会员和乘车人数据规模都已超过 10 亿级别，远超出单机 MySQL 数据库的处理能力，所以需使用分库分表或分布式数据库来支撑 <font color="red">海量用户 / 乘车人数据 </font>。</p><p><font color="red">考虑到 <u>分布式数据库 </u>普及率较低，<u>分库分表 </u>技术仍是大多数公司的选择 </font>，所以后续文章关于大数据量的解决方案会以分库分表技术来说明，查看<a href="#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">用户数据分库分表</a>。</p><p>如果使用分库分表技术，面试中这些问题都是无法避免会被问到：</p><ul><li>选择分库还是分表，还是选择分库分表？基于什么考虑？</li><li>选择哪个字段作为分片键？选择单个分片键还是复合分片键？</li><li>如何在老业务上平滑上线分库分表？出现问题如何快速回滚？</li><li>拆分后出现单表数据量过大，如何继续扩容？扩单表还是整体扩？</li></ul><h3 id="会员多种登录类型"><a class="anchor" href="#会员多种登录类型">#</a> 会员多种登录类型</h3><p>根据前文对 12306 系统设计的讨论分析，我们已经得知会员表预计会采用分库分表技术来应对大规模的访问压力和海量用户数据。</p><p>但是在具体的登录环节，由于系统支持会员使用用户名、手机号以及邮箱等多种方式进行登录，这就存在一个比较棘手的问题：</p><p><font color="red">由于登录时无法确定用户的分片键，使得系统无法直接锁定用户的数据位于哪个数据库或者哪张表中。为了找到用户的数据，只能对全部的数据库和表进行扫描查询，这就造成了所谓的 “读请求扩散” 问题。</font></p><p>也就是说，原本读请求可以直接定位到某个数据库某张表，现在却要多处查询，无疑大大增加了系统的查询负载。</p><p><font color="red">一旦出现了读请求扩散问题，势必会导致用户的登录请求响应时间变长，严重的话还可能造成登录超时。</font></p><h3 id="用户注册缓存穿透"><a class="anchor" href="#用户注册缓存穿透">#</a> 用户注册缓存穿透</h3><h4 id="用户注册穿透场景"><a class="anchor" href="#用户注册穿透场景">#</a> 用户注册穿透场景</h4><p>在高并发的会员注册场景下，可能会出现 **<font color="red">缓存穿透问题 </font>**。</p><blockquote><p>缓存穿透说简单点就是 <strong>大量请求的 key 既不存在于缓存中，也不存在于数据库中，进行了两次无用的查询，最终返回空数据</strong>。这就导致这些请求直接到了数据库上，根本没有经过缓存这一层，<font color="red">对数据库造成了巨大的压力 </font>，可能直接就被这么多请求弄宕机了。</p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/redis-cache-penetration.png" alt="缓存穿透" style="zoom:67%"></blockquote><p>主要原因可能是：</p><ul><li>用户注册时，需要验证用户名是否已存在，这通常需要查询数据库。</li><li>如果缓存中没有该用户名，就会去数据库查询，如果数据库中也没有，就可以判断该用户名可用。</li><li>在高并发的情况下，可能有大量的新用户同时注册，输入的用户名极有可能都不存在于数据库中。这将导致大量的缓存不存在，都去查询数据库，造成数据库压力剧增。</li><li><font color="red">且这些查询数据库的 Key 都不会被缓存，因为数据库中没有，不会写入缓存 </font>。那么这些 Key 对应的 Null 值也不会被缓存，造成每次请求都查不到缓存，直接查询数据库。</li><li>这样就形成了缓存穿透情况。</li></ul><p>而且极端情况下，注册的流程可能是恶意请求访问。注册请求缓存穿透的流程图如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689686443736-10dd98ef-e609-4bcf-90a6-0e73789ca084.png" alt="img"></p><h4 id="常见解决方案及其弊端"><a class="anchor" href="#常见解决方案及其弊端">#</a> 常见解决方案及其弊端</h4><p>所以，在用户注册场景下，需要注意防止缓存穿透，常见的处理方式有下述这些：</p><ol><li><p><font color="cornflowerblue">缓存不存在的 Key </font>，value 设为 Null，并设置短暂过期时间（如 60 秒）。</p><blockquote><p>弊端：</p><ul><li>假设用户 A 注册 username 为 magestack，查询 DB 不存在，返回请求成功，并放入 Redis 缓存。<font color="red">但是用户 A 并没有使用该值作为 username </font>。（如何理解？）</li><li>如果有另一个用户 B 注册 username 为 magestack，将返回失败。也就是说每尝试一次不存在的用户名，该值 60 秒内都不可被注册。</li></ul><p>结论：<font color="red">对用户使用体验不友好 </font>。此外，如果有大量并发请求查询不存在的用户名，可能会导致 <font color="red">数据库短时间内被打挂 </font>。</p></blockquote></li><li><p><font color="cornflowerblue">在缓存之前，使用<strong>布隆过滤器</strong> </font>，<font color="red">其工作特点是 —— 当它判断某个元素存在，小概率会误判；当它判断某个元素不存在，那么这个元素一定不在 </font>。因此可以将所有已注册的用户名存入布隆过滤器，<font color="red">判断时先判断该用户名是否在布隆过滤器中，不存在则直接返回用户名不存在 </font>，避免直接查询数据库。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/redis-cache-penetration-bloom-filter.png" alt="加入布隆过滤器之后的缓存处理流程图"></p><center>加入布隆过滤器之后的缓存处理流程图</center><blockquote><p>弊端：</p><ul><li>这种解决方案算是网上八股说的比较多的一个版本。但是依然不能解决实际场景问题。</li><li><font color="red">如果用户注销了账号，该用户名就可以再次被使用。然而，<strong>布隆过滤器由于无法删除元素</strong>，因此无法处理这种情况。</font></li></ul><p>结论：布隆过滤器不能删除元素的限制，导致该方案无法正式使用生产。</p><p>解决方法：<a href="#%E6%A2%B3%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%85%B3%E7%B3%BB">新增一张表 t_user_reuse ，存储已被注销的可用用户名</a></p></blockquote></li><li><p><font color="cornflowerblue">使用确定的数据结构（如 <strong>Redis 的 Set 集合</strong>）来存储已注册用户名 </font>，判断时检查是否在集合内。</p><blockquote><p>弊端：</p><ul><li><p>永久存储十几亿的用户信息到 Redis 缓存中显然不太现实，因为这会 <font color="red">占用大量的内存资源 </font>。</p></li><li><p>即使是临时存储，如果在缓存中查询不到数据，<font color="red">仍然无法避免查询数据库的场景 </font>。</p></li><li><p>此外，<font color="red">对于这么多的用户信息，是否应该将其存储在一个 Key 中呢？显然是不可行的 </font>。即使进行分片，也会增加系统的复杂度。</p><blockquote><p>我们常说的 Redis 数据结构，其实都是针对 value 的数据类型而言的，因为 Redis 本身仅仅是一个存储 key-value 键值对数据的内存数据库，因此 key 一般为 String 。所以这里才说 “将那么多用户信息存储在一个 key 中是不可行的”，相当于一个 key 对应的 value 中存储了所有用户信息。</p></blockquote></li></ul><p>结论：由于该方案 <font color="red">占用内存较多且复杂度较高 </font>，因此不适合实际应用。</p></blockquote></li><li><p>针对高并发注册场景，可以先查询缓存，<font color="cornflowerblue">如果缓存不命中，则使用<strong>分布式锁</strong>来保证只有一个线程访问数据库 </font>，避免重复查询。</p><blockquote><p>弊端：</p><ul><li>相对于上述解决方案，该方案在一定程度上可以解决会员注册缓存穿透的问题。</li><li>但是，如果在用户注册高峰期，只有一个线程访问数据库，这 <font color="red">可能会导致大量用户的注册请求缓慢或超时 </font>。</li></ul><p>结论：<font color="red">这对用户的使用体验来说并不友好 </font>，因此我们不建议使用该方案。</p></blockquote></li></ol><p>从真实业务场景来看，上面这些解决方案都存在弊端，不能适用于真实场景。</p><h3 id="敏感信息泄露"><a class="anchor" href="#敏感信息泄露">#</a> 敏感信息泄露</h3><p>在 12306 系统中，存在较多的敏感信息，比如会员或者乘车人的姓名、手机号、邮箱、证件号码以及住址。</p><p>在数据库中将手机号或身份证号等敏感个人信息存明文会带来以下安全问题：</p><ul><li><font color="red">明文存储可能会直接泄露用户隐私 </font>，一旦数据库被攻击或数据泄露，个人敏感信息就会被完全暴露。</li><li><font color="red">明文存储提高了内部人员滥用数据的风险 </font>，恶意查询和使用个人敏感信息的成本很低。</li></ul><p>为此，如何选择<strong>将用户信息加密存储</strong>，以及<strong>如何平滑过度转换现有业务中的明文数据为密文</strong>，就是个需要考虑的问题。</p><h2 id="小结"><a class="anchor" href="#小结">#</a> 小结</h2><p>本文通过对 12306 铁路购票系统的业务进行分析，提出了几个关键的业务难点：</p><ol><li>如何确定用户注册信息的真实性，可能需要调用第三方实名认证服务。</li><li>面对亿级用户量，需要使用分库分表技术来支撑海量数据。</li><li>支持多种登录方式会造成读请求扩散，需要解决用户定位问题。</li><li>高并发场景下缓存穿透问题需要有效解决，避免数据库压力过大。</li><li>明文存储用户敏感信息会造成安全隐患，需要对关键数据加密。</li></ol><p>这些问题在大型业务系统中普遍存在，需要系统性地考虑技术选型和方案设计，才能构建一个高性能、安全的系统。</p><h1 id="中间件学习"><a class="anchor" href="#中间件学习">#</a> 中间件学习</h1><ul><li>RocketMQ（消息队列）：<span class="exturl" data-url="aHR0cHM6Ly9uYWdlb2ZmZXIuY29tL3JvY2tldG1xL3JlYWRtZS8=">从零到一学习 RocketMQ | 拿个 offer - 开源 &amp; 项目实战 (nageoffer.com)</span></li><li>ShardingSphere-JDBC（分库分表）：<span class="exturl" data-url="aHR0cHM6Ly9uYWdlb2ZmZXIuY29tL3NoYXJkaW5nc3BoZXJlLWpkYmMvcmVhZG1lLw==">从零到一学习 Sharding-JDBC | 拿个 offer - 开源 &amp; 项目实战 (nageoffer.com)</span></li><li>ShardingSphere-Proxy</li><li>Canal</li><li>Redisson</li><li>Sentinel</li><li>Hippo4j</li></ul><h1 id="核心技术文档"><a class="anchor" href="#核心技术文档">#</a> 核心技术文档</h1><h2 id="雪花算法生成分布式-id"><a class="anchor" href="#雪花算法生成分布式-id">#</a> 雪花算法生成分布式 ID</h2><p>分布式系统中，有一些需要使用全局唯一 ID 的场景，这种时候为了防止 ID 冲突可以使用 36 位的 UUID，但是 <font color="red">UUID 有一些缺点：相对比较长，且一般无序 </font>。</p><p>有些时候我们希望能使用一种简单些的 ID，并且希望 ID 能够按照时间有序生成。</p><h3 id="雪花算法snowflake"><a class="anchor" href="#雪花算法snowflake">#</a> 雪花算法（Snowflake）</h3><h4 id="特点"><a class="anchor" href="#特点">#</a> 特点</h4><p>Snowflake 是 Twitter 开源的<strong>分布式 ID 生成算法</strong>，生成后是 <font color="red">一个 64 bit 的 long 型的数值，组成部分引入了时间戳，基本保持了自增 </font>。</p><p>优点：</p><ol><li>高性能高可用：生成时不依赖于数据库，<font color="red">完全在内存中生成 </font>。</li><li><font color="red">高吞吐 </font>：每秒钟能生成数百万的自增 ID。</li><li><strong><font color="red">ID 自增 </font></strong>：存入数据库中，索引效率高。</li></ol><p>缺点：</p><p><strong><font color="red">依赖于系统时间的一致性 </font></strong>，如果系统时间被回调或者改变，可能会造成 ID 冲突或者重复。</p><h4 id="组成"><a class="anchor" href="#组成">#</a> 组成</h4><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317202116465.png" alt="image-20240317202116465"></p><p>雪花分布式 ID 包括 4 个组成部分：</p><ul><li><p><font color="cornflowerblue">不使用 </font>：默认 1bit，最高位是符号位，0 表示正，1 表示负，<font color="red">固定为 0</font></p></li><li><p><font color="cornflowerblue">时间戳 </font>：默认 41bit，<font color="red">毫秒级 </font>的时间戳（41 位的长度可以使用 <font color="red">69 年 </font>）</p></li><li><p><font color="cornflowerblue">标识位 </font>：默认 10bit，其中 <font color="red">5bit 数据中心 ID，5bit 工作机器 ID </font>，两个标识位组合起来最多可以支持部署 <font color="red">1024（2<sup>10</sup>）个节点</font></p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317202644805.png" alt="image-20240317202644805" style="zoom:80%"></li><li><p><font color="cornflowerblue">序列号 </font>：默认 12bit，<font color="red"><strong>递增</strong>序列号 </font>，表示 <font color="red">节点在 1 毫秒内生成重复 </font>，通过序列号表示唯一，<strong><font color="red">每毫秒可产生 4096（2<sup>12</sup>）个不重复 ID </font></strong>，每秒就是 409.6w 个。</p></li></ul><p>默认的雪花算法是 64 bit，<strong>具体的长度可以自行配置</strong>：</p><ul><li>如果希望运行更久，增加时间戳的位数</li><li>如果需要支持更多节点部署，增加标识位长度</li><li>如果并发很高，增加序列号位数</li></ul><p>总结：雪花算法并不是一成不变的，可以根据系统内具体场景进行定制。</p><h4 id="适用场景"><a class="anchor" href="#适用场景">#</a> 适用场景</h4><p>因为雪花算法生成的 ID 是有序自增的，保障了 MySQL 中 B+ Tree 索引结构的插入高性能。</p><p>所以，日常业务使用中，雪花算法更多是被应用在 <font color="red">数据库的主键 ID 和业务关联主键 </font>。</p><h3 id="生成-id-重复问题"><a class="anchor" href="#生成-id-重复问题">#</a> 生成 ID 重复问题</h3><p>假设：一个订单微服务，通过雪花算法生成 ID，共部署三个节点，标识位一致。</p><p>此时有 200 并发，均匀散布三个节点，<font color="red">三个节点同一毫秒同一序列号下生成 ID，那么就会产生 重复 ID </font>。</p><p>通过上述假设场景，可以知道雪花算法生成 ID 冲突存在一定的 <font color="red">前提条件 </font>：</p><ol><li>服务通过集群的方式部署，其中部分机器标识位一致。</li><li>业务存在一定的并发量，没有并发量无法触发重复问题。</li><li>生成 ID 的时机：同一毫秒下的序列号一致。</li></ol><h4 id="标识位如何定义"><a class="anchor" href="#标识位如何定义">#</a> 标识位如何定义</h4><p>如果能 <font color="red">保证标识位不重复 </font>，那么雪花 ID 也不会重复。通过上面的案例，知道了 ID 重复的必要条件。如果要避免服务内产生重复的 ID，那么就需要从标识位上动文章。</p><p>我们先看看开源框架中使用雪花算法，如何定义标识位。</p><ul><li>Mybatis-Plus v3.4.2 雪花算法实现类 <code>Sequence</code> ，提供了两种构造方法：<ul><li>无参构造，自动生成 dataCenterId 和 workerId</li><li>有参构造，创建 Sequence 时明确指定标识位</li></ul></li><li>Hutool v5.7.9 参照了 Mybatis-Plus dataCenterId 和 workerId 生成方案，提供了默认实现</li></ul><p>下面一起看下 Sequence 的默认无参构造中是如何生成 dataCenterId 和 workerId 的：</p><p>1）dataCenterId：</p><p>入参 <code>maxDatacenterId</code> 是一个固定值，代表数据中心 ID 最大值，<font color="red">默认值 31 </font>。因为 5bit 的二进制最大是 11111，对应十进制数值 31。</p><p>获取 dataCenterId 时存在两种情况：</p><ul><li>网络接口为空，默认取 1L</li><li>网络接口不为空，<font color="red">通过 Mac 地址获取 dataCenterId </font>。看来 dataCenterId 的取值与 Mac 地址有关。</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getDataCenterId</span><span class="token punctuation">(</span><span class="token keyword">long</span> maxDatacenterId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mac <span class="token operator">=</span> <span class="token class-name">NetUtil</span><span class="token punctuation">.</span><span class="token function">getLocalHardwareAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> mac<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x000000FF</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> mac<span class="token punctuation">[</span>mac<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>              <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x0000FF00</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> mac<span class="token punctuation">[</span>mac<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        id <span class="token operator">=</span> id <span class="token operator">%</span> <span class="token punctuation">(</span>maxDatacenterId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）wokerId：</p><p>入参 datacenterId 取自上述的 getDatacenterId 方法；</p><p>入参 <code>maxWorkderId</code> 也是一个固定值，代表工作机器 ID 最大值，<font color="red">默认值 31 </font>；</p><p>name 变量值为 PID@IP ，所以 name 需要根据 @ 分割并获取下标 0，得到 PID。 通过 <font color="red">MAC + PID </font>的 hashcode 获取 16 个低位，进行运算，最终得到 workerId。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getWorkerId</span><span class="token punctuation">(</span><span class="token keyword">long</span> datacenterId<span class="token punctuation">,</span> <span class="token keyword">long</span> maxWorkerId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">final</span> <span class="token class-name">StringBuilder</span> mpid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    mpid<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>datacenterId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        mpid<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">RuntimeUtil</span><span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UtilException</span> igonre<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">//ignore</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>mpid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>maxWorkerId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="分配标识位"><a class="anchor" href="#分配标识位">#</a> 分配标识位</h4><p>Mybatis-Plus 标识位的获取依赖于 Mac 地址和进程 PID，虽然能做到尽量不重复，但仍有小几率。</p><p>标识位如何定义才能不重复？有两种方案：<strong>预分配</strong>和<strong>动态分配</strong>。</p><h5 id="预分配"><a class="anchor" href="#预分配">#</a> 预分配</h5><p>应用上线前，统计当前服务的节点数，<font color="red">人工去申请标识位 </font>。</p><p>这种方案，没有代码开发量，在服务节点固定或者项目少可以使用，但是 <font color="red">解决不了服务节点动态扩容性问题 </font>。</p><h5 id="动态分配"><a class="anchor" href="#动态分配">#</a> 动态分配</h5><p><font color="red">将标识位存放在 Redis、Zookeeper、MySQL 等中间件，以 Redis 举例，在服务启动的时候去请求标识位 </font>，请求后标识位更新为下一个可用的。</p><p>通过存放标识位，延伸出一个问题：雪花算法的 ID <strong><font color="red">是服务内唯一还是全局唯一？</font></strong></p><ul><li>如果要做服务内唯一，存放标识位的 Redis 节点使用自己项目内的就可以</li><li>如果是全局唯一，所有使用雪花算法的应用，要用同一个 Redis 节点</li></ul><p>两者的区别仅是不同的服务间是否公用 Redis。<font color="red">如果没有全局唯一的需求，最好使 ID 服务内唯一，因为这样可以避免单点问题 </font>。</p><p>服务的节点数超过 1024，则需要做额外的扩展；可以扩展 10 bit 标识位，或者选择开源分布 式 ID 框架。</p><hr><p>具体的动态分配实现方案如下：</p><p>Redis 存储 <font color="red">一个 Hash 结构，包含两个键值对 </font>，key 分别为：dataCenterId 和 workerId。</p><p>在应用启动时，<font color="red">通过 Lua 脚本去 Redis 获取标识位 </font>。dataCenterId 和 workerId 的获取与自增在 Lua 脚本中完成，调用返回后就是可用的标示位。</p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317213524648.png" alt="image-20240317213524648" style="zoom:80%"><p>具体 Lua 脚本逻辑如下：</p><ol><li>第一个服务节点在获取时，Redis 可能是没有 snowflake_work_id_key 这个 Hash 的，应该 <font color="red">先判断 Hash 是否存在 </font>，不存在则初始化 Hash，并将 dataCenterId、workerId 的 value 初始化为 0，返回</li><li>如果 Hash 已存在，<font color="red">判断 dataCenterId、workerId 是否等于最大值 31 </font>，是则初始化 dataCenterId、workerId 设置为 0，返回</li><li>dataCenterId 和 workerId 的排列组合一共是 1024（2<sup>10</sup>），在进行分配时，<font color="red">先分配 workerId</font></li><li><font color="red">判断 workerId 是否！= 31 </font>，是则对 workerId 自增，并返回</li><li><font color="red">如果 workerId = 31 </font>， 自增 dataCenterId 并将 workerId 设置为 0。</li></ol><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317213733061.png" alt="image-20240317213733061"></p><p>dataCenterId、workerId 是一直向下推进的，总体形成一个环状。<strong>通过 Lua 脚本的原子性，保证 1024 节点下的雪花算法生成不重复</strong>。如果标识位等于 1024，则从头开始继续循环推进，标识位取值的示意图如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317214456700.png" alt="image-20240317214456700"></p><h3 id="开源分布式-id-框架"><a class="anchor" href="#开源分布式-id-框架">#</a> 开源分布式 ID 框架</h3><p>美团和百度都有实现雪花算法：</p><ul><li>美团 Leaf：额外提供了 <font color="red">号段模式 </font>生成 ID，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01laXR1YW4tRGlhbnBpbmcvTGVhZg==">https://github.com/Meituan-Dianping/Leaf</span></li><li>百度 Uid：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JhaWR1L3VpZC1nZW5lcmF0b3I=">https://github.com/baidu/uid-generator</span></li></ul><p>雪花算法可以满足大部分场景，如无必要，<strong>不建议引入开源方案增加系统复杂度</strong>。</p><h3 id="小结-2"><a class="anchor" href="#小结-2">#</a> 小结</h3><p>文章通过图文并茂的方式帮助读者梳理了一遍什么是雪花算法，以及如何解决雪花算法生成 ID 冲突的问题。</p><p>关于雪花算法生成 ID 冲突问题，文中给了一种方案：<strong>动态分配标识位</strong>；<font color="red">通过分配雪花算法的组成之一（标识位）来达到默认 1024 节点下 ID 生成唯一 </font>。可以去看 Hutool 或者 Mybatis-Plus 雪花算法的具体实现，帮助大家更好的理解。</p><p>雪花算法不是万能的，并不能适用于所有场景。<font color="red">如果 ID 要求全局唯一并且服务节点超出 1024 节点，可以扩展标识位 </font>，或者选择开源方案：LEAF、UID。</p><h2 id="如何全局拦截异常"><a class="anchor" href="#如何全局拦截异常">#</a> 如何全局拦截异常</h2><h3 id="异常是什么"><a class="anchor" href="#异常是什么">#</a> 异常是什么</h3><p>异常机制是指当程序出现错误后，程序如何处理。具体来说，异常机制提供了程序退出的安全通道。<font color="red">当出现错误后，程序执行的流程发生改变，程序的控制权转移到异常处理器 </font>。</p><p>在 Java 中，所有的异常都有一个 <font color="red">共同的祖先 <code>Throwable</code> （可抛出）</font>。Throwable 指定代码中可用异常传播机制通过 Java 应用程序传输的任何问题的共性。<font color="red">Throwable 有两个重要的子类： <code>Error</code> （错误）和  <code>Exception</code> （异常）</font>，二者都是 Java 异常处理的重要子类，各自都包含大量子类，区别是：<strong><font color="red">Exception 能被程序本身可以处理，Error 是无法处理 </font></strong>。</p><ul><li>Error（错误）：JVM 无法解决的<strong>严重问题</strong>，大多数 <font color="red">与代码编写者执行的操作无关 </font>，而是 JVM 出现的问题。例如 StackOverflowError（栈内存溢出）和 OutOfMemoryError（堆内存溢出，简称 OOM）。</li><li>Exception（异常）：其它因编程错误或偶然的外在因素导致的<strong>一般性问题</strong>，是 <font color="red">程序本身可以通过代码处理的异常 </font>。例如空指针访问、试图读取不存在的文件、网络连接中断、数组角标越界等。Exception 类有一个重要的子类 <code>RuntimeException</code> ，表示 <font color="red">运行时异常 </font>。</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1562771528807.png" alt="1562771528807"></p><h3 id="异常分类"><a class="anchor" href="#异常分类">#</a> 异常分类</h3><blockquote><p><code>framework.starter.convention.exception</code> 包</p></blockquote><p>通过上面所述，Error 属于程序无法处理的错误，我们的目标 <font color="red">更多是针对 Exception 做些文章，具体来说是<strong>根据业务异常情况，通过继承其子类 RuntimeException 来自定义（运行时）异常类型</strong>，自定义的异常只能通过 throw 抛出，而后由 try...catch (... finally ...) 处理，或者通过 throws 甩锅给调用者处理 </font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240307184954366.png" alt="image-20240307184954366"></p><h4 id="抽象异常"><a class="anchor" href="#抽象异常">#</a> 抽象异常</h4><blockquote><p><code>AbstractException</code> 类</p></blockquote><p>上图中的三类异常共同继承 <code>RuntimeException</code> ，那么肯定具备很多相似的地方，因此统一抽象一层 AbstractException。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">IErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * 抽象项目中三类异常体系（客户端异常、服务端异常以及远程服务调用异常），作为三者的基类</pre></td></tr><tr><td data-num="11"></td><td><pre> *</pre></td></tr><tr><td data-num="12"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="13"></td><td><pre> * @see ClientException</pre></td></tr><tr><td data-num="14"></td><td><pre> * @see ServiceException</pre></td></tr><tr><td data-num="15"></td><td><pre> * @see RemoteException</pre></td></tr><tr><td data-num="16"></td><td><pre> */</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token annotation punctuation">@Getter</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 继承运行时异常类</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> errorCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">AbstractException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">,</span> <span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Throwable 为异常的根类</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">?</span> message <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="客户端异常"><a class="anchor" href="#客户端异常">#</a> 客户端异常</h4><blockquote><p><code>ClientException</code> 类</p></blockquote><p>客户端相关异常，比如：<font color="red">参数校验失败异常、幂等异常 </font>......</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">BaseErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">IErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre> * 客户端异常</pre></td></tr><tr><td data-num="8"></td><td><pre> *</pre></td></tr><tr><td data-num="9"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientException</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">CLIENT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">,</span> <span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> throwable<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"ClientException&#123;"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token string">"code='"</span> <span class="token operator">+</span> errorCode <span class="token operator">+</span> <span class="token string">"',"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token string">"message='"</span> <span class="token operator">+</span> errorMessage <span class="token operator">+</span> <span class="token string">"'"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token char">'&#125;'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="服务端异常"><a class="anchor" href="#服务端异常">#</a> 服务端异常</h4><blockquote><p><code>ServiceException</code> 类</p></blockquote><p>服务端相关异常，比如：<font color="red">消息模版不合规、消息内容包含关键字 </font>......</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">BaseErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">IErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre> * 服务端异常</pre></td></tr><tr><td data-num="10"></td><td><pre> *</pre></td></tr><tr><td data-num="11"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceException</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">,</span> <span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"ServiceException&#123;"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token string">"code='"</span> <span class="token operator">+</span> errorCode <span class="token operator">+</span> <span class="token string">"',"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token string">"message='"</span> <span class="token operator">+</span> errorMessage <span class="token operator">+</span> <span class="token string">"'"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token char">'&#125;'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="远程调用异常"><a class="anchor" href="#远程调用异常">#</a> 远程调用异常</h4><blockquote><p><code>RemoteException</code> 类</p></blockquote><p>服务调用远端异常，比如：<font color="red">短信调用三方服务发送失败、调用 MQ 失败、调用 Redis 失败 </font>等......</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">BaseErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">IErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre> * 远程服务调用异常</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="8"></td><td><pre> */</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RemoteException</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">REMOTE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">,</span> <span class="token class-name">IErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> throwable<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"RemoteException&#123;"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token string">"code='"</span> <span class="token operator">+</span> errorCode <span class="token operator">+</span> <span class="token string">"',"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token string">"message='"</span> <span class="token operator">+</span> errorMessage <span class="token operator">+</span> <span class="token string">"'"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token char">'&#125;'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="异常码定义"><a class="anchor" href="#异常码定义">#</a> 异常码定义</h3><blockquote><p><code>framework.starter.convention.errorcode</code> 包</p></blockquote><p>这里按照 <code>《Java开发手册（嵩山版）》</code> 中给出的异常码规定方式，确定一版以观后效。我们先看看阿里巴巴开发手册如何规定异常码。</p><p><strong><font color="red">【强制】错误码为字符串类型，共 5 位，分成两个部分：错误产生来源 + 四位数字编号 </font></strong>。</p><p><font color="red">【强制】全部正常，但不得不填充错误码时返回五个零：00000 </font>。</p><blockquote><p>错误产生来源分为 <strong>A / B / C</strong>。</p><ul><li>A 表示错误来源于用户，比如参数错误，用户安装版本过低，用户支付超时等问题。</li><li>B 表示错误来源于当前系统，往往是业务逻辑出错，或程序健壮性差等问题。</li><li>C 表示错误来源于第三方服务，比如 CDN 服务出错，消息投递超时等问题。</li></ul><p>四位数字编号从 0001 到 9999，大类之间的步长间距预留 100，参考文末附表 3。</p></blockquote><h4 id="如何定义异常码"><a class="anchor" href="#如何定义异常码">#</a> 如何定义异常码</h4><p><font color="red">【强制】编号不与公司业务架构挂钩，更不与组织架构挂钩，以 <u>先到先得 </u>的原则在统一平台上（需要开发）进行，审批生效，编号即被 <u>永久固定 </u></font>。</p><p><font color="red">【强制】错误码使用者 <u>避免随意定义 </u>新的错误码 </font>。</p><blockquote><p>尽可能在原有错误码附表中找到语义相同或者相近的错误码在代码中使用即可。</p></blockquote><h4 id="异常码示例"><a class="anchor" href="#异常码示例">#</a> 异常码示例</h4><table><thead><tr><th>异常码</th><th>含义</th><th>备注</th></tr></thead><tbody><tr><td>0</td><td>一切 ok</td><td>正确执行后的返回</td></tr><tr><td>A0001</td><td>用户端错误</td><td>一级宏观错误码</td></tr><tr><td>A0100</td><td>用户注册错误</td><td>二级宏观错误码</td></tr><tr><td>A0101</td><td>用户未同意隐私协议</td><td></td></tr><tr><td>A0102</td><td>注册国家或地区受限</td><td></td></tr><tr><td>A0110</td><td>用户名校验失败</td><td></td></tr><tr><td>A0111</td><td>用户名已存在</td><td></td></tr><tr><td>A0112</td><td>用户名包含敏感词</td><td></td></tr><tr><td>A0113</td><td>用户名包含特殊字符</td><td></td></tr><tr><td>A0120</td><td>密码校验失败</td><td></td></tr><tr><td>A0121</td><td>密码长度不够</td><td></td></tr><tr><td>A0122</td><td>密码强度不够</td><td></td></tr><tr><td>A0130</td><td>校验码输入错误</td><td></td></tr><tr><td>A0131</td><td>短信校验码输入错误</td><td></td></tr><tr><td>A0132</td><td>邮件校验码输入错误</td><td></td></tr><tr><td>A0133</td><td>语音校验码输入错误</td><td></td></tr><tr><td>A0140</td><td>用户证件异常</td><td></td></tr><tr><td>A0141</td><td>用户证件类型未选择</td><td></td></tr><tr><td>A0142</td><td>大陆身份证编号校验非法</td><td></td></tr><tr><td>A0143</td><td>护照编号校验非法</td><td></td></tr><tr><td>A0144</td><td>军官证编号校验非法</td><td></td></tr><tr><td>A0150</td><td>用户基本信息校验失败</td><td></td></tr><tr><td>A0151</td><td>手机格式校验失败</td><td></td></tr><tr><td>A0152</td><td>地址格式校验失败</td><td></td></tr><tr><td>A0153</td><td>邮箱格式校验失败</td><td></td></tr><tr><td>A0200</td><td>用户登录异常</td><td>二级宏观错误码</td></tr><tr><td>A0201</td><td>用户账户不存在</td><td></td></tr><tr><td>A0202</td><td>用户账户被冻结</td><td></td></tr><tr><td>A0203</td><td>用户账户已作废</td><td></td></tr><tr><td>A0210</td><td>用户密码错误</td><td></td></tr><tr><td>A0211</td><td>用户输入密码错误次数超限</td><td></td></tr><tr><td>A0220</td><td>用户身份校验失败</td><td></td></tr><tr><td>A0221</td><td>用户指纹识别失败</td><td></td></tr><tr><td>A0222</td><td>用户面容识别失败</td><td></td></tr><tr><td>A0223</td><td>用户未获得第三方登录授权</td><td></td></tr><tr><td>A0230</td><td>用户登录已过期</td><td></td></tr><tr><td>A0240</td><td>用户验证码错误</td><td></td></tr><tr><td>A0241</td><td>用户验证码尝试次数超限</td><td></td></tr><tr><td>A0300</td><td>访问权限异常</td><td>二级宏观错误码</td></tr><tr><td>A0301</td><td>访问未授权</td><td></td></tr><tr><td>A0302</td><td>正在授权中</td><td></td></tr><tr><td>A0303</td><td>用户授权申请被拒绝</td><td></td></tr><tr><td>A0310</td><td>因访问对象隐私设置被拦截</td><td></td></tr><tr><td>A0311</td><td>授权已过期</td><td></td></tr><tr><td>A0312</td><td>无权限使用 API</td><td></td></tr><tr><td>A0320</td><td>用户访问被拦截</td><td></td></tr><tr><td>A0321</td><td>黑名单用户</td><td></td></tr><tr><td>A0322</td><td>账号被冻结</td><td></td></tr><tr><td>A0323</td><td>非法 IP 地址</td><td></td></tr><tr><td>A0324</td><td>网关访问受限</td><td></td></tr><tr><td>A0325</td><td>地域黑名单</td><td></td></tr><tr><td>A0330</td><td>服务已欠费</td><td></td></tr><tr><td>A0340</td><td>用户签名异常</td><td></td></tr><tr><td>A0341</td><td>RSA 签名错误</td><td></td></tr><tr><td>A0400</td><td>用户请求参数错误</td><td>二级宏观错误码</td></tr><tr><td>A0401</td><td>包含非法恶意跳转链接</td><td></td></tr><tr><td>A0402</td><td>无效的用户输入</td><td></td></tr><tr><td>A0410</td><td>请求必填参数为空</td><td></td></tr><tr><td>A0411</td><td>用户订单号为空</td><td></td></tr><tr><td>A0412</td><td>订购数量为空</td><td></td></tr><tr><td>A0413</td><td>缺少时间戳参数</td><td></td></tr><tr><td>A0414</td><td>非法的时间戳参数</td><td></td></tr><tr><td>A0420</td><td>请求参数值超出允许的范围</td><td></td></tr><tr><td>A0421</td><td>参数格式不匹配</td><td></td></tr><tr><td>A0422</td><td>地址不在服务范围</td><td></td></tr><tr><td>A0423</td><td>时间不在服务范围</td><td></td></tr><tr><td>A0424</td><td>金额超出限制</td><td></td></tr><tr><td>A0425</td><td>数量超出限制</td><td></td></tr><tr><td>A0426</td><td>请求批量处理总个数超出限制</td><td></td></tr><tr><td>A0427</td><td>请求 JSON 解析失败</td><td></td></tr><tr><td>A0430</td><td>用户输入内容非法</td><td></td></tr><tr><td>A0431</td><td>包含违禁敏感词</td><td></td></tr><tr><td>A0432</td><td>图片包含违禁信息</td><td></td></tr><tr><td>A0433</td><td>文件侵犯版权</td><td></td></tr><tr><td>A0440</td><td>用户操作异常</td><td></td></tr><tr><td>A0441</td><td>用户支付超时</td><td></td></tr><tr><td>A0442</td><td>确认订单超时</td><td></td></tr><tr><td>A0443</td><td>订单已关闭</td><td></td></tr><tr><td>A0500</td><td>用户请求服务异常</td><td>二级宏观错误码</td></tr><tr><td>A0501</td><td>请求次数超出限制</td><td></td></tr><tr><td>A0502</td><td>请求并发数超出限制</td><td></td></tr><tr><td>A0503</td><td>用户操作请等待</td><td></td></tr><tr><td>A0504</td><td>WebSocket 连接异常</td><td></td></tr><tr><td>A0505</td><td>WebSocket 连接断开</td><td></td></tr><tr><td>A0506</td><td>用户重复请求</td><td></td></tr><tr><td>A0600</td><td>用户资源异常</td><td>二级宏观错误码</td></tr><tr><td>A0601</td><td>账户余额不足</td><td></td></tr><tr><td>A0602</td><td>用户磁盘空间不足</td><td></td></tr><tr><td>A0603</td><td>用户内存空间不足</td><td></td></tr><tr><td>A0604</td><td>用户 OSS 容量不足</td><td></td></tr><tr><td>A0605</td><td>用户配额已用光</td><td>蚂蚁森林浇水数或每天抽奖数</td></tr><tr><td>A0700</td><td>用户上传文件异常</td><td>二级宏观错误码</td></tr><tr><td>A0701</td><td>用户上传文件类型不匹配</td><td></td></tr><tr><td>A0702</td><td>用户上传文件太大</td><td></td></tr><tr><td>A0703</td><td>用户上传图片太大</td><td></td></tr><tr><td>A0704</td><td>用户上传视频太大</td><td></td></tr><tr><td>A0705</td><td>用户上传压缩文件太大</td><td></td></tr><tr><td>A0800</td><td>用户当前版本异常</td><td>二级宏观错误码</td></tr><tr><td>A0801</td><td>用户安装版本与系统不匹配</td><td></td></tr><tr><td>A0802</td><td>用户安装版本过低</td><td></td></tr><tr><td>A0803</td><td>用户安装版本过高</td><td></td></tr><tr><td>A0804</td><td>用户安装版本已过期</td><td></td></tr><tr><td>A0805</td><td>用户 API 请求版本不匹配</td><td></td></tr><tr><td>A0806</td><td>用户 API 请求版本过高</td><td></td></tr><tr><td>A0807</td><td>用户 API 请求版本过低</td><td></td></tr><tr><td>A0900</td><td>用户隐私未授权</td><td>二级宏观错误码</td></tr><tr><td>A0901</td><td>用户隐私未签署</td><td></td></tr><tr><td>A0902</td><td>用户摄像头未授权</td><td></td></tr><tr><td>A0903</td><td>用户相机未授权</td><td></td></tr><tr><td>A0904</td><td>用户图片库未授权</td><td></td></tr><tr><td>A0905</td><td>用户文件未授权</td><td></td></tr><tr><td>A0906</td><td>用户位置信息未授权</td><td></td></tr><tr><td>A0907</td><td>用户通讯录未授权</td><td></td></tr><tr><td>A1000</td><td>用户设备异常</td><td>二级宏观错误码</td></tr><tr><td>A1001</td><td>用户相机异常</td><td></td></tr><tr><td>A1002</td><td>用户麦克风异常</td><td></td></tr><tr><td>A1003</td><td>用户听筒异常</td><td></td></tr><tr><td>A1004</td><td>用户扬声器异常</td><td></td></tr><tr><td>A1005</td><td>用户 GPS 定位异常</td><td></td></tr><tr><td>B0001</td><td>系统执行出错</td><td>一级宏观错误码</td></tr><tr><td>B0100</td><td>系统执行超时</td><td>二级宏观错误码</td></tr><tr><td>B0101</td><td>系统订单处理超时</td><td></td></tr><tr><td>B0200</td><td>系统容灾功能被触发</td><td>二级宏观错误码</td></tr><tr><td>B0210</td><td>系统限流</td><td></td></tr><tr><td>B0220</td><td>系统功能降级</td><td></td></tr><tr><td>B0300</td><td>系统资源异常</td><td>二级宏观错误码</td></tr><tr><td>B0310</td><td>系统资源耗尽</td><td></td></tr><tr><td>B0311</td><td>系统磁盘空间耗尽</td><td></td></tr><tr><td>B0312</td><td>系统内存耗尽</td><td></td></tr><tr><td>B0313</td><td>文件句柄耗尽</td><td></td></tr><tr><td>B0314</td><td>系统连接池耗尽</td><td></td></tr><tr><td>B0315</td><td>系统线程池耗尽</td><td></td></tr><tr><td>B0320</td><td>系统资源访问异常</td><td></td></tr><tr><td>B0321</td><td>系统读取磁盘文件失败</td><td></td></tr><tr><td>C0001</td><td>调用第三方服务出错</td><td>一级宏观错误码</td></tr><tr><td>C0100</td><td>中间件服务出错</td><td>二级宏观错误码</td></tr><tr><td>C0110</td><td>RPC 服务出错</td><td></td></tr><tr><td>C0111</td><td>RPC 服务未找到</td><td></td></tr><tr><td>C0112</td><td>RPC 服务未注册</td><td></td></tr><tr><td>C0113</td><td>接口不存在</td><td></td></tr><tr><td>C0120</td><td>消息服务出错</td><td></td></tr><tr><td>C0121</td><td>消息投递出错</td><td></td></tr><tr><td>C0122</td><td>消息消费出错</td><td></td></tr><tr><td>C0123</td><td>消息订阅出错</td><td></td></tr><tr><td>C0124</td><td>消息分组未查到</td><td></td></tr><tr><td>C0130</td><td>缓存服务出错</td><td></td></tr><tr><td>C0131</td><td>key 长度超过限制</td><td></td></tr><tr><td>C0132</td><td>value 长度超过限制</td><td></td></tr><tr><td>C0133</td><td>存储容量已满</td><td></td></tr><tr><td>C0134</td><td>不支持的数据格式</td><td></td></tr><tr><td>C0140</td><td>配置服务出错</td><td></td></tr><tr><td>C0150</td><td>网络资源服务出错</td><td></td></tr><tr><td>C0151</td><td>VPN 服务出错</td><td></td></tr><tr><td>C0152</td><td>CDN 服务出错</td><td></td></tr><tr><td>C0153</td><td>域名解析服务出错</td><td></td></tr><tr><td>C0154</td><td>网关服务出错</td><td></td></tr><tr><td>C0200</td><td>第三方系统执行超时</td><td>二级宏观错误码</td></tr><tr><td>C0210</td><td>RPC 执行超时</td><td></td></tr><tr><td>C0220</td><td>消息投递超时</td><td></td></tr><tr><td>C0230</td><td>缓存服务超时</td><td></td></tr><tr><td>C0240</td><td>配置服务超时</td><td></td></tr><tr><td>C0250</td><td>数据库服务超时</td><td></td></tr><tr><td>C0300</td><td>数据库服务出错</td><td>二级宏观错误码</td></tr><tr><td>C0311</td><td>表不存在</td><td></td></tr><tr><td>C0312</td><td>列不存在</td><td></td></tr><tr><td>C0321</td><td>多表关联中存在多个相同名称的列</td><td></td></tr><tr><td>C0331</td><td>数据库死锁</td><td></td></tr><tr><td>C0341</td><td>主键冲突</td><td></td></tr><tr><td>C0400</td><td>第三方容灾系统被触发</td><td>二级宏观错误码</td></tr><tr><td>C0401</td><td>第三方系统限流</td><td></td></tr><tr><td>C0402</td><td>第三方功能降级</td><td></td></tr><tr><td>C0500</td><td>通知服务出错</td><td>二级宏观错误码</td></tr><tr><td>C0501</td><td>短信提醒服务失败</td><td></td></tr><tr><td>C0502</td><td>语音提醒服务失败</td><td></td></tr><tr><td>C0503</td><td>邮件提醒服务失败</td><td></td></tr></tbody></table><h4 id="异常码小结"><a class="anchor" href="#异常码小结">#</a> 异常码小结</h4><p>阿里巴巴开发手册中的 **<font color="red">核心思想：规定常用的异常码，能复用就复用，实在不行就通过异常码平台去创建，先到先得 </font>**。</p><p>这里我是认可的，不过有一点感觉不是很合适，就是异常码的位数。</p><p>阿里巴巴开发手册规定异常码位数 5 位，这对于一个公司项目很多的情况下，我觉得并不适用。所以，在刚果商城中，保留异常码基础概念，但是将 5 位扩展到 7 位。</p><p><font color="red"><u>增加异常码的位数 </u>可以有效防止因项目过多导致的异常码冲突问题 </font>。</p><h3 id="统一处理异常"><a class="anchor" href="#统一处理异常">#</a> 统一处理异常</h3><blockquote><p>全局异常处理器： <code>framework.starter.web.GlobalExceptionHandler</code> 类</p></blockquote><p>为了预防由于项目代码问题导致的异常情况出现，统一格式化后端异常错误响应数据。</p><p>SpringBoot 提供 <font color="red">全局异常拦截处理注解 <code>@RestControllerAdvice</code> ，作用是拦截所有 Controller 层抛出的异常 </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>web</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">SneakyThrows</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">BaseErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">AbstractException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>validation<span class="token punctuation">.</span></span><span class="token class-name">BindingResult</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>validation<span class="token punctuation">.</span></span><span class="token class-name">FieldError</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">MethodArgumentNotValidException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ExceptionHandler</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestControllerAdvice</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre> * 全局异常处理器</pre></td></tr><tr><td data-num="22"></td><td><pre> *</pre></td></tr><tr><td data-num="23"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="24"></td><td><pre> */</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token annotation punctuation">@Slf4j</span> <span class="token comment">// 使用 lombok 的日志注解</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token annotation punctuation">@RestControllerAdvice</span> <span class="token comment">// 使用 Spring 的全局异常处理注解，作用是拦截所有 Controller 层抛出的异常</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionHandler</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     * 拦截参数验证异常</pre></td></tr><tr><td data-num="31"></td><td><pre>     */</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token annotation punctuation">@SneakyThrows</span> <span class="token comment">// 将异常转换为运行时异常</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MethodArgumentNotValidException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// @ExceptionHandler 注解用于指定拦截的异常类型</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">validExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">MethodArgumentNotValidException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token class-name">BindingResult</span> bindingResult <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getBindingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取异常中的 BindingResult 对象，它包含了验证失败的信息</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">FieldError</span> firstFieldError <span class="token operator">=</span> <span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span>bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取第一个验证失败的信息</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">String</span> exceptionStr <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>firstFieldError<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getDefaultMessage</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取验证失败的信息，如果没有则返回空字符串</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> exceptionStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录异常日志</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">CLIENT_ERROR</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exceptionStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回验证失败的信息</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="45"></td><td><pre>     * 拦截应用内抛出的异常</pre></td></tr><tr><td data-num="46"></td><td><pre>     */</pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">AbstractException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// 拦截 AbstractException 及其子类的异常</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">abstractException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">AbstractException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果异常的根因不为空，则记录根因</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回异常信息</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="58"></td><td><pre>     * 拦截未捕获异常</pre></td></tr><tr><td data-num="59"></td><td><pre>     */</pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">Throwable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 拦截所有未捕获的异常</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">defaultErrorHandler</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; "</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 获取请求的 URL</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果请求的查询字符串为空，则返回 URL</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"?"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 否则，返回 URL 和查询字符串</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在上述全局异常拦截中，并没有拦截过多异常，仅对以下三类异常做出了拦截：</p><ul><li><code>MethodArgumentNotValidException</code> ：<font color="red">参数异常 </font>，这里需要提供合理的报错信息，所以单独拦截。正常来说，可根据项目需求，可拦截可不拦截。</li><li><code>AbstractException</code> ：上面有提到，基础组件中封装了三类异常，它们共有一个父类，这里相当于拦截了 <font color="red">三种自定义异常 </font>。</li><li><code>Throwable</code> ：<font color="red">所有异常 </font>，属于兜底方案，如果上面异常都没有拦截到，那么这里通过异常父类来做最后处理。</li></ul><p>通过这些配置，可以很好避免下述烦人的 500 页面。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240307233936374.png" alt="image-20240307233936374"></p><h2 id="抽象后端应用的全局响应对象"><a class="anchor" href="#抽象后端应用的全局响应对象">#</a> 抽象后端应用的全局响应对象</h2><p>如果接口返回的内容格式不规范，会对前端开发人员造成困扰，我们来对接口做一些优化，使用 **<font color="red">统一的响应对象 </font>** 来使每次请求后返回的结果更加规范。</p><h3 id="定义全局响应对象"><a class="anchor" href="#定义全局响应对象">#</a> 定义全局响应对象</h3><blockquote><p><code>framework.starter.convention.result</code> 包下的 <code>Result</code> 类</p></blockquote><p>以下代码中在类上使用了 lombok 的 <code>@Accessors(chain = true)</code> 注解，很容易想起之前同样在类上使用过的 lombok 中的 <code>@Builder</code> 注解，二者都与 <font color="red">链式调用 </font>相关，但是有以下区别：</p><ul><li><p><code>@Builder</code> ：Lombok 会自动生成一个 <font color="red">内部静态类 builder </font>，支持链式 **<font color="red">构建对象 </font>**，代替的是 <font color="red">构造方法 </font>，因此可以轻松地 <font color="red">初始化 </font>对象的属性。</p><p>示例如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Builder</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// Other fields...</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// 使用 @Builder 构建 Person 对象</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用内部静态类 builder ()</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"John"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li><li><p><code>@Accessors(chain = true)</code> ：用于 **<font color="red">控制访问器（getter 和 setter）的生成方式 </font>**，代替的是 <font color="red">getter、setter 方法 </font>，因此可以轻松地 <font color="red">获取 / 修改 </font>对象的属性。</p><ul><li>当 chain = true 时，表示支持 <font color="red">链式表达式 </font>，即每次调用 setter 方法后返回对象本身（this），因此可以在一条语句中 <font color="red">连续调用多个 setter 方法 </font>。</li><li>当 chain = false 时，则默认为普通的 getter 和 setter 方法。</li></ul><p>示例如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FluentPerson</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// Other fields...</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// 使用链式表达式设置属性</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">FluentPerson</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FluentPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul><p>现在再来看全局响应实体的定义：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>result</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token class-name">Accessors</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serial</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * 全局统一的返回对象</pre></td></tr><tr><td data-num="11"></td><td><pre> *</pre></td></tr><tr><td data-num="12"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// @Accessors 注解：链式调用</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 实现序列化接口，用于网络传输。泛型 T 为响应数据的类型</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@Serial</span> <span class="token comment">// @Serial 注解：序列化版本号，用于反序列化时校验</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">5679018624309023727L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * 正确返回码</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SUCCESS_CODE</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="27"></td><td><pre>     * 返回码</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="32"></td><td><pre>     * 返回消息</pre></td></tr><tr><td data-num="33"></td><td><pre>     */</pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="37"></td><td><pre>     * 响应数据</pre></td></tr><tr><td data-num="38"></td><td><pre>     */</pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="42"></td><td><pre>     * 请求 ID</pre></td></tr><tr><td data-num="43"></td><td><pre>     */</pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> requestId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">SUCCESS_CODE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>同时，为了方便 Result 的创建，通过一个 Results 工具类用来创建返回类。</p><blockquote><p><code>framework.starter.web</code> 包下的 <code>Results</code> 类</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>web</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode<span class="token punctuation">.</span></span><span class="token class-name">BaseErrorCode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">AbstractException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * 全局响应对象的构造器</pre></td></tr><tr><td data-num="11"></td><td><pre> *</pre></td></tr><tr><td data-num="12"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Results</span> <span class="token punctuation">&#123;</span> <span class="token comment">//final 类，不可被继承，因为该类中的方法都是静态方法</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 构造成功响应</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token constant">SUCCESS_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="25"></td><td><pre>     * 构造带返回数据的成功响应</pre></td></tr><tr><td data-num="26"></td><td><pre>     */</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token constant">SUCCESS_CODE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="34"></td><td><pre>     * 构建服务端失败响应</pre></td></tr><tr><td data-num="35"></td><td><pre>     */</pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="43"></td><td><pre>     * 通过 &#123;@link AbstractException&#125; 构建失败响应</pre></td></tr><tr><td data-num="44"></td><td><pre>     */</pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">AbstractException</span> abstractException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token class-name">String</span> errorCode <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>abstractException<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token class-name">String</span> errorMessage <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>abstractException<span class="token punctuation">.</span><span class="token function">getErrorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="56"></td><td><pre>     * 通过 errorCode、errorMessage 构建失败响应</pre></td></tr><tr><td data-num="57"></td><td><pre>     */</pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="好处"><a class="anchor" href="#好处">#</a> 好处</h3><p>统一返回 Result 有什么好处呢？</p><p>回答这个问题，首先我们先看下 Result 中都包含哪几个参数。</p><h4 id="返回码"><a class="anchor" href="#返回码">#</a> 返回码</h4><p><code>code</code> ，这是统一返回体的核心字段，用来标记该请求执行返回结果。</p><p>如果返回正常，大部分网站接口返回的往往是 0。另外，根据阿里的 《Java 开发手册（嵩山版）》错误码列表规定，返回 00000。这里以前者为主。</p><p>返回码不止是正确的，同样包含错误。关于错误异常码的定义可以查看<a href="#%E5%BC%82%E5%B8%B8%E7%A0%81%E5%AE%9A%E4%B9%89">这篇文章</a>。</p><h4 id="返回消息"><a class="anchor" href="#返回消息">#</a> 返回消息</h4><p><code>message</code> ，当前请求状态码描述，如果接口请求成功，为空。如果接口请求异常，这里是对应的异常错误提示信息。</p><h4 id="返回数据"><a class="anchor" href="#返回数据">#</a> 返回数据</h4><p><code>data</code> ，当前请求返回响应数据。</p><h4 id="请求id"><a class="anchor" href="#请求id">#</a> 请求 ID</h4><p><code>requestId</code> ，该 ID 也 <font color="red">可以当作链路追踪 TraceID </font>来看，用来 <font color="red">串联当前请求的上下文 </font>，以及 <font color="red">分布式链路追踪错误排查的依据 </font>。</p><p>通过统一返回体约束，可以很好与前端形成良好规范，避免多个项目 “各自为战”，不方便重构和监控。</p><h3 id="真实请求案例"><a class="anchor" href="#真实请求案例">#</a> 真实请求案例</h3><p>我们真实访问下商品服务中根据 SKU ID 获取商品详情的接口，看看它的返回体，很清晰是不是。</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"productBrand"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1477055818267025408</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"小米"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token property">"desc"</span><span class="token operator">:</span> <span class="token string">"小米是一家以手机、智能硬件和IoT平台为核心的互联网公司，以智能手机、智能电视、笔记本等丰富的产品与服务。致力于让全球每个人都能享受科技带来的美好生活"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token property">"productSpu"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1477055850256982016</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token property">"categoryId"</span><span class="token operator">:</span> <span class="token number">1477055818388660224</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token property">"brandId"</span><span class="token operator">:</span> <span class="token number">1477055818267025408</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"小米MIX Fold2 轻薄折叠 骁龙8+旗舰处理器 徕卡光学镜头 自研微水滴形态转轴 12GB+512GB 月影黑 5G手机"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token property">"productSn"</span><span class="token operator">:</span> <span class="token string">"100033890205"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token property">"photoAlbum"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">9999</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token property">"promotionPrice"</span><span class="token operator">:</span> <span class="token number">9988</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token property">"promotionStartTime"</span><span class="token operator">:</span> <span class="token string">"2022-09-14T13:02:26.000+00:00"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token property">"promotionEndTime"</span><span class="token operator">:</span> <span class="token string">"2022-09-14T13:02:26.000+00:00"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token property">"subTitle"</span><span class="token operator">:</span> <span class="token string">"轻薄折叠机,整机轻至262g,展开厚度5.4mm,骁龙8+旗舰处理器!【点击抢购小米11Ultra】"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token property">"sales"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token property">"unit"</span><span class="token operator">:</span> <span class="token string">"件"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token property">"detail"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token property">"publishStatus"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token property">"newStatus"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token property">"recommandStatus"</span><span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token property">"productSkus"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1477056250724933632</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token property">"productId"</span><span class="token operator">:</span> <span class="token number">1477055850256982016</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">9999</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token property">"stock"</span><span class="token operator">:</span> <span class="token number">99526</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token property">"lockStock"</span><span class="token operator">:</span> <span class="token number">474</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token property">"attribute"</span><span class="token operator">:</span> <span class="token string">"[&#123;\"key\":\"外观\",\"value\":\"月影黑\"&#125;,&#123;\"key\":\"版本\",\"value\":\"12GB+256GB\"&#125;]"</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1477056250741710848</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token property">"productId"</span><span class="token operator">:</span> <span class="token number">1477055850256982016</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">11999</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token property">"stock"</span><span class="token operator">:</span> <span class="token number">299</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token property">"lockStock"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token property">"attribute"</span><span class="token operator">:</span> <span class="token string">"[&#123;\"key\":\"外观\",\"value\":\"月影黑\"&#125;,&#123;\"key\":\"版本\",\"value\":\"12GB+512GB\"&#125;]"</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1477056338104868864</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token property">"productId"</span><span class="token operator">:</span> <span class="token number">1477055850256982016</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">9999</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token property">"stock"</span><span class="token operator">:</span> <span class="token number">188</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token property">"lockStock"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token property">"attribute"</span><span class="token operator">:</span> <span class="token string">"[&#123;\"key\":\"外观\",\"value\":\"星耀金\"&#125;,&#123;\"key\":\"版本\",\"value\":\"12GB+256GB\"&#125;]"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1477056338335555584</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token property">"productId"</span><span class="token operator">:</span> <span class="token number">1477055850256982016</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">11999</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token property">"stock"</span><span class="token operator">:</span> <span class="token number">299</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token property">"lockStock"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token property">"attribute"</span><span class="token operator">:</span> <span class="token string">"[&#123;\"key\":\"外观\",\"value\":\"星耀金\"&#125;,&#123;\"key\":\"版本\",\"value\":\"12GB+512GB\"&#125;]"</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token property">"requestId"</span><span class="token operator">:</span> <span class="token string">"4a2c99691f1f4d7dbc944ddbcf60108d.423.16777712688418813"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token property">"success"</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="hutool如何使用builder模式创建线程池"><a class="anchor" href="#hutool如何使用builder模式创建线程池">#</a> Hutool 如何使用 Builder 模式创建线程池</h2><h3 id="前言"><a class="anchor" href="#前言">#</a> 前言</h3><p>Builder 设计模式也叫做 <strong>构建者模式</strong>，名字只是一种叫法，当聊起三种名称的时候知道是怎么回事就行。</p><p>Builder 设计模式在作者编码过程中，<strong>属于比较常用的模式之一</strong>。优秀的设计模式总是会受到广大开发者的青睐，Hutool 也是其中之一。</p><p>因为上周编写的业务需要用到线程池，就去 Hutool thread 包下看了看，还真有惊喜，学习到了一种之前编码中没用过的 Builder 模式实现。</p><p>这里必须提一句：<strong>设计模式重要的是思想，一种设计模式可能不止一种实现方式</strong>。</p><h3 id="builder-模式应用场景"><a class="anchor" href="#builder-模式应用场景">#</a> Builder 模式应用场景</h3><p>Builder 模式作用域：<strong>如果类的属性之间有一定的依赖关系或者约束条件（源自设计模式之美）</strong>，那么就可以考虑使用 Builder 设计模式。</p><p>我们依照线程池来举例，默认创建的线程池，构造方法最多有七个参数，核心线程数、最大线程数、阻塞队列、线程存活时间...</p><p>日常使用中创建线程池时，大家想一下为什么要这么设计？一起来看下源码注释中如何解释此行为。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240308123043885.png" alt="image-20240308123043885"></p><p>线程池之所以设置如此之多的构造参数，<strong>是因为对这些参数会有一定规则的校验</strong>，如果不满足线程池的规则，将不允许创建线程池，<strong>通过抛异常的方式终止程序</strong>。</p><p>终止规则大概有七点，这里列举一下：</p><ol><li>核心线程数不可以小于 0。</li><li>线程存活时间不可以小于 0。</li><li>最大线程数不可以小于等于 0，同时也不可以小于核心线程数。</li><li>阻塞队列、线程工厂、拒绝策略参数均不可为空。</li></ol><p>上述七点有两个作用，其一是为了让核心参数满足线程池运行流程，其二是为了保障运行时的稳定性。</p><p>大家想一下线程池创建是不是非常适合 Builder 模式，<strong>构造器函数过多以及属性之间存在依赖关系和约束条件</strong>。</p><h3 id="hutool-builder-创建线程池"><a class="anchor" href="#hutool-builder-创建线程池">#</a> Hutool Builder 创建线程池</h3><p>Hutool 线程池相关使用 Builder 设计模式有两处，一个是创建线程池，另一个是创建线程工厂，我们重点围绕线程池说。</p><p>创建 Hutool 线程池比较简单且优雅，笔者较喜欢这种链式风格，所以抽象公共业务时都会使用此模式，如图所示。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240308123617012.png" alt="image-20240308123617012"></p><blockquote><p>ThreadPoolExecutor 是 ExecutorService 的一个实现类，也是 java 中最常用的线程池类。其内部维持了一个线程池，可以执行给定的任务。</p></blockquote><p>这个时候跟下源码，先从 <code>ExecutorBuilder#create</code> 入手，小伙伴就明白 Hutool 是如何玩 Builder 模式了。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorBuilder</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>What？ 自己创建自己？这是要搞啥子。大家想一下，如果你想要对一个类中属性进行约束，前提是不是先应该把属性搞到手。没错，<font color="red">ExecutorBuilder#create` 方法返回自己本身，然后通过 set 方法 <strong>把数据填充到创建出来的对象上</strong>，最后再进行依赖关系整理和条件约束 </font>。</p><p>看一下 <code>ExecutorBuilder#build</code> 方法内部做了什么事情。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240308124320551.png" alt="image-20240308124320551"></p><p>这里有个知识点，也是 B 格之一，大家看到 build 方法上有 @Override 注解，证明它是实现了接口方法。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240308124432843.png" alt="image-20240308124432843"></p><p><strong><font color="red">Hutool 定义了 Builder 接口，实现此接口即可完成 Builder 模式，泛型 T 代表需要返回的构造对象类型 </font></strong>，比如刚才线程池 Builder 泛型就是 ThreadPoolExecutor。</p><p>在实现 build 方法上调用真正管理依赖和约束的方法 build (ExecutorBuilder builder)，将刚才创建好并且已经赋过值的构建对象传入。</p><p>最后 build (ExecutorBuilder builder) 返回的就是我们所需要的线程池对象，这一块大家可以自己跟下源码，学会就可以套用自己写的业务代码。</p><h3 id="builder-模式不同的实现方式"><a class="anchor" href="#builder-模式不同的实现方式">#</a> Builder 模式不同的实现方式</h3><p>上文说过，设计模式重思想，就像 Builder 模式，强调的是 <strong>管理依赖关系或者约束条件</strong>。</p><p>刚才 Hutool Builder 只是一种实现方式，之前还用过静态内部类的实现方式。</p><p>代码经过精剪，并且为了阅读体验感，把部分缩进去除了。不过笔者测试过粘贴到 IDEA 中编译是可以的。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Getter</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpParameters</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Builder</span> builder<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Builder</span> <span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">HttpParameters</span><span class="token punctuation">(</span><span class="token class-name">Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>builder <span class="token operator">=</span> builder<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Getter</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Builder</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">String</span> httpType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">parameter</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">httpType</span><span class="token punctuation">(</span><span class="token class-name">String</span> httpType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>httpType <span class="token operator">=</span> httpType<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">HttpParameters</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"URL不允许为空 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token comment">// ...</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpParameters</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>如果后面要获取 HttpParameters 参数就需要先获取 Builder 对象。</p><p>可能有些小伙伴不习惯这种方式，也可以把 Builder 对象属性在 Parameters 里也定义一份，方式都很灵活。</p><h3 id="小结-3"><a class="anchor" href="#小结-3">#</a> 小结</h3><p>本文通过创建线程池为引，讲述了 Builder 设计模式的场景以及实际用途，并引用 Hutool Builder 模式创建线程池进行讲解。</p><p>相信大家看完之后对 Builder 模式的场景以及应用有了更深入的了解，另外我们可以将 Builder 模式引入到自己代码中，实际操练一下，相信你也会对它 &quot;爱不释手&quot;。</p><h2 id="责任链模式是什么"><a class="anchor" href="#责任链模式是什么">#</a> 责任链模式是什么？</h2><p>文章开篇，抛出一个老生常谈的问题，学习设计模式有什么作用？</p><p><strong><font color="red">设计模式主要是为了应对代码的复杂性，让其满足开闭原则，提高代码的扩展性 </font></strong>。</p><blockquote><p><strong>开闭原则</strong>是面向对象设计中的一个重要原则。它强调了软件实体（类、模块、函数等）应该 <font color="red">对扩展开放，对修改关闭 </font>。具体来说：</p><ul><li><strong>开放</strong>：指的是我们可以在不修改现有代码的情况下添加新功能或扩展现有功能。这意味着我们的设计应该允许新增功能的加入，而不会影响到已有的功能。</li><li><strong>关闭</strong>：指的是已有的代码不应该被频繁修改。一旦一个类或模块完成了它的功能，就不应该再对其进行修改，以避免引入新的错误或破坏现有功能。</li></ul><p>总之，开闭原则鼓励我们设计出易于扩展的系统，同时保持现有功能的稳定性。</p></blockquote><p>另外，学习的设计模式 <strong>一定要在业务代码中落实</strong>，只有理论没有真正实施，是无法真正掌握并且灵活运用设计模式的。</p><hr><p>这篇文章主要说 <strong>责任链设计模式</strong>，认识此模式是在读 Mybatis 源码时，Interceptor 拦截器主要使用的就是责任链，当时读过后就留下了很深的印象（内心 OS：还能这样玩）。</p><p>文章先从基础概念说起，另外分析一波 Mybatis 源码中是如何运用的，最后按照 &quot;习俗&quot;，设计一个真实业务场景上的应用。</p><h3 id="责任链模式的概念"><a class="anchor" href="#责任链模式的概念">#</a> 责任链模式的概念</h3><p>责任链设计模式是一种行为型设计模式，其主要目的是解耦请求发送者和请求接收者，让多个对象都有机会处理请求，从而避免请求发送者和接收者之间的紧耦合。</p><p>责任链模式的 <font color="red">核心是一个链式结构，链中每个节点代表一个处理者对象，请求先经过第一个节点处理，如果该节点能够处理请求，则直接返回处理结果；否则，请求继续往下一个节点传递，直到找到能够处理该请求的节点为止 </font>。整个过程类似于流水线上的多个工作站，每个工作站负责一项工作，如果自己处理不了，就将工作交给下一个工作站，直到整个工作完成。</p><p>在责任链模式中，每个处理者对象都有一个指向下一个处理者对象的引用，这样就形成了一个处理者链。请求发送者只需要将请求发送给第一个节点即可，而不用关心请求会被哪个处理者对象处理。由于每个处理者对象都有机会处理请求，因此责任链模式可以实现请求的动态分配。</p><p>责任链模式的优点：</p><ul><li>可以动态地添加、删除和调整处理者对象，从而灵活地构建处理链</li><li>避免了请求发送者和接收者之间的紧耦合，增强了系统的灵活性和可扩展性</li></ul><p>责任链模式的缺点：</p><ul><li>例如如果处理链过长或者处理时间过长，可能会对系统性能产生一定的影响。</li></ul><p>在实际应用中，责任链模式常用于 <font color="red">请求的预处理、请求的过滤、请求的分发 </font>等场景。例如，可以使用责任链模式来实现 <font color="red">权限校验、日志记录、异常处理、请求重试 </font>等功能。同时，也可以将责任链模式与其他设计模式结合起来，例如装饰器模式、工厂模式、观察者模式等，从而实现更复杂的功能。</p><p>举个例子，SpringMvc 中可以定义拦截器，并且可以定义多个。当一个用户发起请求时，顺利的话请求会经过所有拦截器，最终到达业务代码逻辑，<font color="red">SpringMvc 拦截器设计 </font>就是使用了责任链模式。</p><p>在责任链模式中，多个处理器（参照上述拦截器）依次处理同一个请求。一个请求先经过 A 处理器处理，然后再把请求传递给 B 处理器，B 处理器处理完后再传递给 C 处理器，以此类推，形成一个链条，<font color="red">链条上的每个处理器各自承担各自的处理职责 </font>。</p><p>责任链模式中多个处理器形成的处理器链在进行处理请求时，有两种处理方式：</p><ol><li><font color="red">请求会被所有的处理器都处理一遍，不存在中途终止的情况 </font>，这里参照 <font color="gree">MyBatis 拦截器 </font>理解。</li><li>处理器链执行请求中，某一处理器执行时，如果不符合自制定规则的话，<font color="red">停止流程，并且剩下未执行处理器就不会被执行 </font>，大家参照 <font color="gree">SpringMvc 拦截器 </font>理解。</li></ol><h4 id="类型一所有处理器都过一遍"><a class="anchor" href="#类型一所有处理器都过一遍">#</a> 类型一：所有处理器都过一遍</h4><p>这里通过代码的形式对两种处理方式作出解答，方便读者更好的理解。首先看下第一种，请求会经过所有处理器执行的情况：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240313213309407.png" alt="image-20240313213309407"></p><p>IHandler 接口负责抽象处理器的行为， handle () 则是不同处理器具体需要执行的方法。HandlerA、HandlerB 实现类为具体需要执行的处理器类， HandlerChain 则是将 Handler 串成一条处理器链。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChainApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">HandlerChain</span> handlerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        handlerChain<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HandlerA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HandlerB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        handlerChain<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         * 程序执行结果：</pre></td></tr><tr><td data-num="8"></td><td><pre>         * HandlerA 打印：执行 HandlerA</pre></td></tr><tr><td data-num="9"></td><td><pre>         * HandlerB 打印：执行 HandlerB</pre></td></tr><tr><td data-num="10"></td><td><pre>         */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这种责任链执行方式会将所有的 <font color="red">处理器全部执行一遍 </font>，不会被打断。Mybatis 拦截器用的正是此类型，重点在对请求过程中的数据或者行为进行改变。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416205344.png" alt="image.png"></p><h4 id="类型二某一处理器发生阻断剩余处理器不再执行"><a class="anchor" href="#类型二某一处理器发生阻断剩余处理器不再执行">#</a> 类型二：某一处理器发生阻断，剩余处理器不再执行</h4><blockquote><p>这种方式也是本 12306 项目中使用的，主要用于对请求参数数据进行校验。</p></blockquote><p>而另外一种责任链模式实现，则是 <font color="red">会对请求有阻断作用，阻断产生的前置条件是在处理器中自定义的 </font>，代码中的实现较简单，读者可以联想 SpringMvc 拦截器的实现流程。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240313214311712.png" alt="image-20240313214311712"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240313213659299.png" alt="image-20240313213659299"></p><p>根据代码看的出来，在每一个 IHandler 接口的实现类中会返回一个布尔类型的返回值，<font color="red">如果返回布尔值为 false，那么责任链发起类会中断流程，剩余处理器将不会被执行 </font>。就像我们定义在 SpringMvc 中的 Token 拦截器，如果 Token 失效就不能继续访问系统，处理器将请求打回。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChainApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">HandlerChain</span> handlerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        handlerChain<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HandlerA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HandlerB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">boolean</span> resultFlag <span class="token operator">=</span> handlerChain<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resultFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"责任链中处理器不满足条件"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>读者可以自己在 IDEA 中实现两种不同的责任链模式，对比其中的不同，设想下业务中真实的应用场景，再或者可以跑 SpringBoot 项目，创建多个拦截器来佐证文中的说辞。</p><h3 id="责任链业务场景设计"><a class="anchor" href="#责任链业务场景设计">#</a> 责任链业务场景设计</h3><p>趁热打铁，本小节对使用的真实业务场景进行举例说明。假设业务场景是这样的，我们系统处在一个下游服务，因为业务需求，系统中所使用的 <font color="red">基础数据需要从上游中台同步到系统数据库 </font>。</p><p>基础数据包含了很多类型数据，虽然数据在中台会有一定验证，但是 <font color="red">数据只要是人为录入就极可能存在问题，遵从对上游系统不信任原则，需要对数据接收时进行一系列校验 </font>。</p><p>最初是要进行一系列验证原则才能入库的，后来因为工期问题 <font color="red">只放了一套非空验证 </font>，趁着春节期间时间还算宽裕，把这套验证规则骨架放进去。</p><p>从我们系统的接入数据规则而言，个人觉得需要支持以下几套规则：</p><ol><li><strong>必填项校验</strong>，如果数据无法满足业务所必须字段要求，数据一旦落入库中就会产生一系列问题。</li><li><strong>非法字符校验</strong>，因为数据如何录入，上游系统的录入规则是什么样的我们都不清楚，这一项规则也是必须的。</li><li><strong>长度校验</strong>，理由同上，如果系统某字段长度限制 50，但是接入来的数据 500 长度，这也会造成问题。</li></ol><p>为了让读者了解业务嵌入责任链模式的前因，这里列举了三套校验规则，当然真实中可能不止这三套。但是 <font color="red">一旦将责任链模式嵌入数据同步流程，就会完全符合文初所提的开闭原则，提高代码的扩展性 </font>。本案例设计模式中的开闭原则通过 Spring 提供支持，后续添加新的校验规则就可以不必修改原有代码。</p><p>最后说一下需要达成的业务需求：<font color="red">将一个批量数据经过处理器链的处理，返回出符合要求的数据分类 </font>。</p><p>以下是伪代码实现：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240313215211431.png" alt="image-20240313215211431"></p><p>定义顶级验证接口和一系列处理器实现类没什么难度，但是应该 **<font color="red">如何进行链式调用呢？</font>** 这一块代码需要有一定 Spring 基础才能理解，一起来看下 VerifyHandlerChain 如何将所有处理器串成一条链。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240313215523652.png" alt="image-20240313215523652"></p><p>VerifyHandlerChain 处理流程如下：</p><ol><li>实现 <code>InitializingBean</code> 接口，在对应实现方法 afterPropertiesSet () 中获取 IOC 容器中类型为 VerifyHandler 的 Bean，也就是对应的处理器实现类 EmptyVerifyHandler、SexyVerifyHandler。</li><li>将 VerifyHandler 类型的 Bean 添加到处理器链容器 verifyHandlerList 中。</li><li>定义校验方法 verify ()，对入参数据展开处理器链的全部调用，如果过程中发现已无需要验证的数据，直接返回。</li></ol><p>使用 SpringBoot 项目中默认测试类，来测试一下如何调用：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ChainApplicationTests</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">VerifyHandlerChain</span> verifyHandlerChain<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> verify <span class="token operator">=</span> verifyHandlerChain<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token string">"马丁玩编程"</span><span class="token punctuation">,</span> <span class="token string">"马丁"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>verify<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这样的话，<font color="red">如果客户或者产品提出校验相关的新增需求时，我们只需要新建个实现 VerifyHandler 接口的校验规则实现类即可 </font>，这样符合了设计模式的原则：满足开闭原则，提高代码的扩展性。</p><p>熟悉之前作者写过设计模式的文章应该知道，强调设计模式重语意，而不是具体的实现过程。所以，你看这个咱们这个校验代码，把责任链两种模式结合了使用。</p><p>上面的代码只是示例代码，实际业务中的实现要比这复杂很多，比如：</p><ol><li><strong>如何定义处理器的先后调用顺序</strong>。比如说某一个处理器执行时间很长并且过滤数据很少，所以希望把它放到最后面执行。</li><li>这是为当前业务的所有数据类型进行过滤，<strong>如何自定义单个数据类型过滤</strong>。比如你接入学生数据，学号有一定校验规则，这种处理器类肯定只适合单一类型。</li></ol><p>还有很多的业务场景，所以设计模式强调的应该是一种思想，而不是固定的代码写法，需要结合业务场景灵活变通。</p><h3 id="责任链模式的好处"><a class="anchor" href="#责任链模式的好处">#</a> 责任链模式的好处</h3><p><font color="red">设计模式只是帮助减少代码的复杂性，让其满足开闭原则，提高代码的扩展性 </font>。如果不使用同样可以完成需求。</p><p>如果不使用责任链模式，上面说的真实同步场景面临两个问题：</p><ol><li>如果把上述说的代码逻辑校验规则写到一起，毫无疑问这个类或者说这个方法函数奇大无比。减少代码复杂性一贯方法是：将大块代码逻辑拆分成函数，将大类拆分成小类，是应对 代码复杂性的常用方法。如果此时说：可以把不同的校验规则拆分成不同的函数，不同的 类，这样不也可以满足减少代码复杂性的要求么。这样拆分是能解决代码复杂性，但是这样 就会面临第二个问题。</li><li>开闭原则：<font color="red">添加一个新的功能应该是，在已有代码基础上扩展代码，而非修改已有代码 </font>。大家设想一下，假设你写了三套校验规则，运行过一段时间，这时候领导让加第四套，是不是 要在原有代码上改动。</li></ol><p>综上所述，在合适的场景运用适合的设计模式，能够让代码设计复杂性降低，变得更为健壮。朝更远的说也能让自己的编码设计能力有所提高，告别被人吐槽的烂代码...</p><h3 id="电商下单场景实战"><a class="anchor" href="#电商下单场景实战">#</a> 电商下单场景实战</h3><h4 id="下单前置校验"><a class="anchor" href="#下单前置校验">#</a> 下单前置校验</h4><p>在电商系统下单接口中，前置校验是非常重要的环节。下面是一个可能的校验步骤列表：</p><ul><li>检查商品信息是否存在，包括商品名称、价格、规格等信息。</li><li>检查购买数量是否合法，是否超出了最大购买数量或最小购买数量的限制。</li><li>检查商品库存是否充足，以确保库存足够满足购买者的需求。</li><li>检查购买者的优惠券、积分等是否可以使用，以确保购买者能够享受相应的优惠或积分奖励。</li><li>检查收货地址信息是否完整和准确，以确保商品能够顺利地送达给购买者。</li><li>检查下单时间是否合法，例如检查购买者是否在限定的时间范围内下单。</li></ul><p>真实电商场景中，验证逻辑绝对不仅仅是这些，过之而无不及。</p><p>对于完成这些前置校验逻辑，大部分程序员可能的代码思路如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">CreateOrderReqDTO</span> xxx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 检查商品信息是否存在，包括商品名称、价格、规格等信息</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  	<span class="token comment">// 检查购买数量是否合法，是否超出了最大购买数量或最小购买数量的限制</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 检查商品库存是否充足，以确保库存足够满足购买者的需求</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 检查购买者的优惠券、积分等是否可以使用，以确保购买者能够享受相应的优惠或积分奖励</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 检查收货地址信息是否完整和准确，以确保商品能够顺利地送达给购买者</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 检查下单时间是否合法，例如检查购买者是否在限定的时间范围内下单</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>解决前置校验需求需要实现一堆逻辑，常常需要写上几百上千行代码。</p><p>为了避免这种代码臃肿的情况，我们可以 <font color="red">运用责任链设计模式，对下单验证逻辑进行抽象 </font>。</p><h4 id="责任链重构"><a class="anchor" href="#责任链重构">#</a> 责任链重构</h4><p><font color="red">定义一个责任链处理器接口 </font>，所有子任务都实现该接口以处理具体的业务逻辑。同时，为了方便对责任链流程中的任务进行顺序执行，我们需要 <font color="red">继承 Spring 框架中的排序接口 Ordered </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCreateChainHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Ordered</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     * 执行责任链逻辑</pre></td></tr><tr><td data-num="5"></td><td><pre>     *</pre></td></tr><tr><td data-num="6"></td><td><pre>     * @param requestParam 责任链执行入参</pre></td></tr><tr><td data-num="7"></td><td><pre>     */</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">T</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><font color="red">创建一个责任链上下文容器 </font>，用于存储与责任链相应的子任务。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreateChainContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderCreateChainHandler</span><span class="token punctuation">></span></span> orderCreateChainHandlerContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre>     * 责任链组件执行</pre></td></tr><tr><td data-num="7"></td><td><pre>     *</pre></td></tr><tr><td data-num="8"></td><td><pre>     * @param requestParam 请求参数</pre></td></tr><tr><td data-num="9"></td><td><pre>     */</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">T</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 此处根据 Ordered 实际值进行排序处理</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        orderCreateChainHandlerContainer<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token operator">::</span><span class="token function">getOrder</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>each <span class="token operator">-></span> each<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    </pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      	<span class="token comment">// 通过 Spring 上下文容器，获取所有 CreateOrderChainContext Bean</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OrderCreateChainHandler</span><span class="token punctuation">></span></span> chainFilterMap <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">OrderCreateChainHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      	<span class="token comment">// 将对应 Bean 放入责任链上下文容器中</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        chainFilterMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span> <span class="token operator">-></span> orderCreateChainHandlerContainer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><font color="red">实现 OrderCreateChainHandler 接口作为责任链处理器 </font>，每个具体的实现类负责执行特定逻辑。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 订单创建参数必填检验</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreateParamNotNullChainHandler</span> <span class="token keyword">implements</span> <span class="token class-name">OrderCreateChainHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderCreateCommand</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">OrderCreateCommand</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	    <span class="token comment">// 逻辑执行</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// 订单创建参数正确性检验</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreateParamVerificationChainHandler</span> <span class="token keyword">implements</span> <span class="token class-name">OrderCreateChainHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderCreateCommand</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    </pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">OrderCreateCommand</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	    <span class="token comment">// 逻辑执行</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    </pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">// 订单创建商品 SKU 库存验证</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreateProductSkuStockChainHandler</span> <span class="token keyword">implements</span> <span class="token class-name">OrderCreateChainHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderCreateCommand</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">OrderCreateCommand</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	    <span class="token comment">// 逻辑执行</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    </pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过责任链模式优化，<font color="red">创建订单接口前置校验代码 </font>从上千行缩减为一行。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OrderCreateChainContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderCreateCommand</span><span class="token punctuation">></span></span> orderCreateChainContext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderCreateCommand</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 责任链模式：执行订单创建参数验证</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        orderCreateChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>经过责任链模式的重构，你是否发现业务逻辑变得更加清晰易懂了？采用这种设计模式后，增加或删除相关的业务逻辑变得非常方便，不再需要担心更改上千行代码的几行代码，导致整个业务逻辑受到影响的情况。</p><h3 id="mybatis-interceptor-底层实现"><a class="anchor" href="#mybatis-interceptor-底层实现">#</a> Mybatis Interceptor 底层实现</h3><p>Mybatis 3.4.x 的 Interceptor 底层实现就是责任链模式，这里分享其具体实现。开门见山，直接把视线聚焦到 Mybatis 源码，版本号 3.4.7-SNAPSHOT。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240313220944360.png" alt="image-20240313220944360"></p><p>是不是和我们上面用到的第一类责任链模式差不太多，有处理器集合 interceptors，有添加处理器方法。</p><p>Mybatis Interceptor 不仅用到了责任链，还用到了动态代理，服务于 Mybatis 四大 &quot;护教法王&quot;，<font color="red">在创建对象时通过 <u>动态代理 </u>和 <u>责任链 </u>相结合组装而成插件模块 </font>：</p><ol><li>ParameterHandler</li><li>ResultSetHandler</li><li>StatementHandler</li><li>Executor</li></ol><p>使用过 Mybatis 的读者应该知道，查询 SQL 的分页语句就是使用 Interceptor 实现，比如市场上的 PageHelper、Mybatis-Plus 分页插件再或者我们自实现的分页插件（应该没有项目组使用显示调用多条语句组成分页吧）。</p><p>拿查询语句举例，如果定义了多个查询相关的拦截器，会先经过拦截器的代码加工，<strong>所有的拦截器执行完毕后才会走真正查询数据库操作</strong>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240313221151316.png" alt="image-20240313221151316"><br>扯的话就扯远了，能够知道如何用、在哪用就可以了。通过 Interceptor 也能知道一点，想要读框架源码，需要一定的设计模式基础。如果对责任链、动态代理不清楚，那么就不能理解这一块的精髓。</p><h2 id="如何抽象责任链模式"><a class="anchor" href="#如何抽象责任链模式">#</a> <mark>如何抽象责任链模式</mark></h2><p>可能细心的小伙伴会发现一个问题，<a href="#%E7%94%B5%E5%95%86%E4%B8%8B%E5%8D%95%E5%9C%BA%E6%99%AF%E5%AE%9E%E6%88%98">电商下单场景实战</a>中仅仅针对下单这一业务进行了责任链重构，如果业务越来越多呢？<font color="red">当业务越来越多的情况下，重复定义诸如 OrderCreateChainHandler 以及 OrderCreateChainContext 的接口 / 类会增加系统冗余代码量</font>。<strong>因此可以考虑将这两个基础接口 / 类抽象出来，作为基础组件库中的通用组件</strong> ，供所有系统下的业务使用，从而避免代码冗余。</p><h3 id="抽象责任链处理器接口"><a class="anchor" href="#抽象责任链处理器接口">#</a> 抽象责任链处理器接口</h3><blockquote><p>AbstractChainHandler</p></blockquote><p>定义 <font color="gree">抽象责任链处理器接口</font>，所有处理器组件都要实现该接口，以处理具体的业务逻辑。同时，为了方便对责任链流程中的任务进行顺序执行，需要 <font color="red">继承 Spring 框架中的排序接口 Ordered </font>。等同于 OrderCreateChainHandler 。</p><p><font color="red">mark 方法用于标识不同业务 </font>。假设项目中有两个业务场景：订单下单、用户创建，二者都需要责任链模式去验证，mark 就是用来进行分组的。<font color="red">在业务中进行调用责任链时，通过传递不同的 mark 方法参数，找到对应业务的一组责任链组件列表 </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 抽象业务责任链处理器接口，后续【具体业务的责任链处理器接口】需要继承该接口，并重写 mark 方法，返回业务对应的责任链标识。</pre></td></tr><tr><td data-num="3"></td><td><pre> * 至于 handler 方法，由【具体业务的责任链处理器实现类】来实现，此外还需要实现 getOrder 方法，返回各自的排序值，决定各自的执行顺序。</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AbstractChainHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Ordered</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 继承 Ordered 接口是为了实现责任链的排序</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 执行当前责任链组件的业务处理逻辑</pre></td></tr><tr><td data-num="9"></td><td><pre>     *</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @param requestParam 请求参数</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">T</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     * 获取责任链组件标识，后续可以根据它来获取对应业务的责任链组件列表</pre></td></tr><tr><td data-num="16"></td><td><pre>     *</pre></td></tr><tr><td data-num="17"></td><td><pre>     * @return 责任链组件标识，用于区分责任链组件，对应不同业务场景。</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="抽象责任链上下文类"><a class="anchor" href="#抽象责任链上下文类">#</a> 抽象责任链上下文类</h3><blockquote><p>AbstractChainContext</p></blockquote><p>定义 <font color="gree">抽象责任链上下文类 </font>，用于存储与责任链相应的子任务。可以看到保存责任链处理类的容器从 List 改为了 Map，这样可以方便扩展更多的不同业务责任链子类。等同于 OrderCreateChainContext。</p><p><font color="red">通过实现 CommandLineRunner 接口，在 SpringBoot 启动完成后，执行钩子函数将所有实现责任链抽象接口的实现类注册到责任链上下文中 </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 抽象责任链上下文类，负责责任链组件的注册和执行。</pre></td></tr><tr><td data-num="3"></td><td><pre> * 后续具体业务将泛型 T 替换为具体的请求参数类型。</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChainContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 实现 CommandLineRunner 接口是为了在项目启动时加载责任链组件</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 责任链组件列表容器</pre></td></tr><tr><td data-num="9"></td><td><pre>     * &lt;p></pre></td></tr><tr><td data-num="10"></td><td><pre>     * key 为对应业务的责任链组件标识（mark），value 为责任链组件列表（各种 ChainFilter）</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AbstractChainHandler</span><span class="token punctuation">></span><span class="token punctuation">></span></span> abstractChainHandlerContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     * 依次执行 mark 对应业务的所有责任链组件</pre></td></tr><tr><td data-num="16"></td><td><pre>     * &lt;p></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 根据责任链组件标识（mark）获取相关的责任链组件列表（各种 ChainFilter），依次执行它们的 handler 方法</pre></td></tr><tr><td data-num="18"></td><td><pre>     *</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @param mark         责任链组件标识</pre></td></tr><tr><td data-num="20"></td><td><pre>     * @param requestParam 请求参数</pre></td></tr><tr><td data-num="21"></td><td><pre>     */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">String</span> mark<span class="token punctuation">,</span> <span class="token class-name">T</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractChainHandler</span><span class="token punctuation">></span></span> abstractChainHandlers <span class="token operator">=</span> abstractChainHandlerContainer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>abstractChainHandlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s] Chain of Responsibility ID is undefined."</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        abstractChainHandlers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>each <span class="token operator">-></span> each<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 项目启动时运行，负责各业务的责任链组件列表的注册</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 从 Spring 容器中获取所有的责任链处理器实现类（即责任链组件，事先通过 @Component 注解注册到 Spring 容器中）</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 其中 key 为 Bean 的名称，value 为责任链处理器实现类的实例</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractChainHandler</span><span class="token punctuation">></span></span> chainFilterMap <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">AbstractChainHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">// 遍历责任链组件，根据其标识（mark）分组到对应列表中，同时按照排序字段（Order）对该列表内部进行排序，最后将对应列表注册到责任链组件列表容器中</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        chainFilterMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span> <span class="token comment">//bean 为责任链组件实例</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token comment">// 根据责任链组件标识 mark 区分不同业务场景，从责任链组件列表容器中获取对应业务的责任链组件列表</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractChainHandler</span><span class="token punctuation">></span></span> abstractChainHandlers <span class="token operator">=</span> abstractChainHandlerContainer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token comment">// 如果当前 mark 对应的责任链组件列表仍然为空，则初始化一个空列表</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>abstractChainHandlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                abstractChainHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token comment">// 将当前责任链组件添加到对应列表中</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            abstractChainHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">// 将责任链组件列表按照排序字段（Order）排序</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractChainHandler</span><span class="token punctuation">></span></span> actualAbstractChainHandlers <span class="token operator">=</span> abstractChainHandlers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token operator">::</span><span class="token function">getOrder</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment">// 将排序后的责任链组件列表注册（或者覆盖更新）到责任链组件列表容器中</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            abstractChainHandlerContainer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actualAbstractChainHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这两个接口已经被放置在基础组件库中，如果业务需要使用责任链模式，则无需重新定义。</p><h3 id="具体业务中应用责任链模式"><a class="anchor" href="#具体业务中应用责任链模式">#</a> 具体业务中应用责任链模式</h3><p>现在来看看针对一个具体业务（以 12306 中的<a href="#%E5%88%97%E8%BD%A6%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2">列车数据检索</a>的请求参数校验为例），看看需要编写哪些逻辑。</p><h4 id="具体业务的责任链处理器接口"><a class="anchor" href="#具体业务的责任链处理器接口">#</a> 具体业务的责任链处理器接口</h4><p>如果没有该接口，会遇到以下问题：</p><ul><li>所有责任链处理器实现类都依赖顶级抽象接口，如果<font color="red">想知道某个业务场景下有多少具体子类</font>是相当困难的。</li><li>由于责任链处理器实现类都需要实现 Mark 方法，实际上 <font color="red">某一业务对应的所有实现类的 Mark 方法的返回值都是相同的 </font>。</li></ul><p>因此，通过在业务层面上 <font color="gree">抽象出一个具体业务的责任链处理器接口 </font>，需要继承<a href="#%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E6%8E%A5%E5%8F%A3">抽象责任链处理器接口</a>（AbstractChainHandler），就能很好地解决上述两个问题。以下是列车车票查询业务中用于校验请求参数的责任链处理器接口：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 列车车票查询业务的责任链处理器接口</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TrainTicketQueryChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">TicketPageQueryReqDTO</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChainHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketPageQueryReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">TicketChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">TRAIN_QUERY_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="具体业务的责任链处理器实现类"><a class="anchor" href="#具体业务的责任链处理器实现类">#</a> 具体业务的责任链处理器实现类</h4><p>现在，让我们继续探讨 <font color="gree">责任链处理器实现类的编写 </font>，需要实现刚刚定义的<a href="#%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E7%9A%84%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E6%8E%A5%E5%8F%A3">具体业务的责任链处理器接口</a>。</p><p>在列车车票查询的请求参数校验中，需要验证三部分内容：</p><ol><li>非空验证：出发地、目的地、出发日期不能为空；</li><li>基础数据验证：出发日期不能小于当前日期、出发地和目的地不能相同</li><li>城市名称是否存在：出发地、目的地是否存在</li></ol><p>因此需要编写 3 个实现类。</p><h5 id="非空验证-责任链处理器实现类"><a class="anchor" href="#非空验证-责任链处理器实现类">#</a> 非空验证 - 责任链处理器实现类</h5><p>在具体的责任链处理器实现类中，可以看到标注了 <code>@Component</code> 注解，将当前组件注册到了 Spring 容器中，这与<a href="#%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E4%B8%8A%E4%B8%8B%E6%96%87%E7%B1%BB">抽象责任链上下文类</a>中 run () 方法的第一行代码 —— 从 Spring 容器中获取所有的责任链处理器实现类的逻辑相呼应。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 查询列车车票流程中验证数据是否为空或者空字符串的责任链处理器实现类</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 当 Spring 自动扫描时会识别到该注解，从而将当前类注册为 Bean 到 Spring 容器中。</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 与 AbstractChainContext 中的 run () 方法中从 Spring 容器中获取责任链处理器实现类的逻辑相呼应。</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrainTicketQueryParamNotNullChainFilter</span> <span class="token keyword">implements</span> <span class="token class-name">TrainTicketQueryChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketPageQueryReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 验证出发地、目的地和出发日期是否为空</pre></td></tr><tr><td data-num="11"></td><td><pre>     *</pre></td></tr><tr><td data-num="12"></td><td><pre>     * @param requestParam 请求参数</pre></td></tr><tr><td data-num="13"></td><td><pre>     */</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"出发地不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"目的地不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getDepartureDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"出发日期不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 重写 Ordered 接口中的 getOrder 方法，返回当前责任链处理器实现类的排序值，决定在其责任链中的执行顺序</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 表示最先执行</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="基础数据验证-责任链处理器实现类"><a class="anchor" href="#基础数据验证-责任链处理器实现类">#</a> 基础数据验证 - 责任链处理器实现类</h5><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 查询列车车票流程过滤器之基础数据验证</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrainTicketQueryParamBaseVerifyChainFilter</span> <span class="token keyword">implements</span> <span class="token class-name">TrainTicketQueryChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketPageQueryReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 验证出发日期是否大于当前日期、出发地和目的地是否不同</pre></td></tr><tr><td data-num="10"></td><td><pre>     *</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @param requestParam 请求参数</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getDepartureDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocalDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"出发日期不能小于当前日期"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"出发地和目的地不能相同"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="城市存在验证-责任链处理器实现类"><a class="anchor" href="#城市存在验证-责任链处理器实现类">#</a> 城市存在验证 - 责任链处理器实现类</h5><blockquote><p>这块存个疑，逻辑太复杂了...</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 查询列车车票流程过滤器之验证数据是否正确，包括出发地和目的地是否存在</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrainTicketQueryParamVerifyChainFilter</span> <span class="token keyword">implements</span> <span class="token class-name">TrainTicketQueryChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketPageQueryReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RegionMapper</span> regionMapper<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StationMapper</span> stationMapper<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DistributedCache</span> distributedCache<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 缓存数据为空并且已经加载过的标识</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token constant">CACHE_DATA_ISNULL_AND_LOAD_FLAG</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 验证出发地和目的地是否存在</pre></td></tr><tr><td data-num="20"></td><td><pre>     *</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @param requestParam 请求参数</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">HashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> hashOperations <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 查询出发站点和到达站点是否存在，如果不存在也一样属于异常数据</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> actualExistList <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span> <span class="token comment">//multiGet () 方法用于批量获取多个 key 对应的 value</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 这里有个坑，就算为空，也会返回数据，所以我们通过 filter 判断对象是否为空</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">long</span> emptyCount <span class="token operator">=</span> actualExistList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 如果为空的记录是 0 的话，就证明出发站点和到达站点存在，正常返回即可</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// 如果出发站点和到达站点都不存在或者仅存在一个，直接抛出异常</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">// CACHE_DATA_ISNULL_AND_LOAD_FLAG = true 代表已经加载过一次，此时还是空，证明说数据库也没有这两个站点信息，抛异常</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">==</span> <span class="token number">1L</span> <span class="token operator">||</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">==</span> <span class="token number">2L</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">CACHE_DATA_ISNULL_AND_LOAD_FLAG</span> <span class="token operator">&amp;&amp;</span> distributedCache<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"出发地或目的地不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// 如果 CACHE_DATA_ISNULL_AND_LOAD_FLAG=false 代表有可能缓存没有数据，但数据库可能有，此时向下查询数据库</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">// 为了避免缓存击穿，所以这里是用了分布式锁</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_QUERY_ALL_REGION_LIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment">// 获取完分布式锁，避免重复且无用的加载数据库，通过【双重判定锁】的形式，再查询一次缓存</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token comment">// 如果缓存存在，直接返回即可。</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>distributedCache<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                actualExistList <span class="token operator">=</span> hashOperations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        <span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                        <span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                emptyCount <span class="token operator">=</span> actualExistList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">!=</span> <span class="token number">2L</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"出发地或目的地不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token comment">// 因为站点是可以传城市名称的，也就是 Region，所以我们需要查询站点以及城市两张表</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegionDO</span><span class="token punctuation">></span></span> regionDOList <span class="token operator">=</span> regionMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">emptyWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StationDO</span><span class="token punctuation">></span></span> stationDOList <span class="token operator">=</span> stationMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">emptyWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> regionValueMap <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RegionDO</span> each <span class="token operator">:</span> regionDOList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                regionValueMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StationDO</span> each <span class="token operator">:</span> stationDOList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                regionValueMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token comment">// 查询完后，通过 putAll 的形式存入缓存，避免多次 put 浪费网络 IO</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            hashOperations<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">QUERY_ALL_REGION_LIST</span><span class="token punctuation">,</span> regionValueMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token comment">// 设置 CACHE_DATA_ISNULL_AND_LOAD_FLAG = true，代表已经加载过初始化数据</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token constant">CACHE_DATA_ISNULL_AND_LOAD_FLAG</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token comment">// 再查询一次，查看是否存在</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            emptyCount <span class="token operator">=</span> regionValueMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token comment">// 如果加载后还是为空，那么直接抛出异常</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyCount <span class="token operator">!=</span> <span class="token number">2L</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"出发地或目的地不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token comment">// 分布式锁释放</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="在具体业务逻辑中调用"><a class="anchor" href="#在具体业务逻辑中调用">#</a> 在具体业务逻辑中调用</h4><p>在具体业务的 Service Impl 中，<font color="red">首先定义了当前业务场景下的责任链上下文</font> ticketPageQueryAbstractChainContext ，当项目启动时会运行内部的 run () 方法，自动注册该业务相关的责任链组件列表。</p><p>然后在 <code>TicketServiceImpl#pageListTicketQuery</code> 方法中<font color="red">调用上下文中的 handler () 方法，传入业务对应的 mark 标识（以获取责任链组件列表）、请求参数</font>，依次调用列表中的各个责任链组件的 handler 方法，执行各自的业务处理逻辑。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 车票查询的责任链上下文，用于注册和执行相关责任链组件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AbstractChainContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketPageQueryReqDTO</span><span class="token punctuation">></span></span> ticketPageQueryAbstractChainContext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre> * 根据条件，分页查询车票（v1）</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> * @param requestParam 分页查询车票请求参数</pre></td></tr><tr><td data-num="8"></td><td><pre> * @return 查询车票返回结果</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">TicketPageQueryRespDTO</span> <span class="token function">pageListTicketQueryV1</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment">// 责任链模式，车票查询过滤器，依次验证以下内容</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">// 1. 非空验证：出发地、目的地、出发日期不能为空</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token comment">// 2. 基础数据验证：出发日期不能小于当前日期、出发地和目的地不能相同</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token comment">// 3. 城市名称是否存在：出发地、目的地是否存在</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	ticketPageQueryAbstractChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">TRAIN_QUERY_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token class-name">StringRedisTemplate</span> stringRedisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment">// ...</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中， <code>TicketChainMarkEnum</code> 是与车票业务相关的责任链标识枚举类：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 车票业务相关的责任链标识枚举类</pre></td></tr><tr><td data-num="3"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="4"></td><td><pre> * 包括：车票查询过滤器、车票购买过滤器、车票退款过滤器</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">TicketChainMarkEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 车票查询过滤器</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token constant">TRAIN_QUERY_FILTER</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 车票购买过滤器</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token constant">TRAIN_PURCHASE_TICKET_FILTER</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 车票退款过滤器</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token constant">TRAIN_REFUND_TICKET_FILTER</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="策略模式是什么"><a class="anchor" href="#策略模式是什么">#</a> 策略模式是什么？</h2><p>日常 Coding 过程中，设计模式三板斧：<strong>模版、构建者、策略</strong>，今天来说下第三板斧 —— 策略设计模式。</p><p>策略模式还是比较简单并且使用较多的，平常我们多运用策略模式用来 <font color="red">消除 <code>if-else</code> 、 <code>switch-case</code> 等多重分支判断 </font>的代码，有效应对代码的复杂性。</p><p>如果 <font color="red">分支判断会不断变化（增、删、改）</font>，那么可以使用别的技巧让其满足开闭原则，提高代码的扩展性（策略模式场景主要负责解耦，开闭原则需要额外支持）。</p><p>下文中会详细列举如何使用设计模式做个 Demo 、模式的真实场景以及策略模式的好处。</p><h3 id="策略模式的概念"><a class="anchor" href="#策略模式的概念">#</a> 策略模式的概念</h3><p>策略设计模式是一种 OOP 模式，它定义了一组算法类，<strong><font color="red">将每个算法分别封装起来，让它们可以互相替换 </font></strong>。使这些算法可以独立于客户端而变化，客户端代指调用算法的代码。</p><p>策略模式中包含三类角色：</p><ul><li>策略（Strategy）：定义了一组算法，并将每个算法封装起来，使它们可以相互替换</li><li>具体策略（ConcreteStrategy）：实现了策略接口，提供了具体的算法实现</li><li>环境（Context）：持有一个策略对象，并调用其算法</li></ul><p>或者：</p><ul><li><font color="cornflowerblue">抽象策略接口</font></li><li><font color="cornflowerblue">具体的策略实现类</font></li><li><font color="cornflowerblue">策略工厂</font></li></ul><p>在策略设计模式中，环境持有一个策略对象，并通过调用策略的算法来完成具体的任务。策略对象可以根据需要进行替换，从而实现不同的算法实现，并且可以在运行时动态地更改策略对象。</p><p>看到上面的介绍可能不太明白策略模式具体为何物，这里会从最基本的代码说起，一步一步彻底掌握此模式。下述代码可能大家都能联想出对应的业务，<font color="red">根据对应的优惠类型，对价格作出相应的优惠 </font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314155230451.png" alt="image-20240314155230451"></p><p>这段代码是能够满足项目中业务需求的，而且很多已上线生产环境的代码也有这类代码。但是，这一段代码存在存在 <font color="gree">两个弊端 </font>：</p><ol><li><font color="red">代码的复杂性 </font>，正常业务代码逻辑肯定会比这个代码块复杂很多，这也就导致了 <font color="red">if-else 的 分支以及代码数量过多 </font>。这种方式可以通过将代码拆分成独立函数或者拆分成类来解决。</li><li><font color="red">开闭原则 </font>，价格优惠肯定会随着不同的时期作出不同的改变，或许新增、删除或修改。如果 <font color="red">在一个函数中修改无疑是件恐怖的事情 </font>，想想可能多个开发者分别进行开发，杂乱无章的注释，混乱的代码逻辑等情况十有八九会发生。</li></ol><h3 id="策略模式示例"><a class="anchor" href="#策略模式示例">#</a> 策略模式示例</h3><p>将上述代码块改造为策略设计模式，大致需要 <font color="gree">三个步骤 </font>。</p><ol><li><font color="red">定义抽象策略接口 </font>，因为业务使用接口而不是具体的实现类的话，便可以灵活的替换不同的策略；</li><li><font color="red">定义具体策略实现类 </font>，实现自抽象策略接口，其内部封装具体的业务实现；</li><li><font color="red">定义策略工厂 </font>，封装创建策略实现（算法），对客户端屏蔽具体的创建细节。</li></ol><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314155740706.png" alt="image-20240314155740706"></p><p>目前把抽象策略接口、具体的策略实现类以及策略工厂都已经创建了，现在可以看一下 <font color="red">客户端需要如何调用 </font>，又是如何对客户端屏蔽具体实现细节的。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314160019482.png" alt="image-20240314160019482"></p><p>根据代码块图片得知，具体策略类是从策略工厂中获取，确实是取消了 <code>if-else</code> 设计，在工厂中使用 Map 存储策略实现。获取到策略类后执行具体的优惠策略方法就可以获取优惠后的金额。</p><p>通过分析大家得知，目前这种设计确实将应用代码的复杂性降低了。如果新增一个优惠策略，只需要新增一个策略算法实现类即可。但是，<font color="red">添加一个策略算法实现类，意味着需要改动策略工厂中的代码，还是不符合开闭原则 </font>。</p><p>如何完整实现符合开闭原则的策略模式，需要借助 Spring 的帮助，详细案例请继续往下看。</p><h3 id="项目中的真实应用场景"><a class="anchor" href="#项目中的真实应用场景">#</a> 项目中的真实应用场景</h3><p>最近项目中设计的一个功能用到了策略模式，分为两类角色，笔者负责定义抽象策略接口、策略工厂，不同的策略算法需要各个业务方去实现，可以联想到上文中的优惠券功能。因为是 Spring 项目，所以都是按照 Spring 的方式进行处理。</p><p><font color="red">抽象策略接口以及实现类 </font>的代码如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314160429029.png" alt="image-20240314160429029"></p><p>可以看到，比对上面的示例代码，有两处明显的变化：</p><ol><li>抽象策略接口中，<font color="red">新定义了 <code>mark()</code> 接口，此用来标识不同的策略算法</font></li><li><font color="red">具体策略实现类，使用 <code>@Component</code> 修饰，将其交由 Spring 容器管理</font></li></ol><p>小贴士：为了阅读方便，mark () 返回直接使用字符串替代，读者朋友 <font color="red">在返回标识时最好使用枚举定义 </font>。</p><p><font color="red">抽象策略工厂 </font>的代码如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314160857934.png" alt="image-20240314160857934"></p><p>和之前<a href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E8%AE%BE%E8%AE%A1">责任链模式</a>相同，都是通过实现 <code>InitializingBean</code> 接口，在重写方法中调用 IOC 容器查找对应策略实现类，随后将策略实现 mark () 方法返回值作为 key，策略实现类本身作为 value 添加到 Map 容器中等待客户端的调用。</p><p>这里使用的 <font color="red">SpringBoot 测试类 </font>，注入策略工厂 Bean，通过策略工厂选择出具体的策略算法类，继而通过算法获取到优惠后的价格。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314161824891.png" alt="image-20240314161824891"></p><p>总结下本小节，我们通过和 Spring 结合的方式，通过策略设计模式对文初的代码块进行了两块优化：<font color="red">通过抽象策略算法类减少代码的复杂性，通过 Spring 的一些特性满足了开闭原则 </font>。现在，<strong><font color="red">来了新需求只要添加新的策略实现类即可 </font></strong>，健壮易扩展。</p><h3 id="策略模式的优缺点"><a class="anchor" href="#策略模式的优缺点">#</a> 策略模式的优缺点</h3><p>优点：</p><ol><li>提高了代码的灵活性和可维护性：由于算法的实现与使用相分离，使得代码的灵活性和可维护性得到提高。<font color="red">当需要修改或添加新的算法时，只需要定义新的策略类，并将其传递给环境类即可 </font>，而无需修改环境类的代码。</li><li>提高了代码的复用性：策略设计模式将算法的实现封装在策略类中，<font color="red">使得算法可以被多个客户端重复使用 </font>，从而提高了代码的复用性。</li><li>可以动态地切换算法：策略设计模式将算法封装在策略类中，<font color="red">使得可以在运行时动态地更改算法 </font>，从而实现不同的功能和行为。这样可以使得程序更加灵活，适应不同的需求和变化。</li><li>算法实现与使用相分离：策略设计模式将算法的实现与使用相分离，使得代码更加清晰、简洁、易于维护和扩展。由于算法的实现被封装在策略类中，<font color="red">客户端只需要关注如何选择和使用不同的算法即可 </font>，这样可以使得代码更加易于理解和维护。</li><li><font color="red">避免使用大量的条件语句 </font>：在某些情况下，需要根据不同的条件来选择不同的算法，这可能会导致代码中出现大量的条件语句，使得代码难以维护和扩展。而策略设计模式可以避免这种情况的发生，使得代码更加简洁和易于维护。</li></ol><p>注意点：</p><ol><li><font color="red">策略实现类之间应该相互独立 </font>，彼此之间不应该有任何依赖关系。这样才能确保算法的选择和替换可以在运行时动态地进行，同时也可以避免代码的耦合度过高。</li><li><font color="red">策略接口应该尽可能地简单通用 </font>，以便于不同的策略实现类可以共用同一个接口。这样可以提高代码的复用性和灵活性，同时也可以避免接口过于复杂和难以维护。</li><li>策略设计模式适用于需要在运行时动态切换算法的场景，如果算法的实现不需要动态切换，或者算法的实现较为简单，策略设计模式可能会显得过于复杂。因此，在选择使用策略设计模式时，需要根据具体的需求和场景进行判断和选择。</li><li>策略设计模式可以与其他设计模式结合使用，例如工厂方法模式、单例模式等。这样可以进一步提高代码的灵活性和可维护性，同时也可以避免代码的复杂度过高。</li></ol><h3 id="框架源码中的设计模式应用"><a class="anchor" href="#框架源码中的设计模式应用">#</a> 框架源码中的设计模式应用</h3><p>在作者了解中，JDK、Spring、SpringMvc、Mybatis、Dubbo 等等都运用了策略设计模式，这里就以 Mybatis 举例说明。</p><p><font color="red">Mybatis 中的 Executor </font>代表执行器，负责增删改查的具体操作，其中用到了两种设计模式：模版方法 + 策略模式。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314162718012.png" alt="image-20240314162718012"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314163400430.png" alt="image-20240314163400430"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20200603165448345.png" alt="img"></p><ul><li><code>Executor</code> ：代表了抽象策略接口，刚才说到的模版方法模式源自 <code>BaseExecutor</code> 。</li><li><code>Configuration</code> ：代表策略工厂，负责创建具体的策略算法实现类。</li><li><code>SimpleExecutor</code> 、 <code>ReuseExecutor</code> 、 <code>BatchExecutor</code> ：表示具体的策略算法实现类。</li></ul><p>以下代码块发生在 Configuration 类中创建执行器 Executor，通过 executorType 判断创建不同的策略算法。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314164042203.png" alt="image-20240314164042203"></p><p>上述代码块并没有彻底消除 if-else，因为 Mybatis 中执行器策略基本是固定的，也就是说它只会有这些 if-else 判断，基本不会新增或修改。如果非要消除 if-else，可以这么搞，这里写一下伪代码。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240314164242778.png" alt="image-20240314164242778"></p><p>这种方式叫做 &quot;<font color="red">查表法 </font>&quot;，通过策略工厂实现消除 if-else 分支。最后，Mybatis 太过详细的设计这里不再赘述，有兴趣的小伙伴可以去把源码下载啃一啃。</p><p>到了这里可能有读者看出了问题，<font color="red">策略模式就算消除了 if-else 但是如果添加新的策略类，不还是会违反开闭原则么？</font>没错，<strong>因为 Mybatis 本身没有引入 Spring 依赖，所以没有办法借助 IOC 容器实现开闭原则</strong>。</p><p>Spring 是一种开闭原则解决方式，那还有没有别的解决方式？解决方式有很多，开闭原则核心就是<strong>对原有代码修改关闭，对新增代码开放</strong>。可以通过扫描指定包下的自定义注解亦或者通过 instanceof 判断是否继承自某接口都可以。不过， 项目如果用了 Spring 还是消停的吧。</p><h3 id="小结-4"><a class="anchor" href="#小结-4">#</a> 小结</h3><p>策略模式的本质依然是对代码设计解耦合，通过三类角色贯穿整个策略模式：<font color="red">抽象策略接口、具体的策略实现类、策略工厂 </font>。通过细粒度的策略实现类避免了主体代码量过多，减少了设计中的复杂性。</p><p>最后抛出一个问题：出现 if-else 的代码，一定要使用策略模式优化么？ <font color="red">如果 <code>if-else</code> 判断分支不多并且是固定的，后续不会出现新的分支，那完全可以通过抽函数的方式降低程序复杂性 </font>；不要想法设法去除 if-else 语句，存在即合理。而且，<font color="red">使用策略模式会导致类增多 </font>，没有必要为了少量的判断分支引入策略模式。</p><h2 id="如何抽象策略模式"><a class="anchor" href="#如何抽象策略模式">#</a> 如何抽象策略模式</h2><p><font color="red">随着业务越来越多，重复定义诸如 DiscountStrategy 和 DiscountStrategyFactory 的接口 / 类会增加系统冗余代码量，因此<strong>可以考虑将这两个基础接口 / 类抽象出来，作为基础组件库中的通用组件</strong> </font>，供所有系统下的业务使用，从而避免代码冗余。</p><p>定义 <font color="cornflowerblue">抽象策略接口 </font>，添加无返回值、有返回值的两种执行方法：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 抽象策略接口，定义两种执行方法（无返回值、有返回值）</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @param &lt;REQUEST>  执行策略的入参</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param &lt;RESPONSE> 执行策略的返回值</pre></td></tr><tr><td data-num="6"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AbstractExecuteStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span>REQUEST<span class="token punctuation">,</span> RESPONSE<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 执行策略的标识，用于区分不同的策略</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>     * 匹配范解析标识，用于匹配策略标识</pre></td></tr><tr><td data-num="19"></td><td><pre>     */</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">patternMatchMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="25"></td><td><pre>     * 执行策略（无返回值）</pre></td></tr><tr><td data-num="26"></td><td><pre>     *</pre></td></tr><tr><td data-num="27"></td><td><pre>     * @param requestParam 执行策略入参</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">REQUEST</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="34"></td><td><pre>     * 执行策略（有返回值）</pre></td></tr><tr><td data-num="35"></td><td><pre>     *</pre></td></tr><tr><td data-num="36"></td><td><pre>     * @param requestParam 执行策略入参</pre></td></tr><tr><td data-num="37"></td><td><pre>     * @return 执行策略后返回值</pre></td></tr><tr><td data-num="38"></td><td><pre>     */</pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">default</span> <span class="token class-name">RESPONSE</span> <span class="token function">executeResp</span><span class="token punctuation">(</span><span class="token class-name">REQUEST</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>定义 <font color="cornflowerblue">策略选择器类 </font>，通过订阅 Spring 初始化事件来扫描所有抽象策略接口，并根据 mark 方法定义标识添加到 abstractExecuteStrategyMap 容器中。</p><p>客户端在实际业务中使用 AbstractStrategyChoose#choose 即可完成策略模式实现。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 策略选择器类，负责策略的选择和执行。</pre></td></tr><tr><td data-num="3"></td><td><pre> * 其中，ApplicationListener&lt;ApplicationInitializingEvent> 是 Spring 的事件监听器，</pre></td></tr><tr><td data-num="4"></td><td><pre> * 用于监听 ApplicationInitializingEvent 事件</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbstractStrategyChoose</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationInitializingEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 执行策略集合，用于存储所有的执行策略，key 为策略标识，value 为具体的执行策略</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractExecuteStrategy</span><span class="token punctuation">></span></span> abstractExecuteStrategyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 根据 mark 查询具体策略</pre></td></tr><tr><td data-num="17"></td><td><pre>     *</pre></td></tr><tr><td data-num="18"></td><td><pre>     * @param mark          策略标识</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @param predicateFlag 匹配范解析标识</pre></td></tr><tr><td data-num="20"></td><td><pre>     * @return 实际执行策略</pre></td></tr><tr><td data-num="21"></td><td><pre>     */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">AbstractExecuteStrategy</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> mark<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> predicateFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>predicateFlag <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> predicateFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">return</span> abstractExecuteStrategyMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">patternMatchMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">patternMatchMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">"策略未定义"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>abstractExecuteStrategyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s] 策略未定义"</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>     * 根据 mark 查询具体策略并执行</pre></td></tr><tr><td data-num="36"></td><td><pre>     *</pre></td></tr><tr><td data-num="37"></td><td><pre>     * @param mark         策略标识</pre></td></tr><tr><td data-num="38"></td><td><pre>     * @param requestParam 执行策略入参</pre></td></tr><tr><td data-num="39"></td><td><pre>     * @param &lt;REQUEST>    执行策略入参范型</pre></td></tr><tr><td data-num="40"></td><td><pre>     */</pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>REQUEST<span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">chooseAndExecute</span><span class="token punctuation">(</span><span class="token class-name">String</span> mark<span class="token punctuation">,</span> <span class="token class-name">REQUEST</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">AbstractExecuteStrategy</span> executeStrategy <span class="token operator">=</span> <span class="token function">choose</span><span class="token punctuation">(</span>mark<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        executeStrategy<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="47"></td><td><pre>     * 根据 mark 查询具体策略并执行</pre></td></tr><tr><td data-num="48"></td><td><pre>     *</pre></td></tr><tr><td data-num="49"></td><td><pre>     * @param mark          策略标识</pre></td></tr><tr><td data-num="50"></td><td><pre>     * @param requestParam  执行策略入参</pre></td></tr><tr><td data-num="51"></td><td><pre>     * @param predicateFlag 匹配范解析标识</pre></td></tr><tr><td data-num="52"></td><td><pre>     * @param &lt;REQUEST>     执行策略入参范型</pre></td></tr><tr><td data-num="53"></td><td><pre>     */</pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>REQUEST<span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">chooseAndExecute</span><span class="token punctuation">(</span><span class="token class-name">String</span> mark<span class="token punctuation">,</span> <span class="token class-name">REQUEST</span> requestParam<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> predicateFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token class-name">AbstractExecuteStrategy</span> executeStrategy <span class="token operator">=</span> <span class="token function">choose</span><span class="token punctuation">(</span>mark<span class="token punctuation">,</span> predicateFlag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        executeStrategy<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="60"></td><td><pre>     * 根据 mark 查询具体策略并执行，带返回结果</pre></td></tr><tr><td data-num="61"></td><td><pre>     *</pre></td></tr><tr><td data-num="62"></td><td><pre>     * @param mark         策略标识</pre></td></tr><tr><td data-num="63"></td><td><pre>     * @param requestParam 执行策略入参</pre></td></tr><tr><td data-num="64"></td><td><pre>     * @param &lt;REQUEST>    执行策略入参范型</pre></td></tr><tr><td data-num="65"></td><td><pre>     * @param &lt;RESPONSE>   执行策略出参范型</pre></td></tr><tr><td data-num="66"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="67"></td><td><pre>     */</pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>REQUEST<span class="token punctuation">,</span> RESPONSE<span class="token punctuation">></span></span> <span class="token class-name">RESPONSE</span> <span class="token function">chooseAndExecuteResp</span><span class="token punctuation">(</span><span class="token class-name">String</span> mark<span class="token punctuation">,</span> <span class="token class-name">REQUEST</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token class-name">AbstractExecuteStrategy</span> executeStrategy <span class="token operator">=</span> <span class="token function">choose</span><span class="token punctuation">(</span>mark<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">RESPONSE</span><span class="token punctuation">)</span> executeStrategy<span class="token punctuation">.</span><span class="token function">executeResp</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 项目启动时加载执行策略</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationInitializingEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token comment">// 从 Spring 容器中获取所有 AbstractExecuteStrategy 类型的 Bean（执行策略）</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractExecuteStrategy</span><span class="token punctuation">></span></span> actual <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">AbstractExecuteStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        actual<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 遍历执行策略，根据执行策略标识将执行策略注册到执行策略容器中</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token class-name">AbstractExecuteStrategy</span> beanExist <span class="token operator">=</span> abstractExecuteStrategyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断执行策略是否已经存在于执行策略容器中</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanExist <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果执行策略已经存在于执行策略容器中，则抛出异常 “重复的执行策略”</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s] Duplicate execution policy"</span><span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token comment">// 如果执行策略不存在于执行策略容器中，则将执行策略注册到执行策略容器中</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            abstractExecuteStrategyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这两个实现已经被放置在基础组件库中，如果业务需要使用策略模式，则无需重新定义。</p><h2 id="参考-dubbo-实现快速消费线程池"><a class="anchor" href="#参考-dubbo-实现快速消费线程池">#</a> 参考 Dubbo 实现快速消费线程池</h2><p><strong>如何解决 JDK 线程池中，在不超过最大线程数的条件下，即时快速消费任务，而不是在队列中堆积</strong>。</p><p>业务是多变的，而 JDK 中的线程池消费流程却是固定的，所以<strong>基于阻塞队列、线程池扩展改变了原有流程</strong>。</p><h3 id="线程池的构造方法及参数"><a class="anchor" href="#线程池的构造方法及参数">#</a> 线程池的构造方法及参数</h3><p>可以参考博客中对 ThreadPoolExecutor 类的介绍：<span class="exturl" data-url="aHR0cHM6Ly9mYW50ZWRvbmcudG9wL2phdmEvanVjL0pVQyVFNyVBQyU5NCVFOCVBRSVCMC8=">JUC 笔记 - JUC - Java | fantedong = 水文 &amp; 摄影 = 为了能更好地查看图片，你需要一点魔法</span>。</p><h3 id="线程池执行任务的流程"><a class="anchor" href="#线程池执行任务的流程">#</a> 线程池执行任务的流程</h3><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/thread-pool-principle.png" alt="图解线程池实现原理"></p><ol><li>线程池提交任务，首先判断当前线程数是否超过核心线程数，没有则创建核心线程，执行任务；</li><li>如果当前线程超过了核心线程数，再判断当前任务队列是否已满，<font color="red">没有则将任务添加到队列中等待 </font>；</li><li>如果任务队列也满了，再判断当前线程是否超过最大线程数，没有则创建非核心线程执行任务；</li><li>如果当前线程大于或等于最大线程数，则执行拒绝策略。</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// ...</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这道问题的意图就是要将第二步就行改写。<strong><font color="red">如果当前线程超过了核心线程数，但任务队列未满，此时不将任务放入阻塞队列，而是创建非核心线程执行任务 </font></strong>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317132349200.png" alt="image-20240317132349200"></p><p>本地代码实现参考 Dubbo 源码中 <code>EagerThreadPoolExecutor</code> ，确实能实现对应效果，看一下 Dubbo 如何做的。</p><h3 id="dubbo-中实现的快速消费"><a class="anchor" href="#dubbo-中实现的快速消费">#</a> ❓Dubbo 中实现的快速消费</h3><p>涉及的类有以下两个：</p><p>（1） <code>TaskQueue</code> ：自定义的任务队列</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>threadpool<span class="token punctuation">.</span>support<span class="token punctuation">.</span>eager</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedBlockingQueue</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RejectedExecutionException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * 如果 executor 的 submittedTaskCount 小于 currentPoolThreadSize，或者 executor 的最大 PoolSize 小于 currentPoolThreadSize，则向任务队列中添加任务；</pre></td></tr><tr><td data-num="9"></td><td><pre> * 当任务数量大于 corePoolSize 但小于 maximumPoolSize 时，这可以使 executor 创建新的非核心线程。</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2635853580887179627L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 队列中持有线程池的引用</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">EagerThreadPoolExecutor</span> executor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setExecutor</span><span class="token punctuation">(</span><span class="token class-name">EagerThreadPoolExecutor</span> exec<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        executor <span class="token operator">=</span> exec<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">"The task queue does not have executor!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 获取当前池内的线程数</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">int</span> currentPoolThreadSize <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 如果有核心线程正在空闲，将任务加入阻塞队列，由核心线程进行处理任务</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">getSubmittedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> currentPoolThreadSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre> 		 *【重点】当前线程池线程数量小于最大线程数</pre></td></tr><tr><td data-num="39"></td><td><pre>		 * </pre></td></tr><tr><td data-num="40"></td><td><pre>返回 false，根据线程池源码，会创建非核心线程</pre></td></tr><tr><td data-num="41"></td><td><pre>		 */</pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPoolThreadSize <span class="token operator">&lt;</span> executor<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// 如果当前线程池数量大于最大线程数，任务加入阻塞队列</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="51"></td><td><pre>     * retry offer task</pre></td></tr><tr><td data-num="52"></td><td><pre>     *</pre></td></tr><tr><td data-num="53"></td><td><pre>     * @param o task</pre></td></tr><tr><td data-num="54"></td><td><pre>     * @return offer success or not</pre></td></tr><tr><td data-num="55"></td><td><pre>     * @throws RejectedExecutionException if executor is terminated.</pre></td></tr><tr><td data-num="56"></td><td><pre>     */</pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">retryOffer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">"Executor is shutdown!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>存在一个疑点，getSubmittedTaskCount () 是如何获取提交任务数量的？这里就需要看一下 EagerThreadPoolExecutor 实现了，也比较简单，只是重写了线程池的两个方法: <code>afterExecute()</code> 、 <code>execute()</code> 。</p><p>（2） <code>EagerThreadPoolExecutor</code> ：封装快速消费线程池。它继承了 ThreadPoolExecutor，在 execute () 上做了个性化设计。并在线程池内新增了一个 <font color="red">任务数量 </font>的字段，是一个原子类，添加任务时自增，任务异常及结束时递减。这样就能保证 TaskQueue#offer (Runnable runnable) 做出逻辑处理。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>threadpool<span class="token punctuation">.</span>support<span class="token punctuation">.</span>eager</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RejectedExecutionException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RejectedExecutionHandler</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadFactory</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EagerThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre>     * 任务数量</pre></td></tr><tr><td data-num="14"></td><td><pre>     */</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> submittedTaskCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">EagerThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                                   <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                                   <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                                   <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token class-name">TaskQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                                   <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                                   <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> threadFactory<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="27"></td><td><pre>     * @return 当前被执行的任务数量</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSubmittedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> submittedTaskCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">afterExecute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// do not increment in method beforeExecute!</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        submittedTaskCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> rx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment">// retry to offer the task into queue.</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">final</span> <span class="token class-name">TaskQueue</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskQueue</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">retryOffer</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">"Queue capacity is full."</span><span class="token punctuation">,</span> rx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token comment">// decrease any way</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">throw</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="参考-mybatis-动态代理来扩展拒绝策略"><a class="anchor" href="#参考-mybatis-动态代理来扩展拒绝策略">#</a> 参考 Mybatis 动态代理来扩展拒绝策略</h2><p>在阅读 JDK 线程池源码的时候，不知道大家有没有发现一个问题？<strong>线程池 API 中并不支持拒绝策略的扩展</strong>。</p><p>在高并发、高吞吐量的极限情况下，平常稳定运行的线程池可能会变得不稳定，作为线程池任务执行策略中兜底的拒绝策略显得格外重要。</p><p>所以，针对线程池拒绝任务的扩展对于业务是很有必要，因为线程池抛出拒绝策略意味着<strong>业务受到影响</strong>或者<strong>线程池参数设置不合理</strong>。</p><p>我们期望线程池在拒绝提交的任务时，<strong>扩展哪些行为？</strong></p><ol><li>发送线程池报警消息或邮件，通知到相关负责人</li><li>统计线程池拒绝任务的次数，方便后续统计时采集到关键指标。</li><li>......</li></ol><p>本节针对线程池拒绝任务的扩展展开论述，层层渐进的引导大家通过<strong>动态代理</strong>优雅实现拒绝策略扩展功能。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317143120492.png" alt="image-20240317143120492"></p><h3 id="任务拒绝流程"><a class="anchor" href="#任务拒绝流程">#</a> 任务拒绝流程</h3><p>通过前文的下图可知，当客户端提交任务到线程池时，满足以下任意条件，就会发起拒绝任务：</p><ol><li>当前线程池的状态非运行状态（线程池已经触发了停止行为）</li><li>阻塞队列已满，并且线程池中已经创建了最大线程数的线程（线程都在运行中）</li></ol><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/thread-pool-principle.png" alt="图解线程池实现原理"></p><p>线程池底层拒绝任务方法实现：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Invokes the rejected execution handler for the given command.</pre></td></tr><tr><td data-num="3"></td><td><pre> * Package-protected for use by ScheduledThreadPoolExecutor.</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    handler<span class="token punctuation">.</span><span class="token function">rejectedExecution</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>线程池底层设计中，将抛出拒绝策略方法的访问级别设置为默认访问权限（ <code>default</code> ），并添加了 <code>final</code> 关键字。默认访问权限意味着可以被这个类本身和同一个包中的类访问，在其他包中定义的类，即使是这个类的子类，也不能直接访问这个成员。</p><p>这也就意味着，<strong><font color="red">没办法通过继承 ThreadPoolExecutor 去重写 reject 方法，同时也没办法手动调用它 </font></strong>。</p><h3 id="代理模式"><a class="anchor" href="#代理模式">#</a> 代理模式</h3><p>可以使用<strong>代理模式</strong>来满足上述的扩展需求，即在不改变原始目标类代码的情况下，引入代理类对原始目标类的功能作出增强。</p><p>关于代理模式的具体介绍，可以阅读博客文章：<span class="exturl" data-url="aHR0cHM6Ly9mYW50ZWRvbmcudG9wL2phdmEvZGVzaWduLXBhdHRlcm5zLyVFOCVBRSVCRSVFOCVBRSVBMSVFNSU4RSU5RiVFNSU4OCU5OSVFNCVCOCU4RSVFOCVBRSVCRSVFOCVBRSVBMSVFNiVBOCVBMSVFNSVCQyU4Ri8=">设计原则与设计模式 - 设计模式 - Java | fantedong = 水文 &amp; 摄影 = 为了能更好地查看图片，你需要一点魔法</span></p><p>接下来下面我们一步一步来实现，通过代理模式 <font color="red">扩展出拒绝策略的报警和次数统计功能 </font>。</p><h4 id="扩展线程池"><a class="anchor" href="#扩展线程池">#</a> 扩展线程池</h4><p>先来自定义一个线程池，继承原生 ThreadPoolExecutor 。添加一个拒绝策略次数统计的成员变量（原子类），并添加原子自增和查询的成员方法。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SupportThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     * 拒绝策略次数统计</pre></td></tr><tr><td data-num="4"></td><td><pre>     */</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> rejectCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 构造方法</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">SupportThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre>     * 设置 &#123;@link SupportThreadPoolExecutor#rejectCount&#125; 自增</pre></td></tr><tr><td data-num="14"></td><td><pre>     */</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">incrementRejectCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        rejectCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     * 获取拒绝次数</pre></td></tr><tr><td data-num="21"></td><td><pre>     *</pre></td></tr><tr><td data-num="22"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRejectCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> rejectCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="扩展拒绝策略"><a class="anchor" href="#扩展拒绝策略">#</a> 扩展拒绝策略</h4><p>创建增强的公共拒绝策略，其中包含 拒绝策略次数统计 以及 报警推送，供实际的拒绝策略子类实现。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SupportRejectedExecutionHandler</span> <span class="token keyword">extends</span> <span class="token class-name">RejectedExecutionHandler</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     * 拒绝策略执行前，执行某些操作</pre></td></tr><tr><td data-num="4"></td><td><pre>     *</pre></td></tr><tr><td data-num="5"></td><td><pre>     * @param executor</pre></td></tr><tr><td data-num="6"></td><td><pre>     */</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">beforeReject</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token keyword">instanceof</span> <span class="token class-name">SupportThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token class-name">SupportThreadPoolExecutor</span> supportExecutor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SupportThreadPoolExecutor</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token comment">// 发起自增</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            supportExecutor<span class="token punctuation">.</span><span class="token function">incrementRejectCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">// 触发报警...</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程池触发了任务拒绝..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SupportAbortPolicyRejected</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token function">beforeReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">rejectedExecution</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>测试下上面的代码是否能够满足定的需求。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SneakyThrows</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">SupportThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SupportThreadPoolExecutor</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token number">1024</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 使用自定义拒绝策略</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">SupportAbortPolicyRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 测试流程</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 无限睡眠，以此触发拒绝策略.(此处有异常，为了减少无用代码，省略..</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"线程池拒绝策略次数 :: %d"</span><span class="token punctuation">,</span> executor<span class="token punctuation">.</span><span class="token function">getRejectCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="25"></td><td><pre>       * 日志打印：</pre></td></tr><tr><td data-num="26"></td><td><pre>       *</pre></td></tr><tr><td data-num="27"></td><td><pre>       * 线程池触发了任务拒绝...</pre></td></tr><tr><td data-num="28"></td><td><pre>       * 线程池拒绝策略次数 :: 1</pre></td></tr><tr><td data-num="29"></td><td><pre> */</pre></td></tr></table></figure><p>根据日至打印得知，我们的扩展需求完整的实现了。当线程池执行任务拒绝行为时，首先会调用 SupportRejectedExecutionHandler#beforeReject，然后才是执行真正的拒绝策略行为。</p><p>虽然代码需求完成了，但是好与不好，或者说是否可以再优化，咱们继续往下看。</p><h3 id="静态代理"><a class="anchor" href="#静态代理">#</a> 静态代理</h3><p>上面扩展的代码，是一种很典型的设计模式：静态代理。建议小伙伴往下阅读前能够在本地运行下，实践出真知。</p><p>小编画了一张图总结下 <font color="red">静态代理的运行模式 </font>：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317153920552.png" alt="image-20240317153920552"></p><p>通过线程池拒绝策略的实战，让大家对静态代理实现方式有了一定了解。但是这种处理方式真的是优雅的么？</p><p>我们来说一下上面代码的缺点，或者说 <font color="red">静态代理的缺点 </font>：</p><ol><li>静态代理会造成系统设计中 <font color="red">类的数量增加 </font>。比如：线程池原生的四种拒绝策略，如果想要使用扩展功能，需要创建对应的类来实现 SupportRejectedExecutionHandler 接口，违背开闭原则</li><li><font color="red">增加了系统复杂度 </font>。项目中所有线程池都要改动拒绝策略的实现。如果新接手项目的同学，可能会忽略这个代理的细节。</li></ol><p>说到这里，如何解决静态代理带来的问题呢？答案就是：动态代理。</p><h3 id="动态代理"><a class="anchor" href="#动态代理">#</a> ❓动态代理</h3><p>动态代理采用在<strong>运行时动态生成代码</strong>的方式，取消了对被代理类的扩展限制，遵循开闭原则。</p><p>说到这里，问题很多的小伙伴就要问了：你说的这个动态代理，和之前面试官问我的 <font color="red">MyBatis Mapper 接口为什么不需要实现类 </font>，咋这么像？这里额外说一下，MyBatis Mapper 接口 <font color="red">运用了动态代理来规避 JDBC 交互数据库等重复代码行为 </font>。</p><p>如何将动态代理代入到线程池拒绝策略呢？文章采用 <strong>JDK 动态代理</strong>的例子和大家说明。</p><p>创建代理 InvocationHandler，这个类主要负责 <font color="red">代理拒绝策略 </font>执行的，也是 JDK 动态代理必 不可少的一个环节。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 线程池拒绝策略的代理类</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RejectedProxyInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">&#123;</span> <span class="token comment">// InvocationHandler 用于处理代理实例上的方法调用</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 目标对象</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 拒绝次数</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> rejectCount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 重写 invoke 方法，用于执行代理实例的方法调用</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        rejectCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拒绝次数加一</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"线程池执行拒绝策略, 此处模拟报警..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟报警</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 【重点】执行目标对象的方法</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果目标对象方法执行失败，抛出异常</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>对应的拒绝策略代理的工具类如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 拒绝策略代理工具类，用于创建拒绝策略代理类</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>access <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RejectedProxyUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 创建拒绝策略代理类</pre></td></tr><tr><td data-num="11"></td><td><pre>     *</pre></td></tr><tr><td data-num="12"></td><td><pre>     * @param rejectedExecutionHandler 真正的线程池拒绝策略执行器</pre></td></tr><tr><td data-num="13"></td><td><pre>     * @param rejectedNum              拒绝策略执行统计器</pre></td></tr><tr><td data-num="14"></td><td><pre>     * @return 代理拒绝策略</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">RejectedExecutionHandler</span> rejectedExecutionHandler<span class="token punctuation">,</span> <span class="token class-name">AtomicLong</span> rejectedNum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 动态代理模式：增强线程池拒绝策略，比如：拒绝任务报警或加入延迟队列重复放入等逻辑</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionHandler</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                        rejectedExecutionHandler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">RejectedExecutionHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                        <span class="token keyword">new</span> <span class="token class-name">RejectedProxyInvocationHandler</span><span class="token punctuation">(</span>rejectedExecutionHandler<span class="token punctuation">,</span> rejectedNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre>     * 测试线程池拒绝策略动态代理程序</pre></td></tr><tr><td data-num="27"></td><td><pre>     */</pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span> abortPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">AtomicLong</span> rejectedNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">RejectedExecutionHandler</span> proxyRejectedExecutionHandler <span class="token operator">=</span> <span class="token class-name">RejectedProxyUtil</span><span class="token punctuation">.</span><span class="token function">createProxy</span><span class="token punctuation">(</span>abortPolicy<span class="token punctuation">,</span> rejectedNum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        threadPoolExecutor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span>proxyRejectedExecutionHandler<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                ignored<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"================ 线程池拒绝策略执行次数: "</span> <span class="token operator">+</span> rejectedNum<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>线程池使用代理类进行任务拒绝，测试代码如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317155600392.png" alt="image-20240317155600392"></p><p>简单总结下使用动态代理统计拒绝次数和报警的流程，先画一张图巩固下理解。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317155823100.png" alt="image-20240317155823100"></p><ol><li>创建 InvocationHandler 的实现类，代理的行为也是在这里执行。内部包含了实际的拒绝策略和线程池引用，用来执行拒绝任务行为和拒绝次数自增；</li><li>使用 JDK Proxy 创建代理类，原理是运行时生成一个新的代理类。创建完成后，将代理类赋值到线程池，这样线程池拒绝任务时就会包含代理类中的行为。</li></ol><p>好处就比较显而易见了，我们 <font color="red">不用像静态代理一样为每个拒绝策略实现类手动创建代理类，因为动态代理的代理类是<strong>运行时生成的</strong> </font>。</p><p>问题很多的小伙伴可能又要问了，虽然创建动态代理可以解决类的数量增加；但是<strong>代理类的创建依然需要开发人员操作</strong>，这样上面说的静态代理的第二个缺点依然无法解决。这个问题很好，发现代码中不合理的存在并且优化掉它，是工程师的一种美德。</p><p>我们换一种思路去创建代理拒绝策略类，从外部的创建变更到内部就可以了；这一版选择 **<font color="red">在线程池的构造方法内部实现代理类 </font>**。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240317160956909.png" alt="image-20240317160956909"></p><p>具体测试代码就不贴了。至此，使用动态代理扩展线程池任务拒绝策略的主线讲解就完成了。</p><h3 id="动态代理扩展知识"><a class="anchor" href="#动态代理扩展知识">#</a> 动态代理扩展知识</h3><p>给大家再扩展一个问题，也是动态代理的精髓所在；面试过程中问的比较多的问题：<strong>MyBatis Mapper 接口为什么不需要实现类？</strong></p><p>略了</p><h2 id="消息队列中如何借助幂等校验来解决重复消费问题"><a class="anchor" href="#消息队列中如何借助幂等校验来解决重复消费问题">#</a> 消息队列中如何借助幂等校验来解决重复消费问题</h2><blockquote><p>还是建议看这篇文章：<a href="#%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6">接口幂等组件</a></p></blockquote><h3 id="问题背景"><a class="anchor" href="#问题背景">#</a> 问题背景</h3><p>当使用消息队列时，客户端重复消费可能会成为一个严重的问题。这是因为消息队列具有持久性和可靠性的特性，确保消息能够被成功传递给消费者。然而，这也会导致 <font color="red">客户端在某些情况下重复消费消息，例如网络故障、客户端崩溃、消息处理失败等情况 </font>。</p><p>为了避免这种情况发生，需要在客户端实现一些机制来确保消息不会被重复消费，例如 <font color="red">记录消费者已经处理的消息 ID </font>、<font color="red">使用分布式锁来控制消费进程的唯一性 </font>等。这些机制能够保证消息被成功处理，同时也能够提高系统的可靠性和稳定性。</p><p>今天的文章我们将探讨如何确保消息队列中的消息不会被重复消费，下文将 <font color="red">以 RocketMQ 为例 </font>说明。</p><h3 id="消息幂等性"><a class="anchor" href="#消息幂等性">#</a> 消息幂等性</h3><p>消息中间件是分布式系统中常用的组件，它具有广泛的应用价值，例如实现 <font color="red">异步化、解耦、削峰 </font>等功能。通常情况下，我们认为消息中间件是一个可靠的组件。这里的<strong>可靠性</strong>指的是，<font color="red">只要消息被成功投递到了消息中间件，它就不会丢失，至少能够被消费者成功消费一次 </font>。这是消息中间件最基本的特性之一，也就是我们通常所说的 “AT LEAST ONCE”，即消息至少会被成功消费一遍。</p><p>举个例子，假设一个消息 M 被发送到消息中间件并被消费程序 A 接收到，A 开始消费这个消息，但是在消费过程中程序重启了。<font color="red">由于消息 M 没有被标记为已经被消费成功，消息中间件会持续地将消息 M 投递给消费者 A，直到消息 M 被成功消费为止 </font>。</p><p><strong>然而这种可靠性特性也会导致消息被多次投递的情况</strong>。举个例子，仍然以之前的例子为例，如果消费程序 A 接收并完成消息 M 的消费逻辑后，正准备通知消息中间件 “我已经消费成功了”，但在此之前程序 A 又重启了，那么对于消息中间件来说，这个消息 M 并没有被成功消费过，因此消息中间件会继续投递这个消息。<font color="red">而对于消费程序 A 来说，尽管它已经成功消费了这个消息，但由于程序重启导致消息中间件继续投递，看起来就好像消息 M 还没有被成功消费过一样 </font>。</p><p>在 RockectMQ 的场景中，这意味着同一个 messageId 的消息会被重复投递。<strong><font color="red">由于 <u>消息的可靠投递 </u>是更重要的，所以 <u>避免消息重复投递 </u>的任务转移给了应用程序（消费端）自身来实现 </font></strong>。这也是 RocketMQ 文档强调 <font color="red">消费逻辑需要自行实现幂等性 </font>的原因。实际上，这背后的逻辑是：在分布式场景下，保证消息不丢和避免消息重复投递是矛盾的，但是消息重复投递是可以解决的，而消息丢失则非常麻烦。</p><h3 id="幂等设计"><a class="anchor" href="#幂等设计">#</a> 幂等设计</h3><p>让我们先来了解一下 <font color="red">邮件消息的发送流程 </font>，以便更好了解消息队列幂等工作原理。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240318162509431.png" alt="image-20240318162509431"></p><p>正如我们在之前提到的，RocketMQ 遵循 &quot;AT LEAST ONCE&quot; 语义，这意味着消息可能会被重复消费。在发送邮件消息的情况下，由于消息可能被重复消费，我们需要保证幂等性，以确保邮件不会被重复发送。</p><h4 id="消息发送逻辑"><a class="anchor" href="#消息发送逻辑">#</a> 消息发送逻辑</h4><p>下面这块代码是 <font color="red">12306 支付结果回调订单 </font>逻辑实现，通过 <code>RocketMQMessageListener</code> 监听并消费 RocketMQ 消息，<font color="red">此时还没考虑幂等校验 </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 支付结果回调订单的消费者</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Component</span> <span class="token comment">// 标记为 Spring Bean，交给 Spring 容器管理</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span> <span class="token comment">// 生成一个包含常量数据的构造函数</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span> <span class="token comment">// 标记为 RocketMQ 消息监听器，监听指定的 Topic 和 Tag</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        topic <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_GLOBAL_TOPIC_KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        selectorExpression <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_RESULT_CALLBACK_TAG_KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        consumerGroup <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_RESULT_CALLBACK_ORDER_CG_KEY</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayResultCallbackOrderConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageWrapper</span><span class="token punctuation">&lt;</span><span class="token class-name">PayResultCallbackOrderEvent</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 标记为事务方法，出现异常时回滚</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 实现 RocketMQListener 接口的 onMessage 方法，用于处理消息</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PayResultCallbackOrderEvent</span><span class="token punctuation">></span></span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 获取消息体</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">PayResultCallbackOrderEvent</span> payResultCallbackOrderEvent <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 构建订单状态逆转 DTO</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">OrderStatusReversalDTO</span> orderStatusReversalDTO <span class="token operator">=</span> <span class="token class-name">OrderStatusReversalDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orderSn</span><span class="token punctuation">(</span>payResultCallbackOrderEvent<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 订单编号</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">ALREADY_PAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 订单状态</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orderItemStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderItemStatusEnum</span><span class="token punctuation">.</span><span class="token constant">ALREADY_PAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 订单项状态</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 执行订单状态逆转</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        orderService<span class="token punctuation">.</span><span class="token function">statusReversal</span><span class="token punctuation">(</span>orderStatusReversalDTO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// 执行支付结果回调订单</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        orderService<span class="token punctuation">.</span><span class="token function">payCallbackOrder</span><span class="token punctuation">(</span>payResultCallbackOrderEvent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="幂等处理逻辑"><a class="anchor" href="#幂等处理逻辑">#</a> ❓幂等处理逻辑</h4><p>给业务实现幂等校验的常用方法有 2 种：</p><ul><li><code>Redis</code> （常用）：key 和 value 就是天然支持幂等的</li><li><code>MySQL</code> ：主键的唯一性天然能确保重复数据不会被插入多条</li></ul><p>下述方案的优点在于，<font color="red">使用 Redis 消息去重表 </font>，不依赖事务，针对消息表本身做了 <font color="red">状态的区分： <code>没有消费过</code> 、 <code>消费中</code> 、` 消费过</font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240318165116714.png" alt="image-20240318165116714"></p><blockquote><p>如果消息已经在 <code>消费中</code> ，若抛出异常，消息会触发延迟消费（即重试），在 RocketMQ 的场景下即发送到 RETRY TOPIC。</p></blockquote><p>通过该方案可以解决什么问题？</p><ol><li>消息已经消费成功了，第二条消息将被直接幂等处理掉（消费成功）</li><li>并发场景下的消息，依旧能满足不会出现消息重复，即穿透幂等挡板的问题</li><li>支持上游业务生产者重发的业务重复的消息幂等问题</li></ol><p>为什么要给初始化的幂等标识新增 10 分钟过期时间？</p><p>在并发场景下，我们使用消息状态来实现并发控制，以使第二条消息被不断延迟消费（即重试）。但如果在此期间第一条消息也因某些异常原因（例如机器重启或外部异常）未成功消费，该怎么办呢？因为每次查询时都会显示消费中的状态，所以延迟消费会一直进行下去，直到最终 被视为消费失败并被投递到死信 Topic 中（RocketMQ 默认最多可以重复消费 16 次）。</p><p>针对这个问题，我们采取了一种解决方案：<strong>在插入消息表时，必须为每条消息设置一个最长消费过期时间</strong>，例如 10 分钟。这意味着，<font color="red">如果某个消息在消费过程中超过了 10 分钟，就会被视为消费失败并从消息表中删除 </font>。</p><h3 id="抽象幂等通用组件"><a class="anchor" href="#抽象幂等通用组件">#</a> 抽象幂等通用组件</h3><p>为了解决消息队列中的重复消费问题，我们可以设计 <font color="red">一套通用的消息队列幂等组件 </font>。这个组件可以被各个应用程序使用，以确保它们的消费逻辑是幂等的。这种通用的幂等组件可以使应用程序不必为了解决重复消费问题而浪费精力和时间，从而更专注于业务逻辑的实现。</p><p>在企业项目中，使用 MySQL 作为幂等去重表的情况比较少见，因此在代码中只提供了 <code>Redis</code> 实现方案。</p><h4 id="定义幂等注解"><a class="anchor" href="#定义幂等注解">#</a> 定义幂等注解</h4><blockquote><p>2 个场景，3 种方式</p></blockquote><p>我们提供了一种通用的幂等注解，该注解 <font color="red">可用于 RestAPI、MQ 消息防重复场景 </font>（对应于 @Idempotent 注解中的 scene 属性）。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等注解</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@Documented</span> <span class="token comment">// 生成文档</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Idempotent</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>     * 幂等 Key，只有在 &#123;@link Idempotent#type ()&#125; 为 &#123;@link IdempotentTypeEnum#SPEL&#125; 时生效</pre></td></tr><tr><td data-num="13"></td><td><pre>     */</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 触发幂等失败逻辑时，返回的错误提示信息</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"您操作太快，请稍后再试"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * 幂等方式，包含 &#123;@link IdempotentTypeEnum&#125; 中的 3 种类型：TOKEN、PARAM（默认）、SPEL</pre></td></tr><tr><td data-num="23"></td><td><pre>     * RestAPI 场景下，建议使用 TOKEN 或 PARAM</pre></td></tr><tr><td data-num="24"></td><td><pre>     * MQ 等其他场景下，建议使用 SPEL</pre></td></tr><tr><td data-num="25"></td><td><pre>     */</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token class-name">IdempotentTypeEnum</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="29"></td><td><pre>     * 幂等场景，包含 &#123;@link IdempotentSceneEnum&#125; 中的 2 种类型：RESTAPI（默认）、MQ</pre></td></tr><tr><td data-num="30"></td><td><pre>     */</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token class-name">IdempotentSceneEnum</span> <span class="token function">scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">RESTAPI</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="34"></td><td><pre>     * 设置防重令牌 Key 前缀，MQ 幂等去重可选设置</pre></td></tr><tr><td data-num="35"></td><td><pre>     * &#123;@link IdempotentSceneEnum#MQ&#125; and &#123;@link IdempotentTypeEnum#SPEL&#125; 时生效</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">uniqueKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="40"></td><td><pre>     * 设置防重令牌 Key 过期时间，单位秒，默认 1 小时，MQ 幂等去重可选设置</pre></td></tr><tr><td data-num="41"></td><td><pre>     * &#123;@link IdempotentSceneEnum#MQ&#125; and &#123;@link IdempotentTypeEnum#SPEL&#125; 时生效</pre></td></tr><tr><td data-num="42"></td><td><pre>     */</pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">long</span> <span class="token function">keyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">3600L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>为了方便理解幂等注解，整理成思维导图方便记忆：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240318194640942.png" alt="image-20240318194640942"></p><h4 id="定义-aop-增强"><a class="anchor" href="#定义-aop-增强">#</a> 定义 AOP 增强</h4><p>使用 AOP 技术为方法增强提供了通用的幂等性保证，只需要在需要保证幂等性的方法上添加 <code>@Idempotent</code> 注解，Aspect 就会对该方法进行增强。</p><p>这种技术不仅适用于 RestAPI 场景，还适用于消息队列的防重复消费场景。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等注解 AOP 拦截器，用于对标注了 &#123;@link Idempotent&#125; 注解的目标方法进行环绕通知 / 增强（幂等校验）</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 增强方法（幂等校验）</pre></td></tr><tr><td data-num="11"></td><td><pre>     *</pre></td></tr><tr><td data-num="12"></td><td><pre>     * @Around 注解表示环绕通知，可以在目标方法执行前后织入增强代码</pre></td></tr><tr><td data-num="13"></td><td><pre>     * @annotation 表示匹配目标方法上的 &#123;@link Idempotent&#125; 注解</pre></td></tr><tr><td data-num="14"></td><td><pre>     */</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@annotation(org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">idempotentHandler</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ProceedingJoinPoint 表示连接点，即目标方法，可以获取其相关信息（参数、返回值等）</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Idempotent</span> idempotent <span class="token operator">=</span> <span class="token function">getIdempotent</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取目标方法上的 @Idempotent 注解</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">IdempotentExecuteHandler</span> instance <span class="token operator">=</span> <span class="token class-name">IdempotentExecuteHandlerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>idempotent<span class="token punctuation">.</span><span class="token function">scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取幂等执行处理器</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">Object</span> resultObj<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> idempotent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行幂等校验（前置处理）</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            resultObj <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行目标方法（即执行业务逻辑），被环绕增强</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">postProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行成功后的后置处理（幂等标识清理）</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RepeatConsumptionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre>             * 触发幂等逻辑时可能有两种情况：</pre></td></tr><tr><td data-num="27"></td><td><pre>             *    * 1. 消息还在处理，但是不确定是否执行成功，那么需要返回错误，方便 RocketMQ 再次通过重试队列投递</pre></td></tr><tr><td data-num="28"></td><td><pre>             *    * 2. 消息处理成功了，该消息直接返回成功即可</pre></td></tr><tr><td data-num="29"></td><td><pre>             */</pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ex<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span> <span class="token comment">// 消费存在异常</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token comment">// 客户端消费存在异常，需要删除幂等标识方便下次 RocketMQ 再次通过重试队列投递</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">exceptionProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清理幂等上下文</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> resultObj<span class="token punctuation">;</span> <span class="token comment">// 返回目标方法执行结果</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="45"></td><td><pre>     * 获取目标方法上的 @Idempotent 注解</pre></td></tr><tr><td data-num="46"></td><td><pre>     *</pre></td></tr><tr><td data-num="47"></td><td><pre>     * @param joinPoint 连接点，即目标方法</pre></td></tr><tr><td data-num="48"></td><td><pre>     * @return 返回目标方法上的 &#123;@link Idempotent&#125; 注解</pre></td></tr><tr><td data-num="49"></td><td><pre>     * @throws NoSuchMethodException 当目标方法不存在时抛出</pre></td></tr><tr><td data-num="50"></td><td><pre>     */</pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Idempotent</span> <span class="token function">getIdempotent</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token class-name">MethodSignature</span> methodSignature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token class-name">Method</span> targetMethod <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>methodSignature<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodSignature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">return</span> targetMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Idempotent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个方法的执行逻辑与<a href="#%E5%B9%82%E7%AD%89%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91">设计部分</a>相同，大家可以跟着设计阅读幂等源码。</p><p>为了提高通用性和抽象性，该组件采用了 <font color="red">模板方法 </font>和 <font color="red">简单工厂 </font>等设计模式，这有助于隔离复杂性和提高可扩展性。</p><h4 id="在项目中使用"><a class="anchor" href="#在项目中使用">#</a> 在项目中使用</h4><p>同样以实现支付结果回调订单为例，我们可以 <font color="red">将通用组件引入到消息消费的逻辑中 </font>，具体流程如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 支付结果回调订单的消费者</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Component</span> <span class="token comment">// 标记为 Spring Bean，交给 Spring 容器管理</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span> <span class="token comment">// 生成一个包含常量数据的构造函数</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span> <span class="token comment">// 标记为 RocketMQ 消息监听器，监听指定的 Topic 和 Tag</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        topic <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_GLOBAL_TOPIC_KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        selectorExpression <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_RESULT_CALLBACK_TAG_KEY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        consumerGroup <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_RESULT_CALLBACK_ORDER_CG_KEY</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayResultCallbackOrderConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageWrapper</span><span class="token punctuation">&lt;</span><span class="token class-name">PayResultCallbackOrderEvent</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span> <span class="token comment">// 幂等校验注解</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            uniqueKeyPrefix <span class="token operator">=</span> <span class="token string">"index12306-order:pay_result_callback:"</span><span class="token punctuation">,</span> <span class="token comment">// 幂等 Key 前缀</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            key <span class="token operator">=</span> <span class="token string">"#message.getKeys()+'_'+#message.hashCode()"</span><span class="token punctuation">,</span> <span class="token comment">// 幂等 Key SpEL 表达式</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            type <span class="token operator">=</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">SPEL</span><span class="token punctuation">,</span> <span class="token comment">// 幂等验证类型：SPEL</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            scene <span class="token operator">=</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">MQ</span><span class="token punctuation">,</span> <span class="token comment">// 幂等验证场景：MQ</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            keyTimeout <span class="token operator">=</span> <span class="token number">7200L</span> <span class="token comment">// 幂等 Key 过期时间：7200 秒，即 2 小时</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 标记为事务方法，出现异常时回滚</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 实现 RocketMQListener 接口的 onMessage 方法，用于处理消息</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PayResultCallbackOrderEvent</span><span class="token punctuation">></span></span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 获取消息体</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">PayResultCallbackOrderEvent</span> payResultCallbackOrderEvent <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 构建订单状态逆转 DTO</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">OrderStatusReversalDTO</span> orderStatusReversalDTO <span class="token operator">=</span> <span class="token class-name">OrderStatusReversalDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orderSn</span><span class="token punctuation">(</span>payResultCallbackOrderEvent<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 订单编号</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">ALREADY_PAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 订单状态</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orderItemStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderItemStatusEnum</span><span class="token punctuation">.</span><span class="token constant">ALREADY_PAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 订单项状态</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 执行订单状态逆转</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        orderService<span class="token punctuation">.</span><span class="token function">statusReversal</span><span class="token punctuation">(</span>orderStatusReversalDTO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// 执行支付结果回调订单</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        orderService<span class="token punctuation">.</span><span class="token function">payCallbackOrder</span><span class="token punctuation">(</span>payResultCallbackOrderEvent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>支持通过 <code>SpEL</code> 表达式来充当 <font color="red">幂等去重表的唯一键 </font>，通过一个简单的注解，完美解决消息队列重复消费问题。</p><h3 id="更复杂的幂等场景"><a class="anchor" href="#更复杂的幂等场景">#</a> 更复杂的幂等场景</h3><p>到这里，方案看起来非常完美，所有的消息都可以快速接入去重，而且与具体业务实现完全解耦。但是，是否这样就可以完美地完成去重的所有任务呢？很遗憾，实际上并非如此。<font color="red">因为需要确保消息至少成功消费一次，因此消息在消费过程中有可能失败并触发重试 </font>。</p><p>还是以上面的例子，假设消息消费的流程包含：</p><ol><li>检查库存（RPC）</li><li>锁库存（RPC）</li><li>开启事务，插入订单表（MySQL）</li><li>调用某些其他下游服务（RPC）</li><li>更新订单状态</li><li>commit 事务（MySQL）</li></ol><p>当消息消费到第 3 步的时候假设 MySQL 异常导致失败了，触发消息重试。在重试前我们会删除幂等表的记录，所以消息重试的时候就会重新进入消费代码，那么步骤 1 和步骤 2 就会重新再执行一遍。如果步骤 2 本身不是幂等的，那么这个业务消息消费依旧没有做好完整的幂等处理。</p><h4 id="通用方法实现价值"><a class="anchor" href="#通用方法实现价值">#</a> 通用方法实现价值</h4><p>尽管这种方式并不能完全解决消息幂等问题（事实上，软件工程领域里很少有银弹可以完全解决问题），<font color="red">但它仍然具有很大的价值 </font>。通过这种简便的方式，我们能够解决以下问题：</p><ol><li>各种由于 Broker、负载均衡等原因导致的消息重投递的重复问题</li><li>各种上游生产者导致的业务级别消息重复问题</li><li>重复消息并发消费的控制窗口问题，就算重复，重复也不可能同一时间进入消费逻辑</li></ol><h4 id="消息去重的建议"><a class="anchor" href="#消息去重的建议">#</a> 消息去重的建议</h4><p>使用这种方法 <font color="red">可以确保在正常的消费逻辑场景下（无异常，无异常退出），消息的幂等性全部得到解决 </font>，无论是业务重复还是 RocketMQ 特性带来的重复。虽然它不是解决消息幂等性的银弹，但它以一种简单和便捷的方式提供了解决方案。</p><p>实际上，这种方法已经可以解决 99% 的消息重复问题了，因为异常情况通常是少数情况。但是，<font color="red">如果希望在异常情况下也能处理好幂等问题，可以采取以下措施 </font>来降低问题发生的概率：</p><ol><li>消息消费失败时，应该及时回滚处理。如果消息消费失败本身具备回滚机制，则消息重试也就没有副作用了。</li><li>为了尽可能避免程序异常退出导致的消息重试，需要在消费者代码中做好优雅退出处理。</li><li>针对一些无法做到完全幂等的操作，至少要做到终止消息的消费并进行告警。比如锁定库存的操作，如果通过业务流水号已经成功锁定了库存，再次触发锁库存操作的话，如果无法做到幂等性处理，那么至少要在消息消费过程中触发异常（如因主键冲突导致消费异常等），并终止消息的消费，以避免重复消费产生的副作用。</li><li>在 #3 做好的前提下，做好消息的消费监控，发现消息重试不断失败的时候，手动做好 #1 的回滚，使得下次重试消费成功。</li></ol><h3 id="小结-5"><a class="anchor" href="#小结-5">#</a> 小结</h3><p>当我们在使用 RocketMQ 进行消息处理时，消息的幂等性是一个非常重要的问题。本文通过抽象出通用组件的方式，<strong><font color="red">实现了 RestAPI 和 RocketMQ 的幂等处理 </font></strong>。</p><p>同时也发现，幂等性并不是一个银弹，不同的业务场景需要不同的幂等处理策略。</p><p>但是，通过一些基本的处理策略，如 <font color="red">优雅退出、回滚处理、消费监控 </font>等，我们能够大大减少消息重复的问题，提高消息消费的稳定性和可靠性。</p><p>在实际开发中，需要结合具体业务场景，选择合适的幂等处理策略，并且在每次新的场景出现时，都需要仔细考虑是否需要重新审视幂等性的处理方式。</p><p>上文中的代码以及实现已在基础架构模块中定义，详情查看：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240318204452842.png" alt="image-20240318204452842"></p><h2 id="如何为明文的敏感数据进行加密改造"><a class="anchor" href="#如何为明文的敏感数据进行加密改造">#</a> 如何为明文的敏感数据进行加密改造</h2><p>文章以敏感数据安全性存储为背景，讲述 ShardingSphere 完成数据加密上线，以及后续的业务系统加密改造的过程。</p><p>以下如无特殊说明，ShardingSphere-JDBC Starter 版本为 4.1.1。</p><h3 id="业务背景"><a class="anchor" href="#业务背景">#</a> 业务背景</h3><p>事情的起因是集团对于敏感数据安全的重视，需要数据库中存在的<font color="red">敏感数据进行加密改造</font>，最终效果要达到 <strong>数据库中不存在敏感明文数据</strong>。</p><p>不同公司业务差异性，敏感数据的定义不尽相同。不过，基础字段的加密规则大致是相通的。</p><ul><li>强制加密：手机号、证件号、邮箱、密码、人脸识别、指纹等。</li><li>建议加密：用户姓名、住址、坐标、银行卡等。</li></ul><h3 id="技术方案选型"><a class="anchor" href="#技术方案选型">#</a> 技术方案选型</h3><p>如果要让各业务方快速推进数据加密，需要保证效率、通用以及不出错的前提下完成。</p><p>进行技术选型阶段时，面临一个问题：选择自己造轮子还是使用比较成熟的开源组件。</p><h4 id="1-shardingsphere"><a class="anchor" href="#1-shardingsphere">#</a> 1、ShardingSphere</h4><p>Apache ShardingSphere 是一套开源的<font color="red">分布式数据库</font>解决方案组成的生态圈，它由 JDBC、Proxy 和 Sidecar（规划中）这 3 款既能够独立部署，又支持混合部署配合使用的产品组成。</p><p>其中的 JDBC 组件支持数据分片、分布式事务、读写分离、数据加密等，可以通过配置指定需要使用的功能。</p><h5 id="加密原理"><a class="anchor" href="#加密原理">#</a> 加密原理</h5><p><font color="red">ShardingSphere 通过重写 JDBC 组件对用户输入的 SQL 进行解析</font>，并根据提供的加密规则对 SQL 进行重写，将原文数据（可选）及密文数据存储到数据库表。</p><p>在用户查询数据时，根据自定义配置选择按照明文数据查询或者密文数据查询，但是最终都会将原始数据返回给用户。</p><p>在此查询过程中，<font color="red">框架屏蔽了数据的加密处理</font>，使用户无感 SQL 解析、数据加密、数据解密等处理过程。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414152017.png" alt="image.png"></p><h5 id="加密规则"><a class="anchor" href="#加密规则">#</a> 加密规则</h5><p>ShardingSphere 对于数据加密的配置分为四部分：</p><ul><li><p>数据源配置：没有使用加密前，项目中数据源比如说 druid 或者 hikari，是直接通过 Spring 加载到 IOC 容器中；使用了数据加密之后，会<font color="red">由 ShardingSphere 将配置的数据源包装一层再交给 Spring 管理</font>。</p></li><li><p>加密器配置：指的是<font color="red">需要加密的字段通过什么加密方式进行加密</font>。ShardingSphere 中内置了 <code>AES</code> 和 <code>MD5</code> 两种加密算法，另外也可以通过提供的 SPI 机制加载自定义加密器。</p></li><li><p>脱敏表配置：实现了用户无感知加密功能，重点包含三个属性</p><ul><li><font color="cornflowerblue">logicColumn（逻辑列）</font>：虚拟存在的列（必填），是面向开发者在程序中编写 SQL 的列。和 plainColumn 以及 cipherColumn 保持一种映射关系，<font color="red">可以屏蔽底层对明文数据或者密文数据的加密处理</font>。</li><li><font color="cornflowerblue">plainColumn（明文列）</font>：真实存在的列（选填），存储明文数据。</li><li><font color="cornflowerblue">cipherColumn（密文列）</font>：真实存在的列（选填），存储密文数据。</li></ul></li><li><p>查询属性配置（query.with.cipher.column）：<font color="red">决定是否使用密文列查询</font>，默认为 True。当数据库中同时存储了明文列以及密文列时，该属性决定了是查询明文列的数据直接返回，还是查询密文列再通过 ShardingSphere 解密后返回。</p></li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414152251.png" alt="image.png"></p><h5 id="举例说明"><a class="anchor" href="#举例说明">#</a> 举例说明</h5><p>数据库中存在一张 t_user 表，存在明文列 pwd_plain 和密文列 pwd_cipher，同时在脱敏配置中设置逻辑列 pwd，配置如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414153450.png" alt="image.png"></p><p>假设对 t_user 有新增操作，SQL 语句： <code>INSERT INTO t_user SET pwd = '123'</code> 。</p><p>数据表里的字段是 pwd_plain 和 pwd_cipher，通过 ShardingSphere 在底层进行了映射，如下图所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414153609.png" alt="image.png"></p><p>总结起来，<font color="red">ShardingSphere 相当于一个转换层，对用户的 SQL 进行解析，遇到需要加密的字段，根据加密规则进行重写 SQL，最终提交重写后的 SQL 到数据库执行</font>。</p><p>优点：</p><ol><li>屏蔽用户对于加密的过程，项目除了提供必要的加密配置之外，<font color="red">代码基本零改造</font>。</li><li>内部提供了 AES 和 MD5 两种加密算法以及提供了 <font color="red">SPI 自定义加密算法</font>。</li><li><font color="red">支持字段级别的加密算法，灵活切换</font>。</li><li>支持明文字段、密文字段的切换查询，帮助业务实现 <font color="red">安全、透明化的上线迁移</font>。</li></ol><p>缺点：</p><ol><li>业务 SQL 不能完全兼容子查询操作。</li><li>重写的 SQL 解析器遇到 order、over 等关键字报错。</li></ol><p>子查询不兼容和关键字报错可能会在 5.x 版本得到解决，只不过还暂未发布 5.x Release 版本。</p><h4 id="2-自定义开发"><a class="anchor" href="#2-自定义开发">#</a> 2、自定义开发</h4><p>如果选择自己造轮子，实现逻辑与 ShardingSphere 的流程基本一致，解析用户的行为并进行修改，实现方式并不固定。</p><p>优点：</p><ol><li><font color="red">代码实现起来较为简洁</font>，减少了开源组件的大量依赖。</li><li><font color="red">不存在 SQL 兼容问题</font>，仅是修改 SQL 中需要加解密的字段，不涉及 SQL 解析器的开发。</li><li><font color="red">性能良好</font>，相对于开源组件的大量封装以及 SQL 解析，拦截器只有加密算法的必要开销。</li></ol><p>缺点：</p><ol><li><font color="red">对业务侵入性高</font>，在加密功能上线切换阶段，需要频繁修改 SQL 语句（取决实现方式）。</li><li>从开始进行数据加密，最终数据库全部加密，需要一个 <font color="red">很长的开发和测试周期</font>。</li><li>如果业务有耦合关联，数据库加密可能会出现：<font color="red">上线一起上，有问题一起回滚的情况</font>。</li></ol><p>技术水准和开发时间满足的情况下，也有不少公司选择了自己开发数据加密组件。</p><p>考虑到业务侵入、耦合和开发周期这几点因素，<strong>决定放弃自己造轮子，选择使用 ShardingSphere 作为数据加密安全框架</strong>。</p><h3 id="数据加密实施"><a class="anchor" href="#数据加密实施">#</a> 数据加密实施</h3><p>ShardingSphere 数据加密结合公司内部的一些流程，分为 <strong>准备、开发、清洗、切换、最终</strong> 几个阶段执行，目的是稳定进行，把数据加密线上出错的可能性降到最低。</p><p>Medbanks 在原 Starter 功能不变的基础上，对 sharding-jdbc-spring-boot-starter 包装了一层。</p><ol><li><font color="red">密钥统一管理</font>，对加密需要的密钥与应用程序配置分离，密钥根据数据库分配。</li><li>提供代码中通过程序调用<font color="red">加解密 Util 包</font>，适配一些三方服务。</li><li>适配 SpringBoot 项目中<font color="red">连接多个数据源加密</font>。</li><li><font color="red">开发数据清洗程序</font>，提供业务方通用且便捷的使用。</li></ol><p>新应用和已在线上运行的应用会有所区别，新应用相对来说会简单很多，下面的流程如无说明，默认已上线应用。</p><p><strong>已上线应用的数据加密执行流程</strong>：</p><ol><li>准备阶段：统计数据库表<font color="red">需要加密存储的字段</font>以及制定<font color="red">加密改造的周期表</font>。</li><li>开发阶段：<font color="red">Starter 引入项目</font>以及<font color="red">添加明文字段对应的密文字段</font>。</li><li>清洗阶段：对数据库表中<font color="red">历史明文数据执行清洗流程</font>，清洗过程中<font color="red">填充表里所有密文列</font>。</li><li>切换阶段：修改配置<font color="red">按照密文列进行查询</font>。</li><li>最终完成：以上步骤执行完成后，<font color="red">删除表中明文字段</font>，真正完成数据加密。</li></ol><h4 id="准备阶段"><a class="anchor" href="#准备阶段">#</a> 准备阶段</h4><p><font color="red">统计加密字段信息</font>：业务线、应用系统、数据库、加密表、表行数、需要加密的字段、密文列名称、加密类型、是否包含 Canal、ES、DataX 同步、表中字段是否设置 ON UPDATE CURRENT_TIMESTAMP、其它系统是否存在依赖、系统负责人。</p><p><font color="red">制定数据加密的改造登记表、执行周期表</font>：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414155149.png" alt="image.png"></p><center>（数据加密的改造登记表、执行周期表）</center><p>改造周期分为几个阶段：<strong>开发加密</strong>、<strong>数据清洗</strong>、<strong>切换密文列</strong>、<strong>删除明文字段</strong>。</p><h4 id="开发阶段"><a class="anchor" href="#开发阶段">#</a> 开发阶段</h4><blockquote><p>将 ShardingSphere Starter 引入项目，在数据库中<font color="red">添加对应的密文字段</font>。</p></blockquote><p>在开发阶段，开发同学<font color="red">需要扫描所有自定义 SQL，着重查看 SQL 中是否包含子查询操作</font>，尽量让测试同学全方面覆盖功能测试。</p><p>加密后的数据长度和原始数据长度并不一致，<font color="red">需要根据原始数据长度，推算出密文列的字段长度</font>。</p><ol><li>数值 + 英文类型，16 个字符以下（不包括 16 字符），加密后字符串长度 24（数值过少影响加密长度）。</li><li>数值 + 英文类型，大于 16 字符小于 32 字符（不包括 32 字符），加密后字符串长度 44 字符。</li><li>中文类型，16 个字符以下（不包括 16 字符），加密后字符串长度 64（字符过少影响加密长度）。</li><li>中文类型，大于 16 字符小于 32 字符（不包括 32 字符），加密后字符串长度 88 字符。</li></ol><h4 id="清洗阶段"><a class="anchor" href="#清洗阶段">#</a> 清洗阶段</h4><blockquote><p>对数据库表中 <strong>历史的明文数据执行清洗流程</strong>，清洗过程中<font color="red">填充表中所有密文列</font>。</p></blockquote><p>最初开发数据清洗程序时，有考虑很多的功能特性，比如说：在线清洗、离线清洗、单节点清洗、分片清洗等。</p><p>千里之行始于足下，接着开发了 <font color="gree">1.0 版本单节点在线清洗</font>。</p><p>清洗 Starter 通过 SpringBoot Web 对外提供了两个 HTTP 接口，启动清洗和停止清洗，最小的粒度为某个数据库下某张表。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414155913.png" alt="image.png"></p><p>列下数据加密程序支持的一些功能，方便下面介绍的时候贯彻起来：</p><ol><li>业务方引入清洗 Starter，调用启动或者停止接口即可完成表数据清洗。</li><li>实时查看当前清洗任务进度以及清洗状态。</li><li>支持清洗进度留档，兼容人为停止或者应用重启等操作。</li></ol><p>考虑到大表千万级别数据，数据清洗不能很快完成，为了更好监控当前程序的清洗进度，<font color="red">在清洗过程中实时同步清洗运行时状态</font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414160201.png" alt="image.png"></p><p>运行时数据包括：清洗任务状态、需要清洗的总行数、已清洗的行数、当前清洗最大主键值。</p><p>清洗程序主要是以主键 ID 为关键行为，进行分页查询、填充密文列和批量修改操作，具体逻辑如下：</p><ol><li>获取需要数据清洗的数据库名称、表名称以及清洗所需要的字段；</li><li>查询该表需要清洗的总行数，通过分页循环的形式获取一批数据；</li><li><font color="red">分页获取数据进行填充密文列</font>，主键 ID 为条件进行批量修改；</li><li>同步 Redis 数据清洗进度，所有数据清洗完成后结束循环；</li><li>过程中如果触发停止操作，保留进度后优雅结束循环。</li></ol><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414160350.png" alt="image.png"></p><p>生产上 2C 容器单线程每分钟清洗数据在 70 - 120 w 上下，具体性能根据单批清洗的数量而定。数据库 4C 8G CPU 负载 20% 左右，JVM 内存分布以及 GC 回收情况正常，不会对业务产生影响。</p><p>事实证明大多数场景下，最简单直接的程序也是最有效的，所以清洗程序 1.0 版本设计是开始也是结束。</p><h4 id="切换阶段"><a class="anchor" href="#切换阶段">#</a> 切换阶段</h4><blockquote><p>修改配置，<font color="red">按照密文列进行查询</font>。</p></blockquote><p>在切换前需要查看明文列上是否存在索引，如果存在则需要为密文列也添加索引。</p><p>添加索引时注意表的大小，表数据量百万或者千万级别，会对线上业务有影响，应该在业务无访问量时进行。</p><p>接下来设置 <code>spring.shardingsphere.props.query.with.cipher.column</code> 为 true，后续关于加密字段的查询会按照密文 value 查询。</p><p>需要注意的是，<strong>同一个系统切换密文列查询要保持一致</strong>。假设项目中包含三张表，切换时要保证全部已将数据清洗完成。</p><p>如果切换到密文列遇到临时突发问题，可以将设置再切换为 false，数据加密再次按照明文列查询。</p><h4 id="最终完成"><a class="anchor" href="#最终完成">#</a> 最终完成</h4><blockquote><p>切换到密文列稳定后，<font color="red">删除明文列</font>，达到一个最终完成的效果。</p></blockquote><p>如果表涉及到 Canal 增量同步或者 DataX 的数据同步，需要修改 Canal 监听客户端代码以及 DataX 脚本，保持字段对齐密文列。</p><p>执行删除操作前，对数据库表进行备份，保持良好的容错习惯。迁移后对线上环境进行验证，确保无问题后该项目加密工作正式完成。</p><h3 id="问题解决方案"><a class="anchor" href="#问题解决方案">#</a> 问题解决方案</h3><p>推行业务方数据加密时，发现了一些不太友好的兼容问题，在这里分享下解决方案。</p><h4 id="sql-解析器预热"><a class="anchor" href="#sql-解析器预热">#</a> SQL 解析器预热</h4><p>项目启动后，使用 ShardingSphere 加密数据源执行 SQL，发现前两条执行的时间差异比较大。</p><p>通过源码得知，<strong>第一次解析 SQL 时会使用工厂类创建单例对象，第二次解析时就不用再创建了</strong>。</p><p>所以<strong>可以在项目初始化时实例化相关对象，减少第一次预热时间</strong>，节省大概 500 ms 时间。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414161131.png" alt="image.png"></p><h4 id="关键字不识别"><a class="anchor" href="#关键字不识别">#</a> 关键字不识别</h4><p><strong>ShardingSphere 对于某些关键字不会识别</strong>，而且不兼容的关键字并非单个数据库的。如果执行 SQL 包含这些关键字的话，会抛出错误。</p><p><code>mismatched input 'xxx' expecting &#123;'!', '~', '+', '-', '.', '(', '&#123;', '?', '@', TRUNCATE, POSITION...</code></p><p>因为不明确不支持的字段属于哪个数据库，不能按照单个数据库的关键字扫描。所以在开发的时候用了一种笨方法，解决方案如下：</p><ol><li>DB 中创建 <code>encrypt_check</code> 临时表，字段仅一个主键即可；</li><li>查询 DB 下所有表，循环遍历表的所有字段，执行 3、4、5 流程；</li><li>将字段插入 <code>encrypt_check</code> 临时表，执行 <code>select 字段 from encrypt_check</code> ；<ol><li>不报错证明兼容，删除 <code>encrypt_check</code> 表的该字段，继续循环；</li><li>报错的话，将其添加到不兼容集合 <code>Map&lt;表名, List&lt;字段&gt;&gt;</code> ，并删除 <code>encrypt_check</code> 表的该字段，继续循环；</li></ol></li><li>待所有表的所有字段循环完成后，返回不兼容集合 。</li></ol><p>如果扫描 DB 发现有关键字，SQL 语句中使用 `` 修饰，Mybatis-Plus 应用可以在实体对象上添加 <code>@TableField</code> 注解解决。扫描程序流程图如下所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414161620.png" alt="image.png"></p><h4 id="sql-中的不兼容项"><a class="anchor" href="#sql-中的不兼容项">#</a> SQL 中的不兼容项</h4><p>ShardingSphere 的 SQL 解析内核针对的并不仅是包含加密字段的 SQL，而是整个项目。</p><p>所以<strong>项目中如果出现下述的 SQL，需要进行改写</strong>。官网上明确说明的比较和计算类操作不再重复举例。</p><p>示例一</p><p>问题描述：不支持查询列中包含子查询，子查询无法查询到值。</p><p>解决方案：<font color="red">将子查询在 SQL 中优化，或者在代码中查询并替换值</font>。</p><p><code>select t.id, (select ue.email from user_email ue where ue.id = t.id) as email from t_user t</code></p><p>示例二</p><p>问题描述：不支持返回列中使用 * 号搭配子查询，查询有记录返回，但是记录无法进行映射，返回到应用里记录全部为 null。</p><p>解决方案：<font color="red">* 号替换为具体字段</font>。</p><p><code>select t.* from (select id, pwd from t_user) t</code></p><p>示例三</p><p>问题描述：DISTINCT 无法搭配 FROM 子查询，报错：Can not find owner from table。</p><p>解决方案：<font color="red">FROM 后子查询替换，或者将 DISTINCT 替换为 GROUP BY</font>。</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token keyword">distinct</span> t<span class="token punctuation">.</span>id</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> t_user <span class="token keyword">where</span> del_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> t</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">inner</span> <span class="token keyword">join</span> user_enail ue</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">on</span> ue<span class="token punctuation">.</span>id <span class="token operator">=</span> t<span class="token punctuation">.</span>id</pre></td></tr></table></figure><p>示例四</p><p>问题描述：UNION 或 UNION ALL 上下 SQL 结果集不能包含括号。</p><p>解决方案：<font color="red">删除 SQL 结果集的括号</font>。</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_user <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">union</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_user <span class="token punctuation">)</span></pre></td></tr></table></figure><p>示例五</p><p>问题描述：Mybatis &lt;forech&gt; 形式拼接字符串批量提交或修改操作，ShardingSphere 无法为密文列赋值。</p><p>解决方案：<font color="red">修改为 Mybatis-Plus 批量提交的形式，或者切换 Mybatis 批处理执行器</font>。</p><p>示例六</p><p>问题描述：Mybatis-Plus（ 3.4.2 版本）包含 binary 关键字执行分页 SQL 报错： <code>java.lang.xxx cannot be cast to java.lang.xxx</code> ；</p><p>ShardingSphere 在进行 SQL 解析环节会为分页 SQL 找到 offset 和 limit，而 Mybatis-Plus 在 current 为 1 时，默认不拼接 offset，导致 ShardingSphere 解析出错。</p><p>解决方案：重写分页插件 MySqlDialect，current 为 1 也执行 offset 拼接操作。</p><p><code>select * from t_user where binary user_name = ? LIMIT ?</code></p><p>SQL 中的不兼容项总结</p><p>上面大部分问题同出一辙，<strong>ShardingSphere 不能很好兼容子查询、结果集</strong>，其余 SQL 暂时没有发现问题；所以在项目引入加密时，着重注意带子查询的语句。</p><h3 id="小结-6"><a class="anchor" href="#小结-6">#</a> 小结</h3><p>选择 ShardingSphere 作为数据加密方案后，在一定程度上提高了业务系统接入加密的效率，节省了人员投入的成本，快节奏且稳定的完成了敏感数据改造的落地。</p><p>这里总结下方案落地的心得：</p><ol><li>无论上线任何中间件产品，先去网上<font color="red">搜索不兼容项和缺点</font>。如果是 GitHub 开源项目，多看看 Issue，会有很大的帮助。</li><li>上线前要做好<font color="red">充分且全面的测试</font>，最好能考虑到性能、JVM、兼容性等方面。</li><li><font color="red">不同业务线项目的上线难度是不一样的</font>，负责推广的技术需要在开发、测试阶段将可能出现的问题发现及解决。</li><li>要有全局意识，难点往往体现在细枝末节的地方。拿 ShardingSphere 推广业务方使用来说，负责的项目涉及到 DataX、Canal、ES 适配，考虑不到就会出现问题。</li></ol><p>最后，没有任何一款开源软件能做到 “完美无瑕”，尽量在技术方案调研期间把可能出现的问题考虑进去，祝好。</p><h2 id="缓存击穿之双重判定锁如何优化性能"><a class="anchor" href="#缓存击穿之双重判定锁如何优化性能">#</a> 缓存击穿之双重判定锁如何优化性能？</h2><h3 id="缓存击穿的概念以及常见解决方案"><a class="anchor" href="#缓存击穿的概念以及常见解决方案">#</a> 缓存击穿的概念以及常见解决方案</h3><p>首先要清楚，什么是缓存击穿？如何解决缓存击穿？这部分可以参考 <a href="../../database/redis/Redis-JavaGuide.md">Redis-JavaGuide 笔记</a>中关于 Redis 生产问题中对缓存击穿的介绍。</p><p>然后，再考虑如何优化缓存击穿的解决方案。那我们可以从分布式锁解决方案上下文章，如何通过分布式锁完成缓存击穿场景解决方案？</p><h3 id="如何解决缓存击穿问题"><a class="anchor" href="#如何解决缓存击穿问题">#</a> 如何解决缓存击穿问题？</h3><h4 id="方案一查询缓存不存在时请求数据库"><a class="anchor" href="#方案一查询缓存不存在时请求数据库">#</a> 方案一：查询缓存不存在时，请求数据库</h4><blockquote><p>其实就是不采用任何解决方法。</p></blockquote><p>第一版，查询数据缓存是否存在，不存在的话就请求数据库，数据库存在则把当前数据回写到缓存中。</p><p>该方案的问题比较明显，如果缓存过期或被删除，大量请求就会全部请求到数据库，导致数据库压力暴涨，也就是<font color="red">缓存击穿问题</font>。</p><p>伪代码如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">selectTrain</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token comment">// 查询缓存</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token class-name">String</span> cacheData <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cacheData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token comment">// 若缓存中不存在，则请求数据库</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">String</span> dbData <span class="token operator">=</span> trainMapper<span class="token punctuation">.</span><span class="token function">selectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>dbData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	        <span class="token comment">// 将数据写入缓存</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    		cahce<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> dbData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            cacheData <span class="token operator">=</span> dbData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">return</span> cacheData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="思路二分布式锁"><a class="anchor" href="#思路二分布式锁">#</a> 思路二：分布式锁</h4><blockquote><p>对应缓存击穿的第二种常见解决方法。</p></blockquote><p>在获取数据时，<strong>如果缓存上不存在，就使用分布式锁</strong>（如 Redis 的分布式锁）来<font color="red">控制同时只有一个请求可以去后端获取数据，其他请求需要等待锁释放</font>。这样可以防止多个请求同时穿透到后端存储。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414215153.png" alt="image.png"></p><p>在原有基础上继续改进，伪代码如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">selectTrain</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token class-name">String</span> cacheData <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cacheData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token comment">// 若缓存中不存在，则先获取分布式锁，再查询数据库</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token function">getLock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token class-name">String</span> dbData <span class="token operator">=</span> trainMapper<span class="token punctuation">.</span><span class="token function">selectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>dbData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        		cahce<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> dbData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                cacheData <span class="token operator">=</span> dbData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">return</span> cacheData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这种方案有效地避免了缓存穿透问题，因为只有一个线程能够在同一时间内查询数据库，其他线程需要等待，不会同时穿透到后端存储系统。</p><p><font color="red">但是可能造成无用的性能浪费，且会造成用户响应时间边长，接口吞吐量下降等问题</font>。假如 100w 的请求读取一个缓存，100w 的请求全部卡在 lock.lock 获取分布式锁处，只有一个线程会执行逻辑请求数据库并放入缓存。问题来了，因为<font color="red">剩下的所有请求还是会继续请求数据库</font>，大家读一下上面的伪代码就明白了。这会造成两个实际的问题：</p><ol><li>全部用户获取锁后查询数据库，会对数据库造成无用的性能浪费，因为这 100w 的请求，只有第一次是有效的。</li><li>查询数据库会造成用户响应时间变长，接口吞吐量下降。</li></ol><h4 id="思路三双重判定锁"><a class="anchor" href="#思路三双重判定锁">#</a> 思路三：双重判定锁</h4><p>双重判断：<strong>获取锁后，在查询数据库之前，再次检查一下缓存中是否存在数据</strong>。</p><ul><li>如果缓存中存在数据，就直接返回</li><li>如果不存在，才继续执行查询数据库的操作</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414215915.png" alt="image.png"></p><p>伪代码如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">selectTrain</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token class-name">String</span> cacheData <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cacheData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token function">getLock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	        <span class="token comment">// 获取分布式锁后，在查询数据库前，再次查询缓存</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            cacheData <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cacheData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	            <span class="token comment">// 若第二次查询缓存时仍不存在，则查询数据库</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token class-name">String</span> dbData <span class="token operator">=</span> trainMapper<span class="token punctuation">.</span><span class="token function">selectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>dbData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            		cahce<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> dbData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    cacheData <span class="token operator">=</span> dbData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">return</span> cacheData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>下面是这种解决方案的一般步骤：</p><ol><li>获取锁：在查询数据库前，首先尝试获取一个分布式锁。只有一个线程能够成功获取锁，其他线程需要等待。</li><li>双重判断：再次查询缓存中是否存在数据。</li><li>查询数据库：如果双重判断确认数据确实不存在于缓存中，那么就执行查询数据库的操作，获取数据。</li><li>写入缓存：获取到数据后，将数据写入缓存，并设置一个合适的过期时间，以防止缓存永远不会被更新。</li><li>释放锁：最后，释放获取的锁，以便其他线程可以继续使用这个锁。</li></ol><h3 id="小结-7"><a class="anchor" href="#小结-7">#</a> 小结</h3><p>本文深入探讨了缓存击穿问题以及解决方案。首先，我们了解了缓存击穿是指一个缓存中的数据因为某种原因（通常是缓存中的数据过期或者被删除），在短时间内遭受大量的请求，从而直接查询数据库，对系统性能造成了巨大的压力。然后，我们介绍了解决缓存击穿问题的一种有效方式 ——<strong> 分布式锁</strong>，以及分布式互斥锁的升级版本 ——<strong><font color="#B32015">双重判定锁</font></strong>。</p><p>总结一下：</p><ul><li>缓存击穿：是指某些请求查询缓存中不存在的数据，导致大量请求直接穿透到后端数据库，对系统性能造成严重影响。</li><li>分布式锁：是一种解决缓存击穿的有效方式。它通过在查询缓存不存在后尝试获取锁，只有一个线程能够成功获取锁，其他线程需要等待。这确保了只有一个线程可以查询数据库，避免了大规模的穿透。</li><li>双重判定锁：是分布式互斥锁的升级版本。<font color="red">它在获取锁后，再次检查缓存中是否存在数据</font>，以避免重复查询数据库。只有在确认缓存中不存在数据时，才继续查询数据库。</li></ul><p>这两种解决方案都能够有效地应对缓存击穿问题，但需要根据实际情况选择合适的方式。分布式锁适用于大多数场景，而双重判定锁则提供了更高的效率，适用于一些特定的场景。选择合适的解决方案，可以保护系统免受缓存击穿问题的困扰，提高性能和可靠性。</p><h2 id="缓存与数据库的一致性如何解决"><a class="anchor" href="#缓存与数据库的一致性如何解决">#</a> 缓存与数据库的一致性如何解决？</h2><h3 id="背景知识"><a class="anchor" href="#背景知识">#</a> 背景知识</h3><h4 id="引入缓存以提高读性能"><a class="anchor" href="#引入缓存以提高读性能">#</a> 引入缓存以提高读性能</h4><p>我们从最简单的场景开始讲起。</p><p>如果你的业务处于起步阶段，流量非常小，那无论是读请求还是写请求，<font color="red">直接操作数据库</font>即可，这时你的架构模型是这样的：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415151812.png" alt="image.png"></p><hr><p>但随着业务量的增长，你的项目请求量越来越大，这时如果每次都从数据库中读数据，那肯定会有性能问题。</p><p>这个阶段通常的做法是，<font color="red">引入「缓存」来提高读性能</font>，架构模型就变成了这样：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415151933.png" alt="image.png"></p><p>当下优秀的缓存中间件，当属 Redis 莫属，它不仅性能非常高，还提供了很多友好的数据类型，可以很好地满足我们的业务需求。</p><hr><p>但引入缓存之后，你就会面临一个问题：<strong>之前数据只存在数据库中，现在要放到缓存中读取，具体要怎么存呢？</strong></p><p>最简单直接的方案是<font color="red">「全量数据刷到缓存中」</font>：</p><ul><li>数据库的数据，全量刷入缓存（不设置失效时间）</li><li>写请求只更新数据库，不更新缓存</li><li>启动一个定时任务，定时把数据库的数据，更新到缓存中</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415152024.png" alt="image.png"></p><p>这个方案的优点是，所有读请求都可以直接「命中」缓存，不需要再查数据库，性能非常高。</p><p>但缺点也很明显，有 2 个问题：</p><ol><li><strong>缓存利用率低</strong>：不经常访问的数据，还一直留在缓存中</li><li><strong>数据不一致</strong>：因为是「定时」刷新缓存，缓存和数据库存在不一致（取决于定时任务的执行频率）</li></ol><p>所以，这种方案一般更适合业务「体量小」，且对数据一致性要求不高的业务场景。</p><p>那如果我们的业务体量很大，怎么解决这 2 个问题呢？</p><h4 id="缓存利用率-数据一致性问题"><a class="anchor" href="#缓存利用率-数据一致性问题">#</a> 缓存利用率 &amp; 数据一致性问题</h4><p>先来看第一个问题，如何提高缓存利用率？</p><p>想要缓存利用率「最大化」，我们很容易想到的方案是，<font color="red">缓存中只保留最近访问的「热数据」</font>。但具体要怎么做呢？</p><p>我们可以这样优化：</p><ul><li>写请求依旧只写数据库</li><li>读请求先读缓存，如果缓存不存在，则从数据库读取，并重建缓存</li><li>同时，写入缓存中的数据，<font color="red">都设置失效时间</font></li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415153155.png" alt="image.png"></p><p>这样一来，缓存中不经常访问的数据，随着时间的推移，都会逐渐「过期」淘汰掉，最终缓存中保留的，都是经常被访问的「热数据」，缓存利用率得以最大化。</p><hr><p>再来看数据一致性问题。</p><p>要想保证缓存和数据库「实时」一致，那就不能再用定时任务刷新缓存了。</p><p>所以，<font color="red">当数据发生更新时，我们不仅要操作数据库，还要一并操作缓存</font>。具体操作就是，修改一条数据时，不仅要更新数据库，也要连带缓存一起更新。</p><p>但数据库和缓存都更新，又存在先后问题，那对应的方案就有 2 个：</p><ol><li>先更新缓存，后更新数据库【<a href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E5%85%88%E5%86%99%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案一：先写缓存，再写数据库</a>】</li><li>先更新数据库，后更新缓存【<a href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%86%99%E7%BC%93%E5%AD%98">方案二：先写数据库，再写缓存</a>】</li></ol><p>哪个方案更好呢？</p><p>先不考虑并发问题，正常情况下，无论谁先谁后，都可以让两者保持一致，但现在我们需要重点考虑「异常」情况。因为操作分为两步，那么就很有<font color="red">可能存在「第一步成功、第二步失败」的情况发生，会对业务造成影响</font>。这 2 种方案我们一个个来分析：</p><p><strong>1) 先更新缓存，后更新数据库</strong></p><p>如果缓存更新成功了，但数据库更新失败，那么此时缓存中是最新值，但数据库中是「旧值」。</p><p>虽然此时读请求可以命中缓存，拿到正确的值，但是，一旦缓存「失效」，就会从数据库中读取到「旧值」，重建缓存也是这个旧值。</p><p>这时用户会发现自己之前修改的数据又「变回去」了，对业务造成影响。</p><p><strong>2) 先更新数据库，后更新缓存</strong></p><p>如果数据库更新成功了，但缓存更新失败，那么此时数据库中是最新值，缓存中是「旧值」。</p><p>之后的读请求读到的都是旧数据，只有当缓存「失效」后，才能从数据库中得到正确的值。</p><p>这时用户会发现，自己刚刚修改了数据，但却看不到变更，一段时间过后，数据才变更过来，对业务也会有影响。</p><p>可见，<font color="red">无论谁先谁后，但凡后者发生异常，就会对业务造成影响</font>。那怎么解决这个问题呢？</p><p>别急，后面我会详细给出对应的解决方案。</p><hr><p>我们继续分析，除了操作失败问题，还有什么场景会影响数据一致性？</p><p>这里我们还需要重点关注：<strong>并发问题</strong>。</p><h4 id="并发引起的一致性问题"><a class="anchor" href="#并发引起的一致性问题">#</a> 并发引起的一致性问题</h4><p>详情可查看「<a href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E5%85%88%E5%86%99%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案一：先写缓存，再写数据库</a>」和「<a href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%86%99%E7%BC%93%E5%AD%98">方案二：先写数据库，再写缓存</a>」。</p><hr><p>除此之外，我们从「缓存利用率」的角度来评估「<a href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E5%85%88%E5%86%99%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案一：先写缓存，再写数据库</a>」，也是不太推荐的。</p><p>这是因为每次数据发生变更，都「无脑」更新缓存，但是缓存中的数据不一定会被「马上读取」，这就会<font color="red">导致缓存中可能存放了很多不常访问的数据，浪费缓存资源</font>。</p><p>而且很多情况下，写到缓存中的值，并不是与数据库中的值一一对应的，很有可能是先查询数据库，再经过一系列「计算」得出一个值，才把这个值才写到缓存中。</p><p>由此可见，<font color="red">这种「更新数据库 + 更新缓存」的方案缓存利用率不高</font>。</p><p>所以此时我们需要考虑另外一种方案：<strong>删除缓存</strong>。</p><h4 id="删除缓存也不一定保证一致性"><a class="anchor" href="#删除缓存也不一定保证一致性">#</a> 删除缓存也不一定保证一致性</h4><p>删除缓存对应的方案也有 2 种：</p><ol><li>先删除缓存，后更新数据库【<a href="#%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案三：先删除缓存，再写数据库</a>】</li><li>先更新数据库，后删除缓存【<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>】</li></ol><p>经过前面的分析我们已经得知，<font color="red">但凡「第二步」操作失败，都会导致数据不一致</font>。</p><hr><p>这里我们重点来看「并发引起的数据不一致」问题。详情可见上面两篇超链接文章。得出的结论就是：「<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>」<font color="red">在现实中的绝大部分情况下是可以保证数据一致性的</font>。</p><p>所以，我们应该采用这种方案，来操作数据库和缓存。</p><p>好，解决了并发问题，我们继续来看前面遗留的，<strong>第二步执行「失败」导致数据不一致的问题</strong>。</p><h4 id="如何保证缓存和数据库的两步操作都执行成功"><a class="anchor" href="#如何保证缓存和数据库的两步操作都执行成功">#</a> 如何保证缓存和数据库的两步操作都执行成功</h4><p>无论是先操作缓存，还是先操作数据库，但凡后者执行失败了，我们就可以发起<strong>重试</strong>，尽可能地去做「补偿」。</p><p>那这是不是意味着，只要执行失败，我们「无脑重试」就可以了呢？</p><p>答案是否定的。现实情况往往没有想的这么简单，<font color="red">失败后不能立即重试</font>的原因在于：</p><ul><li>立即重试很大概率「还会失败」</li><li>「重试次数」设置多少才合理？</li><li>重试会一直「占用」这个线程资源，无法服务其它客户端请求</li></ul><p>看到了么，虽然我们想通过重试的方式解决问题，但这种「同步」重试的方案依旧不严谨。</p><p>那更好的方案应该怎么做？</p><hr><p>答案是：<strong>异步重试</strong>。什么是异步重试？</p><p>其实就是<font color="red">把重试请求写到「消息队列」中</font>，然后由专门的消费者来重试，直到成功。</p><p>或者更直接的做法，为了避免第二步执行失败，我们<font color="red">也可以把操作缓存这一步直接放到消息队列中</font>，由消费者来操作缓存。</p><p>到这里你可能会问，写消息队列也有可能会失败啊？而且，引入消息队列，这又增加了更多的维护成本，这样做值得吗？</p><p>这个问题很好，但我们思考这样一个问题：如果在执行失败的线程中一直重试，还没等执行成功，此时如果项目「重启」了，那这次重试请求也就「丢失」了，那这条数据就一直不一致了。</p><p>所以，这里我们必须把重试或第二步操作放到另一个「服务」中，这个服务用「消息队列」最为合适。这是因为<font color="red">消息队列的特性正好符合我们的需求</font>：</p><ul><li><strong>可靠性</strong>：写到队列中的消息，成功消费之前不会丢失（重启项目也不担心）</li><li><strong>保证消息成功投递</strong>：下游从队列拉取消息，成功消费后才会删除消息，否则还会继续投递消息给消费者（符合我们重试的场景）</li></ul><p>至于写队列失败和消息队列的维护成本问题：</p><ul><li><strong>写队列失败</strong>：操作缓存和写消息队列，「同时失败」的概率其实是很小的</li><li><strong>维护成本</strong>：我们项目中一般都会用到消息队列，维护成本并没有新增很多</li></ul><p>所以，<strong><font color="red">为了确保两步都执行成功，引入消息队列来实现异步重试</font></strong>，是比较合适的。这时架构模型就变成了这样：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415161753.png" alt="image.png"></p><hr><p>那如果你确实不想<em>在应用中</em>去写消息队列，是否有更简单的方案，同时又可以保证一致性呢？</p><p>方案还是有的，这就是近几年比较流行的解决方案：<strong>订阅数据库的 Binlog（变更日志），再操作缓存</strong>【<a href="#%E6%96%B9%E6%A1%88%E5%85%AD%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E9%80%9A%E8%BF%87BinLog%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">方案六：先写数据库，再通过 BinLog 异步更新缓存</a>】。</p><p>具体来讲就是，我们的业务应用在修改数据时，「只需」修改数据库，无需操作缓存。那什么时候操作缓存呢？这就和数据库的「变更日志」有关了。</p><p>拿 MySQL 举例，<font color="red">当一条数据发生修改时，MySQL 就会产生一条 Binlog（变更日志），我们可以订阅这个 Binlog，拿到具体操作的数据，然后再根据这条数据，去删除对应的缓存</font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415163216.png" alt="image.png"></p><p>订阅 Binlog，目前也有了比较成熟的开源中间件，例如阿里的 canal，使用这种方案的优点在于：</p><ul><li><strong>无需考虑写消息队列失败情况</strong>：只要写 MySQL 成功，Binlog 肯定会有</li><li><strong>自动投递到下游消息队列</strong>：canal 自动把 Binlog「投递」给下游的消息队列</li></ul><p>当然，与此同时，我们需要投入精力去维护 canal 的高可用和稳定性。</p><p>如果你有留意观察很多数据库的特性，就会发现其实很多数据库都逐渐开始提供「订阅变更日志」的功能了，相信不远的将来，我们就不用通过中间件来拉取日志，自己写程序就可以订阅变更日志了，这样可以进一步简化流程。</p><blockquote><p>至此，我们可以得出结论，想要保证数据库和缓存一致性，<strong>推荐采用「先更新数据库，再删除缓存」的方式【<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>】，并配合「消息队列」或「订阅变更日志」的方式【<a href="#%E6%96%B9%E6%A1%88%E5%85%AD%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E9%80%9A%E8%BF%87BinLog%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">方案六：先写数据库，再通过 BinLog 异步更新缓存</a>】来做</strong>。</p></blockquote><h4 id="主从库延迟-延迟双删问题"><a class="anchor" href="#主从库延迟-延迟双删问题">#</a> 主从库延迟 &amp; 延迟双删问题</h4><p>到这里，还有 2 个问题，是我们没有重点分析过的。</p><p><strong>第一个问题</strong>，回顾前面讲到的「<a href="#%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案三：先删除缓存，再写数据库</a>」中因为并发导致的数据不一致场景。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415141012.png" alt="image.png"></p><hr><p><strong>第二个问题</strong>：是关于「读写分离 + 主从复制延迟」情况下，缓存和数据库一致性的问题。</p><p>在「<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>」下，「读写分离 + 主从库延迟」其实也会导致不一致：</p><ol><li>线程 A 更新主库 X = 2（原值 X = 1）</li><li>线程 A 删除缓存</li><li>线程 B 查询缓存，没有命中，查询「从库」得到旧值（从库 X = 1）</li><li>从库「同步」完成（主从库 X = 2）</li><li>线程 B 将「旧值」写入缓存（X = 1）</li></ol><p>最终 X 的值在缓存中是 1（旧值），在主从库中是 2（新值），也发生不一致。</p><hr><p>看到了么？这 2 个问题的核心在于：<strong>缓存都被回种了「旧值」</strong>。</p><p>最有效的解决办法就是：<strong>把缓存删掉</strong>。</p><p>但是，不能立即删，而是需要「延迟删」，这就是业界给出的方案：<strong><font color="#B32015">缓存延迟双删策略</font></strong>【<a href="#%E6%96%B9%E6%A1%88%E4%BA%94%EF%BC%9A%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案五：缓存双删 + 延迟队列</a>】。</p><p>按照延时双删策略，这 2 个问题的解决方案是这样的：</p><p><strong>解决「<a href="#%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案三：先删除缓存，再写数据库</a>」的第一个问题</strong>：在线程 A 删除缓存、更新完数据库之后，<font color="red">先「休眠一会」，再「删除」一次缓存</font>。</p><p><strong>解决「<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>」的第二个问题</strong>：线程 A 可以<font color="red">生成一条「延时消息」，写到消息队列中，消费者延时「删除」缓存</font>。</p><p>这两个方案的目的，都是为了把缓存清掉，这样一来，下次就可以从数据库读取到最新值，写入缓存。</p><p>但问题来了，这个「延迟删除」缓存，<font color="red">延迟时间到底设置要多久呢？</font></p><ul><li>问题 1：延迟时间要大于「主从复制」的延迟时间</li><li>问题 2：延迟时间要大于线程 B 读取数据库 + 写入缓存的时间</li></ul><p>但是，<strong>这个时间在分布式和高并发场景下，其实是很难评估的</strong> **。**</p><p>很多时候，我们都是凭借经验大致估算这个延迟时间，例如延迟 1-5s，只能尽可能地降低不一致的概率。</p><p>所以你看，采用这种方案，也只是尽可能保证一致性而已，极端情况下，还是有可能发生不一致。</p><p>所以实际使用中，我还是<strong>建议采用「<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>」的方案</strong>，同时，要尽可能地保证「主从复制」不要有太大延迟，降低出问题的概率。</p><h4 id="强一致很难实现"><a class="anchor" href="#强一致很难实现">#</a> 强一致很难实现</h4><p>看到这里你可能会想，这些方案还是不够完美，我就想让缓存和数据库「强一致」，到底能不能做到呢？</p><p>其实很难。</p><p>要想做到强一致，<font color="red">最常见的方案是 2PC、3PC、Paxos、Raft 这类一致性协议，但它们的性能往往比较差，而且这些方案也比较复杂，还要考虑各种容错问题</font>。</p><p>相反，这时我们换个角度思考一下，我们引入缓存的目的是什么？</p><p>没错，<strong>性能</strong>。</p><p>一旦我们决定使用缓存，那必然要面临一致性问题。<font color="red">性能和一致性就像天平的两端，无法做到都满足要求</font>。</p><p>而且，就拿我们前面讲到的方案来说，当操作数据库和缓存完成之前，只要有其它请求可以进来，都有可能查到「中间状态」的数据。</p><p>所以如果非要追求强一致，那必须要求所有更新操作完成之前期间，不能有「任何请求」进来。</p><p>虽然我们可以通过加「分布锁」的方式来实现，但我们要付出的代价，很可能会超过引入缓存带来的性能提升。</p><p><font color="red">所以，既然决定使用缓存，就必须容忍「一致性」问题，我们只能尽可能地去降低问题出现的概率</font>。</p><p>同时我们也要知道，缓存都是有「失效时间」的，<font color="red">就算在这期间存在短期不一致，我们依旧有失效时间来兜底，这样也能达到「最终一致」</font>。</p><h4 id="小结-8"><a class="anchor" href="#小结-8">#</a> 小结</h4><p>好了，总结一下这篇文章的重点。</p><p>1、想要提高应用的读性能，可以引入「<strong>缓存</strong>」来解决</p><p>2、引入缓存后，需要<font color="red">考虑缓存和数据库一致性问题</font>，可选的方案有：</p><ul><li>「<strong>更新数据库 + 更新缓存</strong>」方案：在「<strong>并发</strong>」场景下无法保证缓存和数据一致性，且存在「<font color="red">缓存利用率低</font>」和「机器性能浪费」的情况发生</li><li>「<strong>更新数据库 + 删除缓存</strong>」方案：「先删除缓存，再更新数据库」在「并发」场景下<font color="red">依旧有数据不一致问题</font>，解决方案是「<strong>延迟双删</strong>」，<strong>但这个延迟时间很难评估，所以推荐用「先更新数据库，再删除缓存」</strong>【<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>】。</li></ul><p>3、在推荐方案下，为了保证两步都成功执行，需配合「<strong>消息队列</strong>」或「<strong>订阅变更日志 Binlog</strong>」的方案来做，本质是通过「<strong>重试</strong>」的方式保证数据一致性</p><p>4、在推荐方案下，「<strong>读写分离 + 主从库延迟</strong>」也会导致缓存和数据库不一致，缓解此问题的方案是「<strong>延迟双删</strong>」，凭借经验发送「<strong>延迟消息</strong>」到队列中，延迟删除缓存，同时也要控制主从库延迟，尽可能降低不一致发生的概率</p><h4 id="后记"><a class="anchor" href="#后记">#</a> 后记</h4><p>本以为这个老生常谈的话题，写起来很好写，没想到在写的过程中，还是挖到了很多之前没有深度思考过的细节。</p><p>在这里我也分享 4 点心得给你：</p><p>1、<strong>性能和一致性不能同时满足，为了性能考虑，通常会采用「最终一致性」的方案</strong></p><blockquote><p>最终一致性：是指分布式系统中所有副本最终达到一致状态的性质，但不保证在每一时刻下所有副本都一致。</p></blockquote><p>2、掌握缓存和数据库一致性问题，核心问题有 3 点：<strong>缓存利用率</strong>、<strong>并发</strong>、<strong>缓存 + 数据库一起成功</strong></p><p>3、失败场景下要保证一致性，常见手段就是「<strong>重试</strong>」，同步重试会影响吞吐量，所以通常会采用<strong>异步重试</strong>的方案</p><p>4、<strong>订阅变更日志 Binlog</strong> 的思想，本质是把权威数据源（例如 MySQL）当做 leader 副本，让其它异质系统（例如 Redis / Elasticsearch）成为它的 follower 副本，通过同步变更日志 Binlog 的方式，保证 leader 和 follower 之间保持一致</p><p>很多一致性问题，都会采用这些方案来解决，希望我的这些心得对你有所启发。</p><h3 id="业务背景-2"><a class="anchor" href="#业务背景-2">#</a> 业务背景</h3><p>为了满足用户对一趟列车不同站点不同座位类型的余量查询需求，我们采取了一种优化方案。我们将这些<font color="red">余量信息存储在缓存中</font>，以便用户可以快速查询。</p><p>然而，<font color="red">在用户创建订单并完成支付时，需要同时从数据库和缓存中扣减相应的列车站点余票</font>。这种设计不仅提高了查询效率，也保证了数据的一致性，确保订单操作的准确性。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415135149.png" alt="image.png"></p><p>在这个业务场景中的<font color="red">缓存与数据库一致性如何保证？</font>结合大家常在用的以及网上一些方案，给出一些我的思考以及咱们 12306 中实际的解决方案。</p><p>注意，下文中都是以多请求并发场景下的思考。</p><h3 id="技术方案"><a class="anchor" href="#技术方案">#</a> 技术方案</h3><h4 id="方案一先写缓存再写数据库"><a class="anchor" href="#方案一先写缓存再写数据库">#</a> 方案一：先写缓存，再写数据库</h4><p>两个用户购买了车站余票，假设余票有 17 张，两个用户扣减完还剩 15 张票。</p><p>如图所示，多个请求并发写入缓存和数据库，写请求 A 先更新 Redis 余票为 16。此时，写请求 B 将余票缓存更新 Redis 为 15，紧接着执行数据库更新为 15。这个时候，写请求 A 继续执行更新数据库操作，余票数据更新为 16。</p><p>这样就导致了多请求并发场景下，<font color="red">存在并发问题，导致执行结果与预期不符</font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415140503.png" alt="image.png"></p><h4 id="方案二先写数据库再写缓存"><a class="anchor" href="#方案二先写数据库再写缓存">#</a> 方案二：先写数据库，再写缓存</h4><p>同上所诉，参考对应的业务场景和多请求并发场景，不同的是前者先更新缓存，后者先更新的是数据库，相同的是都<font color="red">存在并发问题，导致执行结果与预期不符</font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415140651.png" alt="image.png"></p><h4 id="方案三先删除缓存再写数据库"><a class="anchor" href="#方案三先删除缓存再写数据库">#</a> 方案三：先删除缓存，再写数据库</h4><p>假设有两个并发的读写操作，一个是写操作，另一个是读操作。</p><ol><li>并发读写的情况下，写操作首先删除缓存，接下来需要执行更新数据库操作。</li><li>读操作发生，由于缓存已经被删除，读操作不得不从数据库中读取数据。然而，<font color="red">由于写操作尚未完成，数据库中的数据仍然是过时的</font>。</li><li>写操作这时需要更新数据库中的值，更新后 MySQL 数据库是最新的值。</li><li><font color="red">读操作将从数据库中查询到的过时数据再回写到缓存</font>。</li></ol><p>在这种情况下，读操作获取到的是过时的数据，尽管写操作已经完成。<font color="red">因为缓存先被删除，读操作不得不从数据库中读取旧值，而不是最新的值</font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415141012.png" alt="image.png"></p><h4 id="方案四先写数据库再删除缓存"><a class="anchor" href="#方案四先写数据库再删除缓存">#</a> 方案四：先写数据库，再删除缓存</h4><blockquote><p>本项目采取这种缓存与数据库一致性解决方案</p></blockquote><p>读请求第一次查询时，会查询到一个错误的数据，因为写请求还没有更新到缓存，<font color="red">写请求写入 MySQL 成功后会删除缓存中的历史数据</font>。后续的读请求查询缓存中没有值，就会再请求数据库 MySQL 进行重新加载，并将正确的值放到缓存中。</p><p>也就是说这种模型<font color="red">会存在一个很小周期的缓存与数据库不一致的情况，不过对于绝大多数的情况来说，是可以容忍的</font>。除去一些电商库存、列车余票等对数据比较敏感的情况，比较适合绝大多数业务场景。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415145815.png" alt="image.png"></p><p>当然，这种模型也不是完全没问题，比如可能出现以下情况：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415150111.png" alt="image.png"></p><p>如果以下 3 个条件同时满足，那么就 **<font color="red">有可能删除缓存失败</font>**，触发缓存数据库不一致问题：</p><ol><li>缓存刚好失效（可能是缓存正常过期，也可能是 Redis 内存满了触发清理策略）</li><li>读请求 + 写请求并发</li><li>「写请求更新数据库后，删除缓存」的时刻早于「读请求查询数据库后，回写缓存」的时刻。</li></ol><p>不过能同时满足这 3 个条件的<font color="red">概率极低</font>，特别是条件 3。<font color="red">因为写数据库一般会先「加锁」，所以写数据库，通常是要比读数据库的时间更长的</font>。</p><p>而且上面所说的这种数据不一致情况，可通过 ** 增加缓存更新重试机制（例如消息队列）** 来解决：</p><ul><li>如果缓存删除失败的话，我们就隔一段时间进行重试，重试次数可以自己定。</li><li>如果多次重试还是失败的话，我们可以把当前更新失败的 key 存入队列中，等缓存服务可用之后，再将缓存中对应的 key 删除即可。</li></ul><p>这么来看，「先更新数据库 + 再删除缓存」的方案，是<font color="red">可以保证数据一致性的</font>。所以，我们应该采用这种方案，来操作数据库和缓存。</p><h4 id="方案五先删除缓存再写数据库再删除缓存"><a class="anchor" href="#方案五先删除缓存再写数据库再删除缓存">#</a> 方案五：先删除缓存，再写数据库，再删除缓存</h4><blockquote><p>缓存双删 + 延迟队列</p></blockquote><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415141324.png" alt="image.png"></p><p>如果说上图的读请求回写缓存在写请求第二次删除缓存之前，那这种技术方案是比较好的，而且也不用引入过多复杂的中间件。</p><p><strong><font color="red">问题就在于，第二次删除缓存，不一定在读请求回写缓存之后</font></strong>。所以我们需要保证第二次删除要在请求回写缓存之后。</p><p>假设读请求回写缓存大概需要 300ms，那我们是否<strong>可以在写请求第二次删除缓存前进行一个延迟操作（延迟队列或者引入三方消息队列）</strong>，比如睡眠 500ms 后再删除？这样就可以规避读请求回写缓存在第二次删除之后了。</p><p>最新技术架构流程如下所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415141340.png" alt="image.png"></p><p>如果消息队列更新缓存失败了呢？其实这一点还好，凭借消息队列客户端消费的重试规则，如果更新失败次数都达到客户端重试阈值还是不行，那一定是数据或者缓存中间件有问题。</p><p>当然，<font color="red">如果重试次数多了，也必然会面临缓存与数据库不一致的时间变长了</font>，这个是需要清楚的。</p><p>通过该技术方案，可以很好达到缓存与数据库最终一致性。</p><p>总结一下：<strong><font color="#B32015">缓存双删 + 延迟队列</font></strong></p><h4 id="方案六先写数据库再通过binlog异步更新缓存"><a class="anchor" href="#方案六先写数据库再通过binlog异步更新缓存">#</a> 方案六：先写数据库，再通过 BinLog 异步更新缓存</h4><p>这种方案是我认为<font color="red">最终一致性</font>最为值得尝试以及使用的。但是有一句话说的是没有绝对合适的技术，只有相对适合的技术，这种方案实现是也存在一些技术问题，稍后会给大家详细说明。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240415143311.png" alt="image.png"></p><p>如果是扣减库存的方案，比如说你将列车余票扣减为 16，但是同时又有一个请求将列车余票扣减为 15，这个时候，<font color="red">扣减为 15 的这个请求抢先到消息队列执行</font>，将缓存更新为余票 15，但是随之而来的是第一个请求余票为 16，会将缓存余票为 15 给覆盖掉。</p><p>类似于这种逻辑，<font color="red">会存在一些数据一致性的问题</font>，需要我们通过其它技术手段完善，比如数据库添加版本号，或者根据最后修改时间等技术规避这些问题。</p><p>另外，如果在写入数据库余票 16 前，同时有个查询请求，也会存在数据库不一致问题。比如在写入数据库余票 16 前，将数据库余票 17 获取到，然后等消息队列更新到缓存余票 16 后，再将数据库余票 17 更新到缓存。</p><p>这种出问题的概率比较小，因为跨的周期太长了。也是类似于<font color="red">存在一个很小周期的数据不一致性</font>。</p><h3 id="技术方案小结"><a class="anchor" href="#技术方案小结">#</a> 技术方案小结</h3><h4 id="推荐方案"><a class="anchor" href="#推荐方案">#</a> 推荐方案</h4><p>以下这三种在实际工作中不建议使用，<font color="red">存在较大的数据不一致隐患</font>：</p><ul><li><a href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E5%85%88%E5%86%99%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案一：先写缓存，再写数据库</a></li><li><a href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%86%99%E7%BC%93%E5%AD%98">方案二：先写数据库，再写缓存</a></li><li><a href="#%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93">方案三：先删除缓存，再写数据库</a></li></ul><p>可以根据业务场景选择下述缓存一致性方案：</p><ul><li><a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a>：这种方案 **<font color="red">从实时性以及技术实现复杂度来说都比较不错，推荐使用</font>**。</li><li><a href="#%E6%96%B9%E6%A1%88%E4%BA%94%EF%BC%9A%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%EF%BC%8C%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案五：缓存双删 + 延迟队列</a>：<font color="red">如果有消息队列中间件，可以考虑</font>。</li><li><a href="#%E6%96%B9%E6%A1%88%E5%85%AD%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E9%80%9A%E8%BF%87BinLog%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">方案六：先写数据库，再通过 BinLog 异步更新缓存</a>：如果希望实现<font color="red">最终一致性以及数据多中心模式</font>，该方案无疑是最合适的。</li></ul><h4 id="缓存删除和-binlog-异步处理的坑"><a class="anchor" href="#缓存删除和-binlog-异步处理的坑">#</a> 缓存删除和 Binlog 异步处理的坑</h4><h3 id="小结-9"><a class="anchor" href="#小结-9">#</a> 小结</h3><p>总结一下关于缓存与数据库一致性的方案：</p><ul><li>如果想要实现【最终一致性】： <a href="#%E6%96%B9%E6%A1%88%E5%85%AD%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E9%80%9A%E8%BF%87BinLog%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">方案六：先写数据库，再通过 BinLog 异步更新缓存</a>方案</li><li>如果对【缓存实时性】要求比较高：<a href="#%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98">方案四：先写数据库，再删除缓存</a></li></ul><p>真实场景中根据具体业务需求和系统架构，可以选择适合的方案或组合多种方案。这些方案最终目的是在解决缓存与数据库之间的一致性问题，以确保数据的正确性和可靠性。</p><h1 id="从0到1实现"><a class="anchor" href="#从0到1实现">#</a> 从 0 到 1 实现</h1><h2 id="项目基础教学"><a class="anchor" href="#项目基础教学">#</a> 项目基础教学</h2><h3 id="梳理核心业务"><a class="anchor" href="#梳理核心业务">#</a> 梳理核心业务</h3><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1694240820160-615770c8-570f-4c86-9a9f-cad21b6f383a.png" alt="1694240820160-615770c8-570f-4c86-9a9f-cad21b6f383a"></p><h3 id="初始化数据库表"><a class="anchor" href="#初始化数据库表">#</a> 初始化数据库表</h3><blockquote><p>-&gt;<a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96"> 数据库初始化</a></p></blockquote><h3 id="梳理数据库表关系"><a class="anchor" href="#梳理数据库表关系">#</a> 梳理数据库表关系</h3><h4 id="用户管理"><a class="anchor" href="#用户管理">#</a> 用户管理</h4><h5 id="会员数据"><a class="anchor" href="#会员数据">#</a> 会员数据</h5><p>会员相关核心数据库表如下：</p><ul><li><p><strong>会员用户表</strong> <code>t_user</code> ：用户名、密码、真实姓名、国家 / 地区、证件类型、证件号、手机号、固定电话、邮箱、旅客类型、审核状态、邮编、地址、注销时间戳、创建时间、修改时间、删除标识<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416170352.png" alt="image.png"></p></li><li><p><strong>会员邮箱表</strong> <code>t_user_mail</code> ：用户名、邮箱等信息<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416171053.png" alt="image.png"></p></li><li><p><strong>会员手机号表</strong> <code>t_user_phone</code> ：用户名、手机号等信息<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416171306.png" alt="image.png"></p></li></ul><p>很多小伙伴比较疑惑，和用户直接相关的三张表之间的关系是什么？手机号和邮箱不是可以在 t_user 会员用户表中已经有了么，为什么还要再单独定义？</p><p>这是因为 <font color="red">对 t_user 会员用户表进行了分库分表行为，分片键使用的 username 用户名进行拆分 </font>。</p><p>当我们执行新增语句时，没有分库分表前的数据长这个样子。</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>t_user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>real_name<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'admin123456'</span><span class="token punctuation">,</span> <span class="token string">'徐万里'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>通过分库分表中间件 ShardingSphere 修饰后，真正执行的 SQL 语句长这个样子。</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>t_user_10<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>real_name<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'admin123456'</span><span class="token punctuation">,</span> <span class="token string">'徐万里'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>ShardingSphere 会通过分片键 username 用户名来确定数据在哪个库中的哪个表。所以，<strong><font color="red">分库分表后，每次增删改查都需要带上分片键用户名。不然的话，查询会请求所有库的所有用户表，新增、修改和删除会直接报错 </font></strong>。</p><p>我们以 <font color="red">不带分片键 </font>，而根据手机号查询用户举例，真实执行的 SQL 如下：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span>  id<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>real_name<span class="token punctuation">,</span>region<span class="token punctuation">,</span>id_type<span class="token punctuation">,</span>id_card <span class="token keyword">AS</span> id_card<span class="token punctuation">,</span>phone <span class="token keyword">AS</span> phone<span class="token punctuation">,</span>telephone<span class="token punctuation">,</span>mail <span class="token keyword">AS</span> mail<span class="token punctuation">,</span>user_type<span class="token punctuation">,</span>verify_status<span class="token punctuation">,</span>post_code<span class="token punctuation">,</span>address <span class="token keyword">AS</span> address<span class="token punctuation">,</span>deletion_time<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>del_flag  <span class="token keyword">FROM</span> t_user_0 </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">WHERE</span>  del_flag<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">AND</span> <span class="token punctuation">(</span>phone <span class="token operator">=</span> ?<span class="token punctuation">)</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span>  id<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>real_name<span class="token punctuation">,</span>region<span class="token punctuation">,</span>id_type<span class="token punctuation">,</span>id_card <span class="token keyword">AS</span> id_card<span class="token punctuation">,</span>phone <span class="token keyword">AS</span> phone<span class="token punctuation">,</span>telephone<span class="token punctuation">,</span>mail <span class="token keyword">AS</span> mail<span class="token punctuation">,</span>user_type<span class="token punctuation">,</span>verify_status<span class="token punctuation">,</span>post_code<span class="token punctuation">,</span>address <span class="token keyword">AS</span> address<span class="token punctuation">,</span>deletion_time<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>del_flag  <span class="token keyword">FROM</span> t_user_1 </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">WHERE</span>  del_flag<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">AND</span> <span class="token punctuation">(</span>phone <span class="token operator">=</span> ?<span class="token punctuation">)</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span>  id<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>real_name<span class="token punctuation">,</span>region<span class="token punctuation">,</span>id_type<span class="token punctuation">,</span>id_card <span class="token keyword">AS</span> id_card<span class="token punctuation">,</span>phone <span class="token keyword">AS</span> phone<span class="token punctuation">,</span>telephone<span class="token punctuation">,</span>mail <span class="token keyword">AS</span> mail<span class="token punctuation">,</span>user_type<span class="token punctuation">,</span>verify_status<span class="token punctuation">,</span>post_code<span class="token punctuation">,</span>address <span class="token keyword">AS</span> address<span class="token punctuation">,</span>deletion_time<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>del_flag  <span class="token keyword">FROM</span> t_user_2 </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">WHERE</span>  del_flag<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">AND</span> <span class="token punctuation">(</span>phone <span class="token operator">=</span> ?<span class="token punctuation">)</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span>  id<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>real_name<span class="token punctuation">,</span>region<span class="token punctuation">,</span>id_type<span class="token punctuation">,</span>id_card <span class="token keyword">AS</span> id_card<span class="token punctuation">,</span>phone <span class="token keyword">AS</span> phone<span class="token punctuation">,</span>telephone<span class="token punctuation">,</span>mail <span class="token keyword">AS</span> mail<span class="token punctuation">,</span>user_type<span class="token punctuation">,</span>verify_status<span class="token punctuation">,</span>post_code<span class="token punctuation">,</span>address <span class="token keyword">AS</span> address<span class="token punctuation">,</span>deletion_time<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>del_flag  <span class="token keyword">FROM</span> t_user_3 </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">WHERE</span>  del_flag<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">AND</span> <span class="token punctuation">(</span>phone <span class="token operator">=</span> ?<span class="token punctuation">)</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span>  id<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>real_name<span class="token punctuation">,</span>region<span class="token punctuation">,</span>id_type<span class="token punctuation">,</span>id_card <span class="token keyword">AS</span> id_card<span class="token punctuation">,</span>phone <span class="token keyword">AS</span> phone<span class="token punctuation">,</span>telephone<span class="token punctuation">,</span>mail <span class="token keyword">AS</span> mail<span class="token punctuation">,</span>user_type<span class="token punctuation">,</span>verify_status<span class="token punctuation">,</span>post_code<span class="token punctuation">,</span>address <span class="token keyword">AS</span> address<span class="token punctuation">,</span>deletion_time<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">,</span>del_flag  <span class="token keyword">FROM</span> t_user_4 </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">WHERE</span>  del_flag<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="15"></td><td><pre>xxxxxx</pre></td></tr></table></figure><p>可以发现，<font color="red">ShardingSphere 通过 <code>UNION ALL</code> 的方式查询了所有分表（<strong>读扩散问题</strong>）</font>。所以，<font color="red">这种不带分片键的查询在实际业务中，是不被允许的 </font>。</p><hr><p>那问题来了，12306 支持会员用户登录时根据手机号、邮箱以及用户名三种组合方式登录，手机号和邮箱查询性能岂不是很差，因为要查询所有表。为了解决这个问题，我们通过 **<font color="red">路由表 </font>**（即 <code>t_user_mail</code> 和 <code>t_user_phone</code> ）的方式解决这个问题，相关技术实现方案查看<a href="#%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3">注册用户接口</a>。</p><hr><p>另外，还有两张用户相关扩展功能表：</p><ul><li><p><strong>用户名可复用表</strong> <code>t_user_reuse</code> ：存储已被注销且可复用的用户名。<font color="red">用来搭配对应的 Redis Set 缓存，解决业务难点中<a href="#%E4%BC%9A%E5%91%98%E6%B3%A8%E5%86%8C%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">采用布隆过滤器防止会员注册缓存穿透</a>中的布隆过滤器无法删除元素的问题 </font>，具体可查看<a href="#%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3">注册用户接口</a>。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416171507.png" alt="image.png"></p></li><li><p><strong>用户证件注销表</strong> <code>t_user_deletion</code> ：存储被注销过的证件号数据。<font color="red">用来解决用户恶意注销 12306 账号的问题 </font>。假设一个用户用一个证件号反复注册并注销，是不是应该把他拉入黑名单。因为用户名每次注册都可以使用新的，所以说我们只能针对证件号当做依据。目前系统的规则是，<font color="red">如果同一个证件号注销超过 5 次，就拉入黑名单不再支持注册 </font>。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416173114.png" alt="image.png"></p></li></ul><p>会员数据的整体 UML 图如下所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240127234324530.png" alt="image-20240127234324530"></p><h5 id="乘车人数据"><a class="anchor" href="#乘车人数据">#</a> 乘车人数据</h5><ul><li><strong>用户乘车人表</strong> <code>t_passenger</code> ：用户名、（乘车人）真实姓名、证件类型、证件号码、优惠类型、手机号、添加日期、审核状态等信息。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416173457.png" alt="image.png"></li></ul><p><font color="red">一个用户可以添加多名乘车人 </font>，可以用来买票时选择多人购票。会员用户表和用户乘车人之间通过会员用户名进行关联，一对多的关联关系。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240128004043880.png" alt="image-20240128004043880"></p><h4 id="列车管理"><a class="anchor" href="#列车管理">#</a> 列车管理</h4><ul><li><strong>列车数据表</strong> <code>t_train</code> ：存储每天生成的行驶列车数据，包括列车车次、列车类型、列车标签、列车品牌、起始站、终点站、起始城市、终点城市、销售时间、销售状态、出发时间、到达时间等信息。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416173843.png" alt="image.png"><br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416191251.png" alt="image.png"></li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691541217667-a9efa32b-3a2e-4a93-ab2c-bbe9553c9149.png" alt="img"></p><ul><li><strong>车厢表</strong> <code>t_carriage</code> ：存储每趟列车对应的车厢数据，包括列车 ID、车厢号、车厢类型、座位数等信息。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416190649.png" alt="image.png"><br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416191402.png" alt="image.png"></li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691541261020-d4ce4732-3ef5-44a4-adaf-6c7e024949a1.png" alt="img"></p><ul><li><p><strong>车站表</strong> <code>t_station</code> ：存储车站数据，包括车站编号、车站名称、拼音、车站地区、车站地区名称等信息。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416191948.png" alt="image.png"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416192139.png" alt="image.png"></p></li><li><p><strong>列车站点表</strong> <code>t_train_station</code> ：存储列车行驶站点顺序表，包括列车 ID、车站 ID、站点顺序、出发站点、到达站点、起始城市、终点城市、到站时间、出站时间、停留时间等信息。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416190846.png" alt="image.png"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416191539.png" alt="image.png"></p><p>比如下图中 G169 这趟列车，就需要在该表中存入 8 条数据，分别对应如下：</p><ul><li><p>北京南 -&gt; 天津南</p></li><li><p>天津南 -&gt; 沧州西</p></li><li><p>沧州西 -&gt; 济南西</p></li><li><p>...</p></li><li><p>南京南 -&gt; 句容西</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691541284979-d1571197-d010-4dec-8520-63166c91607a.png" alt="img"></p></li></ul></li><li><p><strong>列车站点关系表</strong> <code>t_train_station_relation</code> ：存储列车行驶站点关联关系表。存储列车 ID、出发站点、到达站点、起始城市名称、终点城市名称、始发标识、终点标识、出发时间、到达时间等信息。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416193052.png" alt="image.png"></p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416192912.png" alt="image.png"></p><p>这是一个<font color="red">会把所有车站都会关联起来</font>的数据集合，存储的数据模型如下所示：</p><ul><li>北京南 -&gt; 天津西，北京南 -&gt; 沧州西，北京南 -&gt;xxx，北京南 -&gt; 句容西。</li><li>天津西 -&gt; 沧州西，天津西 -&gt; 济南西，天津西 -&gt;xxx，天津西 -&gt; 句容西。</li><li>沧州西 -&gt; 济南西，沧州西 -&gt; 徐州东，沧州西 -&gt;xxx，天津西 -&gt; 句容西。</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691541351094-386e23e5-f3cd-4a55-898c-4c9e922e72ad.png" alt="img"></p></li><li><p><strong>列车站点价格表</strong> <code>t_train_station_price</code> ：存储列车站点关联关系不同座位价格表，<font color="red">是在 t_train_station_relation 关系表的基础上，加入了价格、作为类型两个字段，同时删去了一些与价格无关的字段 </font>。因为列车行驶路线中，不同的站点间隔费用不一样，而且不同的座位费用也不一样。通过价格表整体区分出来。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416193412.png" alt="image.png"><br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416193455.png" alt="image.png"><br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691541396876-6d3e2fea-6e0b-4808-9398-748a620744d0.png" alt="img"></p></li><li><p><strong>座位表</strong> <code>t_seat</code> ：存储了列车的座位信息，包括列车 ID、车厢号、座位号、座位类型、起始站、终点站、车票价格、座位状态等信息。<br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416193853.png" alt="image.png"><br><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240416194034.png" alt="image.png"></p></li></ul><p>列车表数据之间的关联关系如下图：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240128010858945.png" alt="image-20240128010858945"></p><h4 id="订单管理"><a class="anchor" href="#订单管理">#</a> 订单管理</h4><ul><li><code>t_order</code> ：订单主表，用户购买的单次车票，就对应一个订单。但是 <font color="red">一个订单中可能会有多个乘车人，所以还会有订单明细表 </font>。</li><li><code>t_order_item</code> ：订单明细表，一个订单可能有多个乘车人，<font color="red">多个乘车人就对应多个订单明细 </font>。</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1691548149334-156addac-09b9-4cbc-a2fd-c85a38c3a149.png" alt="img"></p><ul><li><p><code>t_order_item_passenger</code> ：订单明细乘车人表，因为订单表和订单明细表分库分表规则所致，<font color="red">乘车人无法查看本人车票订单，所以创建了这个关联表 </font>。通过证件号关联订单。</p><p>Q：为什么通过乘车人证件号关联？</p><p>A：因为用户在添加乘车人进行购票时，有可能乘车人是没有注册账号的，所以只能通过证件号进行购票。那如果后来用户注册了账号，也就只能通过证件号去关联自己本人车票订单。</p></li></ul><p>订单表数据之间的关联关系如下图：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240128012004061.png" alt="image-20240128012004061"></p><h4 id="支付管理"><a class="anchor" href="#支付管理">#</a> 支付管理</h4><p>t_pay：订单支付表，存储用户支付车票相关数据。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240128012059303.png" alt="image-20240128012059303"></p><h3 id="工程目录结构设计"><a class="anchor" href="#工程目录结构设计">#</a> 工程目录结构设计</h3><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>├── checkstyle  <span class="token operator">||</span> -- <span class="token comment"># 代码格式检查组件</span></pre></td></tr><tr><td data-num="2"></td><td><pre>│   ├── 12306_checkstyle.xml  <span class="token operator">||</span> -- <span class="token comment"># 代码格式检查组件规则配置</span></pre></td></tr><tr><td data-num="3"></td><td><pre>│   └── 12306_checkstyle_suppression.xml  <span class="token operator">||</span> -- <span class="token comment"># 忽略代码格式检查组件规则配置</span></pre></td></tr><tr><td data-num="4"></td><td><pre>├── console-vue  <span class="token operator">||</span> -- <span class="token comment">#  12306 前端控制台项目</span></pre></td></tr><tr><td data-num="5"></td><td><pre>│   ├── README.md</pre></td></tr><tr><td data-num="6"></td><td><pre>│   ├── babel.config.js</pre></td></tr><tr><td data-num="7"></td><td><pre>│   ├── jsconfig.json</pre></td></tr><tr><td data-num="8"></td><td><pre>│   ├── node_modules</pre></td></tr><tr><td data-num="9"></td><td><pre>│   ├── package.json</pre></td></tr><tr><td data-num="10"></td><td><pre>│   ├── public</pre></td></tr><tr><td data-num="11"></td><td><pre>│   ├── src</pre></td></tr><tr><td data-num="12"></td><td><pre>│   ├── vue.config.js</pre></td></tr><tr><td data-num="13"></td><td><pre>│   └── yarn.lock</pre></td></tr><tr><td data-num="14"></td><td><pre>├── dependencies  <span class="token operator">||</span> -- <span class="token comment">#  12306 后端项目全局依赖版本控制</span></pre></td></tr><tr><td data-num="15"></td><td><pre>│   └── pom.xml</pre></td></tr><tr><td data-num="16"></td><td><pre>├── <span class="token function">format</span>  <span class="token operator">||</span> -- <span class="token comment">#  12306 后端项目格式化组件</span></pre></td></tr><tr><td data-num="17"></td><td><pre>│   ├── 12306_spotless_formatter.xml  <span class="token operator">||</span> -- <span class="token comment">#  12306 后端项目格式化组件规则配置</span></pre></td></tr><tr><td data-num="18"></td><td><pre>│   └── license-header  <span class="token operator">||</span> -- <span class="token comment">#  12306 后端项目开源协议头格式化</span></pre></td></tr><tr><td data-num="19"></td><td><pre>├── frameworks  <span class="token operator">||</span> -- <span class="token comment">#  12306 基础架构组件库</span></pre></td></tr><tr><td data-num="20"></td><td><pre>│   ├── base  <span class="token operator">||</span> -- <span class="token comment">#  12306 顶层抽象基础组件</span></pre></td></tr><tr><td data-num="21"></td><td><pre>│   ├── bizs  <span class="token operator">||</span> -- <span class="token comment">#  12306 业务相关基础组件，比如用户上下文等</span></pre></td></tr><tr><td data-num="22"></td><td><pre>│   ├── cache  <span class="token operator">||</span> -- <span class="token comment"># 12306 缓存基础组件</span></pre></td></tr><tr><td data-num="23"></td><td><pre>│   ├── common  <span class="token operator">||</span> -- <span class="token comment"># 12306 公共工具包组件</span></pre></td></tr><tr><td data-num="24"></td><td><pre>│   ├── convention  <span class="token operator">||</span> -- <span class="token comment"># 12306 项目规约组件</span></pre></td></tr><tr><td data-num="25"></td><td><pre>│   ├── database  <span class="token operator">||</span> -- <span class="token comment"># 12306 数据库持久层组件</span></pre></td></tr><tr><td data-num="26"></td><td><pre>│   ├── designpattern  <span class="token operator">||</span> -- <span class="token comment"># 12306 设计模式抽象基础组件</span></pre></td></tr><tr><td data-num="27"></td><td><pre>│   ├── distributedid  <span class="token operator">||</span> -- <span class="token comment"># 12306 分布式 ID 基础组件</span></pre></td></tr><tr><td data-num="28"></td><td><pre>│   ├── idempotent  <span class="token operator">||</span> -- <span class="token comment"># 12306 幂等基础组件，包括 HTTP 及不同消息队列实现</span></pre></td></tr><tr><td data-num="29"></td><td><pre>│   ├── log  <span class="token operator">||</span> -- <span class="token comment"># 12306 日志打印基础组件库</span></pre></td></tr><tr><td data-num="30"></td><td><pre>│   └── web  <span class="token operator">||</span> -- <span class="token comment"># 12306 Web 相关基础组件库</span></pre></td></tr><tr><td data-num="31"></td><td><pre>│   ├── pom.xml</pre></td></tr><tr><td data-num="32"></td><td><pre>├── resources  <span class="token operator">||</span> -- <span class="token comment"># 12306 项目数据库初始化及其它</span></pre></td></tr><tr><td data-num="33"></td><td><pre>│   ├── data  <span class="token operator">||</span> -- <span class="token comment"># 12306 数据库数据初始化</span></pre></td></tr><tr><td data-num="34"></td><td><pre>│   └── db  <span class="token operator">||</span> -- <span class="token comment"># 12306 数据库初始化</span></pre></td></tr><tr><td data-num="35"></td><td><pre>├── services  <span class="token operator">||</span> -- <span class="token comment"># 12306 后端项目集合</span></pre></td></tr><tr><td data-num="36"></td><td><pre>│   ├── aggregation-service  <span class="token operator">||</span> -- <span class="token comment"># 12306 SpringBoot 聚合模式服务</span></pre></td></tr><tr><td data-num="37"></td><td><pre>│   ├── gateway-service  <span class="token operator">||</span> -- <span class="token comment"># 12306 网关服务</span></pre></td></tr><tr><td data-num="38"></td><td><pre>│   ├── order-service  <span class="token operator">||</span> -- <span class="token comment"># 12306 订单服务</span></pre></td></tr><tr><td data-num="39"></td><td><pre>│   ├── pay-service  <span class="token operator">||</span> -- <span class="token comment"># 12306 支付服务</span></pre></td></tr><tr><td data-num="40"></td><td><pre>│   ├── ticket-service  <span class="token operator">||</span> -- <span class="token comment"># 12306 购票服务</span></pre></td></tr><tr><td data-num="41"></td><td><pre>│   └── user-service  <span class="token operator">||</span> -- <span class="token comment"># 12306 用户服务</span></pre></td></tr><tr><td data-num="42"></td><td><pre>│   ├── pom.xml</pre></td></tr><tr><td data-num="43"></td><td><pre>└── tests  <span class="token operator">||</span> -- <span class="token comment"># 12306 单元测试集合</span></pre></td></tr><tr><td data-num="44"></td><td><pre>│   ├── general  <span class="token operator">||</span> -- <span class="token comment"># 12306 通用单元测试</span></pre></td></tr><tr><td data-num="45"></td><td><pre>└── pom.xml</pre></td></tr><tr><td data-num="46"></td><td><pre>├── LICENSE</pre></td></tr><tr><td data-num="47"></td><td><pre>├── mvnw</pre></td></tr><tr><td data-num="48"></td><td><pre>├── mvnw.cmd</pre></td></tr><tr><td data-num="49"></td><td><pre>├── pom.xml</pre></td></tr><tr><td data-num="50"></td><td><pre>├── README.md</pre></td></tr></table></figure><h3 id="创建-springboot-单模块"><a class="anchor" href="#创建-springboot-单模块">#</a> 创建 SpringBoot 单模块</h3><p>SpringBoot 致力于简洁，让开发者写更少的配置文件，由于 **<font color="red"> Springboot 内置了 Servlet 容器 </font>**，所以程序不需要像传统的方式，先部署到容器然后再启动容器。只需要打开创建包目录文件下 <code>$&#123;项目名&#125;Application.java</code> 文件运行 <code>main</code> 方法即可。</p><h4 id="搭建-springboot-项目"><a class="anchor" href="#搭建-springboot-项目">#</a> 搭建 SpringBoot 项目</h4><p>SpringBoot 项目可以在 <code>https://start.spring.io/</code> 上创建项目进行下载，并在本地运行，也可在 <code>IDEA中</code> 进行构建。本次演示采用 <code>IDEA</code> 的方式。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689508925367-5e95955f-761e-406e-ac39-2b6b2b063336.png" alt="img"></p><p>选择合适的 SpringBoot 版本，这里选择 <code>2.7.13</code> 。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689508959199-bb69983e-b76a-45e6-96a0-4ed153f2d384.png" alt="img"></p><h5 id="结构目录"><a class="anchor" href="#结构目录">#</a> 结构目录</h5><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689515316618-56839018-374e-4ad3-a772-d71df180a10f.png" alt="img"></p><p>如上图所示，SpringBoot 的基础结构一共是三个文件：</p><ul><li><code>src/main/java</code> ：程序开发以及主程序入口。</li><li><code>src/main/resources</code> ：项目相关配置文件。</li><li><code>src/test/java</code> ：测试程序文件。</li></ul><h5 id="pomxml-文件"><a class="anchor" href="#pomxml-文件">#</a> pom.xml 文件</h5><p>可以看到工程中有 Maven 的 Pom 文件，这里默认是依赖了 SpringBoot 的 <code>2.1.4版本</code> ，由于是测试，就不怂有什么问题，可以起到测试效果即可，构建项目不建议使用最新的；可以看到其中的一些依赖 jar 包比较少，因为这些都是 <code>内嵌</code> 到了 <code>SpringBoot 的 Jar 依赖</code> 。</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.nageoffer.demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>spring-boot-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>spring-boot-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="application"><a class="anchor" href="#application">#</a> Application</h5><p>其中有一个 <code>Application</code> 类，它就是程序的入口，右键选择 Run 即可启动该项目（ps：默认端口号为 <code>8080</code> ）。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>nageoffer<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>springbootdemo</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringBootDemoApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringBootDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>resources</code> 下面有一个 <code>application.properties</code> 配置文件，负责配置项目中的一下配置信息，默认为空；一般是采用 <code>.yml</code> 的形式进行配置，可以右键选择此配置文件将其后缀进行修改。</p><h5 id="编写一个-controller"><a class="anchor" href="#编写一个-controller">#</a> 编写一个 Controller</h5><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 等同于 @Controller 加上 @ResponseBody</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 访问 /hello 或者 /hi 任何一个地址，都会返回同样的结果</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @GetMapping 等用于 @RequestMapping (method = RequestMethod.GET)</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"/hello"</span><span class="token punctuation">,</span><span class="token string">"/hi"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"How are you?"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>运行 <code>SpringbootDemoApplication</code> 的 <code>main</code> 方法就会启动项目，打开浏览器输入网址： <code>localhost:8080/hi</code> ，就可以在浏览器上看到： <code>How are you?</code> 。</p><h4 id="属性配置"><a class="anchor" href="#属性配置">#</a> 属性配置</h4><p>在 <code>appliction.yml</code> 文件中添加属性：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">girl</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> 小花</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">18</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">content</span><span class="token punctuation">:</span> content<span class="token punctuation">:</span>$<span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span>$<span class="token punctuation">&#123;</span>age<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 Java 文件中，获取 name 属性，如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;girl.name&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;girl.age&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;girl.content&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span></pre></td></tr></table></figure><p>也可以通过 <code>ConfigurationProperties</code> 注解，将属性可以配置到 <code>Bean</code> ，通过 <code>Component</code> 注解将 Bean 注解到 Spring 容器中。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">"girl"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GirlProperties</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="小结-10"><a class="anchor" href="#小结-10">#</a> 小结</h4><p>使用 SpringBoot 可以 <code>非常方便</code> 、 <code>快速搭建</code> 项目，Spring 项目就相当于是个光脚大汉，boot…boot 给你双鞋总跑得过光脚的吧。另外 SpringBoot 也是构建 <code>Springcloud 微服务架构</code> 的基础。</p><h3 id="创建-springboot-多模块"><a class="anchor" href="#创建-springboot-多模块">#</a> 创建 SpringBoot 多模块</h3><p>如果将 SpringBoot 框架用于单体项目，可能不存在多模块的情况。但是并不代表没有，因为父子模块并不局限于微服务，<strong>单体项目也可以进行明确的职责划分。</strong></p><p>如果是构建微服务项目，基本上会对模块进行明确的划分，比如：</p><ul><li>抽象定义公共代码及 Util 封装进行引用。</li><li>业务代码进行单独定义模块。</li><li>数据库等 DB 操作相关抽离单独模块。</li><li>提供外部平台调取的接口单独定义模块。</li><li>...</li></ul><p><strong>上面的拆分也并非绝对</strong>，随着架构师对于项目结构的不同理解，可能会衍生出不同的模块。</p><p>比较经典的就是 Dubbo 将接口 API 进行抽离提供生产者接口，打为 Jar 包供消费端调用。</p><p>本篇文章也会从零到一创建 SpringBoot 父子模块的项目，<strong>演示聚合、继承的项目特性，并针对不引人注意的知识点进行讲解。</strong></p><h4 id="软硬件环境"><a class="anchor" href="#软硬件环境">#</a> 软硬件环境</h4><p><strong>电脑：</strong> McaBook Pro</p><p><strong>创建项目工具：</strong> IDEA 2023.1.2</p><p><strong>JDK 版本：</strong> 还能再坚持 20 年的 JDK8（随着 JDK 17 的出现，不一定能坚持 20 年了）</p><p><strong>Maven 版本：</strong> 3.5.4</p><h4 id="创建-springboot-项目"><a class="anchor" href="#创建-springboot-项目">#</a> 创建 SpringBoot 项目</h4><p>1）首先打开 IDEA 工具，点击 + Create New Project。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689521114934-a8b99a5a-6b99-47b7-a6da-86272a49e985.png" alt="img"></p><p>2）选择 Spring Initializr（初始化），选择 Project SDK 1.8，使用默认的 SpringBoot 脚手架即可。创建项目详细信息，会逐一进行讲解。</p><p>最终定义项目选项及配置名称如下，点击 Next 按钮继续进行。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689521167561-71cb3ad3-07a4-410f-8692-5b58f39a7f09.png" alt="img"></p><ul><li><strong>Group：</strong> 项目组织唯一的标识符，实际 <font color="red">对应 Java 的包的结构 </font>，是 main 目录里 Java 的目录结构。</li><li><ul><li>Group 也就是 groupId，分为多个段；一般情况下 <strong>第一段为域，第二段为公司，第三段为项目名称。</strong></li><li>以 Nacos 源码进行举例，Group 为 com.alibaba.nacos。</li><li>com 为商业组织，alibaba 为公司名称，nacos 就是项目名称。</li></ul></li><li><strong>Artifact：</strong> 项目的唯一的标识符，实际 <font color="red">对应项目的名称 </font>，就是项目根目录的名称。</li><li><ul><li>Artifact 即为 artifactId，还是以 Nacos 举例，因为最近在看它。</li><li>Nacos 中不同的功能组件的 artifactId 各不相同，比如权限相关的子模块就是 nacos-auth，客户端相关是 nacos-client，具体到了项目功能组件。</li></ul></li><li><strong>Type：</strong> 分为四种不同的类型，日常我们选择默认第一条就行，<strong>也就是 Maven Project。</strong></li><li><strong>Language：</strong> 开发语言的话自然就是默认的 Java。</li><li><strong>Packaging：</strong> 打包方式，分为 War 包 和 Jar 包，这里选择 Jar 包。</li><li><strong>Java Version：</strong> 选择 Java 的一个版本，再坚持 20 年的 JDK 1.8。</li><li><strong>Version：</strong> <font color="red">当前项目的一个版本 </font>，SNAPSHOT 为快照的意思。开发时一般使用此类型，因为对于 Maven 仓库的同步较为友好，有不同纬度的同步选择。</li><li><strong>Name：</strong> 定义项目名称。</li><li><strong>Description：</strong> 定义项目描述信息，帮助别人更好的了解项目。</li><li><strong>Package：</strong> <font color="red">定义 main.java 目录下的结构 </font>。</li></ul><p>3）选择 SpringBoot 版本信息以及 Pom.xml 文件依赖组件。</p><p>这里选择的 SpringBoot 版本是 <strong>2.7.13</strong>，选择了 <strong>Spring Web</strong> 当作 Maven 依赖项。后续会使用发布 Web 测试项目整体是否成功，接下来点击 Next 继续进行下一步。</p><p><img data-src="https://cdn.nlark.com/yuque/0/2023/png/331027/1689521341373-f1ea8f56-b810-439b-b48b-3b04e0471d64.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_46%2Ctext_5pCc77yabmFnZW9mZmVyLmNvbQ%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p><p>4）确认无误后点击 Create，一个标准的 SpringBoot 项目就产生了。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689521464212-c7cfdcb3-5862-4e06-87fc-f886a6b3b7ac.png" alt="img"></p><h4 id="构建子-module"><a class="anchor" href="#构建子-module">#</a> 构建子 Module</h4><p>1）顶级项目地址右键 <strong>New -&gt; Module</strong>，创建子 Module。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689521551486-7ae60202-9e9d-419f-adab-a536751aa372.png" alt="img"></p><p>2）这里就是重复上述在创建 SpringBoot 项目时的步骤，<font color="red">Group 与 Parent 项目保持一致即可，Artifact 修改为 Module 项目作用域名即可 </font>，Next 下一步。</p><p><img data-src="https://cdn.nlark.com/yuque/0/2023/png/331027/1689521649526-29681593-4c1b-4937-aad4-96175a0d25c9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_80%2Ctext_5pCc77yabmFnZW9mZmVyLmNvbQ%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p><p>3）配置可按照需求进行选择，因为不同的 Module 需要引用不同的 Pom 依赖，后面会与 Parent 保持一个交互。</p><p><img data-src="https://cdn.nlark.com/yuque/0/2023/png/331027/1689521714635-09c3d4e3-d629-41d7-a211-d3b93b3d315f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_80%2Ctext_5pCc77yabmFnZW9mZmVyLmNvbQ%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p><p>4）最终结构目录如下，项目已成功创建，<font color="red">原本根目录下 src 目录删除即可 </font>。后续我们要修改其中的 Pom.xml 使其成为真正的父子项目。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689521977755-33b550cc-083d-48de-b384-339df8b0406b.png" alt="img"></p><h4 id="建立父子-module-依赖"><a class="anchor" href="#建立父子-module-依赖">#</a> 建立父子 Module 依赖</h4><p>如果将建立的 Parent 项目与后面创建的 Module 产生关联，需要改动以下几点：</p><ul><li><font color="red">修改 Parent 项目 <code>Pom.xml</code> 的 packaging 标签打包方式为 pom </font>。</li><li><font color="red">修改 Module 项目 <code>Pom.xml</code> 文件依赖 Parent 项目 </font>。</li><li><font color="red">删除不必要文件，并梳理 <code>Pom.xml</code> 依赖上下级关系 </font>。</li></ul><h5 id="修改-parent-项目-packaging"><a class="anchor" href="#修改-parent-项目-packaging">#</a> 修改 Parent 项目 packaging</h5><p>打开 Parent 项目的根 Pom.xml 文件，新增下方代码：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>bootdemo-remote-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>packaging 包含三个值 <strong>Jar、War、Pom</strong>，默认 Jar 的方式。modules 代表了 Parent 项目下的子 Module，体现了聚合的思想。</p><ul><li><strong>Jar：</strong> <font color="red">内部调用 </font>或 <font color="red">作为服务 </font>进行发布使用。</li><li><strong>War：</strong> <font color="red">需要部署的项目 </font>。</li><li>**Pom：** 宏观而言既没有代码需要测试或者编译，也没有资源需要处理。寓意为一个 <font color="red">父级项目 </font>，一般作为项目聚合和依赖传递使用。</li></ul><p>这里把 Parent 项目的 <code>Pom.xml</code> 配置复制出来，帮助大家后续排查问题。</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.nageoffer.demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-module-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>spring-boot-module-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>spring-boot-module-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">&lt;!-- 新增开始 --></span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">></span></span>bootdemo-remote-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">&lt;!-- 新增结束 --></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><strong>spring-boot-maven-plugin</strong> 的作用是运行 <strong>mvn package</strong> 时会将项目打包为可运行的 jar 包，<strong>java -jar</strong> 运行即可。</p><p>如果不加这个 <strong>plugins</strong>，<strong>java -jar xxx.jar</strong> 会报出如下错误。</p><pre><code class="language-Java">xxx/target/bootdemo-remote-api-0.0.1-SNAPSHOT.jar中没有主清单属性
</code></pre><h5 id="修改-module-pomxml-信息"><a class="anchor" href="#修改-module-pomxml-信息">#</a> 修改 Module Pom.xml 信息</h5><p>创建后的 Module 项目的 Parent 信息是 SpringBoot 配置，修改后如下：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.nageoffer.demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-module-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>bootdemo-remote-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>bootdemo-remote-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>bootdemo-remote-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="删除不必要文件"><a class="anchor" href="#删除不必要文件">#</a> 删除不必要文件</h5><p><font color="red">删除 spring-boot-module-demo 项目下 src 包 </font>，因为它作为聚合型项目，不会产生业务数据以及相关配置。</p><p>另外说一下 <code>dependencies</code> 和 <code>dependencyManagement</code> 标签做一个讲解。</p><p><strong>1）dependencies</strong></p><p>如果 Parent 项目中使用 <code>dependencies</code> 标签，<font color="red">标签内的依赖默认传递子 Module，不需要子 Module 进行显示书写依赖 </font>。</p><p><strong>2）dependencyManagement</strong></p><p><code>dependencyManagement</code> 与 <code>dependencies</code> 不同的是，<strong><font color="red">标签内的依赖不会默认传递子 Module，其作用只是为了统一版本声明，需要在子 Module 的 pom 文件中进行显示书写依赖 </font></strong>。</p><h4 id="项目继承关系"><a class="anchor" href="#项目继承关系">#</a> 项目继承关系</h4><p>我们按照 [构建子 Module](# 构建子 Module) 章节的内容，构建出如下所述的子 Module：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.nageoffer.demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>bootdemo-biz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>bootdemo-biz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>然后修改 <strong>bootdemo-biz</strong> 子 Module 的 Pom.xml 文件如下：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.nageoffer.demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-module-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>bootdemo-biz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>bootdemo-biz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>bootdemo-biz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>$&#123;project.groupId&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>bootdemo-remote-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>通过继承关系的设置，<strong>bootdemo-remote-api</strong> 中的代码就可以被 <strong>bootdemo-biz</strong> Module 项目进行引用。</p><h4 id="发布-web-服务"><a class="anchor" href="#发布-web-服务">#</a> 发布 WEB 服务</h4><p>在 Parent 项目 Pom.xml <code>dependencies</code> 标签中定义了 <strong>spring-boot-starter-web</strong> 依赖，直接使用 web 相关内容即可。</p><p>我们在 <strong>bootdemo-biz</strong> 中创建 Controller 控制器：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/echo/&#123;name&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"Hello World "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>启动后端项目成功后，浏览器输入 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDgwL2VjaG8vbWFodWE=">http://localhost:8080/echo/mahua</span> 请求后端服务。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689520889180-58671f85-666f-44d6-87e7-26c38d5908e5.png" alt="img"></p><h2 id="项目开发规范"><a class="anchor" href="#项目开发规范">#</a> 项目开发规范</h2><h3 id="编程规范"><a class="anchor" href="#编程规范">#</a> 编程规范</h3><h4 id="方法命名"><a class="anchor" href="#方法命名">#</a> 方法命名</h4><h5 id="获取单个对象的方法用-get-作前缀"><a class="anchor" href="#获取单个对象的方法用-get-作前缀">#</a> 获取单个对象的方法用 get 作前缀</h5><p>例如：查询单个用户 <code>getStudent</code> ，按照 ID 查询单个用户 <code>getStudentById</code> 。</p><h5 id="获取多个对象的方法用-list-作前缀"><a class="anchor" href="#获取多个对象的方法用-list-作前缀">#</a> 获取多个对象的方法用 list 作前缀</h5><p>例如：按照 IDS 查询多个用户， <code>listStudentByIds</code> 。</p><h5 id="获取统计值的方法用-count-作前缀"><a class="anchor" href="#获取统计值的方法用-count-作前缀">#</a> 获取统计值的方法用 count 作前缀</h5><p>例如：统计全量用户， <code>countUser</code> 。</p><h5 id="插入的方法用-save-作前缀"><a class="anchor" href="#插入的方法用-save-作前缀">#</a> 插入的方法用 save 作前缀</h5><p>例如：新增用户， <code>saveUser</code> 。</p><h5 id="删除的方法用-remove-作前缀"><a class="anchor" href="#删除的方法用-remove-作前缀">#</a> 删除的方法用 remove 作前缀</h5><p>例如：删除用户， <code>removeUser</code> 。</p><h5 id="修改的方法用-update-作前缀"><a class="anchor" href="#修改的方法用-update-作前缀">#</a> 修改的方法用 update 作前缀</h5><p>例如：修改用户， <code>updateUser</code> 。</p><h4 id="领域模型命名规约"><a class="anchor" href="#领域模型命名规约">#</a> 领域模型命名规约</h4><h5 id="数据对象"><a class="anchor" href="#数据对象">#</a> 数据对象</h5><p>xxxDO，xxx 即为数据表名。</p><h5 id="数据传输对象"><a class="anchor" href="#数据传输对象">#</a> 数据传输对象</h5><p>xxxDTO，xxx 为业务领域相关的名称。</p><h5 id="展示对象"><a class="anchor" href="#展示对象">#</a> 展示对象</h5><p>xxxVO，xxx 一般为网页名称。</p><h5 id="注意事项"><a class="anchor" href="#注意事项">#</a> 注意事项</h5><p>POJO 是 DO/DTO/BO/VO 的统称，禁止命名成 xxxPOJO。</p><h4 id="api-路径规约"><a class="anchor" href="#api-路径规约">#</a> API 路径规约</h4><h5 id="get-方法尽量把-id-等变量放到路径上"><a class="anchor" href="#get-方法尽量把-id-等变量放到路径上">#</a> Get 方法尽量把 ID 等变量放到路径上。</h5><p>例如：获取指定用户的信息。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>user<span class="token operator">/</span><span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="多个不可分割的单词使用中划线拼接"><a class="anchor" href="#多个不可分割的单词使用中划线拼接">#</a> 多个不可分割的单词，使用中划线拼接。</h5><p>例如：用户验证码接口。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>user<span class="token operator">/</span>verify<span class="token operator">-</span>code</pre></td></tr></table></figure><h5 id="参数使用驼峰拼写"><a class="anchor" href="#参数使用驼峰拼写">#</a> 参数使用驼峰拼写。</h5><p>例如：获取指定用户购买的指定商品。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>order<span class="token operator">/</span><span class="token punctuation">&#123;</span>productId<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="指向集合的复数名称"><a class="anchor" href="#指向集合的复数名称">#</a> 指向集合的复数名称。</h5><p>例如：获取所有用户列表接口。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>users</pre></td></tr></table></figure><h5 id="不要使用动词定义-url"><a class="anchor" href="#不要使用动词定义-url">#</a> 不要使用动词定义 URL</h5><p>错误示例：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>update<span class="token operator">/</span>user</pre></td></tr></table></figure><p>或者：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>get<span class="token operator">/</span>user</pre></td></tr></table></figure><p>正确应该 <font color="red">结合 HTTP 方法的语义来定义 URL 的行为 </font>。</p><p>比如说获取用户：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">GET</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">/</span>user<span class="token operator">/</span><span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>添加用户：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">POST</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">/</span>user</pre></td></tr></table></figure><p>修改用户：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">PUT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">/</span>user</pre></td></tr></table></figure><h5 id="对非资源-url-使用动词"><a class="anchor" href="#对非资源-url-使用动词">#</a> 对非资源 URL 使用动词</h5><p>如果有一个接口，并不是 CRUD 操作，这种情况可以使用动词。</p><p>例如：向用户发送邮件接口。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>user<span class="token operator">/</span><span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span><span class="token operator">/</span>send<span class="token operator">-</span>mail</pre></td></tr></table></figure><h5 id="在嵌套资源的-url-中使用关系"><a class="anchor" href="#在嵌套资源的-url-中使用关系">#</a> 在嵌套资源的 URL 中使用关系</h5><p>获取指定订单中所有商品列表。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">GET</span> <span class="token operator">/</span>order<span class="token operator">/</span><span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span><span class="token operator">/</span>products</pre></td></tr></table></figure><p>获取指定订单中所有指定商品信息。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">GET</span> <span class="token operator">/</span>order<span class="token operator">/</span><span class="token punctuation">&#123;</span>orderId<span class="token punctuation">&#125;</span><span class="token operator">/</span>product<span class="token operator">/</span><span class="token punctuation">&#123;</span>productId<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="注释规范"><a class="anchor" href="#注释规范">#</a> 注释规范</h4><h5 id="注释说明意图即可无需补充冗余字段"><a class="anchor" href="#注释说明意图即可无需补充冗余字段">#</a> 注释说明意图即可，无需补充冗余字段</h5><p>**【强制】**Class、Interface、Enum、@interface 等文件类型，<font color="red">类上注释仅需说明类的意图即可，不需要补充时间和创建人 </font>，因为往往开发代码的不止是一个人，容易造成信息干扰。需要的话，查看提交记录即可。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 适配第三方框架的线程池</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ThreadPoolAdapter</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="方法上需要添加注释"><a class="anchor" href="#方法上需要添加注释">#</a> 方法上需要添加注释</h5><p>**【强制】** 接口的方法上需添加注释，并 <font color="red">说明清楚方法的意图（接口实现类无需注释）</font>；必要时描述 <code>@param</code> <code>@return</code> 。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 适配第三方框架的线程池</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ThreadPoolAdapter</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>     * 修改框架线程池的核心参数</pre></td></tr><tr><td data-num="8"></td><td><pre>     *</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @param threadPoolBaseInfo  修改线程池的基础参数</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @return  线程池核心参数修改结果</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">updateThreadPool</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolBaseInfo</span> threadPoolBaseInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>如果方法为内部引用方法，并且方法名称见名知意，无需方法注释。</p><h5 id="方法块内部注释规范"><a class="anchor" href="#方法块内部注释规范">#</a> 方法块内部注释规范</h5><p>**【强制】** 方法内部的注释，应该新起一行，而不是跟在代码后面。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>正例：</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 刷新动态线程池参数</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">refreshDynamicPool</span><span class="token punctuation">(</span>parameter<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>反例：</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">refreshDynamicPool</span><span class="token punctuation">(</span>parameter<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新动态线程池参数</span></pre></td></tr></table></figure><h5 id="方法命名说明方法本身意图"><a class="anchor" href="#方法命名说明方法本身意图">#</a> 方法命名说明方法本身意图</h5><p>**【强制】** 私有方法尽量通过方法命名说明方法语义。</p><h4 id="代码开发规约"><a class="anchor" href="#代码开发规约">#</a> 代码开发规约</h4><p>**【强制】** 类、方法和变量的命名要做到顾名思义，避免使用缩写。</p><p>**【强制】** 静态变量使用大写，多个单词使用下划线连接。示例：MESSAGE_CENTER_SEND_TYPR。</p><p>**【强制】** 捕获的异常名称命名为 ex ；捕获异常且不做任何事情，异常名称命名为 ignored。</p><p>**【强制】** 返回值变量使用 result 命名；循环中使用 each 命名循环变量；map 中使用 entry 代替 each。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//result 命名示范：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseDate</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 或采用 result 为前缀：</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseDate</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">Result</span> resultDate <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> resultDate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">//each 命名示范：</span></pre></td></tr><tr><td data-num="13"></td><td><pre>appNameLeaseMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>each <span class="token operator">-></span> appNameLeaseList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 或是 for 循环：</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Lease</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">></span></span> each <span class="token operator">:</span> appNameLeaseMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    appNameLeaseList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>**【强制】** 业务系统中优先使用 Guava、HuTool、Common3 等工具类中的方法，<font color="red">不存在指定方法时再创建自定义工具类，禁止创建相同语义方法的工具类 </font>。</p><p>备注：定义组件项目时，尽量使用自定义工具类，避免因版本问题导致不确定的异常。</p><p>**【强制】** 空实现接口或类不允许存在换行空格。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 正例</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AdapterThreadPoolMonitor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolMonitor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 反例</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AdapterThreadPoolMonitor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolMonitor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>【建议】优先使用卫语句替换嵌套判断，提高代码简洁度。</p><blockquote><p>在《阿里巴巴 Java 开发手册》中强制规定：<strong>超过 3 层的</strong> <strong>if-else</strong> <strong>的逻辑判断代码可以使用卫语句</strong>、策略模式、<span class="exturl" data-url="aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT0lRTclOEElQjYlRTYlODAlODElRTYlQTglQTElRTUlQkMlOEYmYW1wO3NwbT0xMDAxLjIxMDEuMzAwMS43MDIw">状态模式</span>等来实现，其中卫语句 <font color="red">即代码逻辑先考虑失败、异常、中断、退出等直接返回的情况</font></p></blockquote><p>【建议】方法参数自定义实体对象别名尽量使用 requestParam，非自定义对象可以使用对应语义命名。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/add"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"新增购物车"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemRespDTO</span><span class="token punctuation">></span></span> <span class="token function">addCartItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CartItemAddReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="代码格式化spotless"><a class="anchor" href="#代码格式化spotless">#</a> 代码格式化（Spotless）</h3><p>为什么要代码格式化？代码格式化的意义是让代码更加<strong>易读、易懂、易修改</strong>。</p><p>ShardingSphere 作为 Apache 顶级开源项目，截止当前已有 380+ 贡献者。因为大部分开发人员的代码风格不一致，在 Github 多人协作的模式下，不易保障项目整体代码格式。</p><p>基于以上诉求，ShardingSphere 采用了 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RpZmZwbHVnL3Nwb3RsZXNzL3RyZWUvbWFpbi9wbHVnaW4tbWF2ZW4=">Spotless</span> 充当代码格式统一的角色。</p><h4 id="spotless"><a class="anchor" href="#spotless">#</a> Spotless</h4><p>Spotless 是支持多种语言的代码格式化工具，支持 Maven 和 Gradle 以 Plugin 的形式构建。Spotless 对开发者来说，有 2 种使用方式：</p><ul><li>检查代码是否存在格式问题</li><li>格式化代码</li></ul><h4 id="使用示例"><a class="anchor" href="#使用示例">#</a> 使用示例</h4><p>下述代码是 Spotless 官方示例：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>user@machine repo % mvn spotless:check</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span>  <span class="token operator">></span> The following files had <span class="token function">format</span> violations:</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span>  src<span class="token punctuation">\</span>main<span class="token punctuation">\</span>java<span class="token punctuation">\</span>com<span class="token punctuation">\</span>diffplug<span class="token punctuation">\</span>gradle<span class="token punctuation">\</span>spotless<span class="token punctuation">\</span>FormatExtension.java</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span>    -<span class="token punctuation">\</span>t<span class="token punctuation">\</span>t····if·<span class="token punctuation">(</span>targets.length·<span class="token operator">==</span>·0<span class="token punctuation">)</span>·<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span>    +<span class="token punctuation">\</span>t<span class="token punctuation">\</span>tif·<span class="token punctuation">(</span>targets.length·<span class="token operator">==</span>·0<span class="token punctuation">)</span>·<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span>  Run <span class="token string">'mvn spotless:apply'</span> to fix these violations.</pre></td></tr><tr><td data-num="7"></td><td><pre>user@machine repo % mvn spotless:apply</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> BUILD SUCCESS</pre></td></tr><tr><td data-num="9"></td><td><pre>user@machine repo % mvn spotless:check</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> BUILD SUCCESS</pre></td></tr></table></figure><p>通过 <code>mvn spotless:check</code> 检查项目代码时发现错误，接着使用 <code>mvn spotless:apply</code> 进行代码格式化；再次检查时，格式化错误消失。</p><h5 id="项目实战"><a class="anchor" href="#项目实战">#</a> 项目实战</h5><p>ShardingSphere 使用 Spotless 实现了添加 <strong>Java 文件 licenseHeader</strong> 和 <strong>Java 代码格式化</strong>。</p><p>Spotless 有多种 Java 代码格式化方式，例如：googleJavaFormat、eclipse、prettier 等。基于定制化的考虑，最终采用 <font color="red">eclipse </font>进行 Java 代码格式化。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689587236721-0c9afb27-6a50-49c0-97c8-0d4201182065.png" alt="img"></p><p>1）根据项目需求添加 licenseHeader</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Licensed to the Apache Software Foundation (ASF) under one or more</pre></td></tr><tr><td data-num="3"></td><td><pre> * contributor license agreements.  See the NOTICE file distributed with</pre></td></tr><tr><td data-num="4"></td><td><pre> * this work for additional information regarding copyright ownership.</pre></td></tr><tr><td data-num="5"></td><td><pre> * The ASF licenses this file to You under the Apache License, Version 2.0</pre></td></tr><tr><td data-num="6"></td><td><pre> * (the "License"); you may not use this file except in compliance with</pre></td></tr><tr><td data-num="7"></td><td><pre> * the License.  You may obtain a copy of the License at</pre></td></tr><tr><td data-num="8"></td><td><pre> *</pre></td></tr><tr><td data-num="9"></td><td><pre> *     http://www.apache.org/licenses/LICENSE-2.0</pre></td></tr><tr><td data-num="10"></td><td><pre> *</pre></td></tr><tr><td data-num="11"></td><td><pre> * Unless required by applicable law or agreed to in writing, software</pre></td></tr><tr><td data-num="12"></td><td><pre> * distributed under the License is distributed on an "AS IS" BASIS,</pre></td></tr><tr><td data-num="13"></td><td><pre> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</pre></td></tr><tr><td data-num="14"></td><td><pre> * See the License for the specific language governing permissions and</pre></td></tr><tr><td data-num="15"></td><td><pre> * limitations under the License.</pre></td></tr><tr><td data-num="16"></td><td><pre> */</pre></td></tr></table></figure><p>注意，licenseHeader <strong>最后要留有一行空格</strong>。不然 licenseHeader 和 package 之间将没有空隙。</p><p>2）添加 shardingsphere_eclipse_formatter.xml ：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> standalone<span class="token operator">=</span><span class="token string">"no"</span><span class="token operator">?</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * Licensed to the Apache Software Foundation (ASF) under one</pre></td></tr><tr><td data-num="5"></td><td><pre> * or more contributor license agreements.  See the NOTICE file</pre></td></tr><tr><td data-num="6"></td><td><pre> * distributed with this work for additional information</pre></td></tr><tr><td data-num="7"></td><td><pre> * regarding copyright ownership.  The ASF licenses this file</pre></td></tr><tr><td data-num="8"></td><td><pre> * to you under the Apache License, Version 2.0 (the</pre></td></tr><tr><td data-num="9"></td><td><pre> * "License"); you may not use this file except in compliance</pre></td></tr><tr><td data-num="10"></td><td><pre> * with the License.  You may obtain a copy of the License at</pre></td></tr><tr><td data-num="11"></td><td><pre> *</pre></td></tr><tr><td data-num="12"></td><td><pre> *     http://www.apache.org/licenses/LICENSE-2.0</pre></td></tr><tr><td data-num="13"></td><td><pre> *</pre></td></tr><tr><td data-num="14"></td><td><pre> * Unless required by applicable law or agreed to in writing, software</pre></td></tr><tr><td data-num="15"></td><td><pre> * distributed under the License is distributed on an "AS IS" BASIS,</pre></td></tr><tr><td data-num="16"></td><td><pre> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</pre></td></tr><tr><td data-num="17"></td><td><pre> * See the License for the specific language governing permissions and</pre></td></tr><tr><td data-num="18"></td><td><pre> * limitations under the License.</pre></td></tr><tr><td data-num="19"></td><td><pre> */</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token operator">&lt;</span>profiles version<span class="token operator">=</span><span class="token string">"13"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token operator">&lt;</span>profile kind<span class="token operator">=</span><span class="token string">"CodeFormatterProfile"</span> name<span class="token operator">=</span><span class="token string">"'ShardingSphere Apache Current'"</span> version<span class="token operator">=</span><span class="token string">"13"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.compiler.source"</span> value<span class="token operator">=</span><span class="token string">"1.8"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.compiler.compliance"</span> value<span class="token operator">=</span><span class="token string">"1.8"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.compiler.codegen.targetPlatform"</span> value<span class="token operator">=</span><span class="token string">"1.8"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.indent_empty_lines"</span> value<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.tabulation.size"</span> value<span class="token operator">=</span><span class="token string">"4"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.lineSplit"</span> value<span class="token operator">=</span><span class="token string">"200"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.comment.line_length"</span> value<span class="token operator">=</span><span class="token string">"200"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.tabulation.char"</span> value<span class="token operator">=</span><span class="token string">"space"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.indentation.size"</span> value<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.comment.format_javadoc_comments"</span> value<span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.join_wrapped_lines"</span> value<span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.insert_space_before_colon_in_conditional"</span> value<span class="token operator">=</span><span class="token string">"insert"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.insert_space_before_colon_in_default"</span> value<span class="token operator">=</span><span class="token string">"do not insert"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_enum_constants"</span> value<span class="token operator">=</span><span class="token string">"16"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.insert_space_before_colon_in_labeled_statement"</span> value<span class="token operator">=</span><span class="token string">"do not insert"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.insert_space_before_colon_in_case"</span> value<span class="token operator">=</span><span class="token string">"do not insert"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_conditional_expression"</span> value<span class="token operator">=</span><span class="token string">"80"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_assignment"</span> value<span class="token operator">=</span><span class="token string">"16"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.blank_lines_after_package"</span> value<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.continuation_indentation_for_array_initializer"</span> value<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_resources_in_try"</span> value<span class="token operator">=</span><span class="token string">"160"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_throws_clause_in_method_declaration"</span> value<span class="token operator">=</span><span class="token string">"10"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_parameters_in_method_declaration"</span> value<span class="token operator">=</span><span class="token string">"106"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_parameters_in_constructor_declaration"</span> value<span class="token operator">=</span><span class="token string">"106"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_throws_clause_in_constructor_declaration"</span> value<span class="token operator">=</span><span class="token string">"106"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token operator">&lt;</span>setting id<span class="token operator">=</span><span class="token string">"org.eclipse.jdt.core.formatter.alignment_for_arguments_in_explicit_constructor_call.count_dependent"</span> value<span class="token operator">=</span><span class="token string">"16|5|80"</span><span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>profile<span class="token operator">></span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>profiles<span class="token operator">></span></pre></td></tr></table></figure><blockquote><p>ShardingSphere 最新规则查看 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FwYWNoZS9zaGFyZGluZ3NwaGVyZS9ibG9iL21hc3Rlci9zcmMvcmVzb3VyY2VzL3NoYXJkaW5nc3BoZXJlX2VjbGlwc2VfZm9ybWF0dGVyLnhtbA==">shardingsphere_eclipse_formatter.xml</span>，另提供一份 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9zdHlsZWd1aWRlL2Jsb2IvZ2gtcGFnZXMvZWNsaXBzZS1qYXZhLWdvb2dsZS1zdHlsZS54bWw=">eclipse-java-google-style.xml</span> 供参考</p></blockquote><p>这是一个 XML 文件，看起来是 Eclipse IDE 项目中代码格式化配置文件的一部分。该文件定义了项目中代码格式化的各种设置。</p><p>以下是提供的 XML 文件中一些关键设置的解释：</p><ol><li><p><strong>Java 版本设置:</strong></p><ul><li>源代码兼容性： <code>1.8</code></li><li>编译器兼容级别： <code>1.8</code></li><li>代码生成目标平台： <code>1.8</code></li></ul></li><li><p><strong>代码格式化设置:</strong></p><ul><li><p>缩进：</p><ul><li>空行进行缩进 ( <code>org.eclipse.jdt.core.formatter.indent_empty_lines</code> )。</li><li>制表符大小设置为 <code>4</code> 个空格 ( <code>org.eclipse.jdt.core.formatter.tabulation.size</code> )。</li><li>允许行分割达到 <code>200</code> 个字符 ( <code>org.eclipse.jdt.core.formatter.lineSplit</code> )。</li><li>注释行允许达到 <code>200</code> 个字符 ( <code>org.eclipse.jdt.core.formatter.comment.line_length</code> )。</li><li>使用空格进行制表 ( <code>org.eclipse.jdt.core.formatter.tabulation.char</code> )。</li><li>缩进大小设置为 <code>1</code> 个空格 ( <code>org.eclipse.jdt.core.formatter.indentation.size</code> )。</li></ul></li><li><p>注释格式化：</p><ul><li>不对 JavaDoc 注释进行格式化 ( <code>org.eclipse.jdt.core.formatter.comment.format_javadoc_comments</code> )。</li></ul></li><li><p>其他格式化：</p><ul><li>不连接换行的代码 ( <code>org.eclipse.jdt.core.formatter.join_wrapped_lines</code> )。</li><li>在条件语句中的冒号前插入空格 ( <code>org.eclipse.jdt.core.formatter.insert_space_before_colon_in_conditional</code> )</li></ul></li><li><p>对齐：</p><ul><li>枚举常量使用 <code>16</code> 个空格对齐 ( <code>org.eclipse.jdt.core.formatter.alignment_for_enum_constants</code> )。</li><li>条件表达式使用 <code>80</code> 个空格对齐 ( <code>org.eclipse.jdt.core.formatter.alignment_for_conditional_expression</code> )。</li><li>赋值使用 <code>16</code> 个空格对齐 ( <code>org.eclipse.jdt.core.formatter.alignment_for_assignment</code> )。</li><li>在 try 块中的资源使用 <code>160</code> 个空格对齐 ( <code>org.eclipse.jdt.core.formatter.alignment_for_resources_in_try</code> )。</li><li>方法和构造函数声明中的 throws 子句和参数进行对齐。</li></ul></li><li><p>空白行：</p><ul><li>在包声明后添加一个空白行 ( <code>org.eclipse.jdt.core.formatter.blank_lines_after_package</code> )。</li></ul></li><li><p>数组初始化：</p><ul><li>数组初始化器的连续缩进设置为 <code>2</code> 个空格 ( <code>org.eclipse.jdt.core.formatter.continuation_indentation_for_array_initializer</code> )</li></ul></li></ul></li></ol><p>这个配置似乎是为特定的编码风格定制的，可能是为 ShardingSphere Apache 项目而设计的，使用 Eclipse IDE 版本 13。它确保根据指定的规则生成一致且可读的代码格式。</p><p>shardingsphere_eclipse_formatter.xml 的内容是根据 ShardingSphere 代码规范定制开发的，可灵活变动。</p><p>3）添加 Maven plugin</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.diffplug.spotless<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spotless-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.22.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>eclipse</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">></span></span>$&#123;maven.multiModuleProjectDirectory&#125;/src/resources/shardingsphere_eclipse_formatter.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>eclipse</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>licenseHeader</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">></span></span>$&#123;maven.multiModuleProjectDirectory&#125;/src/resources/license-header<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>licenseHeader</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>Spotless 支持格式化指定目录，以及排除指定目录的功能，详情参考 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RpZmZwbHVnL3Nwb3RsZXNzL3RyZWUvbWFpbi9wbHVnaW4tbWF2ZW4jamF2YQ==">plugin-maven#java</span>。如无指定，执行 check 或 apply 时，默认项目全量代码。</p><p>4）执行代码格式化：执行完上述三个步骤，就可以在项目中执行命令，检查 Java 代码是否符合规范，以及代码格式化功能。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>user@machine repo % mvn spotless:apply</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> BUILD SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>user@machine repo % mvn spotless:check</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> BUILD SUCCESS</pre></td></tr></table></figure><h5 id="绑定-maven-生命周期"><a class="anchor" href="#绑定-maven-生命周期">#</a> 绑定 Maven 生命周期</h5><p>在 ShardingSphere 实际应用中，选择 <font color="red">将 Spotless apply 绑定到 compile 阶段，这样本地执行 mvn install 时就能自动格式化 </font>。</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.diffplug.spotless<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spotless-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.22.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>eclipse</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">></span></span>$&#123;maven.multiModuleProjectDirectory&#125;/src/resources/shardingsphere_eclipse_formatter.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>eclipse</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>licenseHeader</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">></span></span>$&#123;maven.multiModuleProjectDirectory&#125;/src/resources/license-header<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>licenseHeader</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>apply<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="idea-格式化"><a class="anchor" href="#idea-格式化">#</a> IDEA 格式化</h5><p>开发者如果在写代码过程中，想 <font color="red">检查单个文件是否符合规范 </font>，执行 <code>mvn spotless:check</code> 或 <code>mvn spotless:apply</code> 显得有些笨重，因为格式化范围默认是整个项目。</p><p>我们 <font color="red">可以使用 shardingsphere_eclipse_formatter.xml 替换 IntelliJ IDEA 原有格式化功能 </font>，这样在写代码过程中可以随时格式化，极大提升了开发效率。</p><blockquote><p>IDEA 版本 2019.3.4。</p></blockquote><p>1）安装插件 Eclipse Code Formatter</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689587236697-3ca0d07b-15f8-4035-89fe-2b6fbd5c3918.png" alt="img"></p><p>2）选择 shardingsphere_eclipse_formatter.xml 为默认格式化模板</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689587236710-ded7fe72-2a42-4bef-8dc8-87f454354177.png" alt="img"></p><p>使用 IDEA 代码格式化快捷键，就可以完成 Spotless 代码格式化。</p><h4 id="常见问题"><a class="anchor" href="#常见问题">#</a> 常见问题</h4><h5 id="spotless-与-checkstyle-冲突"><a class="anchor" href="#spotless-与-checkstyle-冲突">#</a> Spotless 与 Checkstyle 冲突</h5><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoZWNrc3R5bGUvY2hlY2tzdHlsZQ==">Checkstyle</span> 是一种用于检查 Java 源代码是否符合代码标准或一组验证规则（最佳实践）的工具。</p><p>极端场景下，Spotless 格式化代码后，通过 Checkstyle 检查代码会不通过。</p><p>根本原因在于 <font color="red">两者设定的检查配置和格式化配置冲突 </font>。举个例子，Spotless 格式化后换行缩进了 16 个空格，而 Checkstyle 的换行检查是 12 个空格。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PreciseHintShadowValue</span><span class="token punctuation">&lt;</span><span class="token class-name">Comparable</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">createNoteShadowValues</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ShadowDetermineCondition</span> shadowDetermineCondition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// Checkstyle 可以通过的格式</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> shadowDetermineCondition<span class="token punctuation">.</span><span class="token function">getSqlComments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PreciseHintShadowValue</span><span class="token punctuation">&lt;</span><span class="token class-name">Comparable</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token function">map</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        each <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">PreciseHintShadowValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> shadowOperationType<span class="token punctuation">,</span> each<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// Spotless 格式化后</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> shadowDetermineCondition<span class="token punctuation">.</span><span class="token function">getSqlComments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PreciseHintShadowValue</span><span class="token punctuation">&lt;</span><span class="token class-name">Comparable</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token function">map</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            each <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">PreciseHintShadowValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> shadowOperationType<span class="token punctuation">,</span> each<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这种情况，需要开发者衡量如何取舍。解决方案有两种：<font color="red">修改 Spotless 的格式化规则，或修改 Checkstyle 的检查规则 </font>。</p><h5 id="crlf-与-lf-格式化冲突"><a class="anchor" href="#crlf-与-lf-格式化冲突">#</a> CRLF 与 LF 格式化冲突</h5><p>参考 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RpZmZwbHVnL3Nwb3RsZXNzL2lzc3Vlcy8xMTcx">https://github.com/diffplug/spotless/issues/1171</span></p><h4 id="小结-11"><a class="anchor" href="#小结-11">#</a> 小结</h4><p>文章介绍了 <font color="red">Apache ShardingSphere 使用 Spotless 完成历史代码格式化，以及后续代码格式的统一 </font>，对项目代码的整洁起到了很大帮助。</p><p>当然，Spotless 的功能不止 Java 代码的格式化，包括不限于 Pom 和 Markdown 等文件类型的格式化，后续这些都会在 ShardingSphere 得以应用。</p><h3 id="代码检查checkstyle"><a class="anchor" href="#代码检查checkstyle">#</a> 代码检查（CheckStyle）</h3><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9jaGVja3N0eWxlLm9yZy8=">CheckStyle Site</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoZWNrc3R5bGUvY2hlY2tzdHlsZQ==">CheckStyle GitHub</span></p></blockquote><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1678510337590-eda4e030-0118-4a8b-bdf1-5b276250fa9d.png" alt="img"></p><p>Checkstyle 是一种开发工具，<font color="red">可帮助程序员编写符合编码标准的 Java 代码 </font>。它使检查 Java 代码的过程自动化，从而使开发者免于完成这项无聊（但重要）的任务。这使得它非常适合想要强制执行编码标准的项目。</p><p>Checkstyle 可以检查源代码的许多方面。它可以发现 <font color="red">类设计问题、方法设计问题 </font>。它还能够检查 <font color="red">代码布局和格式问题 </font>。</p><h4 id="定义扫描规则"><a class="anchor" href="#定义扫描规则">#</a> 定义扫描规则</h4><p>CheckStyle 有着众多扫描规则，涵盖种类非常之多，容易让人眼花缭乱。这里提供 <font color="red">一份开源项目 Hippo4j 正在使用的规则文件 </font>，如需个性化可参考官网进行修改。</p><p>创建自定义 <code>checkstyle.xml</code> 文件：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">module</span> <span class="token name">PUBLIC</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">"-//Puppy Crawl//DTD Check Configuration 1.3//EN"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">"http://www.puppycrawl.com/dtds/configuration_1_3.dtd"</span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Checker<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NewlineAtEndOfFile<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>RegexpSingleline<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>format<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>printStackTrace<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Prohibit invoking printStackTrace in source code !<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TreeWalker<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AvoidStarImport<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>excludes<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.io,java.net,java.lang.Math<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allowClassImports<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allowStaticMemberImports<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IllegalImport<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>RedundantImport<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UnusedImports<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JavadocType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allowUnknownTags<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allowMissingParamTags<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>message</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javadoc.missing<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Class Comments: Missing Javadoc Comments<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">&lt;!-- Do not scan method annotations for now --></span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">&lt;!--&lt;module name="JavadocMethod"></span></pre></td></tr><tr><td data-num="26"></td><td><pre>    &lt;property name="tokens" value="METHOD_DEF"/></pre></td></tr><tr><td data-num="27"></td><td><pre>    &lt;property name="allowMissingPropertyJavadoc" value="true"/></pre></td></tr><tr><td data-num="28"></td><td><pre>    &lt;message key="javadoc.missing" value="Method Comments: Missing Javadoc Comments"/></pre></td></tr><tr><td data-num="29"></td><td><pre>  &lt;/module>--></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>LocalFinalVariableName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>LocalVariableName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PackageName<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>format<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>^[a-z]+(\.[a-z][a-z0-9]*)*$<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>StaticVariableName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TypeName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MemberName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MethodName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ParameterName <span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ConstantName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ArrayTypeStyle<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UpperEll<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>LineLength<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MethodLength<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tokens<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>METHOD_DEF<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>150<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ParameterNumber<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ignoreOverriddenMethods<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tokens<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>METHOD_DEF<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MethodParamPad<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TypecastParenPad<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NoWhitespaceAfter<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NoWhitespaceBefore<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>OperatorWrap<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ParenPad<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WhitespaceAfter<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WhitespaceAround<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ModifierOrder<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>RedundantModifier<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AvoidNestedBlocks<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>EmptyBlock<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>LeftCurly<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NeedBraces<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>RightCurly<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>EmptyStatement<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>EqualsHashCode<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IllegalInstantiation<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>InnerAssignment<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MagicNumber<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="75"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ignoreNumbers<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0, 1, 2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ignoreAnnotation<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ignoreHashCodeMethod<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="78"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ignoreFieldDeclaration<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="79"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="80"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MissingSwitchDefault<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="81"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SimplifyBooleanExpression<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SimplifyBooleanReturn<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>FinalClass<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="84"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>InterfaceIsType<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="85"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VisibilityModifier<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="86"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>packageAllowed<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>protectedAllowed<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="88"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="89"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>StringLiteralEquality<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NestedForDepth<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="93"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NestedIfDepth<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="94"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="96"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UncommentedMain<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="97"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>excludedClasses<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.*Application$<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="98"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="99"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Regexp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="100"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>format<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>System\.out\.println<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="101"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>illegalPattern<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="102"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ReturnCount<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="105"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="106"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NestedTryDepth <span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="107"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>max<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="108"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="109"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SuperFinalize<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="110"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SuperClone<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="111"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="112"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>这是一个 PMD 检查器的配置文件，用于在 Java 代码中执行静态代码分析和规范检查。以下是该配置文件的主要模块及其功能的简要说明：</p><ol><li><strong>NewlineAtEndOfFile：</strong><ul><li>检查文件末尾是否有换行符。</li></ul></li><li><strong>RegexpSingleline：</strong><ul><li>检查源代码中是否包含 <code>printStackTrace</code> 。</li><li>提供自定义消息，防止在代码中调用 <code>printStackTrace</code> 。</li></ul></li><li><strong>TreeWalker：</strong><ul><li>使用多个子模块对代码进行深入检查。</li><li><strong>AvoidStarImport：</strong><ul><li>避免使用通配符导入。</li><li>可以排除 <code>java.io</code> 、 <code>java.net</code> 和 <code>java.lang.Math</code> 。</li><li>不允许类导入，但允许静态成员导入。</li></ul></li><li><strong>IllegalImport：</strong><ul><li>检查是否存在非法的导入。</li></ul></li><li><strong>RedundantImport：</strong><ul><li>检查是否存在冗余的导入。</li></ul></li><li><strong>UnusedImports：</strong><ul><li>检查是否存在未使用的导入。</li></ul></li><li><strong>JavadocType：</strong><ul><li>检查类缺少 Javadoc 注释。</li></ul></li><li><strong>LocalFinalVariableName、LocalVariableName、PackageName、StaticVariableName、TypeName、MemberName、MethodName、ParameterName、ConstantName：</strong><ul><li>命名约定的检查。</li></ul></li><li><strong>ArrayTypeStyle：</strong><ul><li>数组声明的样式检查。</li></ul></li><li><strong>LineLength：</strong><ul><li>检查代码行长度不超过 200 个字符。</li></ul></li><li><strong>MethodLength：</strong><ul><li>检查方法长度不超过 150 行。</li></ul></li><li><strong>ParameterNumber：</strong><ul><li>检查方法参数数量不超过 5 个。</li></ul></li><li>其他的模块涵盖了代码格式、布尔表达式简化、代码块规范等方面的检查。</li><li><strong>Regexp：</strong><ul><li>使用正则表达式检查代码中是否包含 <code>System.out.println</code> 。</li></ul></li><li><strong>NestedTryDepth、NestedForDepth、NestedIfDepth：</strong><ul><li>分别检查嵌套的 try、for 和 if 语句的深度。</li></ul></li><li><strong>UncommentedMain：</strong><ul><li>检查是否有未注释的主方法。</li></ul></li><li><strong>MagicNumber：</strong><ul><li>检查是否使用了魔法数字（未解释的常量值）。</li></ul></li><li><strong>ReturnCount：</strong><ul><li>检查方法返回语句的数量是否超过 4 个。</li></ul></li><li><strong>VisibilityModifier：</strong><ul><li>检查不同可见性修饰符的使用。</li></ul></li><li><strong>FinalClass：</strong><ul><li>检查是否有未声明为 <code>final</code> 的类。</li></ul></li><li><strong>InterfaceIsType：</strong><ul><li>检查是否有未声明为接口的类型。</li></ul></li><li><strong>StringLiteralEquality：</strong><ul><li>检查是否使用了字符串字面量的比较。</li></ul></li><li><strong>MissingSwitchDefault：</strong><ul><li>检查是否在 switch 语句中缺少 default 分支。</li></ul></li><li><strong>SuperFinalize、SuperClone：</strong><ul><li>检查是否调用了 <code>super.finalize()</code> 和 <code>super.clone()</code> 。</li></ul></li></ul></li></ol><p>这个配置文件涵盖了许多静态代码检查方面，用于保持代码的一致性、规范性和可读性。</p><h4 id="如何使用"><a class="anchor" href="#如何使用">#</a> 如何使用</h4><p>CheckStyle 在日常生活中有两种常用的使用方式，分别是通过代码编辑器 IDEA 和 Maven 配合使用。</p><h5 id="idea-插件"><a class="anchor" href="#idea-插件">#</a> IDEA 插件</h5><p>首先打开 IDEA 菜单栏的 Settings 配置中的 Plugins，搜索 CheckStyle-IDEA 并安装：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1678510337622-2e5e2a71-018b-4c37-9b0b-227b3bc3616d.png" alt="img"></p><p>安装后，查看 Enable 是否开启，如果没有开启，将该框打勾并重启 IDEA。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1678510337652-c3fb8ca0-2c80-45ff-a52e-37b7fae45190.png" alt="img"></p><p>安装重启 IDEA 之后，Settings 下搜索 Inspections，再查询 CheckStyle，如果能查询到内容，说明安装成功：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1678510337645-569fb749-7e9a-4169-be90-201096220e50.png" alt="img"></p><p>在 Settings 中搜索 CheckStyle，按下图导入上一步骤新建的 checkstyle.xml 文件：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1678510337666-1e3a909c-0615-4f4f-a190-33c8fbd45989.png" alt="img"></p><p>通过下述代码扫描 CheckStyle 代码规则，看是否需要需要变更：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>* 记录 C 用户用户变更日志</pre></td></tr><tr><td data-num="3"></td><td><pre>*</pre></td></tr><tr><td data-num="4"></td><td><pre>* @param customerOperationLogEvent</pre></td></tr><tr><td data-num="5"></td><td><pre>*/</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordCustomerUserOperationLog</span><span class="token punctuation">(</span><span class="token class-name">OperationLogEvent</span> customerOperationLogEvent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">String</span> keys <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> message <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageWrapper</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> customerOperationLogEvent<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_KEYS</span><span class="token punctuation">,</span> keys<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_TAGS</span><span class="token punctuation">,</span> <span class="token class-name">RocketMQConstants</span><span class="token punctuation">.</span><span class="token constant">CUSTOMER_USER_OPERATION_LOG_TAG</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">boolean</span> sendResult <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    sendResult <span class="token operator">=</span> output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"C 端用户保存用户日志，发送状态: &#123;&#125;, Keys: &#123;&#125;, 执行时间: &#123;&#125; ms, 消息内容: &#123;&#125;"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>customerOperationLogEvent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过控制台，可以看到该代码段有以下不规范的操作，双击提示，可以一步一步去解决规范的问题：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1678510338145-441dfc3e-3860-456c-a5c7-9e875e5c83bd.png" alt="img"></p><h5 id="maven-插件"><a class="anchor" href="#maven-插件">#</a> Maven 插件</h5><p>在项目根目录新建一个 dev-support 文件夹，将代码规约配置文件放到此路径下，当然你也可以根据自己的需求去自行定义。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1678510338312-ee096061-b7ad-43e7-86d9-ec21a4fdf0ce.png" alt="img"></p><p>在 Maven 中导入一个名为 maven-checkstyle-plugin 的插件，用于执行 <span class="exturl" data-url="aHR0cDovL2NoZWNrc3R5bGUuc291cmNlZm9yZ2UubmV0Lw==">CheckStyle</span> 任务。下面是一个简单的配置。在 Maven 工程中的 pom.xml 文件，添加内容如下：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-checkstyle-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configLocation</span><span class="token punctuation">></span></span>$&#123;maven.multiModuleProjectDirectory&#125;/dev-support/checkstyle.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configLocation</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includeTestSourceDirectory</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includeTestSourceDirectory</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">></span></span>**/autogen/**/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>validate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>check<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>validate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>运行 CheckStyle 检查：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mvn checkstyle:check</pre></td></tr></table></figure><p>IDEA 和 Maven 插件可结合使用。</p><h3 id="如何正确使用消息队列"><a class="anchor" href="#如何正确使用消息队列">#</a> 如何正确使用消息队列</h3><h4 id="命名规范"><a class="anchor" href="#命名规范">#</a> 命名规范</h4><p><strong>RocketMQ</strong> 相关命名强制使用 <font color="red">英文小写 </font>。</p><p>1）【强制】Topic 命名：业务线_项目名_topic。业务线或项目包含多个单词，使用 - 分割，例如： <code>common_message-center_topic</code> 。</p><p>2）【强制】Tag 命名：业务线_项目_业务_tag，例如： <code>common_message-center_send-message_tag</code> 。</p><p>3）【强制】生产者组命名：业务线_项目_业务_pg，例如： <code>common_message-center_send-message_pg</code> 。</p><p>4）【强制】消费者组命名：业务线_项目_业务_cg，例如： <code>common_message-center_send-message_cg</code> 。</p><h4 id="申请规范"><a class="anchor" href="#申请规范">#</a> 申请规范</h4><p>创建 Topic 需要走线上申请，申请时补充下述信息：</p><hr><p>申请人：马称</p><p>Topic： <code>common_message-center_topic</code></p><p>Produce：</p><table><thead><tr><th></th><th>生产应用</th><th>生产者组</th><th>Tag</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td>message-center</td><td>common_message-center_send-message_pg</td><td>common_message-center_send-message_tag</td><td>流量削峰</td></tr><tr><td>2</td><td>message-center</td><td>common_message-center_send-message_pg</td><td>insurance_trading-order_send-message-fail_tag</td><td>微信模板消息发送失败通知保险项目</td></tr></tbody></table><p>Consume：</p><table><thead><tr><th></th><th>消费应用</th><th>消费者组</th><th>Tag</th><th>消费模型</th><th>备注</th></tr></thead><tbody><tr><td>1</td><td>message-center</td><td>common_message-center_send-message_cg</td><td>common_message-center_send-message_tag</td><td>集群模式</td><td>发送微信模板、短信、小程序等消息</td></tr><tr><td>2</td><td>trading-order</td><td>insurance_trading-order_send-message-fail_cg</td><td>insurance_trading-order_send-message-fail_tag</td><td>集群模式</td><td>微信模板消息发送失败通知保险项目</td></tr></tbody></table><h4 id="使用规范"><a class="anchor" href="#使用规范">#</a> 使用规范</h4><h5 id="发送消息"><a class="anchor" href="#发送消息">#</a> 发送消息</h5><p>1）【强制】消息生产者创建时，<strong>必须指定生产者组</strong>。</p><p>2）【强制】<strong>一个系统对应一个 Topic</strong>，系统下的<strong>不同业务根据 Tag 区分</strong>，参考申请规范 - 消费应用 Tag。</p><p>3）【强制】发送消息时，需设置 KEYS。<strong>KEYS 建议定义为业务唯一标识</strong>，比如订单 ID。</p><p>4）【强制】发送消息不管发送成功或失败，需打印 KEYS、Payload、执行时间以及 SendResult。</p><p>5）【强制】发送消息时，<strong>需设置超时时间</strong>，避免应用被拖垮；建议超时时间设置为 2000ms 内。</p><p>6）【建议】针对可靠性较高的消息，<strong>发送失败后可以存储到 DB，开启定时任务扫描，并重新投递</strong>。</p><h5 id="消费消息"><a class="anchor" href="#消费消息">#</a> 消费消息</h5><p>1）【强制】消费端创建时，<strong>必须指定消费者组</strong>。</p><p>2）【强制】消费端<strong>需要保证数据幂等</strong>。</p><blockquote><p>数据幂等：<strong>对同一操作的重复执行不会产生不同结果</strong>或不良影响。在数据处理和计算中，幂等性是一种重要的特性，确保系统<strong>在面对重复请求或操作时能够保持一致性和可靠性</strong>。</p><p>具体来说，对于一个幂等操作，无论执行多少次，系统的状态都不会发生改变，或者改变是可控的。这对于数据处理和分布式系统尤为重要，因为在这些环境中，<font color="red">可能会出现网络故障、请求超时、重传等情况，导致相同的请求被多次发送 </font>。</p><p>举例来说，假设有一个银行账户转账的操作是幂等的。如果一个用户发起了一笔转账请求，但由于网络问题或其他原因导致请求未得到及时的响应，用户可能会选择重新发送相同的请求。如果这个转账操作是幂等的，系统会确保无论接收到这个请求多少次，最终的结果都是一致的，即转账只会发生一次，不会重复扣款。</p><p>在 Web 开发中，HTTP 方法的幂等性也是一个重要考虑因素。GET 请求通常是幂等的，因为它仅用于获取资源，而不会修改服务器状态。另一方面，<font color="red">POST 请求通常不是幂等的，因为它可能会引起服务器状态的改变，而且多次执行可能产生不同的结果 </font>。</p></blockquote><p>3）【强制】消费消息不管成功或失败，需打印 KEYS、MsgId、执行时间以及 Message。</p><p>4）【强制】不同的应用集群应使用不同的消费者组，如果不同的应用集群需要订阅同一消费者组，需保证 Topic Tag 订阅关系一致。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1663550134348-88d58115-092f-49cb-85d6-cf72280be781.png" alt="img"></p><p>5）【强制】引入 <code>easymall-rocketmq-spring-boot-starter</code> 打印消息消费日志。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Execute result: &#123;&#125;, Keys: &#123;&#125;, Dispatch time: &#123;&#125; ms, Execute time: &#123;&#125; ms, Message: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>6）【建议】消费时<strong>尽量不设置重试</strong>，大部分情况下，执行失败的消息重试后会再次失败，反而会影响消费进度。开发者应该针对特定场景<strong>在代码中设置重试逻辑</strong>。</p><p>7）【建议】消费者<strong>并发消费数量默认为 1，即串行化</strong>，应该基于不同系统场景来设置并发数，同时要考虑消费过程中其它组件的压力。</p><ul><li>系统 CPU 任务少： <code>CPU 核数 / (1 - 阻塞系数 0.8)</code> 。</li><li>系统 CPU 任务较多，建议 <code>CPU 核数 + 1</code> 即可。</li></ul><h2 id="基础组件库"><a class="anchor" href="#基础组件库">#</a> 基础组件库</h2><h3 id="从0到1写组件库"><a class="anchor" href="#从0到1写组件库">#</a> 从 0 到 1 写组件库</h3><p>文章从零到一的<strong>封装设计 Starter</strong>，并提供<strong>可插拔 Starter</strong> 以及<strong>元数据配置</strong>等说明，并在可插拔上与开源 Zuul 进行比对，希望小伙伴看后有所收获。</p><h4 id="springboot-starter"><a class="anchor" href="#springboot-starter">#</a> SpringBoot Starter</h4><h5 id="starter-定义"><a class="anchor" href="#starter-定义">#</a> Starter 定义</h5><p>SpringBoot Starter 类似于一种插件机制，抛弃了之前繁琐的配置，<font color="red">将复杂依赖统一集成 </font>进 Starter。</p><p>所有依赖模块都遵循着约定成俗的默认配置，并允许我们调整这些配置，即遵循 <font color="red">“约定大于配置”</font>的理念。</p><h5 id="starter-好处"><a class="anchor" href="#starter-好处">#</a> Starter 好处</h5><p>Starter 的出现极大地帮助开发者们 <font color="red">从繁琐的框架配置中解放出来 </font>，从而更专注于业务代码。</p><p>并且 SpringBoot <font color="red">官方提供企业级项目不同场景的 Starter 依赖模块 </font>，可以很便捷的集成进项目。</p><p>比如 SpringBoot 项目需要依赖 Redis，我们只需要加入 spring-boot-starter-data-redis 依赖，并配置一些必须的连接信息。</p><p><strong><font color="red">使用者只需要引用 Starter 依赖，SpringBoot 就可以自动加载项目所需要的配置依赖，彻底摆脱了不同的依赖库引用以及版本问题 </font></strong>。</p><h4 id="自定义-starter"><a class="anchor" href="#自定义-starter">#</a> 自定义 Starter</h4><h5 id="starter-命名"><a class="anchor" href="#starter-命名">#</a> Starter 命名</h5><p>官方对 Starter 包定义的 ArtifactId 是有要求的，当然也可以不遵守（毕竟你的项目你做主）。</p><p>Spring <font color="red">官方提供 Starter 通常命名为 `spring-boot-starter-{name}</font>，如：spring-boot-starter-web，spring-boot-starter-activemq 等，这里放一部分官方提供列表，详情查看 SpringBoot Starter 列表。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558671062-acc51f4b-253d-4017-ae5e-4fa71f43c1a6.png" alt="img"></p><p>Spring 官方建议 <font color="red">非官方提供的 Starter 命名应遵守 <code>&#123;name&#125;-spring-boot-starter</code> 的格式 </font>。</p><p>比如 MyBatis 出品的：mybatis-spring-boot-starter。</p><h5 id="创建-springboot-项目-2"><a class="anchor" href="#创建-springboot-项目-2">#</a> 创建 SpringBoot 项目</h5><p><font color="red">Starter 也是基于 SpringBoot 项目创建的 </font>，所以第一步应该先创建 SpringBoot 项目。</p><p>创建工程完成后，删除不必要文件，目录如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>├── pom<span class="token punctuation">.</span>xml</pre></td></tr><tr><td data-num="2"></td><td><pre>└── src</pre></td></tr><tr><td data-num="3"></td><td><pre>    ├── main</pre></td></tr><tr><td data-num="4"></td><td><pre>    │   ├── java</pre></td></tr><tr><td data-num="5"></td><td><pre>    │   │   └── cn</pre></td></tr><tr><td data-num="6"></td><td><pre>    │   │       └── machen</pre></td></tr><tr><td data-num="7"></td><td><pre>    │   │           └── starter</pre></td></tr><tr><td data-num="8"></td><td><pre>    │   │               └── demospringbootstarter</pre></td></tr><tr><td data-num="9"></td><td><pre>    │   └── resources</pre></td></tr></table></figure><h5 id="pom-依赖配置"><a class="anchor" href="#pom-依赖配置">#</a> Pom 依赖配置</h5><p>pom.xml 中依赖非常简洁，除了 <font color="red">项目的基本信息 </font>和 <font color="red">父类引用 </font>，只需 <font color="red">引用 spring-boot-starter </font>即可。</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.2.11.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.machen.starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>demo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="自动配置类"><a class="anchor" href="#自动配置类">#</a> 自动配置类</h5><p>创建一个注册为 Spring Bean 的 Service 类，提供一个 sayHello 方法以供后续测试。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceBean</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Hello World, %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><font color="red">创建自动配置类 </font>，将 ServiceBean 进行 <font color="red">声明 Bean </font>，等待扫描后交付给 Spring Ioc 容器。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoConfigurationTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ServiceBean</span> <span class="token function">getServiceBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="springfactories"><a class="anchor" href="#springfactories">#</a> spring.factories</h5><p><font color="red">项目 Resources 目录下新建 META-INF 文件夹 </font>，然后创建 spring.factories 文件。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558646997-4699c8ed-f6e0-4dff-b666-ee5bad6a5122.png" alt="img"></p><p>文件中 <font color="red">定义 Autoconfigure 指定配置类为自动装配的配置 </font>。</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre>org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</pre></td></tr><tr><td data-num="2"></td><td><pre>  cn.machen.starter.demospringbootstarter.AutoConfigurationTest</pre></td></tr></table></figure><p><strong>为什么要指定 resources/META-INF 下写 spring.factories？不这么写不行啊。</strong></p><p><code>SpringFactoriesLoader#loadFactories</code> 负责完成自动装配类的加载，扫描的就是 spring.factories 这个变量文件。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558671063-d0f23e9a-950d-4fb0-a40b-f9c3812e44b0.png" alt="img"></p><h5 id="打包项目发布仓库"><a class="anchor" href="#打包项目发布仓库">#</a> 打包项目，发布仓库</h5><p>我们提供 Starter 肯定是要被第三方或者我们其它项目所引用的，所以要把项目打包后发布到仓库中。</p><blockquote><p>这里科普一下 Maven 命令知识点，一般我们打包使用比较多的命令就是 package、install、deploy。</p><p>声明一点就是这三个命令都能打包，而且是步骤递增关系：</p><ul><li>**package：** 该命令完成了 <font color="red">项目编译、单元测试、打包 </font>功能三个过程。</li><li>**install：** 在 package 命令的前提下新增一个步骤，将新打好的包 <font color="red">部署到本地 Maven 仓库 </font>。</li><li>**deploy：** 在 install 命令的前提下新增一个步骤，将新打的包 <font color="red">部署到远端仓库（相当于本地和远端仓库同时部署一份）</font>。</li></ul></blockquote><p>而我们只是本地仓库引用，只需要 install 命令执行即可，两种方式分别是 Maven 插件或者终端执行命令 <strong>mvn clean install。</strong></p><p><img data-src="https://cdn.nlark.com/yuque/0/2023/png/331027/1689558671126-92a4ae4b-6986-45dd-82d3-71299e0418c3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_5pCc77yabmFnZW9mZmVyLmNvbQ%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p><p>可以去对应的仓库坐标下查看 Jar 是否部署成功。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558671063-60c05bbe-880b-4c34-8041-d27add2f8313.png" alt="img"></p><h5 id="测试-starter"><a class="anchor" href="#测试-starter">#</a> 测试 Starter</h5><p>我们如何测试刚才新建的 Starter 是否成功了呢？新建一个项目 demo-test ，然后在 pom.xml 文件中引用 demo 的 Starter 项目坐标就可以了。</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.2.11.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.machen.starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>demo-test-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">&lt;!-- 引入 starter 包 --></span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.machen.starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>demo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.junit.vintage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit-vintage-engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>既然是测试，<strong>达到什么样的标准才算通过呢？</strong></p><p>根据我们 Starter 中定义代码，只要 demo-test 项目 <strong>引用 ServiceBean 打印输出对应信息</strong> 即算成功。</p><p>src-main-test 目录下使用项目创建自带的测试类。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DemoTestSpringBootStarterApplicationTests</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">ServiceBean</span> serviceBean<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>serviceBean<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">"machen"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>运行 contextLoads 测试方法，最终输出 <strong>Hello World, machen。</strong></p><p>你以为这就结束了么？不不不，硬核且干的知识才刚刚开始。</p><h4 id="可插拔-starter"><a class="anchor" href="#可插拔-starter">#</a> 可插拔 Starter</h4><h5 id="自定义可插拔-starter"><a class="anchor" href="#自定义可插拔-starter">#</a> 自定义可插拔 Starter</h5><p>Starter 就是 Starter，咋起了个名字叫 <strong>可插拔。</strong></p><p>所谓可插拔，字面意思理解就是虽然我引入了你的 Starter Jar 包，但是 <font color="red">可以通过条件判断是否加载 Starter 的功能 </font>。</p><p>满足条件的话加载此 Jar 相关配置，不满足就哪凉快哪歇着吧（比较白话哈，具体点就是模块插件化，降低耦合）。</p><p>实现可插拔的方式有很多，通过 <font color="red">配置文件 Key 前缀 </font>或者 <font color="red">自定义注解 </font>等，但是这些都绕不过 SpringBoot 的 <font color="red">条件注解 </font>。</p><p>文章使用 <font color="gree">自定义注解 + 条件注解 </font>的形式完成，其余这里就不一一举例了，大家可以网上自行搜索。</p><hr><p><strong>demo-spring-boot-starter</strong></p><p>1）首先在项目中创建 <font color="red">自定义注解 </font>@EnableAutoConfigTest 。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAutoConfigTest</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）AutoConfigurationTest 类中添加 <font color="red">条件注解 </font>@ConditionalOnBean ，然后 <font color="red">重新打包 </font>至本地仓库。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span>annotation <span class="token operator">=</span> <span class="token class-name">EnableAutoConfigTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoConfigurationTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ServiceBean</span> <span class="token function">getServiceBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>解读 <code>@ConditionalOnBean(annotation = EnableAutoConfigTest.class)</code> ：</p><p><code>@ConditionalOnBean</code> 注解用于 <font color="red">指定一个或多个 bean 存在时，才会启用被注解的类或配置 </font>。因此 <code>@ConditionalOnBean(annotation = EnableAutoConfigTest.class)</code> 表示被注解的类或配置（AutoConfigurationTest）只有在存在带有 <code>EnableAutoConfigTest</code> 注解的 bean（下文中的 DemoTestSpringBootStarterApplication）时才会生效。</p><p>这通常用于在 Spring Boot 自动配置中，根据特定的条件来决定是否启用某个配置类。</p></blockquote><p><strong>demo-test-spring-boot-starter</strong></p><p>1）在主程序引用 @EnableAutoConfigTest 注解 。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@EnableAutoConfigTest</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoTestSpringBootStarterApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">DemoTestSpringBootStarterApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>测试可插拔 starter</strong></p><p>跑一下上文测试类中运行程序，这样的常规操作自然可以正常打印我们的 Hello World。</p><p>跑程序谁家只跑正常的呀是不是，把 @EnableAutoConfigTest 删了试一哈，看迎接咱的是不是这玩意。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Unsatisfied</span> dependency expressed through field 'serviceBean'<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span>NoSuchBeanDefinitionException</span><span class="token operator">:</span> <span class="token class-name">No</span> qualifying bean of type '<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>machen<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>demospringbootstarter<span class="token punctuation">.</span></span>ServiceBean</span>' available<span class="token operator">:</span> expected at least <span class="token number">1</span> bean which qualifies as autowire <span class="token class-name"><span class="token namespace">candidate<span class="token punctuation">.</span></span> Dependency</span> annotations<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token annotation punctuation">@org.springframework.beans.factory.annotation.Autowired</span><span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当然，正式环境上可不能实现的这么糙哈，不过，思路都是一致的。</p><p>之前参与公司搜索业务封装 Starter，就是采用上述自定义注解结合条件注解完成的。</p><p>其实除了文中可插拔的实现之外，像 SpringCloud Zuul 也是类似的思路，因为就这点玩意，也玩不出个花。</p><h5 id="zuul-实现可插拔原理"><a class="anchor" href="#zuul-实现可插拔原理">#</a> Zuul 实现可插拔原理</h5><p>我们通常是通过配置类上配置 zuul 注解 <code>@EnableZuulProxy</code> 开启 Zuul 注入功能。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558671095-50016818-1b35-4e51-97ca-718f984a32d0.png" alt="img"></p><p>看一下图片中标红的类起到了什么作用。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558671737-05cfdd86-2429-40ff-8fae-0c8d63d24ef7.png" alt="img"></p><p>通过类上的注释得知：</p><p>负责添加标记 bean 以触发 {@link ZuulProxyAutoConfiguration} 的激活。</p><p>其实到这里就已经很明白了，但是本着负责到底的良好品质，继续跟进。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558671994-b1b78afb-9501-4487-8e52-0c33974fce3e.png" alt="img"></p><p>和我们上面自定义可插拔 Starter 思想一致，通过一个标记来实现可插拔特性。</p><p>不同的是 Zuul 中使用过一个无实际意义的 Bean 来标记，而我们使用的注解。</p><h4 id="配置元数据"><a class="anchor" href="#配置元数据">#</a> 配置元数据</h4><p>不知道小伙伴在项目配置文件中输入时，看到智能提示时，有没有疑惑怎么实现的？</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558672059-9bbc286d-93e5-4bd7-848b-8858488278e1.png" alt="img"></p><p>以 <span class="exturl" data-url="aHR0cDovL3NlcnZlci54eHg=">server.xxx</span> 为例，带着疑惑打开 SpringBoot 源码包下的 <code>spring-configuration-metadata.json</code> 。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558672204-c80f2b61-5aa1-4bf1-a0b3-4989a8027460.png" alt="img"></p><p>看到 defaultValue 和 description 熟悉么？可不就是上文中提示的默认值以及提示信息嘛。</p><p>这种文件如何产生的呢？有两种方式：</p><ol><li>通过建立 <code>META-INF/spring-configuration-metadata.json</code> 文件，开发者 <font color="red">手动配置 </font>。</li><li>还有一种是通过注解 <code>@ConfigurationProperties</code> 方式 <font color="red">自动生成 </font>。</li></ol><p>实现元数据配置只需要在 starter 包下简单三步操作：</p><p>1）pom.xml 文件中 <font color="red">引入 <code>spring-boot-configuration-processor</code> 包 </font>。</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-configuration-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>2）<font color="red">编写 Properties 配置类 </font>，以 Swagger 示例。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"swagger"</span><span class="token punctuation">)</span> <span class="token comment">// 用于自动生成 swagger 相关的元数据配置</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerProperties</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>     * 文档扫描包路径</pre></td></tr><tr><td data-num="8"></td><td><pre>     */</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> basePackage <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>     * title 示例：订单创建接口</pre></td></tr><tr><td data-num="13"></td><td><pre>     */</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> title <span class="token operator">=</span> <span class="token string">"平台系统接口详情"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 服务条款网址</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> termsOfServiceUrl <span class="token operator">=</span> <span class="token string">"https://www.xxxx.com/"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * 版本号</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> version <span class="token operator">=</span> <span class="token string">"V_1.0.0"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3）最后 <font color="red">执行打包命令 </font>，更新本地仓库 Jar 包。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mvn clean <span class="token function">install</span></pre></td></tr></table></figure><p>接下来在 demo-test-spring-boot-starter 项目更新引用，然后在 application.properties 测试一下。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558672684-292abf88-e9e6-491d-aa72-96fa4958574f.png" alt="img"></p><h4 id="mybatis-starter-如何实现"><a class="anchor" href="#mybatis-starter-如何实现">#</a> MyBatis Starter 如何实现</h4><p>我们引一下相关 pom 包依赖，如果大家平常找不到相关依赖包，可以在公共仓库上搜索。</p><blockquote><p>公共仓库地址：<span class="exturl" data-url="aHR0cHM6Ly9tdm5yZXBvc2l0b3J5LmNvbS8=">https://mvnrepository.com/</span></p></blockquote><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>看一下 Mybatis Starter 包里都包含什么内容，是否和我们自定义一致。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558673546-dfbd5983-9ef6-4e6b-b631-f8cb8bbb4bd2.png" alt="img"></p><p>why？这里面为啥该有的配置类元信息啥的都没有？点进去可能找到答案的 pom.xml 看一哈。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558674073-acccad26-b699-4580-8775-d6d7443f8ade.png" alt="img"></p><p>可以看到 pom.xml 中包含 mybatis-spring-boot-autoconfigure、mybatis、mybatis-spring 依赖。</p><p>而 <font color="red">真正让 Mybatis 进行全局初始化的秘密就在 <code>mybatis-spring-boot-autoconfigure</code> 中 </font>。</p><p><img data-src="https://cdn.nlark.com/yuque/0/2023/png/331027/1689558674581-31461b29-443c-4b7b-9ef6-667c45a664a7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_5pCc77yabmFnZW9mZmVyLmNvbQ%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p><p>到这里就很明确了，mybatis-spring-boot-autoconfigure 包含初始化配置类 MybatisAutoConfiguration，在其中做了 Mybatis 相关初始化。</p><p><strong>MyBatis Starter 设计与我们上文讲的自定义 Starter 有何不同？</strong></p><p>Mybatis Starter 并没有做什么操作，只是做了一个组合依赖作用，起到初始化作用的是其中 Autoconfigure 包。</p><p>springboot 也是这种思想，只不过它是将所有包的 autoconfigure 实现统一发现的，大家看一下 spring-boot-autoconfigure-xxx.jar 就会明白。</p><p>而我们<strong>自定义 Starter 中就少了依赖 Autoconfigure 包这个环节</strong>，两者无关对错，只是不同设计的体现，这里不作任何建议，看个人喜好。</p><p>啥？你说要跟着主流走，严格贯彻 SpringBoot 思想？</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558674652-271637d0-548a-4b36-af5e-81183739f714.jpeg" alt="img"></p><p>就料到你会这么想，所以我们也搬来了 “重量级” 选手 Netflix。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1689558675315-f64f0b79-29aa-45a5-bda9-c7b123fd4d65.png" alt="img"></p><p>懂的人自然懂，看心情实现 Starter 吧，一天到晚写 BUG 的互联网人。</p><h3 id="基础组件"><a class="anchor" href="#基础组件">#</a> 基础组件</h3><blockquote><p><code>framework/starter/bases</code> 包</p></blockquote><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-base-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><code>index12306-base-spring-boot-starter</code> 在 12306 的整体规划中，属于 <font color="red">顶层组件或基础组件 </font>。</p><p>那什么样的组件能被称为顶层？可以从几个方面去说明这个问题：</p><ul><li>兼容性：能够被所有组件或者所有客户端项目所依赖，不会存在兼容性的代码组件。</li><li>功能性：独立且公用的功能可被用户无感知依赖。比如当 fastjson 出现安全漏洞，可通过升级顶层组件来解决所有依赖包问题。</li></ul><p>组件概览：</p><ol><li>定义 <font color="red">全局配置常量 </font>和 <font color="red">过滤器执行顺序 </font>。</li><li><font color="red">封装 Spring 应用上下文 </font><code>ApplicationContextHolder</code> 。</li><li><font color="red">封装 FastJSON 安全模式 </font>，客户端可通过配置 <code>fastjson.safa-mode=true</code> 开启安全模式。</li><li><font color="red">封装应用初始化事件 </font>，通过 Spring <code>ApplicationReadyEvent</code> 进行发布，并保证仅执行一次 <code>ApplicationInitializingEvent</code> 。</li><li><font color="red">单例对象容器 </font>，可避免重复创建对象，方便全局访问。</li></ol><h4 id="全局变量-组件执行顺序"><a class="anchor" href="#全局变量-组件执行顺序">#</a> 全局变量 &amp; 组件执行顺序</h4><h5 id="全局用户常量"><a class="anchor" href="#全局用户常量">#</a> 全局用户常量</h5><blockquote><p>UserConstant</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>constant</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * 用户常量</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UserConstant</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 用户 ID Key</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_ID_KEY</span> <span class="token operator">=</span> <span class="token string">"userId"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 用户名 Key</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_NAME_KEY</span> <span class="token operator">=</span> <span class="token string">"username"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * 用户真实名称 Key</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REAL_NAME_KEY</span> <span class="token operator">=</span> <span class="token string">"realName"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre>     * 用户 Token Key</pre></td></tr><tr><td data-num="27"></td><td><pre>     */</pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_TOKEN_KEY</span> <span class="token operator">=</span> <span class="token string">"token"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>思考下，为什么要定义这个全局变量定义常量类？</p><p>如果没有定义在顶级组件库中，那么这些常量都是定义在各个组件库中的。比如用户的常量定义在用户的组件库中。</p><p>那又为什么把这个抽象提炼出来？</p><p>一旦涉及到抽象提炼的工作，就能说明，这个常量肯定不是只在用户组件库中使用。因为在网关中，将用户 Token 进行解析，并放到 HTTP Header 中，最终放到用户请求上下文，也需要用到这些用户常量。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">String</span> requestPath <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPathInBlackPreList</span><span class="token punctuation">(</span>requestPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getBlackPathPre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token class-name">UserInfoDTO</span> userInfo <span class="token operator">=</span> <span class="token class-name">JWTUtil</span><span class="token punctuation">.</span><span class="token function">parseJwtToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">validateToken</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token class-name">ServerHttpRequest<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>httpHeaders <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token comment">// 通过 HTTP Token 获取用户 ID 放入 HTTP Header 中</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                httpHeaders<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token constant">USER_ID_KEY</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token comment">// 同上</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                httpHeaders<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token constant">USER_NAME_KEY</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    <span class="token comment">// 同上</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                    httpHeaders<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token constant">REAL_NAME_KEY</span><span class="token punctuation">,</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>类似于 **<font color="red">这种多处使用的变量，分别定义肯定是不优雅的 </font>**，那我们只能找个地方将这个定义，并被用户和网关同时使用。<strong>基础组件库因为要被每个组件库依赖，所以是最好的选择</strong>。</p><h5 id="全局过滤器顺序执行常量类"><a class="anchor" href="#全局过滤器顺序执行常量类">#</a> 全局过滤器顺序执行常量类</h5><blockquote><p>FilterOrderConstant</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>constant</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * 全局过滤器顺序执行常量类</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FilterOrderConstant</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 用户信息传递过滤器执行顺序排序</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">USER_TRANSMIT_FILTER_ORDER</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>再思考下，过滤器、拦截器或 AOP 组件的执行顺序又为什么定义在基础组件库？</p><p>提个问题：假设你的应用依赖了日志打印和幂等组件，方法执行时，需要打印日志和避免请求幂等。流程伪代码如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Log</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Idempotent</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token class-name">UserInfoDTO</span> userInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> userInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>正常来说，要先打印日志，再触发幂等行为。但是，如果说日志和幂等的组件库开发者不是同一人，幂等在日志请求之前。如果不触发幂等还好，一旦触发幂等行为抛出异常，那么日志组件将不再执行。这对于生产日志以及排查问题来说非常不友好。</p><p><strong>所以说，<font color="red">每个基础组件的执行顺序需要在全局定义 </font>，每个组件开发者要有全局思维，定义类似于这种过滤器或拦截器再或者 AOP 时，需要从组件功能再结合全局组件功能考虑到执行顺序问题。</strong></p><p>正因为如此，将这些组件的执行顺序单独放到基础组件库中，一个是基础组库被全部组件库依赖，另一个就是定义组件时，也能看到其他组件库的功能以及执行顺序。避免出现信息孤岛问题。</p><p>总得来说，有以下这些优势：</p><ul><li>解耦和可复用性：通过将组件库的执行顺序抽象到一个基础的组件库中，<font color="red">可以将各个组件库之间的依赖和执行顺序解耦 </font>。这样，每个组件库可以独立开发、测试和维护，提高了代码的可复用性和可维护性。</li><li>灵活性：由于执行顺序被抽象到基础组件库中，<font color="red">可以根据具体的业务需求对组件库进行配置，灵活地调整组件的执行顺序 </font>。这种灵活性使得开发人员可以根据具体的场景和需求来定义过滤器的执行顺序，提供更好的定制化和灵活性。</li><li>执行顺序的统一管理：将执行顺序抽象到一个基础组件库中，<font color="red">可以实现对所有组件库中过滤器执行顺序的统一管理 </font>。开发人员只需关注各个组件库的业务逻辑实现，而不必关心过滤器的具体执行顺序。这样可以简化开发流程，提高开发效率。</li><li>扩展性：基础组件库 <font color="red">可以提供一些通用的功能和特性 </font>，例如全局变量的管理、过滤器的注册和执行等。这样可以为其他组件库提供扩展性，使其能够更好地适应不同的业务场景和需求。</li></ul><h4 id="spring-容器上下文"><a class="anchor" href="#spring-容器上下文">#</a> Spring 容器上下文</h4><blockquote><p>ApplicationContextHolder</p></blockquote><p>在 Spring Bean 中获取 Spring Bean，只需要通过构造器或者 @Autowired 或 @Resource 就可以了。</p><p>但是很多时候，我们也 <font color="red">需要在非 Spring Bean 中使用到 Spring Bean </font>。</p><p>举个简单的例子，大家定义线程池任务实现类时，可能需要获取到 Spring Bean。</p><p>基于以上诉求，我们依赖 Spring 提供的 <code>ApplicationContextAware</code> 接口，来将 Spring IOC 容器的对象放到一个自定义容器中，并持有 Spring IOC 容器。</p><p>这样就可以 <font color="red">通过实现 ApplicationContextAware 接口，自定义上下文容器，从而访问 Spring IOC 容器，获取 Spring Bean </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * ApplicationContextHolder：用于获取 Spring 的上下文对象 ApplicationContext</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// ApplicationContextAware 是 Spring 提供的一个接口，用于获取 Spring 的上下文对象 ApplicationContext</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextHolder</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> <span class="token constant">CONTEXT</span><span class="token punctuation">;</span> <span class="token comment">// 存储 Spring 的上下文对象</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token constant">CONTEXT</span> <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 按类型获取 ioc 容器 bean</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * 按名称获取 ioc 容器 bean</pre></td></tr><tr><td data-num="25"></td><td><pre>     */</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="31"></td><td><pre>     * 按名称和类型获取 ioc 容器 bean</pre></td></tr><tr><td data-num="32"></td><td><pre>     */</pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre>     * 按类型获取一组 ioc 容器 beans</pre></td></tr><tr><td data-num="39"></td><td><pre>     */</pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="45"></td><td><pre>     * 查找 bean 是否有注释</pre></td></tr><tr><td data-num="46"></td><td><pre>     */</pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> <span class="token class-name">A</span> <span class="token function">findAnnotationOnBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">></span></span> annotationType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">findAnnotationOnBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> annotationType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="52"></td><td><pre>     * 获取应用程序上下文 applicationContext</pre></td></tr><tr><td data-num="53"></td><td><pre>     */</pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="fastjson-安全模式"><a class="anchor" href="#fastjson-安全模式">#</a> FastJSON 安全模式</h4><blockquote><p>FastJsonSafeMode</p></blockquote><p>Fastjson 的 <font color="red">&quot;autoType&quot; 特性是指在反序列化过程中，允许将 JSON 字符串自动转换为指定的 Java 类型 </font>。它提供了一种方便的方式，使得开发人员可以直接将 JSON 数据转换为相应的 Java 对象，而无需手动指定目标类。</p><p>然而，这个特性也存在一定的安全风险。<font color="red">攻击者可以构造恶意的 JSON 数据，其中包含对不受信任的类的引用。当 &quot;autoType&quot; 特性被启用时，Fastjson 会尝试根据 JSON 字符串中的类信息实例化相应的对象，而不考虑该类是否可信或预期，从而可能导致潜在的安全问题，例如远程代码执行攻击。</font></p><p>为了说明这个问题，考虑以下示例：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"com.example.EvilClass\",\"data\":\"Malicious Data\"&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>在上述示例中，JSON 字符串中的 &quot;@type&quot; 属性指定了一个名为 &quot;com.example.EvilClass&quot; 的类。如果 Fastjson 的 &quot;autoType&quot; 特性被启用，它将尝试将该 JSON 字符串转换为 &quot;com.example.EvilClass&quot; 类的实例，而不考虑该类是否可信或预期。</p><p><strong><font color="red">为了防止这种安全问题，Fastjson 默认情况下禁用了 &quot;autoType&quot; 特性，以提供一定的安全性 </font></strong>。但是，在某些特定场景下，开发人员可能会手动启用该特性，例如在处理受信任的 JSON 数据时需要转换为多态对象。</p><p>我们 FastJSON 安全模式，会关闭该 autoType 特性。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>safa</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">InitializingBean</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre> * FastJson 安全模式，开启后关闭类型隐式传递</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// InitializingBean 接口是 Spring 提供的一个初始化 bean 的接口</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastJsonSafeMode</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 该方法在 bean 初始化后执行</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"fastjson2.parser.safeMode"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启用 fastjson 的安全模式，更加严格地检查 JSON 数据的结构，防止一些潜在的安全风险，例如防止恶意构造的 JSON 数据导致的攻击。</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>如果配置文件中配置了 <code>framework.fastjson.safa-mode=true</code> 那么则开启安全模式，反之无任何变化。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContextHolder</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>init<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContentPostProcessor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>safa<span class="token punctuation">.</span></span><span class="token class-name">FastJsonSafeMode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>condition<span class="token punctuation">.</span></span><span class="token class-name">ConditionalOnMissingBean</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>condition<span class="token punctuation">.</span></span><span class="token class-name">ConditionalOnProperty</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContext</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre> * 应用基础自动装配</pre></td></tr><tr><td data-num="13"></td><td><pre> *</pre></td></tr><tr><td data-num="14"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="15"></td><td><pre> */</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationBaseAutoConfiguration</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@Bean</span> <span class="token comment">// 注册一个 bean</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token annotation punctuation">@ConditionalOnMissingBean</span> <span class="token comment">// 当容器中没有该 bean 的情况下创建该 bean</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// ApplicationContextHolder 是自定义的一个 bean，用于获取 Spring 的上下文对象 ApplicationContext，用于获取 bean</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ApplicationContextHolder</span> <span class="token function">congoApplicationContextHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token annotation punctuation">@ConditionalOnMissingBean</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// ApplicationContentPostProcessor 是自定义的一个 bean，用于防止 Spring 事件被多次执行</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ApplicationContentPostProcessor</span> <span class="token function">congoApplicationContentPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContentPostProcessor</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token annotation punctuation">@ConditionalOnMissingBean</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"framework.fastjson.safa-mode"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// 当 framework.fastjson.safa-mode 为 true 时创建该 bean</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">// FastJsonSafeMode 是自定义的一个 bean，用于开启 fastjson 的安全模式</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FastJsonSafeMode</span> <span class="token function">congoFastJsonSafeMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FastJsonSafeMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="安全初始化事件"><a class="anchor" href="#安全初始化事件">#</a> 安全初始化事件</h4><blockquote><p>ApplicationInitializingEvent</p></blockquote><p>我们在实际应用开发中，会依赖很多应用初始化时执行任务，比如说 <code>InitializingBean</code> 、 <code>CommandLineRunner</code> 等。</p><p>除此之外，还有 <font color="gree">一些依赖 Spring 初始化的事件 </font>。</p><ol><li><code>ContextRefreshedEvent</code> ： <font color="red">当应用程序上下文（ApplicationContext）初始化或刷新完成后触发 </font>。这通常发生在应用程序启动过程中，并且表示应用程序已准备好接收请求和执行业务逻辑。可以使用该事件来 **<font color="red">执行一些初始化操作，例如加载缓存数据、启动后台任务等 </font>**。</li><li><code>ContextStartedEvent</code> ： <font color="red">当 ApplicationContext 启动时触发 </font>。这个事件在调用 ConfigurableApplicationContext 的 start () 方法后被发布。可以使用该事件来 **<font color="red">执行启动应用程序所需的特定逻辑，例如启动定时任务、启动消息监听器等 </font>**。</li><li><code>ContextStoppedEvent</code> ： <font color="red">当 ApplicationContext 停止时触发 </font>。这个事件在调用 ConfigurableApplicationContext 的 stop () 方法后被发布。可以使用该事件来 **<font color="red">执行停止应用程序所需的清理逻辑，例如关闭连接、释放资源等 </font>**。</li><li><code>ContextClosedEvent</code> ： <font color="red">当 ApplicationContext 关闭时触发 </font>。这个事件在调用 ConfigurableApplicationContext 的 close () 方法后被发布。可以使用该事件来 **<font color="red">执行一些最终的清理操作，例如释放数据库连接、销毁单例对象等 </font>**。</li><li><code>ServletRequestHandledEvent</code> ： <font color="red">当 Spring MVC 处理完一个 HTTP 请求时触发 </font>。该事件提供了有关请求处理的详细信息，包括请求的处理时间、处理器、处理器适配器等。可以使用该事件来 **<font color="red">进行请求处理的监控、日志记录或统计信息收集等操作 </font>**。</li><li><code>ApplicationStartedEvent</code> （Spring Boot）： <font color="red">当 Spring Boot 应用程序启动时触发 </font>。这个事件在 SpringApplication.run () 方法完成后被发布。可以使用该事件来 **<font color="red">执行特定于应用程序的初始化逻辑 </font>**。</li><li><code>ApplicationReadyEvent</code> （Spring Boot）： <font color="red">当 Spring Boot 应用程序准备就绪时触发 </font>。这个事件表示应用程序已经启动完毕，并且已经可以提供服务。可以使用该事件来 **<font color="red">执行应用程序的后续初始化操作，例如加载数据、发送通知等 </font>**。</li></ol><p>有些场景是依赖 Spring 容器初始化完成后调用的， <code>ContextRefreshedEvent</code> 这个时间就比较合适。但是大家发现没有，它除了初始化调用，容器刷新也会调用。</p><p><font color="gree">为了避免容器刷新造成二次调用初始化逻辑，我们对一些比较常用的事件简单封装了一层逻辑 </font>。</p><p>1）首先定义 应用初始化事件 对象类 <code>ApplicationInitializingEvent</code></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>init</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationEvent</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre> * 应用初始化事件</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * &lt;p> 规约事件，通过此事件可以查看业务系统所有初始化行为</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// ApplicationEvent 是 Spring 的事件模型，用于监听应用的初始化和销毁</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationInitializingEvent</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * Create a new &#123;@code ApplicationEvent&#125;.</pre></td></tr><tr><td data-num="17"></td><td><pre>     *</pre></td></tr><tr><td data-num="18"></td><td><pre>     * @param source the object on which the event initially occurred or with</pre></td></tr><tr><td data-num="19"></td><td><pre>     *               which the event is associated (never &#123;@code null&#125;)</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ApplicationInitializingEvent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> source<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="23"></td><td><pre>         * source 是事件源，即事件发生的地方</pre></td></tr><tr><td data-num="24"></td><td><pre>         * 这里调用父类的构造方法，将 source 传递给父类</pre></td></tr><tr><td data-num="25"></td><td><pre>         */</pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）其次，定义 应用初始化后置处理器 <code>ApplicationContentPostProcessor</code> ，防止 Spring 事件被多次执行。</p><p>整体逻辑也比较简单，<font color="red">通过锁来保证同一时间只有一个事件进行初始化 </font>。初始化后设置一个标识，下次如果再触发，就不再执行，类似于幂等处理的逻辑。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 应用初始化后置处理器，防止 Spring 事件被多次执行</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span> <span class="token comment">// 生成一个包含 final 常量，构造方法，get 和 set 方法的构造函数</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * ApplicationListener 是 Spring 的事件监听器接口，用于监听 Spring 的事件</pre></td></tr><tr><td data-num="9"></td><td><pre> * ApplicationReadyEvent 是 Spring 的事件模型，用于监听应用的初始化和销毁</pre></td></tr><tr><td data-num="10"></td><td><pre> * 该类实现了 ApplicationListener 接口，用于监听 Spring 的 ApplicationReadyEvent 事件</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContentPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationReadyEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 声明一个 ApplicationContext 对象，用于获取 Spring 上下文</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 执行标识，确保 Spring 事件 &#123;@link ApplicationReadyEvent&#125; 有且执行一次。</pre></td></tr><tr><td data-num="18"></td><td><pre>     * AtomicBoolean 是一个原子操作类，用于在多线程环境下对 boolean 类型的变量进行原子操作</pre></td></tr><tr><td data-num="19"></td><td><pre>     */</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> executeOnlyOnce <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 该方法用于监听 Spring 的 ApplicationReadyEvent 事件</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationReadyEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 如果 executeOnlyOnce 为 true，说 ApplicationReadyEvent 事件已经发布过了，直接返回</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executeOnlyOnce<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 如果 executeOnlyOnce 为 false，则发布一个 ApplicationInitializingEvent 事件，用于查看业务系统所有初始化行为</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        applicationContext<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationInitializingEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该类确保当应用准备就绪时，仅执行一次 <code>onApplicationEvent</code> 方法内的逻辑。如果该方法已经执行过，它将直接返回，不执行任何额外的操作。</p><h4 id="单例对象容器"><a class="anchor" href="#单例对象容器">#</a> 单例对象容器</h4><blockquote><p>Singleton</p></blockquote><p>提供一种单例的访问模式，单例的优点如下：</p><ol><li><font color="red">全局访问 </font>：单例对象可以在应用程序的任何地方被访问，而不需要传递对象的引用。这样可以方便地共享对象的状态和功能，简化了对象之间的通信和协作。</li><li><font color="red">节省资源 </font>：由于只有一个对象实例存在，可以减少重复创建对象的开销。在需要频繁创建和销毁对象的情况下，单例对象可以显著节省系统资源，提高性能。</li></ol><p>应用场景也比较多，比如说，发送邮件时需要加载邮件的模板文件，重复加载就比较浪费性能。<strong><font color="red">完全可以加载一次后，将该对象放到单例对象容器中缓存，下次使用时直接获取就好 </font></strong>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AccessLevel</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Supplier</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * 单例对象容器</pre></td></tr><tr><td data-num="11"></td><td><pre> *</pre></td></tr><tr><td data-num="12"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>access <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span><span class="token punctuation">)</span> <span class="token comment">// 生成一个私有的无参构造函数，以确保该类不会被外部直接实例化</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 声明为 final 类，以确保该类不会被继承</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>     * 声明一个单例对象容器，使用 ConcurrentHashMap（线程安全的 HashMap）存储单例对象</pre></td></tr><tr><td data-num="19"></td><td><pre>     * 其中 key 为对象的类名（String），value 为对象实例（Object）</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token constant">SINGLE_OBJECT_POOL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * 根据 key 获取单例对象</pre></td></tr><tr><td data-num="25"></td><td><pre>     */</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token constant">SINGLE_OBJECT_POOL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> result<span class="token punctuation">;</span> <span class="token comment">// 如果 result 为空，则返回 null；否则，返回 result 强制转换为 T 类型</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="32"></td><td><pre>     * 根据 key 获取单例对象</pre></td></tr><tr><td data-num="33"></td><td><pre>     *</pre></td></tr><tr><td data-num="34"></td><td><pre>     * &lt;p> 为空时，通过 supplier 构建单例对象并放入容器</pre></td></tr><tr><td data-num="35"></td><td><pre>     */</pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token constant">SINGLE_OBJECT_POOL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token constant">SINGLE_OBJECT_POOL</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> result <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="45"></td><td><pre>     * 对象放入容器</pre></td></tr><tr><td data-num="46"></td><td><pre>     */</pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="52"></td><td><pre>     * 对象放入容器</pre></td></tr><tr><td data-num="53"></td><td><pre>     */</pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token constant">SINGLE_OBJECT_POOL</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个类的设计使得在应用程序中可以方便地 <font color="red">通过 key（类名）获取和存储单例对象 </font>，同时确保在多线程环境中的 <font color="red">线程安全性 </font>。需要注意的是，<font color="red">这里的单例是指在容器中具有相同 key 的对象是唯一的，而不是传统的单例模式中只有一个实例 </font>。</p><h3 id="规约组件"><a class="anchor" href="#规约组件">#</a> 规约组件</h3><blockquote><p><code>framework/starter/convention</code> 包</p></blockquote><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-convention-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：</p><ol><li>定义异常码抽象和公共异常码。</li><li>定义抽象异常和客户端、服务端以及远程调用异常。</li><li>封装分页对象请求参数和返回参数实体。</li><li>封装全局响应对象。</li></ol><h4 id="异常码"><a class="anchor" href="#异常码">#</a> 异常码</h4><blockquote><p>异常码如何设计与定义：<a href="#%E5%BC%82%E5%B8%B8%E7%A0%81%E5%AE%9A%E4%B9%89">异常码定义</a></p></blockquote><p><font color="red">异常码的不统一，带来的最直接后果就是<strong>返回结果异常码混乱</strong>，没有规律，也不方便排查问题 </font>。</p><p>为此，我参考了阿里开发规约中，关于异常码的定义部分，最终抽象了异常码接口以及公共异常码。</p><p>1）异常码接口抽象</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * 平台错误码接口</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IErrorCode</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 错误码</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 错误信息</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）封装常用的公共异常码</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>errorcode</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * 基础错误码定义</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">BaseErrorCode</span> <span class="token keyword">implements</span> <span class="token class-name">IErrorCode</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 定义了一个枚举类，实现了 IErrorCode 接口</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// ========== 一级宏观错误码 客户端错误 ==========</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">CLIENT_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000001"</span><span class="token punctuation">,</span> <span class="token string">"用户端错误"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// ========== 二级宏观错误码 用户注册错误 ==========</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">USER_REGISTER_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000100"</span><span class="token punctuation">,</span> <span class="token string">"用户注册错误"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">USER_NAME_VERIFY_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000110"</span><span class="token punctuation">,</span> <span class="token string">"用户名校验失败"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">USER_NAME_EXIST_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000111"</span><span class="token punctuation">,</span> <span class="token string">"用户名已存在"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">USER_NAME_SENSITIVE_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000112"</span><span class="token punctuation">,</span> <span class="token string">"用户名包含敏感词"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">USER_NAME_SPECIAL_CHARACTER_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000113"</span><span class="token punctuation">,</span> <span class="token string">"用户名包含特殊字符"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">PASSWORD_VERIFY_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000120"</span><span class="token punctuation">,</span> <span class="token string">"密码校验失败"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">PASSWORD_SHORT_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000121"</span><span class="token punctuation">,</span> <span class="token string">"密码长度不够"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">PHONE_VERIFY_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000151"</span><span class="token punctuation">,</span> <span class="token string">"手机格式校验失败"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// ========== 二级宏观错误码 系统请求缺少幂等 Token ==========</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">IDEMPOTENT_TOKEN_NULL_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000200"</span><span class="token punctuation">,</span> <span class="token string">"幂等Token为空"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">IDEMPOTENT_TOKEN_DELETE_ERROR</span><span class="token punctuation">(</span><span class="token string">"A000201"</span><span class="token punctuation">,</span> <span class="token string">"幂等Token已被使用或失效"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// ========== 一级宏观错误码 系统执行出错 ==========</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">SERVICE_ERROR</span><span class="token punctuation">(</span><span class="token string">"B000001"</span><span class="token punctuation">,</span> <span class="token string">"系统执行出错"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// ========== 二级宏观错误码 系统执行超时 ==========</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">SERVICE_TIMEOUT_ERROR</span><span class="token punctuation">(</span><span class="token string">"B000100"</span><span class="token punctuation">,</span> <span class="token string">"系统执行超时"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// ========== 一级宏观错误码 调用第三方服务出错 ==========</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">REMOTE_ERROR</span><span class="token punctuation">(</span><span class="token string">"C000001"</span><span class="token punctuation">,</span> <span class="token string">"调用第三方服务出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token class-name">BaseErrorCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">return</span> code<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="抽象异常体系"><a class="anchor" href="#抽象异常体系">#</a> 抽象异常体系</h4><blockquote><p>异常如何进行分类与抽象：<a href="#%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB">异常分类</a></p></blockquote><h4 id="封装分页对象"><a class="anchor" href="#封装分页对象">#</a> 封装分页对象</h4><p>MyBatisPlus 分页对象已经足够好了，为什么还要单独封装分页对象？</p><p>如果是我刚开始开这个项目，我可能会有这样的疑问。在已经比较完善的框架上封装新的功能，这不是多此一举么？</p><p>对于业务比较单一公司来说，不需要考虑这种情况，但是如果公司业务比较多就会出现不同的场景。我觉得下面 <font color="red">两个原因 </font>是我要封装分页对象的主要出发点：</p><ul><li>提供出去的 API 包，包里有个对象用了分页对象。但是依赖这个包的客户端没有使用 MyBatisPlus，<font color="red">难道要因为一个分页对象，把整个 MyBatisPlus 包都依赖进去么？</font></li><li>随着现在技术架构发展日新月异，谁也不能保证哪个框架可以长久留存。如果强依赖 MyBatisPlus，后续 <font color="red">如果换了 ORM 框架，对于整体修改是个灾难。</font></li></ul><p>基于这两点考虑，我抽象了<strong>分页请求参数</strong>和<strong>分页返回参数</strong>两个实体对象。</p><p>1）分页请求参数对象</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>page</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre> * 分页请求对象</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * &lt;p> &#123;@link PageRequest&#125;、&#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="9"></td><td><pre> * 可以理解是防腐层的一种实现，不论底层 ORM 框架，对外分页参数属性不变</pre></td></tr><tr><td data-num="10"></td><td><pre> *</pre></td></tr><tr><td data-num="11"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@Data</span> <span class="token comment">// Lombok 注解，自动生成 getter、setter、toString 等方法</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageRequest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 当前页，默认为第 1 页</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> current <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * 每页显示条数，默认为 10</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> size <span class="token operator">=</span> <span class="token number">10L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）分页返回参数对象</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>page</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Builder</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Function</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="15"></td><td><pre> * 分页返回对象</pre></td></tr><tr><td data-num="16"></td><td><pre> *</pre></td></tr><tr><td data-num="17"></td><td><pre> * &lt;p> &#123;@link PageRequest&#125;、&#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="18"></td><td><pre> * 可以理解是防腐层的一种实现，不论底层 ORM 框架，对外分页参数属性不变</pre></td></tr><tr><td data-num="19"></td><td><pre> *</pre></td></tr><tr><td data-num="20"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="21"></td><td><pre> */</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token annotation punctuation">@Data</span> <span class="token comment">// 自动生成 getter、setter、toString 等方法</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token annotation punctuation">@Builder</span> <span class="token comment">// 自动生成 builder 模式的对象创建方法，用于链式调用</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 实现序列化接口，用于网络传输。泛型 T 为数据列表的类型</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span> <span class="token comment">// 序列化版本号，用于反序列化时校验</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="31"></td><td><pre>     * 当前页</pre></td></tr><tr><td data-num="32"></td><td><pre>     */</pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> current<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="36"></td><td><pre>     * 每页显示条数</pre></td></tr><tr><td data-num="37"></td><td><pre>     */</pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> size <span class="token operator">=</span> <span class="token number">10L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="41"></td><td><pre>     * 总条数</pre></td></tr><tr><td data-num="42"></td><td><pre>     */</pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> total<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="46"></td><td><pre>     * 查询数据列表，初始化为空列表，避免空指针异常</pre></td></tr><tr><td data-num="47"></td><td><pre>     */</pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> records <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">PageResponse</span><span class="token punctuation">(</span><span class="token keyword">long</span> current<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">PageResponse</span><span class="token punctuation">(</span><span class="token keyword">long</span> current<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> total<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> current<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> total<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">PageResponse</span> <span class="token function">setRecords</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> records<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 设置查询数据列表</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>records <span class="token operator">=</span> records<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> mapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 转换数据列表，将 T 类型转换为 R 类型</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> collect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 Stream API 进行数据类型转换</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置转换后的数据列表</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3）提供 <font color="red">MyBatisPlus 分页对象、自定义分页对象之间的转换工具类 </font>，帮助开发提高开发效率</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>database<span class="token punctuation">.</span>toolkit</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span></span><span class="token class-name">IPage</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>pagination<span class="token punctuation">.</span></span><span class="token class-name">Page</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>common<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">BeanUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>page<span class="token punctuation">.</span></span><span class="token class-name">PageRequest</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>page<span class="token punctuation">.</span></span><span class="token class-name">PageResponse</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Function</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre> * 分页工具类</pre></td></tr><tr><td data-num="15"></td><td><pre> *</pre></td></tr><tr><td data-num="16"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="17"></td><td><pre> */</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * &#123;@link PageRequest&#125; to &#123;@link Page&#125;</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Page</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将自定义的 PageRequest 对象转换为 MyBatisPlus 的 Page 对象</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">convert</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pageRequest<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="28"></td><td><pre>     * &#123;@link PageRequest&#125; to &#123;@link Page&#125;</pre></td></tr><tr><td data-num="29"></td><td><pre>     */</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Page</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token keyword">long</span> current<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将当前页和每页显示条数转换为 MyBatisPlus 的 Page 对象</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>     * &#123;@link IPage&#125; to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PageResponse</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">IPage</span> iPage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">buildConventionPage</span><span class="token punctuation">(</span>iPage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="42"></td><td><pre>     * &#123;@link IPage&#125; to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="43"></td><td><pre>     */</pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">,</span> ORIGINAL<span class="token punctuation">></span></span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span>ORIGINAL<span class="token punctuation">></span></span> iPage<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        iPage<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 BeanUtil.convert 方法将每个元素转换为目标类型</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">buildConventionPage</span><span class="token punctuation">(</span>iPage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="50"></td><td><pre>     * &#123;@link IPage&#125; to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="51"></td><td><pre>     */</pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">,</span> ORIGINAL<span class="token punctuation">></span></span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span>ORIGINAL<span class="token punctuation">></span></span> iPage<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> ORIGINAL<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> TARGET<span class="token punctuation">></span></span> mapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> targetDataList <span class="token operator">=</span> iPage<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 Stream API 将每个元素转换为目标类型</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span>targetDataList<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="65"></td><td><pre>     * &#123;@link IPage&#125; build to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="66"></td><td><pre>     */</pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">PageResponse</span> <span class="token function">buildConventionPage</span><span class="token punctuation">(</span><span class="token class-name">IPage</span> iPage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="封装全局响应对象"><a class="anchor" href="#封装全局响应对象">#</a> 封装全局响应对象</h4><blockquote><p><a href="#%E6%8A%BD%E8%B1%A1%E5%90%8E%E7%AB%AF%E5%BA%94%E7%94%A8%E5%93%8D%E5%BA%94%E5%AE%9E%E4%BD%93">抽象后端应用响应实体</a></p></blockquote><h3 id="用户基础组件"><a class="anchor" href="#用户基础组件">#</a> 用户基础组件</h3><blockquote><p><code>frameworks/starter/user</code> 包</p></blockquote><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-user-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：</p><ol><li>通过 JWT 生成用户登录唯一凭证（Token）。</li><li>封装当前请求的用户上下文。</li><li>拦截带 Token 的请求，并将 Token 解析放入用户上下文中。</li></ol><h4 id="jwt-token-生成器"><a class="anchor" href="#jwt-token-生成器">#</a> JWT Token 生成器</h4><p>通过 JWT 生成用户唯一 Token 凭证，并提供将 Token 凭证反解析为用户信息的方法，应用于用户服务以及网关服务。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>frameworks<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>user<span class="token punctuation">.</span>toolkit</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson2<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Claims</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">ExpiredJwtException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Jwts</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">SignatureAlgorithm</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>frameworks<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>user<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">UserInfoDTO</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token static">REAL_NAME_KEY</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token static">USER_ID_KEY</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token static">USER_NAME_KEY</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre> * JWT 工具类，用于生成和解析用户 Token</pre></td></tr><tr><td data-num="22"></td><td><pre> *</pre></td></tr><tr><td data-num="23"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="24"></td><td><pre> */</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">JWTUtil</span> <span class="token punctuation">&#123;</span> <span class="token comment">//final：不能被继承</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// Token 过期时间，单位：秒，默认为 24 小时</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">EXPIRATION</span> <span class="token operator">=</span> <span class="token number">86400L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// Token 前缀，用于区分 Token 类型</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOKEN_PREFIX</span> <span class="token operator">=</span> <span class="token string">"Bearer "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// Token 签发者，用于校验 Token 是否合法</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ISS</span> <span class="token operator">=</span> <span class="token string">"index12306"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// Token 密钥，用于签名和解签</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECRET</span> <span class="token operator">=</span> <span class="token string">"SecretKey039245678901232039487623456783092349288901402967890140939827"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre>     * 生成用户 Token：用户信息 -- 加密 --> 用户 Token</pre></td></tr><tr><td data-num="39"></td><td><pre>     *</pre></td></tr><tr><td data-num="40"></td><td><pre>     * @param userInfo 用户信息</pre></td></tr><tr><td data-num="41"></td><td><pre>     * @return 用户访问 Token</pre></td></tr><tr><td data-num="42"></td><td><pre>     */</pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateAccessToken</span><span class="token punctuation">(</span><span class="token class-name">UserInfoDTO</span> userInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> customerUserMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于存储用户信息</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        customerUserMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">USER_ID_KEY</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户 ID</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        customerUserMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">USER_NAME_KEY</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户名</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        customerUserMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">REAL_NAME_KEY</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 真实姓名</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token class-name">String</span> jwtToken <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个 JWT 构建器对象</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS512</span><span class="token punctuation">,</span> <span class="token constant">SECRET</span><span class="token punctuation">)</span> <span class="token comment">// 签名算法和密钥</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 签发时间</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span><span class="token constant">ISS</span><span class="token punctuation">)</span> <span class="token comment">// 签发者，通常是应用程序的名称或者标识符</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>customerUserMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 主题，通常存放用户的身份信息</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">EXPIRATION</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 过期时间，单位：毫秒</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成最终的 Token 字符串</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">TOKEN_PREFIX</span> <span class="token operator">+</span> jwtToken<span class="token punctuation">;</span> <span class="token comment">// 返回 Token 前缀 + Token 字符串</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="59"></td><td><pre>     * 解析用户 Token：用户 Token -- 解密 --> 用户信息</pre></td></tr><tr><td data-num="60"></td><td><pre>     *</pre></td></tr><tr><td data-num="61"></td><td><pre>     * @param jwtToken 用户访问 Token</pre></td></tr><tr><td data-num="62"></td><td><pre>     * @return 用户信息</pre></td></tr><tr><td data-num="63"></td><td><pre>     */</pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserInfoDTO</span> <span class="token function">parseJwtToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> jwtToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 判断 Token 是否非空</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token class-name">String</span> actualJwtToken <span class="token operator">=</span> jwtToken<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">TOKEN_PREFIX</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 去掉 Token 前缀</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token constant">SECRET</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>actualJwtToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析 Token</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                <span class="token class-name">Date</span> expiration <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 Token 过期时间</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>expiration<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 判断 Token 是否未过期</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                    <span class="token class-name">String</span> subject <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 Token 中的用户信息</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token class-name">UserInfoDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回用户信息</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExpiredJwtException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Token 过期异常，不做处理</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"JWT Token解析失败，请检查"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Token 为空或解析失败，返回 null</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="封装用户上下文"><a class="anchor" href="#封装用户上下文">#</a> 封装用户上下文</h4><p>1）定义用户参数实体：仅定义有且必须的，当前想到了三个字段，后续可能还会补充。一切以代码实际行动为准。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>frameworks<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>user<span class="token punctuation">.</span>core</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Builder</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre> * 用户信息实体</pre></td></tr><tr><td data-num="10"></td><td><pre> *</pre></td></tr><tr><td data-num="11"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token annotation punctuation">@Builder</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoDTO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     * 用户 ID</pre></td></tr><tr><td data-num="21"></td><td><pre>     */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> userId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="25"></td><td><pre>     * 用户名</pre></td></tr><tr><td data-num="26"></td><td><pre>     */</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     * 真实姓名</pre></td></tr><tr><td data-num="31"></td><td><pre>     */</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> realName<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>     * 用户 Token</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> token<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）定义用户参数上下文。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>frameworks<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>user<span class="token punctuation">.</span>core</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>ttl<span class="token punctuation">.</span></span><span class="token class-name">TransmittableThreadLocal</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * 用户参数上下文</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UserContext</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// TransmittableThreadLocal 是阿里巴巴开源的一个线程上下文传递工具，用于解决线程池中的线程上下文传递问题</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 通过 TransmittableThreadLocal 可以在线程池中传递线程上下文，例如用户信息、请求信息等</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoDTO</span><span class="token punctuation">></span></span> <span class="token constant">USER_THREAD_LOCAL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 设置用户上下文</pre></td></tr><tr><td data-num="20"></td><td><pre>     *</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @param user 用户详情信息</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token class-name">UserInfoDTO</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token constant">USER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="28"></td><td><pre>     * 获取上下文中用户 ID</pre></td></tr><tr><td data-num="29"></td><td><pre>     *</pre></td></tr><tr><td data-num="30"></td><td><pre>     * @return 用户 ID</pre></td></tr><tr><td data-num="31"></td><td><pre>     */</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">UserInfoDTO</span> userInfoDTO <span class="token operator">=</span> <span class="token constant">USER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// Optional 类是 Java 8 新增的一个容器类，用于解决空指针异常</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">//ofNullable 方法用于创建一个 Optional 实例</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">//map 方法用于对 Optional 实例进行转换</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">//orElse 方法用于在 Optional 实例为空时返回默认值</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>userInfoDTO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserInfoDTO</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="42"></td><td><pre>     * 获取上下文中用户名称</pre></td></tr><tr><td data-num="43"></td><td><pre>     *</pre></td></tr><tr><td data-num="44"></td><td><pre>     * @return 用户名称</pre></td></tr><tr><td data-num="45"></td><td><pre>     */</pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token class-name">UserInfoDTO</span> userInfoDTO <span class="token operator">=</span> <span class="token constant">USER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>userInfoDTO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserInfoDTO</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="52"></td><td><pre>     * 获取上下文中用户真实姓名</pre></td></tr><tr><td data-num="53"></td><td><pre>     *</pre></td></tr><tr><td data-num="54"></td><td><pre>     * @return 用户真实姓名</pre></td></tr><tr><td data-num="55"></td><td><pre>     */</pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token class-name">UserInfoDTO</span> userInfoDTO <span class="token operator">=</span> <span class="token constant">USER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>userInfoDTO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserInfoDTO</span><span class="token operator">::</span><span class="token function">getRealName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="62"></td><td><pre>     * 获取上下文中用户 Token</pre></td></tr><tr><td data-num="63"></td><td><pre>     *</pre></td></tr><tr><td data-num="64"></td><td><pre>     * @return 用户 Token</pre></td></tr><tr><td data-num="65"></td><td><pre>     */</pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token class-name">UserInfoDTO</span> userInfoDTO <span class="token operator">=</span> <span class="token constant">USER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>userInfoDTO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserInfoDTO</span><span class="token operator">::</span><span class="token function">getToken</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="72"></td><td><pre>     * 清理用户上下文</pre></td></tr><tr><td data-num="73"></td><td><pre>     */</pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token constant">USER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用阿里 TransmittableThreadLocal（TTL）安全的 ThreadLocal 作为存储容器，绑定当前请求用户参数。</p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvdHJhbnNtaXR0YWJsZS10aHJlYWQtbG9jYWw=">https://github.com/alibaba/transmittable-thread-local</span></p><h4 id="用户上下文拦截器"><a class="anchor" href="#用户上下文拦截器">#</a> 用户上下文拦截器</h4><p>添加用户上下文过滤器，如果 HTTP 请求 Header 中包含用户信息，则进行解析并放入 <code>UserContext</code> 。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>frameworks<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>user<span class="token punctuation">.</span>core</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">Filter</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletRequest</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletResponse</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>bases<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">UserConstant</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLDecoder</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token static">UTF_8</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre> * 用户信息传输过滤器，可以拦截请求，解析请求中的用户信息，将其放入用户上下文</pre></td></tr><tr><td data-num="19"></td><td><pre> *</pre></td></tr><tr><td data-num="20"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="21"></td><td><pre> */</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserTransmitFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 实现 Filter 接口可以对请求进行过滤</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">HttpServletRequest</span> httpServletRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span> <span class="token comment">// 获取请求对象</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">String</span> userId <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token constant">USER_ID_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从请求头中获取用户 ID</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果用户 ID 不为空</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token class-name">String</span> userName <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token constant">USER_NAME_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从请求头中获取用户名</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token class-name">String</span> realName <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token constant">REAL_NAME_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从请求头中获取真实姓名</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果用户名不为空</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                userName <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解码用户名</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>realName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果真实姓名不为空</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                realName <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>realName<span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解码真实姓名</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token class-name">String</span> token <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">UserConstant</span><span class="token punctuation">.</span><span class="token constant">USER_TOKEN_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从请求头中获取用户 Token</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token class-name">UserInfoDTO</span> userInfoDTO <span class="token operator">=</span> <span class="token class-name">UserInfoDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建用户信息对象</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">realName</span><span class="token punctuation">(</span>realName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>userInfoDTO<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将用户信息放入用户上下文</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 继续执行过滤器链</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除用户信息</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="设计模式组件"><a class="anchor" href="#设计模式组件">#</a> 设计模式组件</h3><blockquote><p><code>framework/starter/designpattern</code> 包</p></blockquote><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-designpattern-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：</p><ol><li>封装构建者（Builder）模式。</li><li>封装责任链（Chain）模式</li><li>封装策略（Strategy）模式。</li></ol><h4 id="封装构建者builder模式"><a class="anchor" href="#封装构建者builder模式">#</a> 封装构建者（Builder）模式</h4><blockquote><p>相关技术文档：<a href="#Hutool%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Builder%E6%A8%A1%E5%BC%8F%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0">Hutool 如何使用 Builder 模式创建线程池</a></p></blockquote><p>构建者模式相对简单，仅需要提供一个 <font color="red"><u>抽象接口 </u></font>即可。构建者相关的 <font color="red">特性均在 <u>实现类 </u>中完成 </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>designpattern<span class="token punctuation">.</span>builder</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre> * Builder 模式抽象接口</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 继承 Serializable 接口，用于网络传输</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre>     * 构建方法</pre></td></tr><tr><td data-num="14"></td><td><pre>     *</pre></td></tr><tr><td data-num="15"></td><td><pre>     * @return 构建后的对象</pre></td></tr><tr><td data-num="16"></td><td><pre>     */</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">T</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="封装责任链chain模式"><a class="anchor" href="#封装责任链chain模式">#</a> 封装责任链（Chain）模式</h4><blockquote><p>相关技术文档：</p><ul><li><a href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">责任链模式是什么？</a></li><li><a href="#==%E5%A6%82%E4%BD%95%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F==">如何抽象责任链模式</a></li></ul></blockquote><h4 id="封装策略strategy模式"><a class="anchor" href="#封装策略strategy模式">#</a> 封装策略（Strategy）模式</h4><blockquote><p>相关技术文档：</p><ul><li><a href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">策略模式是什么？</a></li><li><a href="#%E5%A6%82%E4%BD%95%E6%8A%BD%E8%B1%A1%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F">如何抽象策略模式</a></li></ul></blockquote><h3 id="公共组件"><a class="anchor" href="#公共组件">#</a> 公共组件</h3><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-common-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：</p><ol><li>抽象常用枚举，比如：逻辑删除标记枚举、标识枚举、操作类型以及状态枚举等。</li><li>封装线程池，比如：线程池构造器、快速执行线程池、动态代理拒绝策略等。</li><li>常用工具类，比如：断言工具类、对象复制工具类、环境类以及线程工具类等。</li></ol><h4 id="抽象常用枚举"><a class="anchor" href="#抽象常用枚举">#</a> 抽象常用枚举</h4><p>枚举在日常开发项目中占着比较重要的位置，<font color="red">有一些每个项目都要用到的枚举可以尝试抽象出来，避免重复创建 </font>。</p><p>逻辑删除标记枚举：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 逻辑删除标记枚举，分为正常状态（NORMAL）、删除状态（DELETE）</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">DelEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">//----- 常量对象列表（括号意为调用构造方法）-----</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 正常状态</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">NORMAL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 自动添加修饰符 public static final</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 删除状态</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">//-------- 成员属性列表 --------</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> statusCode<span class="token punctuation">;</span> <span class="token comment">// 逻辑删除状态码</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">//-------- 手动定义有参构造方法 --------</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token class-name">DelEnum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> statusCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>statusCode <span class="token operator">=</span> statusCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">//-------- 成员方法列表 --------</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">strCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// String.valueOf () 方法是将参数转换为字符串</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">//-------- 重写父类方法 --------</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">strCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>标识枚举：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 标识枚举，非 &#123;@link Boolean#TRUE&#125; 即 &#123;@link Boolean#FALSE&#125;</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FlagEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * FALSE</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">FALSE</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * TRUE</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">TRUE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">FlagEnum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">strCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">strCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>操作类型枚举：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 操作类型，分为保存（SAVE）、修改（UPDATE）、删除（DELETE）</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">OperationTypeEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token constant">SAVE</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token constant">UPDATE</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token constant">DELETE</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>状态枚举：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 状态枚举，分为成功（SUCCESS）、失败（FAIL）</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">StatusEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 成功</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">SUCCESS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 失败</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">FAIL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> statusCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">StatusEnum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> statusCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>statusCode <span class="token operator">=</span> statusCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">strCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">strCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="封装线程池"><a class="anchor" href="#封装线程池">#</a> 封装线程池</h4><blockquote><p>相关技术文档：[参考 Dubbo 实现快速消费线程池](# 参考 Dubbo 实现快速消费线程池)</p></blockquote><p>首先回顾一下线程池的基本知识。</p><p>线程池实现类 ThreadPoolExecutor 是 Executor 框架最核心的类。</p><p>《阿里巴巴 Java 开发手册》中强制 <font color="red">“线程资源必须通过线程池提供，不允许在应用中自行显式创建线程”</font>。</p><blockquote><p>线程池的好处是减少在创建和销毁线程上所消耗的时间以及系统资源的开销，解决资源不足的问题。</p><p>如果不使用线程池，有可能造成系统创建大量同类线程而导致消耗完内存或者 “过度切换” 的问题。</p></blockquote><p>此外，还强制 “<strong><font color="red">线程池不允许使用 Executors 工具类去创建，而是通过 ThreadPoolExecutor 构造函数的方式 </font></strong>。这样的处理方式让写的同学更加明确线程池的运行规则，规避资源耗尽（OOM）的风险”。</p><blockquote><p>Executors 工具类返回的线程池对象存在以下弊端：</p><ul><li><code>FixedThreadPool</code> 和 <code>SingleThreadPool</code> ： 允许的任务队列长度为 Integer.MAX_VALUE，可能会堆积 <font color="red">大量的请求 </font>，从而导致 OOM</li><li><code>CachedThreadPool</code> ：允许的创建线程数量为 Integer.MAX_VALUE，可能会创建 <font color="red">大量的线程 </font>，从而导致 OOM</li></ul></blockquote><p>ThreadPoolExecutor 类的构造方法：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     * 用给定的初始参数创建一个新的 ThreadPoolExecutor。</pre></td></tr><tr><td data-num="3"></td><td><pre>     */</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span><span class="token comment">// 线程池的核心线程数量</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span><span class="token comment">// 线程池的最大线程数</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span><span class="token comment">// 当线程数大于核心线程数时，多余的空闲线程存活的最长时间</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span><span class="token comment">// 时间单位</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span><span class="token comment">// 任务队列，用来储存等待执行任务的队列</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                              <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span><span class="token comment">// 线程工厂，用来创建线程，一般默认即可</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                              <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token comment">// 拒绝策略，当提交的任务过多而不能及时处理时，我们可以定制策略来处理任务</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                               <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> threadFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>具体的参数理解可以查看 JUC 笔记中对线程池的介绍：<span class="exturl" data-url="aHR0cHM6Ly9mYW50ZWRvbmcudG9wL2phdmEvanVjL0pVQyVFNyVBQyU5NCVFOCVBRSVCMC8=">JUC 笔记 - JUC - Java | fantedong = 水文 &amp; 摄影 = 为了能更好地查看图片，你需要一点魔法</span>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20231018163149255.png" alt="image-20231018163149255"></p><h5 id="封装快速消费线程池"><a class="anchor" href="#封装快速消费线程池">#</a> 封装快速消费线程池</h5><p>线程池中阻塞队列（任务队列）的作用是：当新任务到来时，会先判断当前运行的线程数量是否达到核心线程数，如果达到的话，新任务就会被存放在阻塞队列（任务队列）中。</p><p>不同的线程池会选用不同的阻塞队列，因此首先定义快速消费线程池的<strong>任务队列</strong>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 快速消费线程池的任务队列，继承自 无界阻塞队列 LinkedBlockingQueue，其容量为 Integer.MAX_VALUE</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 泛型用于指定队列中的元素类型</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Setter</span> <span class="token comment">// @Setter 注解用于生成 set 方法</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">EagerThreadPoolExecutor</span> executor<span class="token punctuation">;</span> <span class="token comment">// 线程池</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//capacity 为队列容量</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 重写 offer 方法，用于向任务队列中添加任务</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 获取当前线程数量</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">int</span> currentPoolThreadSize <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">//getSubmittedTaskCount () 获取任务队列中的任务数量</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 如果任务数量小于当前线程池线程数量，说明有空闲线程，则将新任务加入任务队列，交由线程执行</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">getSubmittedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> currentPoolThreadSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 任务数量≥当前线程池线程数量，说明没有空闲线程</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 如果当前线程数量小于最大线程数，返回 False，根据线程池源码，会创建非核心线程</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPoolThreadSize <span class="token operator">&lt;</span> executor<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 任务数量≥当前线程池线程数量，且当前线程池数量大于最大线程数量，则将任务加入阻塞队列</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 用于向任务队列中添加任务，并设置等待时间</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">retryOffer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果线程池已关闭，抛出异常</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">"Executor is shutdown!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//timeout 表示等待时间，若超时仍未添加成功，返回 False</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>定义<strong>快速消费线程池</strong>，这里参考了 Dubbo 的线程池模型之一。另外，Tomcat 也是这种消费模型。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 快速消费线程池</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EagerThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">EagerThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                   <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                                   <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                                   <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                   <span class="token class-name">TaskQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                   <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                                   <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> threadFactory<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 记录任务数量</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> submittedTaskCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSubmittedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> submittedTaskCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">afterExecute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 任务执行完毕，任务数量减一</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        submittedTaskCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行任务前，任务数量加一</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行任务</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 任务执行失败</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token class-name">TaskQueue</span> taskQueue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskQueue</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取任务队列</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskQueue<span class="token punctuation">.</span><span class="token function">retryOffer</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 【重点】如果任务在等待时间内未向队列中成功添加</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 任务数量减一</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">"Queue capacity is full."</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> iex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果添加任务时发生异常</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 任务数量减一</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span>iex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            submittedTaskCount<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 任务添加失败，任务数量减一</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">// 任务添加成功</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="通过动态代理实现拒绝或饱和策略"><a class="anchor" href="#通过动态代理实现拒绝或饱和策略">#</a> 通过动态代理实现拒绝（或饱和）策略</h5><blockquote><p>相关技术文档：[参考 Mybatis 动态代理来扩展拒绝策略](# 参考 Mybatis 动态代理来扩展拒绝策略)</p></blockquote><h4 id="常用工具类"><a class="anchor" href="#常用工具类">#</a> 常用工具类</h4><p>断言工具类：用于校验参数</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 断言工具类，用于校验参数</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Assert</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">//isTrue 方法用于判断 表达式 是否为 true，如果为 false，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> expression<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expression<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> expression<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function">isTrue</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> <span class="token string">"[Assertion failed] - this expression must be true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">//isNull 方法用于判断 Object 参数是否为 null，如果不为 null，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">isNull</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">isNull</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function">isNull</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">"[Assertion failed] - the object argument must be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">//notNull 方法用于判断 Object 参数是否为 null，如果为 null，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notNull</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notNull</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token function">notNull</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">"[Assertion failed] - this argument is required; it must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">//notEmpty 方法用于判断 集合参数 是否为空，如果为空，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> collection<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> collection<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token function">notEmpty</span><span class="token punctuation">(</span>collection<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token string">"[Assertion failed] - this collection must not be empty: it must contain at least 1 element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">//notEmpty 方法用于判断 Map 参数 是否为空，如果为空，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> map<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token function">notEmpty</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token string">"[Assertion failed] - this map must not be empty; it must contain at least one entry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">//notEmpty 方法用于判断 字符串 参数 是否为空，如果为空，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token function">notEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"[Assertion failed] - this string must not be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">//notBlank 方法用于判断 字符串 参数 是否为空，如果为空，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notBlank</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span>StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notBlank</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token function">notBlank</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"[Assertion failed] - this string must not be blank"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token comment">//hasText 方法用于判断 字符串 参数 是否为空，如果为空，则抛出非法参数异常</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hasText</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hasText</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token function">hasText</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token string">"[Assertion failed] - this String argument must have text; it must not be null, empty, or blank"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>对象属性复制工具类：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 对象属性复制工具类</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>access <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">lombok<span class="token punctuation">.</span></span>AccessLevel</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span><span class="token punctuation">)</span> <span class="token comment">// 将构造函数私有化，防止被外部实例化</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 一个静态变量，用于保存 DozerBeanMapperBuilder 的实例</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Mapper</span> <span class="token constant">BEAN_MAPPER_BUILDER</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token constant">BEAN_MAPPER_BUILDER</span> <span class="token operator">=</span> <span class="token class-name">DozerBeanMapperBuilder</span><span class="token punctuation">.</span><span class="token function">buildDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 属性复制</pre></td></tr><tr><td data-num="18"></td><td><pre>     *</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @param source 数据对象</pre></td></tr><tr><td data-num="20"></td><td><pre>     * @param target 目标对象</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @param &lt;T></pre></td></tr><tr><td data-num="22"></td><td><pre>     * @param &lt;S></pre></td></tr><tr><td data-num="23"></td><td><pre>     * @return 转换后对象</pre></td></tr><tr><td data-num="24"></td><td><pre>     */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">S</span> source<span class="token punctuation">,</span> <span class="token class-name">T</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 如果 source 不为 null，则调用 BEAN_MAPPER_BUILDER.map 方法，将 source 的属性复制到 target 中</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token constant">BEAN_MAPPER_BUILDER</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="33"></td><td><pre>     * 复制单个对象</pre></td></tr><tr><td data-num="34"></td><td><pre>     *</pre></td></tr><tr><td data-num="35"></td><td><pre>     * @param source 数据对象</pre></td></tr><tr><td data-num="36"></td><td><pre>     * @param clazz  复制目标类型</pre></td></tr><tr><td data-num="37"></td><td><pre>     * @param &lt;T></pre></td></tr><tr><td data-num="38"></td><td><pre>     * @param &lt;S></pre></td></tr><tr><td data-num="39"></td><td><pre>     * @return 转换后对象</pre></td></tr><tr><td data-num="40"></td><td><pre>     */</pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">S</span> source<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token constant">BEAN_MAPPER_BUILDER</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="48"></td><td><pre>     * 复制多个对象</pre></td></tr><tr><td data-num="49"></td><td><pre>     *</pre></td></tr><tr><td data-num="50"></td><td><pre>     * @param sources 数据对象</pre></td></tr><tr><td data-num="51"></td><td><pre>     * @param clazz   复制目标类型</pre></td></tr><tr><td data-num="52"></td><td><pre>     * @param &lt;T></pre></td></tr><tr><td data-num="53"></td><td><pre>     * @param &lt;S></pre></td></tr><tr><td data-num="54"></td><td><pre>     * @return 转换后对象集合</pre></td></tr><tr><td data-num="55"></td><td><pre>     */</pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> sources<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> targetList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                    each<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-></span> targetList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">BEAN_MAPPER_BUILDER</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token keyword">return</span> targetList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="68"></td><td><pre>     * 复制多个对象</pre></td></tr><tr><td data-num="69"></td><td><pre>     *</pre></td></tr><tr><td data-num="70"></td><td><pre>     * @param sources 数据对象</pre></td></tr><tr><td data-num="71"></td><td><pre>     * @param clazz   复制目标类型</pre></td></tr><tr><td data-num="72"></td><td><pre>     * @param &lt;T></pre></td></tr><tr><td data-num="73"></td><td><pre>     * @param &lt;S></pre></td></tr><tr><td data-num="74"></td><td><pre>     * @return 转换后对象集合</pre></td></tr><tr><td data-num="75"></td><td><pre>     */</pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> sources<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> targetSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                    each<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-></span> targetSize<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">BEAN_MAPPER_BUILDER</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                    <span class="token keyword">return</span> targetSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="88"></td><td><pre>     * 复制多个对象</pre></td></tr><tr><td data-num="89"></td><td><pre>     *</pre></td></tr><tr><td data-num="90"></td><td><pre>     * @param sources 数据对象</pre></td></tr><tr><td data-num="91"></td><td><pre>     * @param clazz   复制目标类型</pre></td></tr><tr><td data-num="92"></td><td><pre>     * @param &lt;T></pre></td></tr><tr><td data-num="93"></td><td><pre>     * @param &lt;S></pre></td></tr><tr><td data-num="94"></td><td><pre>     * @return 转换后对象集合</pre></td></tr><tr><td data-num="95"></td><td><pre>     */</pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sources<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                    <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targetArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> sources<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> targetArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                        targetArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">BEAN_MAPPER_BUILDER</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                    <span class="token keyword">return</span> targetArray<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="110"></td><td><pre>     * 拷贝非空且非空串属性</pre></td></tr><tr><td data-num="111"></td><td><pre>     *</pre></td></tr><tr><td data-num="112"></td><td><pre>     * @param source 数据源</pre></td></tr><tr><td data-num="113"></td><td><pre>     * @param target 指向源</pre></td></tr><tr><td data-num="114"></td><td><pre>     */</pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">convertIgnoreNullAndBlank</span><span class="token punctuation">(</span><span class="token class-name">Object</span> source<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token class-name">DozerBeanMapperBuilder</span> dozerBeanMapperBuilder <span class="token operator">=</span> <span class="token class-name">DozerBeanMapperBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token class-name">Mapper</span> mapper <span class="token operator">=</span> dozerBeanMapperBuilder<span class="token punctuation">.</span><span class="token function">withMappingBuilders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanMappingBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="120"></td><td><pre>            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>                <span class="token function">mapping</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mapNull</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mapEmptyString</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        mapper<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="128"></td><td><pre>     * 拷贝非空属性</pre></td></tr><tr><td data-num="129"></td><td><pre>     *</pre></td></tr><tr><td data-num="130"></td><td><pre>     * @param source 数据源</pre></td></tr><tr><td data-num="131"></td><td><pre>     * @param target 指向源</pre></td></tr><tr><td data-num="132"></td><td><pre>     */</pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">convertIgnoreNull</span><span class="token punctuation">(</span><span class="token class-name">Object</span> source<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        <span class="token class-name">DozerBeanMapperBuilder</span> dozerBeanMapperBuilder <span class="token operator">=</span> <span class="token class-name">DozerBeanMapperBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        <span class="token class-name">Mapper</span> mapper <span class="token operator">=</span> dozerBeanMapperBuilder<span class="token punctuation">.</span><span class="token function">withMappingBuilders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanMappingBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre></pre></td></tr><tr><td data-num="137"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="138"></td><td><pre>            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>                <span class="token function">mapping</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mapNull</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        mapper<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>环境工具类：用于判断当前环境</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 环境工具类，用于判断当前环境</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnvironmentUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 用于保存环境的列表</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token constant">ENVIRONMENT_LIST</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 静态代码块，用于初始化环境列表</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token constant">ENVIRONMENT_LIST</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"dev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token constant">ENVIRONMENT_LIST</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 判断当前是否为开发环境</pre></td></tr><tr><td data-num="18"></td><td><pre>     *</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isDevEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">ConfigurableEnvironment</span> configurableEnvironment <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">String</span> propertyActive <span class="token operator">=</span> configurableEnvironment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.profiles.active"</span><span class="token punctuation">,</span> <span class="token string">"dev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">ENVIRONMENT_LIST</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>each <span class="token operator">-></span> propertyActive<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="28"></td><td><pre>     * 判断当前是否为正式环境</pre></td></tr><tr><td data-num="29"></td><td><pre>     *</pre></td></tr><tr><td data-num="30"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="31"></td><td><pre>     */</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isProdEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">ConfigurableEnvironment</span> configurableEnvironment <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token class-name">String</span> propertyActive <span class="token operator">=</span> configurableEnvironment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.profiles.active"</span><span class="token punctuation">,</span> <span class="token string">"dev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token constant">ENVIRONMENT_LIST</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>each <span class="token operator">-></span> propertyActive<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>线程工具类：用于操作线程</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 线程池工具类，用于操作线程</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 睡眠当前线程指定时间 &#123;@param millis&#125;</pre></td></tr><tr><td data-num="10"></td><td><pre>     *</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @param millis 睡眠时间，单位毫秒</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@SneakyThrows</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// @SneakyThrows 注解用于抑制异常，将异常转换为 RuntimeException</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">long</span> millis<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="持久层组件"><a class="anchor" href="#持久层组件">#</a> 持久层组件</h3><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-database-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：</p><ol><li>封装 MybatisPlus 配置文件</li><li>封装数据持久层基础属性</li><li>封装元数据处理器</li><li>封装分页工具转换器</li><li>封装自定义雪花算法</li></ol><h4 id="mybatisplus-配置文件"><a class="anchor" href="#mybatisplus-配置文件">#</a> MybatisPlus 配置文件</h4><p>定义一些 MybatisPlus 的配置，避免每个项目都需要重新定义。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * MybatisPlus 配置文件，避免重复配置</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisPlusAutoConfiguration</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 分页插件</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@Bean</span> <span class="token comment">// MybatisPlusInterceptor 是 MyBatis-Plus 的拦截器，用于处理分页查询</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">MybatisPlusInterceptor</span> <span class="token function">mybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">MybatisPlusInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        interceptor<span class="token punctuation">.</span><span class="token function">addInnerInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PaginationInnerInterceptor</span><span class="token punctuation">(</span><span class="token class-name">DbType</span><span class="token punctuation">.</span><span class="token constant">MYSQL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 元数据填充</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token annotation punctuation">@Bean</span> <span class="token comment">// MyMetaObjectHandler 是 MyBatis-Plus 的元数据填充器，用于自动填充创建时间、更新时间、创建人、更新人等字段</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">MyMetaObjectHandler</span> <span class="token function">myMetaObjectHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyMetaObjectHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="27"></td><td><pre>     * 自定义雪花算法 ID 生成器</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token annotation punctuation">@Bean</span> <span class="token comment">// CustomIdGenerator 是自定义的雪花算法 ID 生成器，用于生成全局唯一的 ID</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token annotation punctuation">@Primary</span> <span class="token comment">// @Primary 注解表示当有多个同类型的 Bean 时，优先使用该 Bean</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">IdentifierGenerator</span> <span class="token function">idGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="实体基础属性"><a class="anchor" href="#实体基础属性">#</a> 实体基础属性</h4><p>因为每个表都有一些 <font color="red">公共属性 </font>，比如创建时间、修改时间以及是否逻辑删除标识。</p><p>避免每个实体上都重复定义，我们在持久层对象中抽象一个基础的 BaseDO 杜绝上述重复行为。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 数据持久层的基础公共属性，包含创建时间、修改时间、删除标志</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Data</span> <span class="token comment">// 自动生成 getter、setter、toString 等方法</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseDO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 创建时间</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token class-name">FieldFill</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token comment">// 表示该字段在插入时自动填充</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 修改时间</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token class-name">FieldFill</span><span class="token punctuation">.</span><span class="token constant">INSERT_UPDATE</span><span class="token punctuation">)</span> <span class="token comment">// 表示该字段在插入和更新时自动填充</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * 删除标志</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token class-name">FieldFill</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token comment">// 表示该字段在插入时自动填充</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> delFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="元数据处理器"><a class="anchor" href="#元数据处理器">#</a> 元数据处理器</h4><p>MyBatisPlus 为我们提供了一种便利的方式 <font color="red">为这些实体基础属性赋值 </font>，那就是元数据处理器。可在数据新增、修改时对元数据进行变更。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 元数据处理器，用于自动填充创建时间、更新时间、删除标志等字段</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMetaObjectHandler</span> <span class="token keyword">implements</span> <span class="token class-name">MetaObjectHandler</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 数据新增时填充</pre></td></tr><tr><td data-num="10"></td><td><pre>     *</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @param metaObject</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertFill</span><span class="token punctuation">(</span><span class="token class-name">MetaObject</span> metaObject<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strictInsertFill</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> <span class="token string">"createTime"</span><span class="token punctuation">,</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strictInsertFill</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> <span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strictInsertFill</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> <span class="token string">"delFlag"</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">DelEnum</span><span class="token punctuation">.</span><span class="token constant">NORMAL</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * 数据修改时填充</pre></td></tr><tr><td data-num="22"></td><td><pre>     *</pre></td></tr><tr><td data-num="23"></td><td><pre>     * @param metaObject</pre></td></tr><tr><td data-num="24"></td><td><pre>     */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateFill</span><span class="token punctuation">(</span><span class="token class-name">MetaObject</span> metaObject<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strictInsertFill</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> <span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="分页转换器"><a class="anchor" href="#分页转换器">#</a> 分页转换器</h4><p>在规约组件库的介绍当中，详细说明了为什么会有<a href="#%E5%B0%81%E8%A3%85%E5%88%86%E9%A1%B5%E5%AF%B9%E8%B1%A1">自定义分页参数</a>。</p><p>这里提供 MyBatisPlus 的分页对象和规约分页对象的数据和类型转换工具类。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 分页工具类，用于转换分页对象</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * &#123;@link PageRequest&#125; to &#123;@link Page&#125;</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Page</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将自定义的 PageRequest 对象转换为 MyBatisPlus 的 Page 对象</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">convert</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pageRequest<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * &#123;@link PageRequest&#125; to &#123;@link Page&#125;</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Page</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token keyword">long</span> current<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将当前页和每页显示条数转换为 MyBatisPlus 的 Page 对象</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="23"></td><td><pre>     * &#123;@link IPage&#125; to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="24"></td><td><pre>     */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PageResponse</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">IPage</span> iPage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">buildConventionPage</span><span class="token punctuation">(</span>iPage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     * &#123;@link IPage&#125; to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="31"></td><td><pre>     */</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">,</span> ORIGINAL<span class="token punctuation">></span></span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span>ORIGINAL<span class="token punctuation">></span></span> iPage<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        iPage<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 BeanUtil.convert 方法将每个元素转换为目标类型</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">buildConventionPage</span><span class="token punctuation">(</span>iPage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre>     * &#123;@link IPage&#125; to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="39"></td><td><pre>     */</pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">,</span> ORIGINAL<span class="token punctuation">></span></span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span>ORIGINAL<span class="token punctuation">></span></span> iPage<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> ORIGINAL<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> TARGET<span class="token punctuation">></span></span> mapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span> targetDataList <span class="token operator">=</span> iPage<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 Stream API 将每个元素转换为目标类型</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>TARGET<span class="token punctuation">></span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span>targetDataList<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="53"></td><td><pre>     * &#123;@link IPage&#125; build to &#123;@link PageResponse&#125;</pre></td></tr><tr><td data-num="54"></td><td><pre>     */</pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">PageResponse</span> <span class="token function">buildConventionPage</span><span class="token punctuation">(</span><span class="token class-name">IPage</span> iPage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将 MyBatisPlus 的 IPage 对象转换为自定义的 PageResponse 对象</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">records</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span>iPage<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="自定义雪花算法"><a class="anchor" href="#自定义雪花算法">#</a> 自定义雪花算法</h4><blockquote><p>相关技术文档：[雪花算法生成分布式 ID](# 雪花算法生成分布式 ID)</p></blockquote><p>定义雪花算法类 <code>CustomIdGenerator</code> ，并替换 MyBatisPlus 原有的雪花 ID 生成器：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 自定义雪花算法生成器，用于生成全局唯一 ID</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomIdGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">IdentifierGenerator</span> <span class="token punctuation">&#123;</span> <span class="token comment">// IdentifierGenerator 是 MyBatis-Plus 的 ID 生成器接口，用于生成全局唯一的 ID</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 重写 nextId 方法，用于生成全局唯一的 ID</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Number</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">Object</span> entity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">SnowflakeIdUtil</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用自定义的雪花算法工具类生成全局唯一的 ID</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中，自定义的分布式唯一雪花算法 ID 工具类 <code>SnowflakeIdUtil</code> 在下一节再详细介绍。</p><h3 id="分布式-id-组件"><a class="anchor" href="#分布式-id-组件">#</a> 分布式 ID 组件</h3><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-distributedid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：</p><ol><li>实现分布式唯一雪花算法 ID 生成器</li><li>封装分布式唯一雪花算法 ID 工具类</li><li>封装分库或分表基因算法工具类</li></ol><h4 id="雪花算法生成器"><a class="anchor" href="#雪花算法生成器">#</a> 雪花算法生成器</h4><blockquote><p>相关技术文档：[雪花算法生成分布式 ID](# 雪花算法生成分布式 ID)</p></blockquote><p>雪花算法生成器是为了解决工作机器 ID 重复问题，底层创建雪花算法依然采用推特那一套逻辑。</p><p>通过分配抢占的方式获取机器 ID，存储机器 ID 的位置就是个比较难选择的事情。</p><p><font color="red">默认是通过 Redis 缓存存储 </font>，但是当项目中没有 Redis 时，采用随机数方式获取机器 ID。</p><p>1）定义雪花算法获取机器 ID 的<strong>模板抽象类</strong>。</p><p>采用模板方法设计模式，即让子类可以重写方法的一部分，而不是整个重写，获取 Redis 或者随机数提供的机器 ID。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 雪花算法模板生成</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractWorkIdChooseTemplate</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 抽象模板类</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 是否使用 &#123;@link SystemClock&#125; 获取当前时间戳</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;framework.distributed.id.snowflake.is-use-system-clock:false&#125;"</span><span class="token punctuation">)</span> <span class="token comment">// 从配置文件中获取是否使用系统时钟</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isUseSystemClock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 根据自定义策略获取 WorkId 生成器</pre></td></tr><tr><td data-num="17"></td><td><pre>     *</pre></td></tr><tr><td data-num="18"></td><td><pre>     * @return &#123;@link WorkIdWrapper&#125; WorkId 包装器：包含 WorkId 和 DataCenterId</pre></td></tr><tr><td data-num="19"></td><td><pre>     */</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">WorkIdWrapper</span> <span class="token function">chooseWorkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="23"></td><td><pre>     * 选择 WorkId 并初始化雪花</pre></td></tr><tr><td data-num="24"></td><td><pre>     */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">chooseAndInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 模板方法设计模式：通过上面的抽象方法获取 WorkId 包装器，从而创建雪花算法</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">WorkIdWrapper</span> workIdWrapper <span class="token operator">=</span> <span class="token function">chooseWorkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">long</span> workId <span class="token operator">=</span> workIdWrapper<span class="token punctuation">.</span><span class="token function">getWorkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 WorkId</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">long</span> dataCenterId <span class="token operator">=</span> workIdWrapper<span class="token punctuation">.</span><span class="token function">getDataCenterId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 DataCenterId</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">Snowflake</span> snowflake <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span>workId<span class="token punctuation">,</span> dataCenterId<span class="token punctuation">,</span> isUseSystemClock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建雪花算法</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Snowflake type: &#123;&#125;, workId: &#123;&#125;, dataCenterId: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> workId<span class="token punctuation">,</span> dataCenterId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">SnowflakeIdUtil</span><span class="token punctuation">.</span><span class="token function">initSnowflake</span><span class="token punctuation">(</span>snowflake<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化雪花算法</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中，WorkIdWrapper 是用于包装 工作 ID 和 数据中心 ID 的包装器：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * WorkId 包装器，包含 WorkId 和 DataCenterId</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WorkIdWrapper</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>     * 工作 ID</pre></td></tr><tr><td data-num="13"></td><td><pre>     */</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> workId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 数据中心 ID</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> dataCenterId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>另外，Snowflake 是 Twitter 的雪花算法实现：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Twitter 的 Snowflake 算法 & lt;br></pre></td></tr><tr><td data-num="3"></td><td><pre> * 分布式系统中，有一些需要使用全局唯一 ID 的场景，有些时候我们希望能使用一种简单一些的 ID，并且希望 ID 能够按照时间有序生成。</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="6"></td><td><pre> * snowflake 的结构如下 (每部分用 - 分开):&lt;br></pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * &lt;pre></pre></td></tr><tr><td data-num="9"></td><td><pre> * 符号位（1bit）- 时间戳相对值（41bit）- 数据中心标志（5bit）- 机器标志（5bit）- 递增序号（12bit）</pre></td></tr><tr><td data-num="10"></td><td><pre> * 0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000</pre></td></tr><tr><td data-num="11"></td><td><pre> * &lt;/pre></pre></td></tr><tr><td data-num="12"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="13"></td><td><pre> * 第一位为未使用 (符号位表示正数)，接下来的 41 位为毫秒级时间 (41 位的长度可以使用 69 年)&lt;br></pre></td></tr><tr><td data-num="14"></td><td><pre> * 然后是 5 位 datacenterId 和 5 位 workerId (10 位的长度最多支持部署 1024 个节点）&lt;br></pre></td></tr><tr><td data-num="15"></td><td><pre> * 最后 12 位是毫秒内的计数（12 位的计数顺序号支持每个节点每毫秒产生 4096 个 ID 序号）</pre></td></tr><tr><td data-num="16"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="17"></td><td><pre> * 并且可以通过生成的 id 反推出生成时间，datacenterId 和 workerId</pre></td></tr><tr><td data-num="18"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num="19"></td><td><pre> * 参考：http://www.cnblogs.com/relucent/p/4955340.html&lt;br></pre></td></tr><tr><td data-num="20"></td><td><pre> * 关于长度是 18 还是 19 的问题见：https://blog.csdn.net/unifirst/article/details/80408050</pre></td></tr><tr><td data-num="21"></td><td><pre> *</pre></td></tr><tr><td data-num="22"></td><td><pre> * @author Looly</pre></td></tr><tr><td data-num="23"></td><td><pre> * @since 3.0.1</pre></td></tr><tr><td data-num="24"></td><td><pre> */</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Snowflake</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">,</span> <span class="token class-name">IdGenerator</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     * 默认的起始时间，为 Thu, 04 Nov 2010 01:42:54 GMT</pre></td></tr><tr><td data-num="31"></td><td><pre>     */</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">DEFAULT_TWEPOCH</span> <span class="token operator">=</span> <span class="token number">1288834974657L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>     * 默认回拨时间，2S</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">DEFAULT_TIME_OFFSET</span> <span class="token operator">=</span> <span class="token number">2000L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">WORKER_ID_BITS</span> <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 最大支持机器节点数 0~31，一共 32 个</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"PointlessBitwiseExpression"</span><span class="token punctuation">,</span> <span class="token string">"FieldCanBeLocal"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">MAX_WORKER_ID</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">WORKER_ID_BITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">DATA_CENTER_ID_BITS</span> <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 最大支持数据中心节点数 0~31，一共 32 个</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"PointlessBitwiseExpression"</span><span class="token punctuation">,</span> <span class="token string">"FieldCanBeLocal"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">MAX_DATA_CENTER_ID</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">DATA_CENTER_ID_BITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">// 序列号 12 位（表示只允许 workId 的范围为：0-4095）</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">SEQUENCE_BITS</span> <span class="token operator">=</span> <span class="token number">12L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token comment">// 机器节点左移 12 位</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">WORKER_ID_SHIFT</span> <span class="token operator">=</span> <span class="token constant">SEQUENCE_BITS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 数据中心节点左移 17 位</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">DATA_CENTER_ID_SHIFT</span> <span class="token operator">=</span> <span class="token constant">SEQUENCE_BITS</span> <span class="token operator">+</span> <span class="token constant">WORKER_ID_BITS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">// 时间毫秒数左移 22 位</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">TIMESTAMP_LEFT_SHIFT</span> <span class="token operator">=</span> <span class="token constant">SEQUENCE_BITS</span> <span class="token operator">+</span> <span class="token constant">WORKER_ID_BITS</span> <span class="token operator">+</span> <span class="token constant">DATA_CENTER_ID_BITS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 序列掩码，用于限定序列最大值不能超过 4095</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">SEQUENCE_MASK</span> <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SEQUENCE_BITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="67"></td><td><pre>     * 初始化时间点</pre></td></tr><tr><td data-num="68"></td><td><pre>     */</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> twepoch<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> workerId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> dataCenterId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> useSystemClock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="78"></td><td><pre>     * 允许的时钟回拨毫秒数</pre></td></tr><tr><td data-num="79"></td><td><pre>     */</pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeOffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="83"></td><td><pre>     * 当在低频模式下时，序号始终为 0，导致生成 ID 始终为偶数 & lt;br></pre></td></tr><tr><td data-num="84"></td><td><pre>     * 此属性用于限定一个随机上限，在不同毫秒下生成序号时，给定一个随机数，避免偶数问题。&lt;br></pre></td></tr><tr><td data-num="85"></td><td><pre>     * 注意次数必须小于 &#123;@link #SEQUENCE_MASK&#125;，&#123;@code 0&#125; 表示不使用随机数。&lt;br></pre></td></tr><tr><td data-num="86"></td><td><pre>     * 这个上限不包括值本身。</pre></td></tr><tr><td data-num="87"></td><td><pre>     */</pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> randomSequenceLimit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="91"></td><td><pre>     * 自增序号，当高频模式下时，同一毫秒内生成 N 个 ID，则这个序号在同一毫秒下，自增以避免 ID 重复。</pre></td></tr><tr><td data-num="92"></td><td><pre>     */</pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">long</span> sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="98"></td><td><pre>     * 构造，使用自动生成的工作节点 ID 和数据中心 ID</pre></td></tr><tr><td data-num="99"></td><td><pre>     */</pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">getWorkerId</span><span class="token punctuation">(</span><span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">getDataCenterId</span><span class="token punctuation">(</span><span class="token constant">MAX_DATA_CENTER_ID</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">MAX_WORKER_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="105"></td><td><pre>     * @param workerId 终端 ID</pre></td></tr><tr><td data-num="106"></td><td><pre>     */</pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token keyword">long</span> workerId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>workerId<span class="token punctuation">,</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">getDataCenterId</span><span class="token punctuation">(</span><span class="token constant">MAX_DATA_CENTER_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="112"></td><td><pre>     * @param workerId     终端 ID</pre></td></tr><tr><td data-num="113"></td><td><pre>     * @param dataCenterId 数据中心 ID</pre></td></tr><tr><td data-num="114"></td><td><pre>     */</pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token keyword">long</span> workerId<span class="token punctuation">,</span> <span class="token keyword">long</span> dataCenterId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>workerId<span class="token punctuation">,</span> dataCenterId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="120"></td><td><pre>     * @param workerId         终端 ID</pre></td></tr><tr><td data-num="121"></td><td><pre>     * @param dataCenterId     数据中心 ID</pre></td></tr><tr><td data-num="122"></td><td><pre>     * @param isUseSystemClock 是否使用 &#123;@link SystemClock&#125; 获取当前时间戳</pre></td></tr><tr><td data-num="123"></td><td><pre>     */</pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token keyword">long</span> workerId<span class="token punctuation">,</span> <span class="token keyword">long</span> dataCenterId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isUseSystemClock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> workerId<span class="token punctuation">,</span> dataCenterId<span class="token punctuation">,</span> isUseSystemClock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="129"></td><td><pre>     * @param epochDate        初始化时间起点（null 表示默认起始日期）, 后期修改会导致 id 重复，如果要修改连 workerId dataCenterId，慎用</pre></td></tr><tr><td data-num="130"></td><td><pre>     * @param workerId         工作机器节点 id</pre></td></tr><tr><td data-num="131"></td><td><pre>     * @param dataCenterId     数据中心 id</pre></td></tr><tr><td data-num="132"></td><td><pre>     * @param isUseSystemClock 是否使用 &#123;@link SystemClock&#125; 获取当前时间戳</pre></td></tr><tr><td data-num="133"></td><td><pre>     * @since 5.1.3</pre></td></tr><tr><td data-num="134"></td><td><pre>     */</pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token class-name">Date</span> epochDate<span class="token punctuation">,</span> <span class="token keyword">long</span> workerId<span class="token punctuation">,</span> <span class="token keyword">long</span> dataCenterId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isUseSystemClock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>epochDate<span class="token punctuation">,</span> workerId<span class="token punctuation">,</span> dataCenterId<span class="token punctuation">,</span> isUseSystemClock<span class="token punctuation">,</span> <span class="token constant">DEFAULT_TIME_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="140"></td><td><pre>     * @param epochDate        初始化时间起点（null 表示默认起始日期）, 后期修改会导致 id 重复，如果要修改连 workerId dataCenterId，慎用</pre></td></tr><tr><td data-num="141"></td><td><pre>     * @param workerId         工作机器节点 id</pre></td></tr><tr><td data-num="142"></td><td><pre>     * @param dataCenterId     数据中心 id</pre></td></tr><tr><td data-num="143"></td><td><pre>     * @param isUseSystemClock 是否使用 &#123;@link SystemClock&#125; 获取当前时间戳</pre></td></tr><tr><td data-num="144"></td><td><pre>     * @param timeOffset       允许时间回拨的毫秒数</pre></td></tr><tr><td data-num="145"></td><td><pre>     * @since 5.8.0</pre></td></tr><tr><td data-num="146"></td><td><pre>     */</pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token class-name">Date</span> epochDate<span class="token punctuation">,</span> <span class="token keyword">long</span> workerId<span class="token punctuation">,</span> <span class="token keyword">long</span> dataCenterId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isUseSystemClock<span class="token punctuation">,</span> <span class="token keyword">long</span> timeOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">(</span>epochDate<span class="token punctuation">,</span> workerId<span class="token punctuation">,</span> dataCenterId<span class="token punctuation">,</span> isUseSystemClock<span class="token punctuation">,</span> timeOffset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="150"></td><td><pre></pre></td></tr><tr><td data-num="151"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="152"></td><td><pre>     * @param epochDate           初始化时间起点（null 表示默认起始日期）, 后期修改会导致 id 重复，如果要修改连 workerId dataCenterId，慎用</pre></td></tr><tr><td data-num="153"></td><td><pre>     * @param workerId            工作机器节点 id</pre></td></tr><tr><td data-num="154"></td><td><pre>     * @param dataCenterId        数据中心 id</pre></td></tr><tr><td data-num="155"></td><td><pre>     * @param isUseSystemClock    是否使用 &#123;@link SystemClock&#125; 获取当前时间戳</pre></td></tr><tr><td data-num="156"></td><td><pre>     * @param timeOffset          允许时间回拨的毫秒数</pre></td></tr><tr><td data-num="157"></td><td><pre>     * @param randomSequenceLimit 限定一个随机上限，在不同毫秒下生成序号时，给定一个随机数，避免偶数问题，0 表示无随机，上限不包括值本身。</pre></td></tr><tr><td data-num="158"></td><td><pre>     * @since 5.8.0</pre></td></tr><tr><td data-num="159"></td><td><pre>     */</pre></td></tr><tr><td data-num="160"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token class-name">Date</span> epochDate<span class="token punctuation">,</span> <span class="token keyword">long</span> workerId<span class="token punctuation">,</span> <span class="token keyword">long</span> dataCenterId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isUseSystemClock<span class="token punctuation">,</span> <span class="token keyword">long</span> timeOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> randomSequenceLimit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>twepoch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> epochDate<span class="token punctuation">)</span> <span class="token operator">?</span> epochDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">DEFAULT_TWEPOCH</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">=</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">checkBetween</span><span class="token punctuation">(</span>workerId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_WORKER_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterId <span class="token operator">=</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">checkBetween</span><span class="token punctuation">(</span>dataCenterId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_DATA_CENTER_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>useSystemClock <span class="token operator">=</span> isUseSystemClock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>timeOffset <span class="token operator">=</span> timeOffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>randomSequenceLimit <span class="token operator">=</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">checkBetween</span><span class="token punctuation">(</span>randomSequenceLimit<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEQUENCE_MASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="168"></td><td><pre></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="170"></td><td><pre>     * 根据 Snowflake 的 ID，获取机器 id</pre></td></tr><tr><td data-num="171"></td><td><pre>     *</pre></td></tr><tr><td data-num="172"></td><td><pre>     * @param id snowflake 算法生成的 id</pre></td></tr><tr><td data-num="173"></td><td><pre>     * @return 所属机器的 id</pre></td></tr><tr><td data-num="174"></td><td><pre>     */</pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getWorkerId</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>        <span class="token keyword">return</span> id <span class="token operator">>></span> <span class="token constant">WORKER_ID_SHIFT</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">WORKER_ID_BITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="178"></td><td><pre></pre></td></tr><tr><td data-num="179"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="180"></td><td><pre>     * 根据 Snowflake 的 ID，获取数据中心 id</pre></td></tr><tr><td data-num="181"></td><td><pre>     *</pre></td></tr><tr><td data-num="182"></td><td><pre>     * @param id snowflake 算法生成的 id</pre></td></tr><tr><td data-num="183"></td><td><pre>     * @return 所属数据中心</pre></td></tr><tr><td data-num="184"></td><td><pre>     */</pre></td></tr><tr><td data-num="185"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDataCenterId</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>        <span class="token keyword">return</span> id <span class="token operator">>></span> <span class="token constant">DATA_CENTER_ID_SHIFT</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">DATA_CENTER_ID_BITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="188"></td><td><pre></pre></td></tr><tr><td data-num="189"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="190"></td><td><pre>     * 根据 Snowflake 的 ID，获取生成时间</pre></td></tr><tr><td data-num="191"></td><td><pre>     *</pre></td></tr><tr><td data-num="192"></td><td><pre>     * @param id snowflake 算法生成的 id</pre></td></tr><tr><td data-num="193"></td><td><pre>     * @return 生成的时间</pre></td></tr><tr><td data-num="194"></td><td><pre>     */</pre></td></tr><tr><td data-num="195"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getGenerateDateTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span>id <span class="token operator">>></span> <span class="token constant">TIMESTAMP_LEFT_SHIFT</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token number">41L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> twepoch<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="198"></td><td><pre></pre></td></tr><tr><td data-num="199"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="200"></td><td><pre>     * 下一个 ID</pre></td></tr><tr><td data-num="201"></td><td><pre>     *</pre></td></tr><tr><td data-num="202"></td><td><pre>     * @return ID</pre></td></tr><tr><td data-num="203"></td><td><pre>     */</pre></td></tr><tr><td data-num="204"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token function">genTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp <span class="token operator">-</span> timestamp <span class="token operator">&lt;</span> timeOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="208"></td><td><pre>                <span class="token comment">// 容忍指定的回拨，避免 NTP 校时造成的异常</span></pre></td></tr><tr><td data-num="209"></td><td><pre>                timestamp <span class="token operator">=</span> lastTimestamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>                <span class="token comment">// 如果服务器时间有问题 (时钟后退) 报错。</span></pre></td></tr><tr><td data-num="212"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Clock moved backwards. Refusing to generate id for &#123;&#125;ms"</span><span class="token punctuation">,</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>            <span class="token keyword">final</span> <span class="token keyword">long</span> sequence <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">SEQUENCE_MASK</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="217"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="218"></td><td><pre>                timestamp <span class="token operator">=</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">=</span> sequence<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>            <span class="token comment">// issue#I51EJY</span></pre></td></tr><tr><td data-num="223"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>randomSequenceLimit <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>                sequence <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomLong</span><span class="token punctuation">(</span>randomSequenceLimit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="225"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="226"></td><td><pre>                sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="227"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="228"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>        lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> twepoch<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">TIMESTAMP_LEFT_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>dataCenterId <span class="token operator">&lt;&lt;</span> <span class="token constant">DATA_CENTER_ID_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> <span class="token constant">WORKER_ID_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">|</span> sequence<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="232"></td><td><pre></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="234"></td><td><pre>     * 下一个 ID（字符串形式）</pre></td></tr><tr><td data-num="235"></td><td><pre>     *</pre></td></tr><tr><td data-num="236"></td><td><pre>     * @return ID 字符串形式</pre></td></tr><tr><td data-num="237"></td><td><pre>     */</pre></td></tr><tr><td data-num="238"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">nextIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="239"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="240"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="241"></td><td><pre></pre></td></tr><tr><td data-num="242"></td><td><pre>    <span class="token comment">// ------------------------------------------------------------------------------------------------------------------------------------ Private method start</span></pre></td></tr><tr><td data-num="243"></td><td><pre></pre></td></tr><tr><td data-num="244"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="245"></td><td><pre>     * 循环等待下一个时间</pre></td></tr><tr><td data-num="246"></td><td><pre>     *</pre></td></tr><tr><td data-num="247"></td><td><pre>     * @param lastTimestamp 上次记录的时间</pre></td></tr><tr><td data-num="248"></td><td><pre>     * @return 下一个时间</pre></td></tr><tr><td data-num="249"></td><td><pre>     */</pre></td></tr><tr><td data-num="250"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="251"></td><td><pre>        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token function">genTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="252"></td><td><pre>        <span class="token comment">// 循环直到操作系统时间戳变化</span></pre></td></tr><tr><td data-num="253"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>timestamp <span class="token operator">==</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>            timestamp <span class="token operator">=</span> <span class="token function">genTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>            <span class="token comment">// 如果发现新的时间戳比上次记录的时间戳数值小，说明操作系统时间发生了倒退，报错</span></pre></td></tr><tr><td data-num="258"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Clock moved backwards. Refusing to generate id for &#123;&#125;ms"</span><span class="token punctuation">,</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="259"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="260"></td><td><pre>        <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="261"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="262"></td><td><pre></pre></td></tr><tr><td data-num="263"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="264"></td><td><pre>     * 生成时间戳</pre></td></tr><tr><td data-num="265"></td><td><pre>     *</pre></td></tr><tr><td data-num="266"></td><td><pre>     * @return 时间戳</pre></td></tr><tr><td data-num="267"></td><td><pre>     */</pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">genTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="269"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>useSystemClock <span class="token operator">?</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="271"></td><td><pre></pre></td></tr><tr><td data-num="272"></td><td><pre>    <span class="token comment">// ------------------------------------------------------------------------------------------------------------------------------------ Private method end</span></pre></td></tr><tr><td data-num="273"></td><td><pre></pre></td></tr><tr><td data-num="274"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="275"></td><td><pre>     * 解析雪花算法生成的 ID 为对象</pre></td></tr><tr><td data-num="276"></td><td><pre>     *</pre></td></tr><tr><td data-num="277"></td><td><pre>     * @param snowflakeId 雪花算法 ID</pre></td></tr><tr><td data-num="278"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="279"></td><td><pre>     */</pre></td></tr><tr><td data-num="280"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">SnowflakeIdInfo</span> <span class="token function">parseSnowflakeId</span><span class="token punctuation">(</span><span class="token keyword">long</span> snowflakeId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="281"></td><td><pre>        <span class="token class-name">SnowflakeIdInfo</span> snowflakeIdInfo <span class="token operator">=</span> <span class="token class-name">SnowflakeIdInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sequence</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>snowflakeId <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SEQUENCE_BITS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">workerId</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>snowflakeId <span class="token operator">>></span> <span class="token constant">WORKER_ID_SHIFT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="282"></td><td><pre>                        <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">WORKER_ID_BITS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dataCenterId</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>snowflakeId <span class="token operator">>></span> <span class="token constant">DATA_CENTER_ID_SHIFT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="283"></td><td><pre>                        <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">DATA_CENTER_ID_BITS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="284"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>snowflakeId <span class="token operator">>></span> <span class="token constant">TIMESTAMP_LEFT_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> twepoch<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="285"></td><td><pre>        <span class="token keyword">return</span> snowflakeIdInfo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="286"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="287"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）Redis 获取机器 ID 处理器。</p><p>底层通过 <code>Redis Lua 脚本</code> 保障原子性。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 使用 Redis 获取雪花 ID 标识位（WorkId 和 DataCenterId）</pre></td></tr><tr><td data-num="3"></td><td><pre> * 是对 &#123;@link AbstractWorkIdChooseTemplate&#125; 的一种具体实现</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalRedisWorkIdChoose</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractWorkIdChooseTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span> <span class="token comment">// Redis 模板，用于执行 Lua 脚本</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">LocalRedisWorkIdChoose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// StringRedisTemplate 是 RedisTemplate 的子类</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 重写抽象方法，模板方法设计模式的体现</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">WorkIdWrapper</span> <span class="token function">chooseWorkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">DefaultRedisScript</span> redisScript <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        redisScript<span class="token punctuation">.</span><span class="token function">setScriptSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceScriptSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"lua/chooseWorkIdLua.lua"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 Lua 脚本，在 resources/lua 目录下</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> luaResultList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            redisScript<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            luaResultList <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>redisScript<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Redis Lua 脚本获取 WorkId 失败"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 如果 Redis 获取失败，则使用随机数获取 WorkId、DataCenterId</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>luaResultList<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">WorkIdWrapper</span><span class="token punctuation">(</span>luaResultList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> luaResultList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RandomWorkIdChoose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chooseWorkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">chooseAndInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Lua 脚本具体如下，返回的 resultWorkId, resultDataCenterId 就是雪花 ID 组成中的标识位部分。</p><figure class="highlight lua"><figcaption data-lang="lua"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">local</span> hashKey <span class="token operator">=</span> <span class="token string">'snowflake_work_id_key'</span> <span class="token comment">-- 用于保存 workId 和 dataCenterId 的 hash 结构</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">local</span> dataCenterIdKey <span class="token operator">=</span> <span class="token string">'dataCenterId'</span> <span class="token comment">-- 保存 dataCenterId 的 key</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">local</span> workIdKey <span class="token operator">=</span> <span class="token string">'workId'</span> <span class="token comment">-- 保存 workId 的 key</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'exists'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">-- 如果 hash 结构不存在，则初始化</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> dataCenterIdKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- 初始化 dataCenterId 为 0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> workIdKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- 初始化 workId 为 0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span> <span class="token comment">-- 返回 workId 和 dataCenterId 都为 0</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">end</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">-- 如果 hash 结构存在，则从中获取 workId 和 dataCenterId</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">local</span> dataCenterId <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hget'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> dataCenterIdKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 获取 dataCenterId</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">local</span> workId <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hget'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> workIdKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 获取 workId</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">local</span> max <span class="token operator">=</span> <span class="token number">31</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">local</span> resultWorkId <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">local</span> resultDataCenterId <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>dataCenterId <span class="token operator">==</span> max <span class="token keyword">and</span> workId <span class="token operator">==</span> max<span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">-- 如果 dataCenterId 和 workId 都已经达到最大值，则重置为 0</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hset'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> dataCenterIdKey<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hset'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> workIdKey<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">elseif</span> <span class="token punctuation">(</span>workId <span class="token operator">~=</span> max<span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">-- 如果 workId 没有达到最大值，则递增 workId</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    resultWorkId <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> workIdKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    resultDataCenterId <span class="token operator">=</span> dataCenterId <span class="token comment">-- dataCenterId 不变</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">elseif</span> <span class="token punctuation">(</span>dataCenterId <span class="token operator">~=</span> max<span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">-- 如果 workId 已经达到最大值，但是 dataCenterId 没有达到最大值，则递增 dataCenterId</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    resultWorkId <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">-- workId 重置为 0</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    resultDataCenterId <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> dataCenterIdKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">-- dataCenterId 递增</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hset'</span><span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> workIdKey<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token comment">-- workId 重置为 0</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">end</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">return</span> <span class="token punctuation">&#123;</span> resultWorkId<span class="token punctuation">,</span> resultDataCenterId <span class="token punctuation">&#125;</span> <span class="token comment">-- 返回 workId 和 dataCenterId</span></pre></td></tr></table></figure><p>3）随机数生成机器 ID 处理器。</p><p>整体比较简单，调用 <code>Random</code> 随机函数获取两个值。就不过多介绍。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 使用随机数获取雪花 ID 标识位（WorkId 和 DataCenterId）</pre></td></tr><tr><td data-num="3"></td><td><pre> * 是对 &#123;@link AbstractWorkIdChooseTemplate&#125; 的一种具体实现</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomWorkIdChoose</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractWorkIdChooseTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 重写抽象方法，模板方法设计模式的体现</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">WorkIdWrapper</span> <span class="token function">chooseWorkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WorkIdWrapper</span><span class="token punctuation">(</span><span class="token function">getRandom</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getRandom</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">chooseAndInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">long</span> random <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> random<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="雪花算法工具类"><a class="anchor" href="#雪花算法工具类">#</a> 雪花算法工具类</h4><p>对象属性 SNOWFLAKE 是在 AbstractWorkIdChooseTemplate 获取到机器 ID 标识位后初始化的。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 分布式雪花 ID 工具类，提供雪花算法 ID 生成、解析、获取等功能</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SnowflakeIdUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 雪花算法对象</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Snowflake</span> <span class="token constant">SNOWFLAKE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 初始化雪花算法</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initSnowflake</span><span class="token punctuation">(</span><span class="token class-name">Snowflake</span> snowflake<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">SnowflakeIdUtil</span><span class="token punctuation">.</span><span class="token constant">SNOWFLAKE</span> <span class="token operator">=</span> snowflake<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * 获取雪花算法实例</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Snowflake</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">SNOWFLAKE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="28"></td><td><pre>     * 获取雪花算法下一个 ID</pre></td></tr><tr><td data-num="29"></td><td><pre>     */</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">SNOWFLAKE</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>     * 获取雪花算法下一个字符串类型 ID</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">nextIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="42"></td><td><pre>     * 解析雪花算法生成的 ID 为对象</pre></td></tr><tr><td data-num="43"></td><td><pre>     */</pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SnowflakeIdInfo</span> <span class="token function">parseSnowflakeId</span><span class="token punctuation">(</span><span class="token class-name">String</span> snowflakeId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">SNOWFLAKE</span><span class="token punctuation">.</span><span class="token function">parseSnowflakeId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>snowflakeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="49"></td><td><pre>     * 解析雪花算法生成的 ID 为对象</pre></td></tr><tr><td data-num="50"></td><td><pre>     */</pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SnowflakeIdInfo</span> <span class="token function">parseSnowflakeId</span><span class="token punctuation">(</span><span class="token keyword">long</span> snowflakeId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">SNOWFLAKE</span><span class="token punctuation">.</span><span class="token function">parseSnowflakeId</span><span class="token punctuation">(</span>snowflakeId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="56"></td><td><pre>     * 根据 &#123;@param serviceId&#125; 生成雪花算法 ID</pre></td></tr><tr><td data-num="57"></td><td><pre>     */</pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">nextIdByService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IdGeneratorManager</span><span class="token punctuation">.</span><span class="token function">getDefaultServiceIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="63"></td><td><pre>     * 根据 &#123;@param serviceId&#125; 生成字符串类型雪花算法 ID</pre></td></tr><tr><td data-num="64"></td><td><pre>     */</pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">nextIdStrByService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IdGeneratorManager</span><span class="token punctuation">.</span><span class="token function">getDefaultServiceIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextIdStr</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="70"></td><td><pre>     * 根据 &#123;@param serviceId&#125; 生成字符串类型雪花算法 ID</pre></td></tr><tr><td data-num="71"></td><td><pre>     */</pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">nextIdStrByService</span><span class="token punctuation">(</span><span class="token class-name">String</span> resource<span class="token punctuation">,</span> <span class="token keyword">long</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IdGeneratorManager</span><span class="token punctuation">.</span><span class="token function">getIdGenerator</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextIdStr</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="77"></td><td><pre>     * 根据 &#123;@param serviceId&#125; 生成字符串类型雪花算法 ID</pre></td></tr><tr><td data-num="78"></td><td><pre>     */</pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">nextIdStrByService</span><span class="token punctuation">(</span><span class="token class-name">String</span> resource<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IdGeneratorManager</span><span class="token punctuation">.</span><span class="token function">getIdGenerator</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextIdStr</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="84"></td><td><pre>     * 解析雪花算法生成的 ID 为对象</pre></td></tr><tr><td data-num="85"></td><td><pre>     */</pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SnowflakeIdInfo</span> <span class="token function">parseSnowflakeServiceId</span><span class="token punctuation">(</span><span class="token class-name">String</span> snowflakeId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IdGeneratorManager</span><span class="token punctuation">.</span><span class="token function">getDefaultServiceIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseSnowflakeId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>snowflakeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="91"></td><td><pre>     * 解析雪花算法生成的 ID 为对象</pre></td></tr><tr><td data-num="92"></td><td><pre>     */</pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SnowflakeIdInfo</span> <span class="token function">parseSnowflakeServiceId</span><span class="token punctuation">(</span><span class="token class-name">String</span> resource<span class="token punctuation">,</span> <span class="token class-name">String</span> snowflakeId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IdGeneratorManager</span><span class="token punctuation">.</span><span class="token function">getIdGenerator</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseSnowflakeId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>snowflakeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中，SnowflakeIdInfo 是雪花算法 ID 的组成部分，通常用来反解析使用：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 雪花算法 ID 的组成部分，通常用来反解析使用</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Builder</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowflakeIdInfo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre>     * 时间戳，占 41 bit</pre></td></tr><tr><td data-num="14"></td><td><pre>     */</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>     * 工作机器节点 ID，占 5 bit</pre></td></tr><tr><td data-num="19"></td><td><pre>     */</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> workerId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="23"></td><td><pre>     * 数据中心 ID，占 5 bit</pre></td></tr><tr><td data-num="24"></td><td><pre>     */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> dataCenterId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="28"></td><td><pre>     * 自增序号，当高频模式下时，同一毫秒内生成 N 个 ID，则这个序号在同一毫秒下，自增以避免 ID 重复</pre></td></tr><tr><td data-num="29"></td><td><pre>     */</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sequence<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="33"></td><td><pre>     * 通过基因法生成的序号，会和 &#123;@link SnowflakeIdInfo#sequence&#125; 共占 12 bit</pre></td></tr><tr><td data-num="34"></td><td><pre>     */</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> gene<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="分库或分表基因算法"><a class="anchor" href="#分库或分表基因算法">#</a> 分库或分表基因算法</h4><p>TODO</p><h3 id="日志打印组件"><a class="anchor" href="#日志打印组件">#</a> 日志打印组件</h3><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-log-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：定义日志打印注解，可以标记在方法或类上，从而打印日志。</p><h4 id="日志打印注解"><a class="anchor" href="#日志打印注解">#</a> 日志打印注解</h4><p>定义<strong>日志打印注解</strong> <code>ILog</code> ，可以标记在类或者方法上。</p><ul><li>标记在类上时，类下所有方法都会打印</li><li>标记在方法上，仅打印标记方法</li><li>如果类或者方法上都有标记，<font color="red">以方法上注解为准</font></li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 日志打印注解，可以标记在类或者方法上</pre></td></tr><tr><td data-num="3"></td><td><pre> * 标记在类上，类下所有方法都会打印；标记在方法上，仅打印标记方法；如果类或者方法上都有标记，以方法上注解为准</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// 注解使用范围：类、方法</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span> <span class="token comment">// 注解生命周期：运行时</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ILog</span> <span class="token punctuation">&#123;</span> <span class="token comment">// @interface 定义注解</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>     * 入参打印，入参表示方法的参数</pre></td></tr><tr><td data-num="13"></td><td><pre>     *</pre></td></tr><tr><td data-num="14"></td><td><pre>     * @return 打印结果中是否包含入参，&#123;@link Boolean#TRUE&#125; 打印，&#123;@link Boolean#FALSE&#125; 不打印</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 出参打印，出参表示方法的返回值</pre></td></tr><tr><td data-num="20"></td><td><pre>     *</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @return 打印结果中是否包含出参，&#123;@link Boolean#TRUE&#125; 打印，&#123;@link Boolean#FALSE&#125; 不打印</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="日志打印参数dto"><a class="anchor" href="#日志打印参数dto">#</a> 日志打印参数 DTO</h4><p>DTO 表示数据传输对象，</p><p>定义<strong>日志打印规约参数</strong>，包括：开始时间、请求入参、以及返回参数等。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 日志打印参数 DTO，DTO 表示数据传输对象</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ILogPrintDTO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 开始时间</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> beginTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     * 请求入参</pre></td></tr><tr><td data-num="16"></td><td><pre>     */</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inputParams<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     * 返回参数</pre></td></tr><tr><td data-num="21"></td><td><pre>     */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Object</span> outputParams<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="日志注解-aop-扫描类"><a class="anchor" href="#日志注解-aop-扫描类">#</a> 日志注解 AOP 扫描类</h4><p>定义<strong>日志注解 AOP 扫描类</strong>，对执行方法进行 <font color="red">环绕增强 </font>，最终打印方法的执行日志。</p><p>其中， <code>@within</code> 和 <code>@annotation</code> 注解分别对注解在类上和在方法上增强。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * &#123;@link ILog&#125; 日志打印 AOP 切面，用于对标记了 &#123;@link ILog&#125; 注解的类或方法进行环绕通知 / 增强（打印日志）</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Aspect</span> <span class="token comment">// 切面</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ILogPrintAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 打印类或方法上的 &#123;@link ILog&#125;</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// @Aroud 注解表示环绕通知，可以在目标方法执行前后织入增强 / 通知的代码</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// @within 表示匹配类上的 @ILog 注解，@annotation 表示匹配方法上的 @ILog 注解</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@within(org.opengoofy.index12306.framework.starter.log.annotation.ILog) || @annotation(org.opengoofy.index12306.framework.starter.log.annotation.ILog)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">printMLog</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ProceedingJoinPoint 表示连接点，可以获取目标方法的参数、方法名等信息</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">MethodSignature</span> methodSignature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取目标方法的签名，包括方法名、参数类型等信息</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>methodSignature<span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取目标方法所在类的 Logger 对象，Logger 对象用于打印日志</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">String</span> beginTime <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            result <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行目标方法</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// 获取目标方法</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token class-name">Method</span> targetMethod <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>methodSignature<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodSignature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token comment">// 获取目标方法上的 @ILog 注解</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token class-name">ILog</span> logAnnotation <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>targetMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ILog</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ILog</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>logAnnotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果目标方法上有 @ILog 注解</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token class-name">ILogPrintDTO</span> logPrint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ILogPrintDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建日志打印参数 DTO</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                logPrint<span class="token punctuation">.</span><span class="token function">setBeginTime</span><span class="token punctuation">(</span>beginTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>logAnnotation<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    logPrint<span class="token punctuation">.</span><span class="token function">setInputParams</span><span class="token punctuation">(</span><span class="token function">buildInput</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置入参</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>logAnnotation<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    logPrint<span class="token punctuation">.</span><span class="token function">setOutputParams</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置出参</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token class-name">String</span> methodType <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> requestURI <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token class-name">ServletRequestAttributes</span> servletRequestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取请求属性</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token keyword">assert</span> servletRequestAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 断言 servletRequestAttributes 不为空</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    methodType <span class="token operator">=</span> servletRequestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取请求方法类型</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    requestURI <span class="token operator">=</span> servletRequestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取请求 URI</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token comment">// 打印日志</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125;, executeTime: &#123;&#125;ms, info: &#123;&#125;"</span><span class="token punctuation">,</span> methodType<span class="token punctuation">,</span> requestURI<span class="token punctuation">,</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>logPrint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token comment">// 如果目标方法上没有 @ILog 注解，不打印日志</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span> <span class="token comment">// 返回目标方法执行结果</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">buildInput</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 构建入参</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> printArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>args<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> <span class="token operator">||</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// 如果参数是 HttpServletRequest 或者 HttpServletResponse，不打印</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                printArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"byte array"</span><span class="token punctuation">;</span> <span class="token comment">// 如果参数是 byte 数组，打印 "byte array"</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">MultipartFile</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                printArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"file"</span><span class="token punctuation">;</span> <span class="token comment">// 如果参数是 MultipartFile，打印 "file"</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                printArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 其他情况，打印参数值</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token keyword">return</span> printArgs<span class="token punctuation">;</span> <span class="token comment">// 返回打印参数</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="日志自动装配类"><a class="anchor" href="#日志自动装配类">#</a> 日志自动装配类</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 日志自动装配类，用于装配 &#123;@link ILog&#125; 日志打印 AOP 切面</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogAutoConfiguration</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * &#123;@link ILog&#125; 日志打印 AOP 切面</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@Bean</span> <span class="token comment">// 将 ILogPrintAspect 注入到 Spring 容器</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ILogPrintAspect</span> <span class="token function">iLogPrintAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ILogPrintAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="接口幂等组件"><a class="anchor" href="#接口幂等组件">#</a> <mark>接口幂等组件</mark></h3><h4 id="幂等问题是什么"><a class="anchor" href="#幂等问题是什么">#</a> 幂等问题是什么</h4><p>幂等性是数学和计算机科学中的概念，用于描述 <font color="red">操作无论执行多少次，都产生相同结果 </font>的特性。在软件行业中，广泛应用该概念。<font color="red">当我们说一个接口支持幂等性时，无论调用多少次，系统的结果都保持一致 </font>。</p><p>一般我们在系统中，幂等可能存在两种类型的问题：</p><ul><li><font color="cornflowerblue">接口幂等 </font>：常说的接口 <font color="red">防重复提交 / 调用 </font>。</li><li><font color="cornflowerblue">消息队列幂等 </font>：如何保障消息队列客户端对相同的消息仅消费一次，<font color="red">防重复消费 </font>。</li></ul><p>如果不做防重复提交或者幂等，可能会导致以下问题：</p><ol><li>数据重复处理：如果用户在某个操作还在处理中时重复提交请求，可能会导致相同的数据被处理多次，造成数据的重复操作和处理逻辑的错误。</li><li>重复写入：在某些场景下，请求可能触发对数据库或其他存储系统的写入操作。如果请求被重复提交，可能会导致相同的数据被重复写入，破坏数据的一致性。</li><li>资源浪费：重复提交请求可能会导致服务器资源的浪费。如果请求处理的时间较长，重复提交会占用服务器的处理能力，增加服务器的负载，降低系统的性能和吞吐量。</li><li>业务逻辑错误：在某些业务场景下，重复提交可能会导致业务逻辑错误。例如，如果用户在生成订单的过程中重复提交订单请求，可能会导致生成多个相同的订单，引发订单的混乱和错误。</li></ol><h5 id="接口防重复提交调用"><a class="anchor" href="#接口防重复提交调用">#</a> 接口防重复提交 / 调用</h5><p>举个例子，你在淘宝上下单某个商品，然后提交订单时由于你快速点击多次，或者网络波动提交服务端多次请求，如果淘宝服务端没有做相关防重复提交处理，那么就有可能生成多笔相同的订单。</p><p>如果做了幂等处理，除了第一次正常请求外，第二次乃至更多次应该返回错误，比如说提示语 “重复提交失败” 等；再或者返回 “提交成功”，但是 <font color="red">真正保存数据库的只有一次请求 </font>。具体使用哪一种需要看程序设计以及产品逻辑。</p><h5 id="消息队列防重复消费"><a class="anchor" href="#消息队列防重复消费">#</a> 消息队列防重复消费</h5><p>消息队列在消息传递过程中，由于网络延迟、系统故障或其他异常情况，可能会导致消息被重复消费的问题。造成消息重复消费的问题比较多，我们就不细分析了，知道有这种场景就好。</p><p>通常情况下，我们认为消息中间件是一个可靠的组件。这里的 <font color="red">可靠性指的是，只要消息被成功投递到了消息中间件，它就不会丢失，至少能够被消费者成功消费一次 </font>。这是消息中间件最基本的特性之一，也就是我们通常所说的 <code>“AT LEAST ONCE”</code> ，即消息至少会被成功消费一遍。</p><p>这也就说明，<font color="red">如果服务端出现了客户端是否消费成功的疑问时，会让客户端再次消费 </font>。</p><p>造成的问题也比较明显，如果订单支付消息被重复消费，可能会导致业务逻辑的错误执行。例如，系统可能会多次发放优惠券、赠品或其他奖励，使得商家承担不必要的成本或资源浪费。</p><h4 id="幂等问题的解决方案"><a class="anchor" href="#幂等问题的解决方案">#</a> 幂等问题的解决方案</h4><p>说幂等底层代码设计前，先把各自问题场景的解决方案说说，主要涵盖分布式锁、Token 令牌以及去重表。</p><p><font color="red">分布式锁和 Token 令牌应用于接口防重复提交，去重表应对于 MQ 防重复消费场景 </font>。</p><h5 id="分布式锁"><a class="anchor" href="#分布式锁">#</a> 分布式锁</h5><p>当用户提交请求时，服务器端可以生成一个唯一的标识，例如使用 UUID。</p><p>在处理用户请求之前，服务器尝试获取一个分布式锁。如果成功获取到分布式锁，那么则执行接下来的正常业务逻辑流程。因为锁已经被获取，这样可以 <font color="red">确保其他请求无法使用相同的标识，避免重复处理 </font>。在请求处理完成后，服务器需要释放分布式锁。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710827996427-d8c9baf6-a15c-4e8a-b8de-be954cc5ba22.png" alt="img"></p><h5 id="token-令牌"><a class="anchor" href="#token-令牌">#</a> Token 令牌</h5><p>为了防止重复操作，<font color="red">客户端在第一次调用业务请求之前会发送一个获取 Token 的请求 </font>。<font color="red">服务端会生成一个全局唯一的 ID 作为 Token，并将其保存在 Redis 中 </font>，同时将该 ID 返回给客户端。</p><p>在客户端进行业务请求时，必须在 header 中携带这个 Token。</p><p>服务端会验证这个 Token，</p><ul><li>如果验证成功，则执行业务逻辑，<font color="red">并从 Redis 中删除该 Token </font>，最后返回执行结果。</li><li>如果验证失败，说明 Redis 中已经没有对应的 Token，表示重复操作，服务端会直接返回指定的结果。</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710828130127-47a6a071-95da-4da6-87c4-5f5183830e50.png" alt="img"></p><h5 id="去重表"><a class="anchor" href="#去重表">#</a> 去重表</h5><blockquote><p>疑问点</p></blockquote><p>去重表是指在使用 Redis 或者 MySQL 作为存储时，为了实现幂等性而用于 <font color="red">记录已经处理过的请求或操作，以防止重复执行 </font>。大部分场景下，大家会 <font color="red">使用 Redis 作为去重组件 </font>实现。</p><p>去重表只是一个说法，存储到 Redis 的话，<font color="red">其实就是一个 String 的 Key 而已 </font>（即 value 类型为 String 的 k-v 结构）。</p><p>具体来说，当客户端发送请求时，服务端会先查询 Redis 去重表来 <font color="red">检查该请求是否已经被处理过 </font>。</p><ul><li>如果在存在对应的记录，表示请求已经执行过，服务端可以直接返回之，而不再执行重复操作。</li><li>如果在不存在对应的记录，表示请求是新的，服务端会执行相应的业务逻辑，<strong><font color="red">并在处理完成后将请求的唯一标识（如请求 ID 或标识）添加到 Redis 去重表中 </font></strong>，以便后续的重复请求可以被正确识别和处理。</li></ul><p>另外，消息的幂等标识状态有 <font color="red">消费中、已消费 </font>两种。如果消息已经在消费中，抛出异常，消息会触发延迟消费，在消息队列消费失败的场景下即发送到重试队列 <code>RETRY TOPIC</code> 。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710828013589-631846f0-1fae-4b31-9bf0-aea084af8d07.png" alt="img"></p><h4 id="幂等组件的设计"><a class="anchor" href="#幂等组件的设计">#</a> 幂等组件的设计</h4><p>上面说了多种解决方案，那我们一起看下幂等组件是怎么实现的吧。既然是组件化设计，自然需要用到 <font color="red">SpringBoot Starter </font>，通过 <font color="red">自动装配 </font>的机制完成整体运行。然后通过 <font color="red">注解 </font>和 <font color="red">AOP </font>的形式进行实现。</p><h5 id="幂等注解"><a class="anchor" href="#幂等注解">#</a> 幂等注解</h5><p>幂等设计可能存在通用的代码，为此，我们可以通过注解形式进行抽象。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等注解</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Documented</span> <span class="token comment">// 生成文档</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Idempotent</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 幂等 Key，只有在 &#123;@link Idempotent#type ()&#125; 为 &#123;@link IdempotentTypeEnum#SPEL&#125; 时生效</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     * 触发幂等失败逻辑时，返回的错误提示信息</pre></td></tr><tr><td data-num="16"></td><td><pre>     */</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"您操作太快，请稍后再试"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     * 幂等方式，包含 &#123;@link IdempotentTypeEnum&#125; 中的 3 种类型：TOKEN、PARAM（默认）、SPEL</pre></td></tr><tr><td data-num="21"></td><td><pre>     * RestAPI 场景下，建议使用 TOKEN 或 PARAM</pre></td></tr><tr><td data-num="22"></td><td><pre>     * MQ 等其他场景下，建议使用 SPEL</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token class-name">IdempotentTypeEnum</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="27"></td><td><pre>     * 幂等场景，包含 &#123;@link IdempotentSceneEnum&#125; 中的 2 种类型：RESTAPI（默认）、MQ</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token class-name">IdempotentSceneEnum</span> <span class="token function">scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">RESTAPI</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="32"></td><td><pre>     * 设置防重令牌 Key 前缀，MQ 幂等去重可选设置</pre></td></tr><tr><td data-num="33"></td><td><pre>     * &#123;@link IdempotentSceneEnum#MQ&#125; and &#123;@link IdempotentTypeEnum#SPEL&#125; 时生效</pre></td></tr><tr><td data-num="34"></td><td><pre>     */</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">uniqueKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre>     * 设置防重令牌 Key 过期时间，单位秒，默认 1 小时，MQ 幂等去重可选设置</pre></td></tr><tr><td data-num="39"></td><td><pre>     * &#123;@link IdempotentSceneEnum#MQ&#125; and &#123;@link IdempotentTypeEnum#SPEL&#125; 时生效</pre></td></tr><tr><td data-num="40"></td><td><pre>     */</pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">long</span> <span class="token function">keyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">3600L</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上文中说到了<strong>三种幂等解决方案，最终全部浓缩到一个注解上</strong>，所以注解上的内容有点多，为此我做了简单梳理，大家可以参考下，下面也会针对重要字段做一个讲解。</p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710828294307-0a5fd82d-7334-4b46-836e-c0cfc40bcedc.png" alt="img"><p>重要的字段有两个， <code>scene</code> 和 <code>type</code> 。先说场景 <code>scene</code> 字段，该字段 <font color="red">代表了是接口的防重复提交还是消息队列的防重复消费 </font>，通过一个枚举类 <code>IdempotentSceneEnum</code> 标识：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>idempotent<span class="token punctuation">.</span>enums</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * 幂等验证场景枚举</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">IdempotentSceneEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 基于 RestAPI 场景验证</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token constant">RESTAPI</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 基于 MQ 场景验证</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token constant">MQ</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后就是 type 字段，记录了 <font color="red">使用什么方式实现幂等 </font>，其中 TOKEN 和 PARAM 以及 SPEL 都可以应用于接口防重复提交，<font color="red">SPEL 应用于消息队列防重复消费 </font>。</p><p>然后从分布式锁、Token 令牌以及去重表实现上来说，有个对应关系：</p><ul><li>分布式锁：PARAM 和 SPEL</li><li>Token 令牌：TOKEN</li><li>去重表：SPEL</li></ul><p>同样地，通过一个枚举类 <code>IdempotentTypeEnum</code> 标识：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>idempotent<span class="token punctuation">.</span>enums</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * 幂等验证类型枚举</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">IdempotentTypeEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 基于 Token 方式验证</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token constant">TOKEN</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 基于方法参数方式验证</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token constant">PARAM</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 基于 SpEL 表达式方式验证</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token constant">SPEL</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="幂等注解的-aop-拦截器"><a class="anchor" href="#幂等注解的-aop-拦截器">#</a> 幂等注解的 AOP 拦截器</h5><p>我们使用 AOP 技术为方法增强提供了通用的幂等性保证，<font color="red">只需要在需要保证幂等性的方法上添加 <code>@Idempotent</code> 注解， <code>IdempotentAspect</code>  类就会对该方法进行环绕增强 </font>。</p><p>简单来说就是：</p><ol><li>先获取到方法上的 <font color="red">幂等注解</font></li><li>然后获取到该注解对应的 <font color="red">幂等处理器的实例 </font>，通过该实例执行【幂等前置逻辑】</li><li>接着执行具体被注解修饰的 <font color="red">目标方法 </font>【业务逻辑】</li><li>最终执行释放资源、清理幂等标识的【后置逻辑】</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等注解 AOP 拦截器，用于对标注了 &#123;@link Idempotent&#125; 注解的目标方法进行环绕通知 / 增强（幂等校验）</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 增强方法（幂等校验）</pre></td></tr><tr><td data-num="9"></td><td><pre>     *</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @Around 注解表示环绕通知，可以在目标方法执行前后织入增强代码</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @annotation 表示匹配目标方法上的 &#123;@link Idempotent&#125; 注解</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@annotation(org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">idempotentHandler</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ProceedingJoinPoint 表示连接点，即目标方法，可以获取其相关信息（参数、返回值等）</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">Idempotent</span> idempotent <span class="token operator">=</span> <span class="token function">getIdempotent</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取目标方法上的 @Idempotent 注解</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">IdempotentExecuteHandler</span> instance <span class="token operator">=</span> <span class="token class-name">IdempotentExecuteHandlerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>idempotent<span class="token punctuation">.</span><span class="token function">scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取幂等执行处理器</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Object</span> resultObj<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> idempotent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行幂等校验（前置处理）</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            resultObj <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行目标方法（即执行业务逻辑），被环绕增强</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">postProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行成功后的后置处理（幂等标识清理）</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RepeatConsumptionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 重复消费异常</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>             * 触发幂等逻辑时可能有两种情况：</pre></td></tr><tr><td data-num="25"></td><td><pre>             *    * 1. 消息还在处理【消费中】，但是不确定是否执行成功，那么需要返回错误，方便 RocketMQ 再次通过重试队列投递</pre></td></tr><tr><td data-num="26"></td><td><pre>             *    * 2. 消息处理成功了【已消费】，该消息直接返回成功即可</pre></td></tr><tr><td data-num="27"></td><td><pre>             */</pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ex<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果为 false，表示消息已消费成功，直接返回</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span> <span class="token comment">// 如果为 true，表示消息还在处理，但是不确定是否执行成功，需要返回错误，方便 RocketMQ 再次通过重试队列投递</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 客户端消费存在异常，需要删除幂等标识，方便下次 RocketMQ 再次通过重试队列投递</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">exceptionProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清理幂等上下文，即幂等参数包装器，包含幂等 key 和目标方法</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">return</span> resultObj<span class="token punctuation">;</span> <span class="token comment">// 返回目标方法执行结果</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="43"></td><td><pre>     * 获取目标方法上的 @Idempotent 注解</pre></td></tr><tr><td data-num="44"></td><td><pre>     *</pre></td></tr><tr><td data-num="45"></td><td><pre>     * @param joinPoint 连接点，即目标方法</pre></td></tr><tr><td data-num="46"></td><td><pre>     * @return 返回目标方法上的 &#123;@link Idempotent&#125; 注解</pre></td></tr><tr><td data-num="47"></td><td><pre>     * @throws NoSuchMethodException 当目标方法不存在时抛出</pre></td></tr><tr><td data-num="48"></td><td><pre>     */</pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Idempotent</span> <span class="token function">getIdempotent</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token class-name">MethodSignature</span> methodSignature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token class-name">Method</span> targetMethod <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>methodSignature<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodSignature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> targetMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Idempotent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="幂等执行处理器工厂"><a class="anchor" href="#幂等执行处理器工厂">#</a> 幂等执行处理器工厂</h6><p>针对不同幂等验证场景以及幂等处理类型拆分为了一个个 <font color="red">策略模式处理器 </font>，帮助我们实现高内聚低耦合。</p><p>可能会有同学有疑问：这里为什么要<strong>采用简单工厂模式</strong>？策略模式不行么？策略模式同样可以达到获取真正幂等处理器功能。但是简单工厂的语意更适合这个场景，所以选择了简单工厂。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等执行处理器工厂</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentExecuteHandlerFactory</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>     * 静态方法：获取幂等执行处理器的实例</pre></td></tr><tr><td data-num="8"></td><td><pre>     *</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @param scene 指定幂等验证场景类型</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @param type  指定幂等处理类型</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @return 幂等执行处理器</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IdempotentExecuteHandler</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">IdempotentSceneEnum</span> scene<span class="token punctuation">,</span> <span class="token class-name">IdempotentTypeEnum</span> type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">IdempotentExecuteHandler</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>scene<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">RESTAPI</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token comment">//// 从 Spring 容器中获取 “接口场景 + PARAM 方式” 的幂等处理器实例</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                    <span class="token keyword">case</span> <span class="token constant">PARAM</span> <span class="token operator">-></span> result <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">IdempotentParamService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                    <span class="token comment">// 从 Spring 容器中获取 “接口场景 + TOKEN 方式” 的幂等处理器实例</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    <span class="token keyword">case</span> <span class="token constant">TOKEN</span> <span class="token operator">-></span> result <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">IdempotentTokenService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                    <span class="token comment">// 从 Spring 容器中获取 “接口场景 + SPEL 方式” 的幂等处理器实例</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token keyword">case</span> <span class="token constant">SPEL</span> <span class="token operator">-></span> result <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">IdempotentSpELByRestAPIExecuteHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    <span class="token keyword">default</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token comment">// 从 Spring 容器中获取 “MQ 场景 + SPEL 方式” 的幂等处理器实例</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">case</span> <span class="token constant">MQ</span> <span class="token operator">-></span> result <span class="token operator">=</span> <span class="token class-name">ApplicationContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">IdempotentSpELByMQExecuteHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">default</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="抽象幂等执行处理器"><a class="anchor" href="#抽象幂等执行处理器">#</a> 抽象幂等执行处理器</h6><p>获取到对应的幂等处理器后，我们就开始处理幂等的真实处理逻辑。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 抽象幂等执行处理器，实现了幂等执行处理器接口，用于提供幂等处理逻辑的模板方法</pre></td></tr><tr><td data-num="3"></td><td><pre> * 实现类只需要实现 &#123;@link #buildWrapper (ProceedingJoinPoint)&#125; 方法和 &#123;@link #handler (IdempotentParamWrapper)&#125; 方法即可</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractIdempotentExecuteHandler</span> <span class="token keyword">implements</span> <span class="token class-name">IdempotentExecuteHandler</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 构建幂等验证过程中所需要的参数包装器</pre></td></tr><tr><td data-num="9"></td><td><pre>     *</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @param joinPoint AOP 方法处理</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @return 幂等参数包装器</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">IdempotentParamWrapper</span> <span class="token function">buildWrapper</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 执行幂等处理逻辑</pre></td></tr><tr><td data-num="17"></td><td><pre>     *</pre></td></tr><tr><td data-num="18"></td><td><pre>     * @param joinPoint  AOP 方法处理</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @param idempotent 幂等注解</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Idempotent</span> idempotent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 模板方法模式：即定义了一个操作中的算法框架，而将一些步骤延迟到子类中</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 子类需要实现：构建幂等参数包装器 buildWrapper，具体的幂等处理逻辑 handler</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">IdempotentParamWrapper</span> idempotentParamWrapper <span class="token operator">=</span> <span class="token function">buildWrapper</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIdempotent</span><span class="token punctuation">(</span>idempotent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">handler</span><span class="token punctuation">(</span>idempotentParamWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>不同的策略实现类都会自定义实现幂等处理逻辑，比如 <code>buildWrapper</code> 方法，<strong>这里使用了模版方法模式进行了一个封装，让具体的实现细节下沉到其 4 个实现类中： <code>IdempotentParamExecuteHandler</code> 、 <code>IdempotentSpELByMQExecuteHandler</code> 、 <code>IdempotentSpELByRestAPIExecuteHandler</code> 、 <code>IdempotentTokenExecuteHandler</code> </strong>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710842171842-334f830e-af44-4ca5-850d-5828932f4fc5.png" alt="img"></p><p>获取到 <code>IdempotentParamWrapper</code> 参数后调用 <code>handler</code> 执行具体幂等逻辑的方法。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710842333993-3725d33a-4e53-4620-87fa-c934e400a8d0.png" alt="img"></p><h6 id="释放幂等资源"><a class="anchor" href="#释放幂等资源">#</a> 释放幂等资源</h6><p>IdempotentAspect 的 idempotentHandler 方法的最后，通过 <code>instance.postProcessing();</code> <font color="red">释放幂等资源，进行分布式锁的解锁 </font>等行为，同样是各个幂等策略实现类自定义，有的需要释放资源，有的不需要。不需要释放的，空实现即可。</p><p>以分布式解锁为参考：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span> <span class="token comment">// 后置处理</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// RLock 表示 Redisson 的分布式锁</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            lock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RLock</span><span class="token punctuation">)</span> <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token constant">LOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取锁</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放锁</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="项目中的例子防重复消费"><a class="anchor" href="#项目中的例子防重复消费">#</a> 项目中的例子：防重复消费</h5><p>接口防重复提交比较简单，大家看看很快就能理解，重点在于消息防重复消费这块，可能有点复杂，这里重点讲解下。</p><p>这张图是关键，整个代码的运行轨迹都是按照图里的逻辑运行的，大家可以先梳理逻辑再看代码。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710828013589-631846f0-1fae-4b31-9bf0-aea084af8d07.png" alt="img"></p><p>我们 <font color="red">以支付结果回调订单消费者举例 </font>，业务很简单，就是用户支付成功，需要进行订单状态反转等逻辑操作。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 支付结果回调订单的消费者</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Component</span> <span class="token comment">// 标记为 Spring Bean，交给 Spring 容器管理</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span> <span class="token comment">// 生成一个包含常量数据的构造函数</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span> <span class="token comment">// 标记为 RocketMQ 消息监听器，监听指定的 Topic 和 Tag</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    topic <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_GLOBAL_TOPIC_KEY</span><span class="token punctuation">,</span> <span class="token comment">// 指定 Topic</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    selectorExpression <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_RESULT_CALLBACK_TAG_KEY</span><span class="token punctuation">,</span> <span class="token comment">// 指定 Tag</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    consumerGroup <span class="token operator">=</span> <span class="token class-name">OrderRocketMQConstant</span><span class="token punctuation">.</span><span class="token constant">PAY_RESULT_CALLBACK_ORDER_CG_KEY</span> <span class="token comment">// 指定消费者组</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayResultCallbackOrderConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageWrapper</span><span class="token punctuation">&lt;</span><span class="token class-name">PayResultCallbackOrderEvent</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span> <span class="token comment">// 幂等校验注解</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        uniqueKeyPrefix <span class="token operator">=</span> <span class="token string">"index12306-order:pay_result_callback:"</span><span class="token punctuation">,</span> <span class="token comment">// 幂等 Key 前缀</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        key <span class="token operator">=</span> <span class="token string">"#message.getKeys()+'_'+#message.hashCode()"</span><span class="token punctuation">,</span> <span class="token comment">// 幂等 Key SpEL 表达式</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        type <span class="token operator">=</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">SPEL</span><span class="token punctuation">,</span> <span class="token comment">// 幂等验证类型：SPEL</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        scene <span class="token operator">=</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">MQ</span><span class="token punctuation">,</span> <span class="token comment">// 幂等验证场景：MQ</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        keyTimeout <span class="token operator">=</span> <span class="token number">7200L</span> <span class="token comment">// 幂等 Key 过期时间：7200 秒，即 2 小时</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 标记为事务方法，出现异常时回滚</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 实现 RocketMQListener 接口的 onMessage 方法，用于处理消息</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PayResultCallbackOrderEvent</span><span class="token punctuation">></span></span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 业务逻辑...</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="spel-表达式"><a class="anchor" href="#spel-表达式">#</a> SpEL 表达式</h6><p>相信很多同学看到 key 里面的那个参数是不清楚是什么的，这个就是 SpEL 表达式，Spring 提供的自然语言表达式。</p><p><code>SpEL（Spring Expression Language，Spring 表达语言）</code> 是 Spring 框架提供的一种表达式语言，用于在运行时评估表达式。<strong>它支持在 Spring 应用程序中进行动态求值和访问对象的属性、方法调用、运算符操作等</strong>。</p><p>SpEL 表达式的语法类似于其他编程语言的表达式语言，具有以下特点：</p><ol><li><font color="red">属性访问 </font>：可以使用点号（.）来访问对象的属性，<span class="exturl" data-url="aHR0cDovL3huLS1wZXJzb24tOXY5aWk0OWQubmFtZQ==">例如 person.name</span>。</li><li><font color="red">方法调用 </font>：可以通过在表达式中使用方法名和参数来调用对象的方法，例如 person.getName ()。</li><li><font color="red">运算符操作 </font>：支持常见的算术运算符（如加减乘除）、逻辑运算符（如与、或、非）和比较运算符（如等于、大于、小于等）。</li><li><font color="red">条件表达式 </font>：支持条件表达式，例如三元运算符 condition ? value1 : value2。</li><li>......</li></ol><p>我们分步骤解析这个 SpEL 表达式最终运行结果是什么？</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>#message<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token char">'_'</span><span class="token operator">+</span>#message<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>共分为三部分：</p><ul><li>通过请求入参 message 对象，获取属性 keys 值</li><li>然后再获取 message 对象的 hashCode 值</li><li>通过 _ 的方式拼接在一起，就 <font color="red">得到了本次请求的唯一幂等 Key，用于标识不同的消息 </font>。</li></ul><h6 id="mq-场景下-spel-方式的幂等处理逻辑"><a class="anchor" href="#mq-场景下-spel-方式的幂等处理逻辑">#</a> MQ 场景下 SpEL 方式的幂等处理逻辑</h6><p>即上文提到的 AbstractIdempotentExecuteHandler 的 4 个实现类中的其中 1 个： <code>IdempotentSpELByMQExecuteHandler</code></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 基于 SpEL 方法验证请求幂等性，适用于 MQ 场景</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentSpELByMQExecuteHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractIdempotentExecuteHandler</span> <span class="token keyword">implements</span> <span class="token class-name">IdempotentSpELService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DistributedCache</span> distributedCache<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">TIMEOUT</span> <span class="token operator">=</span> <span class="token number">600</span><span class="token punctuation">;</span> <span class="token comment">// 幂等标识的过期时间</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">WRAPPER</span> <span class="token operator">=</span> <span class="token string">"wrapper:spEL:MQ"</span><span class="token punctuation">;</span> <span class="token comment">// 幂等参数包装器</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@SneakyThrows</span> <span class="token comment">// @SneakyThrows 注解用于隐藏异常，不会抛出异常，但是会打印异常信息</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">IdempotentParamWrapper</span> <span class="token function">buildWrapper</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 获取目标方法上的 @Idempotent 注解</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">Idempotent</span> idempotent <span class="token operator">=</span> <span class="token class-name">IdempotentAspect</span><span class="token punctuation">.</span><span class="token function">getIdempotent</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 解析 SpEL 表达式，获取幂等 key</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token class-name">SpELUtil</span><span class="token punctuation">.</span><span class="token function">parseKey</span><span class="token punctuation">(</span>idempotent<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IdempotentParamWrapper</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinPoint</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建幂等参数包装器，包含幂等 key 和目标方法</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">IdempotentParamWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 拼接前缀和 SpEL 表达式对应的幂等 key，构建能唯一标识消息的 key</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">String</span> uniqueKey <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getIdempotent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uniqueKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> wrapper<span class="token punctuation">.</span><span class="token function">getLockKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 向 Redis 中添加上述能唯一标识消息的 key（幂等标识），</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 将其 value（幂等标识的状态是个枚举类：分为 CONSUMING 和 CONSUMED）设置为 CONSUMING，表示消费中，</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 同时设置过期时间为 10 分钟，</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 如果 key 不存在，则设置成功，返回 true，否则返回 false</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">Boolean</span> setIfAbsent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">,</span> <span class="token class-name">IdempotentMQConsumeStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CONSUMING</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TIMEOUT</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 如果 value 为 false，表示 key 已存在，此时有两种情况：</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 1. value 为 CONSUMING，表示消息还在处理，但是不确定是否执行成功，那么需要向上抛出 RepeatConsumptionException 异常，方便 RocketMQ 再次通过重试队列（Retry Topic）投递；</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 2. value 为 CONSUMED，表示消息处理成功了，该消息直接返回成功即可</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 因此，还需要判断 value 的值</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>setIfAbsent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token comment">// 获取 key 对应的 value（幂等标识的状态）</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token class-name">String</span> consumeStatus <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token comment">// 判断 value 的值是否为 CONSUMING</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token keyword">boolean</span> error <span class="token operator">=</span> <span class="token class-name">IdempotentMQConsumeStatusEnum</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span>consumeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token comment">// 记录日志：</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token comment">//- 如果 value 的值为 CONSUMING，表示消息还在处理，但是不确定是否执行成功，那么需要返回错误，方便 RocketMQ 再次通过重试队列投递；</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token comment">//- 如果 value 的值为 CONSUMED，表示消息处理成功了，该消息直接返回成功即可</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getJoinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] MQ repeated consumption, &#123;&#125;."</span><span class="token punctuation">,</span> uniqueKey<span class="token punctuation">,</span> error <span class="token operator">?</span> <span class="token string">"Wait for the client to delay consumption"</span> <span class="token operator">:</span> <span class="token string">"Status is completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token comment">// 抛出重复消费异常到上层，上层根据 error 的值判断是否需要重试</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RepeatConsumptionException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// 如果 value 为 true，表示 key 不存在，设置成功，此时将幂等参数包装器放入上下文中</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">WRAPPER</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 异常处理：删除幂等标识，方便下次 RocketMQ 再次通过重试队列投递</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token class-name">IdempotentParamWrapper</span> wrapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IdempotentParamWrapper</span><span class="token punctuation">)</span> <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token constant">WRAPPER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token class-name">Idempotent</span> idempotent <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getIdempotent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token class-name">String</span> uniqueKey <span class="token operator">=</span> idempotent<span class="token punctuation">.</span><span class="token function">uniqueKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> wrapper<span class="token punctuation">.</span><span class="token function">getLockKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                distributedCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据幂等 key 删除幂等标识</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getJoinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] Failed to del MQ anti-heavy token."</span><span class="token punctuation">,</span> uniqueKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 后置处理：设置幂等 key 的 value 为 CONSUMED，表示已消费，防止消息重复消费。同时设置过期时间，避免幂等 key 永久存在。</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token comment">// 从上下文中获取幂等参数包装器</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token class-name">IdempotentParamWrapper</span> wrapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IdempotentParamWrapper</span><span class="token punctuation">)</span> <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token constant">WRAPPER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token class-name">Idempotent</span> idempotent <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getIdempotent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token class-name">String</span> uniqueKey <span class="token operator">=</span> idempotent<span class="token punctuation">.</span><span class="token function">uniqueKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> wrapper<span class="token punctuation">.</span><span class="token function">getLockKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取幂等 key</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                <span class="token comment">// 设置幂等标识为已消费</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                distributedCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">,</span> <span class="token class-name">IdempotentMQConsumeStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CONSUMED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">keyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token comment">// 如果设置失败，记录日志</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getJoinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] Failed to set MQ anti-heavy token."</span><span class="token punctuation">,</span> uniqueKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中， <code>IdempotentMQConsumeStatusEnum</code> 是幂等 MQ 消费状态的枚举类：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等 MQ 消费状态枚举，用于标识消息是否已经被消费，包括消费中、已消费</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">IdempotentMQConsumeStatusEnum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 消费中</pre></td></tr><tr><td data-num="9"></td><td><pre>     */</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">CONSUMING</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre>     * 已消费</pre></td></tr><tr><td data-num="14"></td><td><pre>     */</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">CONSUMED</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Getter</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * 如果消费状态等于消费中，返回失败</pre></td></tr><tr><td data-num="22"></td><td><pre>     *</pre></td></tr><tr><td data-num="23"></td><td><pre>     * @param consumeStatus 消费状态</pre></td></tr><tr><td data-num="24"></td><td><pre>     * @return 是否消费失败</pre></td></tr><tr><td data-num="25"></td><td><pre>     */</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isError</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumeStatus<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">CONSUMING</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> consumeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个 <code>RepeatConsumptionException</code> 异常很关键，决定了是<strong>抛出异常让 RocketMQ 重试</strong>，还是将该消息吞掉，不执行具体的消费流程。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等注解 AOP 拦截器，用于对标注了 &#123;@link Idempotent&#125; 注解的目标方法进行环绕通知 / 增强（幂等校验）</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Aspect</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentAspect</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 增强方法（幂等校验）</pre></td></tr><tr><td data-num="9"></td><td><pre>     *</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @Around 注解表示环绕通知，可以在目标方法执行前后织入增强代码</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @annotation 表示匹配目标方法上的 &#123;@link Idempotent&#125; 注解</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@annotation(org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">idempotentHandler</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ProceedingJoinPoint 表示连接点，即目标方法，可以获取其相关信息（参数、返回值等）</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">Idempotent</span> idempotent <span class="token operator">=</span> <span class="token function">getIdempotent</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取目标方法上的 @Idempotent 注解</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">IdempotentExecuteHandler</span> instance <span class="token operator">=</span> <span class="token class-name">IdempotentExecuteHandlerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>idempotent<span class="token punctuation">.</span><span class="token function">scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取幂等执行处理器</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Object</span> resultObj<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> idempotent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行幂等校验（前置处理）</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            resultObj <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行目标方法（即执行业务逻辑），被环绕增强</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">postProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行成功后的后置处理（幂等标识清理）</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RepeatConsumptionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 重复消费异常</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>             * 触发幂等逻辑时可能有两种情况：</pre></td></tr><tr><td data-num="25"></td><td><pre>             *    * 1. 消息还在处理【消费中】，但是不确定是否执行成功，那么需要返回错误，方便 RocketMQ 再次通过重试队列投递</pre></td></tr><tr><td data-num="26"></td><td><pre>             *    * 2. 消息处理成功了【已消费】，该消息直接返回成功即可</pre></td></tr><tr><td data-num="27"></td><td><pre>             */</pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ex<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果为 false，表示消息已消费成功，直接返回</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span> <span class="token comment">// 如果为 true，表示消息还在处理，但是不确定是否执行成功，需要返回错误，方便 RocketMQ 再次通过重试队列投递</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 客户端消费存在异常，需要删除幂等标识，方便下次 RocketMQ 再次通过重试队列投递</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            instance<span class="token punctuation">.</span><span class="token function">exceptionProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清理幂等上下文，即幂等参数包装器，包含幂等 key 和目标方法</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">return</span> resultObj<span class="token punctuation">;</span> <span class="token comment">// 返回目标方法执行结果</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="43"></td><td><pre>     * 获取目标方法上的 @Idempotent 注解</pre></td></tr><tr><td data-num="44"></td><td><pre>     *</pre></td></tr><tr><td data-num="45"></td><td><pre>     * @param joinPoint 连接点，即目标方法</pre></td></tr><tr><td data-num="46"></td><td><pre>     * @return 返回目标方法上的 &#123;@link Idempotent&#125; 注解</pre></td></tr><tr><td data-num="47"></td><td><pre>     * @throws NoSuchMethodException 当目标方法不存在时抛出</pre></td></tr><tr><td data-num="48"></td><td><pre>     */</pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Idempotent</span> <span class="token function">getIdempotent</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token class-name">MethodSignature</span> methodSignature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token class-name">Method</span> targetMethod <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>methodSignature<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodSignature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> targetMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Idempotent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过捕获 <code>RepeatConsumptionException</code> 异常，获取里面 error 变量，判断标识状态是否为 CONSUMING：</p><ul><li>如果 error 为 true，代表需要抛异常让 RocketMQ 重试。</li><li>如果 error 为 false，代表消息已经消费过了，不执行业务逻辑，将异常吞掉返回 RocketMQ 消费成功即可。</li></ul><h6 id="能保障永久幂等吗"><a class="anchor" href="#能保障永久幂等吗">#</a> 能保障永久幂等吗？</h6><p>不能保障永久幂等，因为 Redis 内存资源比较珍贵，<font color="red">如果长时间保存幂等 Key，会造成 Redis 内存占用增加 </font>。</p><p>业务需要评估自己的消息队列消费情况，<font color="red">如果队列消费量级很高，keyTimeout 不能设置过长时间 </font>。设置 keyTimeout 时间过长，这意味着幂等 Key 将会长时间占用 Redis 内存。</p><h6 id="设置状态为已完成"><a class="anchor" href="#设置状态为已完成">#</a> 设置状态为已完成</h6><p>如果获取到了幂等标识，然后正常业务逻辑也执行成功了，会调用 <code>instance.postProcessing();</code> 将幂等标识的完成状态设置为已完成。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710852804272-128110d2-145d-4b6f-9ca7-36d85c175e38.png" alt="img"></p><p>获取唯一标识幂等 Key，并设置幂等 Key 的状态为已完成，流程结束。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span> <span class="token comment">// 后置处理：设置幂等 key 的 value 为 CONSUMED，表示已消费，防止消息重复消费。同时设置过期时间，避免幂等 key 永久存在。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 从上下文中获取幂等参数包装器</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">IdempotentParamWrapper</span> wrapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IdempotentParamWrapper</span><span class="token punctuation">)</span> <span class="token class-name">IdempotentContext</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token constant">WRAPPER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">Idempotent</span> idempotent <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getIdempotent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">String</span> uniqueKey <span class="token operator">=</span> idempotent<span class="token punctuation">.</span><span class="token function">uniqueKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> wrapper<span class="token punctuation">.</span><span class="token function">getLockKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取幂等 key</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token comment">// 设置幂等标识为已消费</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            distributedCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">,</span> <span class="token class-name">IdempotentMQConsumeStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CONSUMED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">keyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">// 如果设置失败，记录日志</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getJoinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] Failed to set MQ anti-heavy token."</span><span class="token punctuation">,</span> uniqueKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="qa"><a class="anchor" href="#qa">#</a> Q&amp;A</h4><p>问题：为什么要使用 <code>IdempotentContext</code> ？幂等组件中把一部分内容放到幂等上下文类，并在不同方法中进行使用，为什么这么使用？</p><p><font color="red">因为如果不这么用，会有大量的参数需要在方法传参中声明以及传递 </font>，使用上下文形式可以很好规避该问题，编码较为优雅。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 幂等上下文，用于存储幂等参数包装器，包含幂等 key 和目标方法</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentContext</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 使用 ThreadLocal 存储上下文信息，保证线程安全</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token constant">CONTEXT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  </pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">Object</span> actual <span class="token operator">=</span> <span class="token function">getKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>actual <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">return</span> actual<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  </pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            context <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token function">putContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  </pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">putContext</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> threadContext <span class="token operator">=</span> <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>threadContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            threadContext<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  </pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token constant">CONTEXT</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="消息队列幂等组件"><a class="anchor" href="#消息队列幂等组件">#</a> 消息队列幂等组件</h3><blockquote><p>相关技术文档：<a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E5%A6%82%E4%BD%95%E5%80%9F%E5%8A%A9%E5%B9%82%E7%AD%89%E6%A0%A1%E9%AA%8C%E6%9D%A5%E8%A7%A3%E5%86%B3%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98">消息队列中如何借助幂等校验来解决重复消费问题</a>，但其实<a href="#%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6">上节内容</a>更加干货</p></blockquote><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-idempotent-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：实现消息队列 RocketMQ、Kafka、ActiveMQ、RabbitMQ 等客户端 <font color="red">消费幂等，避免重复消费 </font>。</p><p>组件的使用方式如下，<strong>仅在消息队列的消费端添加注解即可</strong>。目前仅支持 <code>SpEL</code> 方式进行 <font color="red">定义幂等唯一 Key </font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    uniqueKeyPrefix <span class="token operator">=</span> <span class="token string">"index12306-order:refund_result_callback:"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    key <span class="token operator">=</span> <span class="token string">"#message.getKeys()+'_'+#message.hashCode()"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    type <span class="token operator">=</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">SPEL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    scene <span class="token operator">=</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">MQ</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    keyTimeout <span class="token operator">=</span> <span class="token number">7200L</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundResultCallbackOrderEvent</span><span class="token punctuation">></span></span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 业务逻辑处理...</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="web-组件"><a class="anchor" href="#web-组件">#</a> Web 组件</h3><blockquote><p>相关技术文档：<a href="#%E5%A6%82%E4%BD%95%E5%85%A8%E5%B1%80%E6%8B%A6%E6%88%AA%E5%BC%82%E5%B8%B8">如何全局拦截异常</a></p></blockquote><p>组件地址：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-web-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>组件概述：</p><ol><li>定义全局异常处理器</li><li>全局返回对象构造器</li><li>项目启动后初始化调用 HTTP 请求，增加第一次访问速度</li></ol><h4 id="全局异常处理器"><a class="anchor" href="#全局异常处理器">#</a> 全局异常处理器</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 全局异常处理器</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Slf4j</span> <span class="token comment">// 使用 lombok 的日志注解</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@RestControllerAdvice</span> <span class="token comment">// 使用 Spring 的全局异常处理注解，作用是拦截所有 Controller 层抛出的异常</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionHandler</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 拦截参数验证异常</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@SneakyThrows</span> <span class="token comment">// 将异常转换为运行时异常</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MethodArgumentNotValidException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// @ExceptionHandler 注解用于指定拦截的异常类型</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">validExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">MethodArgumentNotValidException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">BindingResult</span> bindingResult <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getBindingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取异常中的 BindingResult 对象，它包含了验证失败的信息</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">FieldError</span> firstFieldError <span class="token operator">=</span> <span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span>bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取第一个验证失败的信息</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">String</span> exceptionStr <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>firstFieldError<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getDefaultMessage</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取验证失败的信息，如果没有则返回空字符串</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> exceptionStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录异常日志</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">CLIENT_ERROR</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exceptionStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回验证失败的信息</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre>     * 拦截应用内抛出的异常</pre></td></tr><tr><td data-num="27"></td><td><pre>     */</pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">AbstractException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// 拦截 AbstractException 及其子类的异常</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">abstractException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">AbstractException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果异常的根因不为空，则记录根因</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回异常信息</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="39"></td><td><pre>     * 拦截未捕获异常</pre></td></tr><tr><td data-num="40"></td><td><pre>     */</pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">Throwable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 拦截所有未捕获的异常</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">defaultErrorHandler</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; "</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="48"></td><td><pre>     * 获取请求的 URL</pre></td></tr><tr><td data-num="49"></td><td><pre>     */</pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果请求的查询字符串为空，则返回 URL</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"?"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 否则，返回 URL 和查询字符串</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="全局响应对象构造器"><a class="anchor" href="#全局响应对象构造器">#</a> 全局响应对象构造器</h4><p>配合规约组件中的全局响应对象 <code>Result</code> 使用， <code>Results</code> 提供 Result 的快捷构建：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 全局响应对象的构造器</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Results</span> <span class="token punctuation">&#123;</span> <span class="token comment">//final 类，不可被继承，因为该类中的方法都是静态方法</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 构造成功响应</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token constant">SUCCESS_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 构造带返回数据的成功响应</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token constant">SUCCESS_CODE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre>     * 构建服务端失败响应</pre></td></tr><tr><td data-num="27"></td><td><pre>     */</pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>     * 通过 &#123;@link AbstractException&#125; 构建失败响应</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">AbstractException</span> abstractException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">String</span> errorCode <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>abstractException<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">String</span> errorMessage <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>abstractException<span class="token punctuation">.</span><span class="token function">getErrorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">BaseErrorCode</span><span class="token punctuation">.</span><span class="token constant">SERVICE_ERROR</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="48"></td><td><pre>     * 通过 errorCode、errorMessage 构建失败响应</pre></td></tr><tr><td data-num="49"></td><td><pre>     */</pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="优化项目初次调用响应"><a class="anchor" href="#优化项目初次调用响应">#</a> 优化项目初次调用响应</h4><p>不知道大家有没有注意过，<font color="red">SpringBoot 第一次的调用接口响应速度，相比对之后显得格外的慢 </font>。</p><p>为此，我在 Web 中定义了 **<font color="red">伪 Controller 接口 </font>**，并 <font color="red">在项目启动后进行自己调用自己 </font>。极大优化了第一次调用的接口性能响应。</p><ol><li><p>定义伪 Controller 接口，方便自己调用自己：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 初始化 &#123;@link org.springframework.web.servlet.DispatcherServlet&#125;</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Slf4j</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">"Initialize DispatcherServlet"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InitializeDispatcherServletController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token constant">INITIALIZE_PATH</span><span class="token punctuation">)</span> <span class="token comment">// 通过 GET 请求初始化 DispatcherServlet</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initializeDispatcherServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Initialized the dispatcherServlet to improve the first response time of the interface..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>继承 CommandLineRunner 接口，在项目启动后进行自调用:</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 通过 &#123;@link InitializeDispatcherServletController&#125; 初始化 &#123;@link DispatcherServlet&#125;</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InitializeDispatcherServletHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span> <span class="token comment">// 使用 RestTemplate 发送 HTTP 请求</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConfigurableEnvironment</span> configurableEnvironment<span class="token punctuation">;</span> <span class="token comment">// 可配置的环境</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Override</span> <span class="token comment">// 在应用启动后执行</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:%s%s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                configurableEnvironment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">,</span> <span class="token string">"8080"</span><span class="token punctuation">)</span> <span class="token operator">+</span> configurableEnvironment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.servlet.context-path"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token constant">INITIALIZE_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化 DispatcherServlet 的 URL</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">// 发送 GET 请求初始化 DispatcherServlet</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            restTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ol><h2 id="核心业务实现"><a class="anchor" href="#核心业务实现">#</a> 核心业务实现</h2><p>在实现核心业务之前，建议大家回顾一下项目基础教学中的<a href="#%E6%A2%B3%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%85%B3%E7%B3%BB">梳理数据库表关系</a>，回顾一下数据库表的结构与关系。</p><h3 id="如何发起一笔支付"><a class="anchor" href="#如何发起一笔支付">#</a> 如何发起一笔支付</h3><p>前提条件是保证网关和相关后端服务启动成功。</p><h4 id="支付流程"><a class="anchor" href="#支付流程">#</a> 支付流程</h4><h5 id="用户发起支付"><a class="anchor" href="#用户发起支付">#</a> 用户发起支付</h5><p>当用户抢到票后，开始发起订单支付请求，假设选择支付宝作为支付方式，支付流程如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690721916429-44b0f4ef-b32e-49ce-a21f-f0e1e9cce04b.jpeg" alt="img"></p><h5 id="支付结果回调"><a class="anchor" href="#支付结果回调">#</a> 支付结果回调</h5><p>当用户支付完一笔订单，支付宝付款渠道接收到支付结果后，对请求支付的系统进行支付结果回调，参考上图红色字体流程。</p><h4 id="支付配置"><a class="anchor" href="#支付配置">#</a> 支付配置</h4><h5 id="内网穿透"><a class="anchor" href="#内网穿透">#</a> 内网穿透</h5><p><font color="red">支付宝回调的地址一定要是在公网可以访问到的 </font>。试想下，如果我们提供本地地址，支付宝肯定是访问不到的。</p><p>最好的方式就是部署到公网可访问的云服务器上。<font color="red">但是为了本地联调方便，我们可以<strong>把本地的开发环境网络配置成公网可访问</strong>，这就需要用到内网穿透技术 </font>。</p><p>比较常用的有 <code>Natapp</code> 工具，接下来我们需要通过 Natapp 开通内网穿透，开通教程详细查看下述官方文档：<span class="exturl" data-url="aHR0cHM6Ly9uYXRhcHAuY24vYXJ0aWNsZS9uYXRhcHBfbmV3Ymll">https://natapp.cn/article/natapp_newbie</span></p><p>开通后，<font color="red">将内网穿透端口改为 9000，即 gateway-service 端口 </font>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690722492645-d162ded6-7254-4f1a-bac1-a4dac8272ed2.png" alt="img"></p><h5 id="替换支付回调地址"><a class="anchor" href="#替换支付回调地址">#</a> 替换支付回调地址</h5><p>按照 Natapp 教程，本地启动客户端，我这里展示下 Mac 系统的启动结果。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690722556445-53076dd4-850c-461d-b5ad-af829059766f.png" alt="img"></p><p><code>http://3mb4zt.natappfree.cc</code> 也就是我启动的内网穿透地址，访问这个地址会被请求到我们的 <code>127.0.0.1:9000</code> 服务端口上。</p><p>注意，这个内网穿透地址并不是固定，当你电脑锁屏再打开后它自己也是会变，或者你退出再启动也会变。</p><p><font color="red">将 Natapp 内网穿透地址替换 <code>application.properties</code> 文件下 <code>pay.alipay.notify-url</code> 属性 </font>。</p><ul><li><p>如果你是启动的 SpringBoot 单体版就修改 <code>aggregation-service</code> 服务下 <code>application.properties</code> 文件</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1696565289960-0f64908f-1967-4d2a-b84f-93c7dd215d06.png" alt="img"></p></li><li><p>反之，修改 <code>pay-service</code> 服务下的配置文件</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240325111105330.png" alt="image-20240325111105330"></p></li></ul><h4 id="发起支付"><a class="anchor" href="#发起支付">#</a> 发起支付</h4><h5 id="选择列车购票"><a class="anchor" href="#选择列车购票">#</a> 选择列车购票</h5><p>选择 G35 列车进行用户购票操作。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1711071283676-a6b6ea4c-5c2a-461f-bee1-eae77ff4f341.png" alt="img"></p><h5 id="提交订单"><a class="anchor" href="#提交订单">#</a> 提交订单</h5><p>选择乘车人，选择席别后提交订单。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1711071283997-8d0b5181-a5fd-4ae1-afc0-9bd685cc5155.png" alt="img"></p><p>根据乘车人选择好席别后，点击确认进行订单。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1711071283484-126758b9-9f49-46d3-be4f-6c3d1bdf80c6.png" alt="img"></p><h5 id="支付宝付款"><a class="anchor" href="#支付宝付款">#</a> 支付宝付款</h5><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1711071283571-4bf78f1e-eeaa-4bdd-afbf-70164266c49a.png" alt="img"></p><p>当前只对接了支付宝的沙箱环境，所以选择支付宝进行支付。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1696567081650-13e6d78f-da56-4705-b178-d3d493f4286c.png" alt="img"></p><p>账户名：ahlbks5547@sandbox.com</p><p>密码：111111</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690723185209-c1a11067-4ff0-47ac-b77b-31a179b977c6.png" alt="img"></p><p>如果让输入支付宝密码，输入 111111，点击确认付款按钮。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690723265409-9fc3819d-413f-4fac-89c6-34ba30aae7b8.png" alt="img"></p><h5 id="支付回调"><a class="anchor" href="#支付回调">#</a> 支付回调</h5><p>当支付宝请求付款成功后，会返回成功付款请求结果。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1711071283432-4ba78d37-cf4f-4703-b001-533c595753cb.png" alt="img"></p><p>当返回支付成功结果后，咱们支付服务回调接口也会接到对应的支付宝回调请求。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1711071284725-e5ae40b7-5727-4865-9389-3f142b288353.png" alt="img"></p><p>跳过 Debug 模式后，查看数据库支付表和订单表的记录状态，都会进行相应变更，也意味着一笔订单购票全流程顺利结束。</p><h3 id="车票搜索为什么用-redis-而不是-es"><a class="anchor" href="#车票搜索为什么用-redis-而不是-es">#</a> 车票搜索为什么用 Redis 而不是 ES ？</h3><blockquote><p>[Elasticsearch 常见面试题总结](<span class="exturl" data-url="aHR0cHM6Ly9mYW50ZWRvbmcudG9wL2RhdGFiYXNlL2VsYXN0aWNzZWFyY2gvRWxhc3RpY3NlYXJjaA==">https://fantedong.top/database/elasticsearch/Elasticsearch</span> 常见面试题总结 /)</p></blockquote><p>在文章正式开始前，大家打开 <a href="12306.cn">12306.cn</a> 搜索一趟列车，根据搜索条件判断，数据搜索技术使用 ElasticSearch 或者其它搜索技术是否合适？这里我先把答案说下，<strong>12306 车票搜索用的是 Redis</strong> ，而不是大家常用的 ElasticSearch。至于为什么？大家可以先思考下再继续阅读。</p><h4 id="12306-列车搜索条件"><a class="anchor" href="#12306-列车搜索条件">#</a> 12306 列车搜索条件</h4><p>先来一张 12306 列车检索的截图，让大家看下 12306 都有哪些搜索条件。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1693623205985-e3cadb1e-8389-4723-8d8c-7ee536b572cb.png" alt="img"></p><p>搜索条件如下：</p><ul><li>单程或者往返</li><li>出发地</li><li>目的地</li><li>出发日或者返程日</li><li>普通或者学生</li><li>车次类型</li><li>出发车站</li><li>到达车站</li><li>车次席别</li><li>发车时间</li><li>显示积分兑换车次</li><li>显示全部可预订车次</li></ul><p>许多同学都感到疑惑，因为搜索条件实在太多了，这似乎会严重影响数据库的性能。有些人甚至认为，如果性能不佳，至少应该使用 Elasticsearch 等搜索引擎来处理。这也是我一开始的想法，与大多数同学一致。</p><p>然而，随着进一步的思考，我发现了 <font color="red">一个有意思的页面交互 </font>，这改变了我的看法。跟着马哥的思路，一起来深入探讨一下。</p><h4 id="数据搜索框架"><a class="anchor" href="#数据搜索框架">#</a> 数据搜索框架</h4><h5 id="搜索中间件-elasticsearch"><a class="anchor" href="#搜索中间件-elasticsearch">#</a> 搜索中间件 ElasticSearch</h5><p><code>ElasticSearch</code> 是一款非常强大的、基于 Lucene 的开源搜索及分析引擎；它是 <font color="red">一个近实时的分布式搜索、分析引擎 </font>，它能让你以前所未有的速度和规模，去探索你的数据。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1693624033223-b9b47891-0ce7-4f59-8d07-528d1eae54a7.png" alt="img"></p><p>Elasticsearch 提供了一个强大而灵活的搜索和分析引擎，适用于各种应用场景，包括日志分析、电子商务搜索、实时监控等。<font color="red">它具有高性能、可扩展性和可用性，能够处理大规模数据，并提供丰富的搜索、分析和可视化功能，帮助用户从数据中获取有价值的信息 </font>。</p><p>根据大家对 Elasticsearch 的了解，以及对 12306 复杂搜索条件的背景，肯定是 Elasticsearch 更适合实现数据检索的功能。不急，咱们继续往下看。</p><h5 id="缓存中间件-redis"><a class="anchor" href="#缓存中间件-redis">#</a> 缓存中间件 Redis</h5><p><code>Redis</code> （Remote Dictionary Server，远程词典服务器）是一个开源的 <font color="red">内存数据结构存储系统 </font>，被广泛应用于 <font color="red">缓存、消息队列、实时数据分析、排行榜等场景 </font>。它提供了以下主要功能：</p><ol><li><strong>内存缓存</strong>：Redis 将数据存储在内存中，以实现高速的读写操作。作为缓存系统，它可以显著提升应用程序的性能，减少对后端存储系统的访问压力。</li><li><strong>键值存储</strong>：Redis 是一个键值存储系统，其中的数据是以键值对的形式进行存储和访问。这使得 Redis 非常适合存储简单的数据结构，如 <font color="red">字符串、哈希表、列表、集合和有序集合 </font>。</li><li><strong>发布 / 订阅</strong>：Redis 支持发布 / 订阅模式，允许多个客户端通过订阅频道来接收消息，同时可以通过发布消息来向订阅者广播消息。这使得 Redis 可以用作消息队列、实时通知等场景。</li><li><strong>数据持久化</strong>：Redis 支持将内存中的数据持久化到硬盘中，以便在重启后恢复数据。它提供了两种持久化方式： <code>RDB</code> （Redis Database）快照和 <code>AOF</code> （Append-Only File）日志。</li><li><strong>分布式</strong>：Redis 提供了一些分布式特性，如 <font color="red">主从复制、集群 </font>等。主从复制可以实现数据的热备份和读写分离，在主节点写入数据后，数据会自动同步到从节点。集群模式可以将数据分布在多个节点上，提供更高的容量和吞吐量。</li><li><strong>事务支持</strong>：Redis 支持事务操作，可以将一系列操作组合成一个原子操作进行提交。通过事务，可以确保多个操作在执行过程中不会被其他客户端中断。</li><li><strong>Lua 脚本</strong>：Redis 支持使用 Lua 脚本执行复杂的操作。通过编写脚本，可以减少与 Redis 之间的网络通信次数，提高性能。</li></ol><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1693624946843-faccbbe9-7202-4105-83a9-fc3f56190baf.png" alt="img"></p><p>大家对 Redis 熟知的一些概念就是 Redis 非常快，那快是如何体现以及原理是什么？也就是经典老题：<strong>Redis 为什么这么快？</strong></p><ol><li><strong>数据存储在内存中</strong>：Redis 将数据存储在内存中，而 <font color="red">内存的随机访问速度远远快于磁盘 </font>，这使得数据的读取和写入非常快。</li><li><strong>单线程模型</strong>：Redis 采用单线程模型，这意味着 <font color="red">在任何给定时刻只有一个线程处理请求 </font>。尽管它是单线程的，但通过使用 <font color="red">非阻塞 I/O </font>和 <font color="red">事件循环 </font>，它能够处理大量并发请求而不需要消耗大量的 CPU 开销。这减少了上下文切换和锁竞争，提高了性能。</li><li><strong>优化的数据结构</strong>：Redis 支持多种数据结构，如字符串、哈希表、列表、集合、有序集合等，每种数据结构都经过高度优化，以提供高性能的操作。例如， Redis 的 <font color="red">有序集合允许你快速进行范围查询和排名操作 </font>。</li><li><strong>优化的网络协议</strong>：Redis 使用高度优化的协议进行与客户端的通信，如 <code>RESP</code> （REdis Serialization Protocol）。这个协议 <font color="red">非常轻量，减少了网络通信的开销 </font>，从而提高了性能。</li></ol><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/why-redis-so-fast-E21l9uI2.png" alt="why-redis-so-fast"></p><h4 id="为什么使用-redis"><a class="anchor" href="#为什么使用-redis">#</a> 为什么使用 Redis？</h4><p>考虑使用 Redis 和 Elasticsearch 两个技术都是有一定道理的，它们分别有自己的优势和适用场景。</p><p>作为承受请求最多的列车搜索功能，需要同时兼容实时性、并发性以及部署成本几大要点。为此，我梳理了为什么必须用 Redis 的几个原因。</p><h5 id="实时性能"><a class="anchor" href="#实时性能">#</a> 实时性能</h5><ul><li><strong>内存存储</strong>：Redis 将数据存储在内存中，因此具有极低的读取延迟，<font color="red">可以快速响应实时查询请求 </font>。这对于需要即时更新的列车数据非常重要。</li><li><strong>单线程模型</strong>：Redis 使用单线程模型，虽然是单线程的，但通过 <font color="red">非阻塞 I/O </font>和 <font color="red">事件循环 </font>，它可以处理大量并发请求，减少了上下文切换和锁竞争，提高了实时性。</li></ul><h5 id="并发性能"><a class="anchor" href="#并发性能">#</a> 并发性能</h5><ul><li><strong>多客户端支持</strong>：Redis 支持多个客户端并发连接，<font color="red">每个客户端可以独立地执行读取和写入操作 </font>，这使得它在处理高并发请求时表现出色。</li><li><strong>原子性操作</strong>：Redis 提供了原子性操作，如 <font color="red">原子增减和原子加锁 </font>，这些操作可以在多线程或多进程环境下安全使用，有助于处理并发操作。</li></ul><h5 id="部署成本"><a class="anchor" href="#部署成本">#</a> 部署成本</h5><ul><li><strong>轻量级</strong>：Redis 是一款轻量级的数据库，易于部署和维护。它的内存占用相对较低，可以在相对较小的硬件配置上运行，从而减少了部署成本。</li><li><strong>容易扩展</strong>：Redis 集群模式允许你将数据分布在多个节点上，以增加吞吐量和可伸缩性，而且这一扩展性是相对容易实现的。</li></ul><p>公司实际用过 ES 集群的同学应该知道，<strong><font color="red">ES 就是个性能深渊，非常消耗资源 </font></strong>，懂得都懂。</p><h5 id="搜索条件拆解"><a class="anchor" href="#搜索条件拆解">#</a> 搜索条件拆解</h5><p>到这里，许多人可能会有疑问，面对如此多的搜索条件，难道不应该使用 Elasticsearch 吗？然而，这正是要强调为什么选择 Redis 的关键原因。</p><p>您是否注意到了这张图的一个关键点？它<strong>只允许选择一天的出发日期</strong>。深思熟虑一下。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1693623205985-e3cadb1e-8389-4723-8d8c-7ee536b572cb.png" alt="img"></p><p>如果只能选择一天，那我们是不是可以这么来设计 Redis 缓存存储 12306 列车查询数据。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710990785809-5443c6a8-d7a7-49ee-9a28-f684d365f9b1.jpeg" alt="img"></p><p>也许有些人会问，这么多的查询条件怎么处理呢？你可以亲自在 12306 网站上尝试，<font color="red">虽然页面上有很多查询条件，但大多数条件都是由前端进行筛选，实际上并没有触发后端的请求 </font>。</p><p>如果你不相信的话，可以观看下面的视频，你会发现只有在点击 “查询” 按钮时才会真正触发后端的请求，而点击页面上的其他筛选条件并不会向后端发出请求。</p><h4 id="小结-12"><a class="anchor" href="#小结-12">#</a> 小结</h4><p>12306 列车数据搜索具有多个搜索条件，包括单程 / 往返、出发地、目的地、出发日期 / 返程日期、乘客类型、车次类型、出发车站、到达车站、车次席别、发车时间、显示积分兑换车次以及显示全部可预订车次等。这些条件使搜索功能变得复杂，但在实际使用中，大部分条件是前端筛选，而不是每个条件都会发起后端请求。</p><p>在这种情况下，Redis 作为列车数据的缓存存储是有道理的，原因如下：</p><ol><li><strong>实时性</strong>：Redis 以内存为基础，具有极低的读取延迟，可以快速响应实时查询请求，这对于需要即时更新的列车数据非常重要。单程或往返、出发日期等条件可以通过快速的 Redis 查询来满足。</li><li><strong>缓存</strong>：Redis 是一个出色的缓存数据库，<font color="red">可以用于缓存热门的列车路线和查询结果 </font>，从而减轻后端数据库的负载。对于需要被查询的路线，可以将其结果缓存在 Redis 中，以提高响应速度。</li><li><strong>简单性</strong>：Redis 的数据模型相对简单，适合存储简单的键值对或一些常规数据结构。这使得 Redis 适合存储一些搜索条件，如出发地、目的地、车次类型等，以便快速筛选结果。</li><li><strong>部署成本</strong>：Redis 是一款轻量级的数据库，易于部署和维护。它的内存占用相对较低，可以在相对较小的硬件配置上运行，从而减少了部署成本。</li><li><strong>只需后端查询一次</strong>：在实际操作中，页面上的搜索条件大多是前端筛选，而只有在点击查询按钮时才会发起后端请求。因此，Redis 可以用于快速存储和检索列车数据，而 Elasticsearch 等搜索引擎可以在需要进行全文搜索或复杂查询时使用。</li></ol><p>总的来说，Redis 作为列车数据的缓存存储在实时性、并发性和部署成本方面具有一些优势，尤其适用于快速检索和缓存常用路线数据。然而，对于复杂的全文搜索和高级查询需求，可以考虑将 Redis 与 Elasticsearch 等搜索引擎结合使用，以充分发挥它们各自的优势。</p><h3 id="注册用户接口"><a class="anchor" href="#注册用户接口">#</a> 注册用户接口</h3><h4 id="用户表结构"><a class="anchor" href="#用户表结构">#</a> 用户表结构</h4><p>以下表结构为用户原始表结构，而大家执行过建表语句后，看到数据库中大多为 <code>t_user_0-15</code> 的表名。这是因为，<font color="red">考虑到用户量过大，对用户表进行了分库分表处理 </font>。详细的表结构可以查看：<a href="#%E4%BC%9A%E5%91%98%E6%95%B0%E6%8D%AE">会员数据</a>。</p><p>对应的 UML 图：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240127234324530.png" alt="image-20240127234324530"></p><p><code>t_user</code> 的原始建表 SQL：</p><pre><code class="language-SQL">CREATE TABLE `t_user` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `username` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '用户名',
  `password` varchar(512) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '密码',
  `real_name` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '真实姓名',
  `region` varchar(64) COLLATE utf8mb4_unicode_ci DEFAULT '0' COMMENT '国家/地区',
  `id_type` int(3) DEFAULT NULL COMMENT '证件类型',
  `id_card` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '证件号',
  `phone` varchar(128) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '手机号',
  `telephone` varchar(128) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '固定电话',
  `mail` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '邮箱',
  `user_type` int(3) DEFAULT NULL COMMENT '旅客类型',
  `verify_status` int(3) DEFAULT NULL COMMENT '审核状态',
  `post_code` varchar(64) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '邮编',
  `address` varchar(1024) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '地址',
  `deletion_time` bigint(20) DEFAULT '0' COMMENT '注销时间戳',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_time` datetime DEFAULT NULL COMMENT '修改时间',
  `del_flag` tinyint(1) DEFAULT NULL COMMENT '删除标识',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`,`deletion_time`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
</code></pre><h4 id="分库分表策略"><a class="anchor" href="#分库分表策略">#</a> 分库分表策略</h4><p>用户数据分库分表相关文档参考<a href="#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">用户数据分库分表</a>，一定程度上解决了业务难点中的<a href="#%E6%95%B0%E5%8D%81%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E9%87%8F">数十亿级数据量</a>问题。</p><h4 id="缓存穿透问题"><a class="anchor" href="#缓存穿透问题">#</a> 缓存穿透问题</h4><p>相关文档：<a href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">用户注册如何防止缓存穿透</a></p><h4 id="用户注册接口"><a class="anchor" href="#用户注册接口">#</a> 用户注册接口</h4><p>用户注册接口整体流程如下所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690251198470-c42d8678-5a3c-4b06-9559-e1999afa0f97.png" alt="img"></p><p>注册代码如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 事务回滚，保证数据一致性。任何异常都回滚</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">UserRegisterRespDTO</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 接收用户注册请求参数</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 通过责任链模式来过滤用户注册请求参数</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	abstractChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">UserChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">USER_REGISTER_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">// 通过 Redisson 分布式锁来保证注册用户的幂等性，防止重复注册</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_USER_REGISTER</span> <span class="token operator">+</span> requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 Redisson 分布式锁</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">boolean</span> tryLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 尝试获取锁</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tryLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果获取锁失败，说明有其他线程正在注册该用户，直接返回</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token constant">HAS_USERNAME_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token comment">// 将用户注册请求参数转换为 UserDO 对象（前提是两个对象的属性名相同），然后插入数据库的用户表</span></pre></td></tr><tr><td data-num="15"></td><td><pre>			<span class="token keyword">int</span> inserted <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">,</span> <span class="token class-name">UserDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span>inserted <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token constant">USER_REGISTER_FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 插入失败，抛出 "用户注册失败" 异常</span></pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> dke<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>			log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"用户名 [&#123;&#125;] 重复注册"</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token constant">HAS_USERNAME_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户名重复，抛出 "用户名已存在" 异常</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token class-name">UserPhoneDO</span> userPhoneDO <span class="token operator">=</span> <span class="token class-name">UserPhoneDO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token punctuation">.</span><span class="token function">phone</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>				<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>			<span class="token comment">// 将用户注册请求参数转换为 UserPhoneDO 对象，然后插入数据库的用户手机号表</span></pre></td></tr><tr><td data-num="29"></td><td><pre>			userPhoneMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>userPhoneDO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> dke<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"用户 [&#123;&#125;] 注册手机号 [&#123;&#125;] 重复"</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token constant">PHONE_REGISTERED</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手机号重复，抛出 "手机号已被占用" 异常</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token class-name">UserMailDO</span> userMailDO <span class="token operator">=</span> <span class="token class-name">UserMailDO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>					<span class="token punctuation">.</span><span class="token function">mail</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>					<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>					<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>			<span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>				<span class="token comment">// 将用户注册请求参数转换为 UserMailDO 对象，然后插入数据库的用户邮箱表</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				userMailMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>userMailDO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>			<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> dke<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>				log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"用户 [&#123;&#125;] 注册邮箱 [&#123;&#125;] 重复"</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token constant">MAIL_REGISTERED</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 邮箱重复，抛出 "邮箱已被占用" 异常</span></pre></td></tr><tr><td data-num="45"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>		<span class="token class-name">String</span> username <span class="token operator">=</span> requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>		<span class="token comment">// 用户注册成功后，将该用户名从 Redis Set 缓存（已注销 / 可复用的用户名）中删除</span></pre></td></tr><tr><td data-num="49"></td><td><pre>		userReuseMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserReuseDO</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		<span class="token class-name">StringRedisTemplate</span> instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		instance<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">USER_REGISTER_REUSE_SHARDING</span> <span class="token operator">+</span> <span class="token function">hashShardingIdx</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		<span class="token comment">// 将该用户名添加到布隆过滤器中，表示该用户名已被注册</span></pre></td></tr><tr><td data-num="53"></td><td><pre>		userRegisterCachePenetrationBloomFilter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 布隆过滤器设计问题：设置多大、碰撞率以及初始容量不够了怎么办？详情查看：https://nageoffer.com/12306/question</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>		lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放锁，表示注册完成</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	<span class="token keyword">return</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">,</span> <span class="token class-name">UserRegisterRespDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将用户注册请求参数转换为 UserRegisterRespDTO 对象，返回</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="责任链模式校验"><a class="anchor" href="#责任链模式校验">#</a> 责任链模式校验</h5><p>技术文档：<a href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">责任链模式是什么？</a>、<a href="#==%E5%A6%82%E4%BD%95%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F==">如何抽象责任链模式</a></p><p>12306 系统中，我们定义责任链模式分为三步，确定方法执行入参、定义当前业务的责任链接口、具体实施验证责任链执行器。</p><h6 id="确定方法执行入参"><a class="anchor" href="#确定方法执行入参">#</a> 确定方法执行入参</h6><p>因为我们是用户注册接口，验证的也是用户提交的数据，直接复用用户注册请求参数实体 <code>UserRegisterReqDTO</code> 即可。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>req</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre> * 用户注册请求参数</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="9"></td><td><pre> */</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRegisterReqDTO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 用户名</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 密码</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * 真实姓名</pre></td></tr><tr><td data-num="25"></td><td><pre>     */</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> realName<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="29"></td><td><pre>     * 证件类型</pre></td></tr><tr><td data-num="30"></td><td><pre>     */</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> idType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="34"></td><td><pre>     * 证件号</pre></td></tr><tr><td data-num="35"></td><td><pre>     */</pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> idCard<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="39"></td><td><pre>     * 手机号</pre></td></tr><tr><td data-num="40"></td><td><pre>     */</pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="44"></td><td><pre>     * 邮箱</pre></td></tr><tr><td data-num="45"></td><td><pre>     */</pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> mail<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="49"></td><td><pre>     * 旅客类型</pre></td></tr><tr><td data-num="50"></td><td><pre>     */</pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> userType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="54"></td><td><pre>     * 审核状态</pre></td></tr><tr><td data-num="55"></td><td><pre>     */</pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> verifyState<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="59"></td><td><pre>     * 邮编</pre></td></tr><tr><td data-num="60"></td><td><pre>     */</pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> postCode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="64"></td><td><pre>     * 地址</pre></td></tr><tr><td data-num="65"></td><td><pre>     */</pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="69"></td><td><pre>     * 国家 / 地区</pre></td></tr><tr><td data-num="70"></td><td><pre>     */</pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> region<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="74"></td><td><pre>     * 固定电话</pre></td></tr><tr><td data-num="75"></td><td><pre>     */</pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> telephone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="定义业务的责任链接口"><a class="anchor" href="#定义业务的责任链接口">#</a> 定义业务的责任链接口</h6><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>service<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>user</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>common<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">UserChainMarkEnum</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>req<span class="token punctuation">.</span></span><span class="token class-name">UserRegisterReqDTO</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>designpattern<span class="token punctuation">.</span>chain<span class="token punctuation">.</span></span><span class="token class-name">AbstractChainHandler</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * 用户注册的责任链过滤器接口</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRegisterCreateChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">UserRegisterReqDTO</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChainHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRegisterReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 获取责任链标记</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">UserChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">USER_REGISTER_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当构建责任链时，<strong>为什么要定义具体业务责任链接口而不是直接实现抽象责任链类 <code>AbstractChainHandler</code> 呢？</strong></p><p>虽然直接实现 <code>AbstractChainHandler</code> 是可行的，但这种方式会导致两个问题：</p><ol><li><font color="red">冗余标识</font>：所有责任链处理器都需要实现 <code>mark</code> 接口来标识当前类用于处理哪种业务。这样做会增加冗余代码，因为每个处理器类都需要实现相同的接口来提供标识信息。</li><li><font color="red">可读性降低</font>：当我们想查看项目中有多少责任链业务处理时，可能会看到大量的具体实现类。这种情况下，我们更关注责任链的类别而不是具体的实现类。直接实现 <code>AbstractChainHandler</code> 会导致责任链类别信息被掩盖，降低了代码的可读性。</li></ol><p>因此，为了提高代码的可读性和可维护性，以及避免冗余的标识信息，我们采用定义责任链接口的方式。<font color="red">通过定义责任链接口，每个处理器实现类只需实现自己负责的逻辑，而责任链的类别信息可以通过接口的命名和文档来清晰地体现</font>。</p><p>这样一来，我们可以更方便地了解责任链的结构和组成，使代码更加简洁、清晰、易于维护和扩展。</p><p>以 List 接口举例，当大家点开 List 实现类的时候，是不是发现根本就没有可用信息。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414120734.png" alt="image.png"></p><p><font color="red">而我们这种具体业务接口继承自 <code>AbstractChainHandler</code> 的方式，就可以便于知道，用户注册责任链处理器都有哪些实现</font>：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414121027.png" alt=""></p><p>因此，定义责任链接口是一种更优雅、灵活且可扩展的设计方式，有助于提高代码的可维护性和可扩展性。</p><h6 id="定义业务的具体责任链处理器"><a class="anchor" href="#定义业务的具体责任链处理器">#</a> 定义业务的具体责任链处理器</h6><p>在定义责任链处理器时，需要注意<font color="red">使用 <code>getOrder</code> 排序接口来决定组件的执行顺序</font>。通常情况下，处理效率高且在内存中执行的验证策略应该优先执行，而需要涉及交互操作（例如 Redis 等）的处理策略则放在后面执行。</p><p>举例来说，假设用户没有传递身份证号，在这种情况下，首先执行验证用户名的操作是非常浪费的，因为后续还需要验证参数必填性，这样就多了一次查询缓存的无用耗时。尽管性能损耗可能不会很高，但这种无用的损耗应该尽量避免。</p><p>因此，通过合理地使用 <code>getOrder</code> 排序接口，我们可以优化责任链的执行顺序，使得处理效率高的操作优先执行，避免不必要的性能损耗，从而提升整体处理性能和效率。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 用户注册参数必填检验</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UserRegisterParamNotNullChainHandler</span> <span class="token keyword">implements</span> <span class="token class-name">UserRegisterCreateChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRegisterReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_NAME_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PASSWORD_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PHONE_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getIdType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">ID_TYPE_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getIdCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">ID_CARD_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">MAIL_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">REAL_NAME_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">//xxx 这里应该把所有用户注册入参校验必填，因为重复工作量所以暂时验证上述这些字段</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 数字越小，优先级越高</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="34"></td><td><pre> * 用户名可用检验</pre></td></tr><tr><td data-num="35"></td><td><pre> */</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">// 通过构造方法注入 UserLoginService ，为什么不用 @Autowired 注解？</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">// 因为 @RequiredArgsConstructor 注解可以生成 final 类型的属性，而 @Autowired 不能。</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UserRegisterHasUsernameChainHandler</span> <span class="token keyword">implements</span> <span class="token class-name">UserRegisterCreateChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRegisterReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserLoginService</span> userLoginService<span class="token punctuation">;</span> <span class="token comment">// 用户登录服务，用于检查用户名是否可用</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userLoginService<span class="token punctuation">.</span><span class="token function">hasUsername</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">// 用户名不可用，抛出 “用户名已存在” 异常</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">HAS_USERNAME_NOTNULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="59"></td><td><pre> * 用户注册检查证件号是否多次注销</pre></td></tr><tr><td data-num="60"></td><td><pre> */</pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UserRegisterCheckDeletionChainHandler</span> <span class="token keyword">implements</span> <span class="token class-name">UserRegisterCreateChainFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRegisterReqDTO</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token class-name">Integer</span> userDeletionNum <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">queryUserDeletionNum</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getIdType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getIdCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>userDeletionNum <span class="token operator">>=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token string">"证件号多次注销账号已被加入黑名单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="用户表相关新增"><a class="anchor" href="#用户表相关新增">#</a> 用户表相关新增</h5><p>有同学表示疑问：<strong>新增用户时操作用户表是理所当然的，可是为什么需要同时操作用户手机号表和用户邮箱表？</strong></p><p>在回答之前，我们先来查看 12306 登录功能的原型截图及其对应的功能。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414123134.png" alt="image.png"></p><p>在登录功能中，用户一栏明确标出<font color="red">可以使用用户名、邮箱或手机号中的任意一个搭配密码进行登录</font>。需要强调的是，<font color="red">在分库分表中，我们是通过用户名进行分片的，因此如果在查询用户信息时不带用户名，将会触发<strong>读扩散问题</strong></font>。</p><p>引用之前写过的一段话，来详细说明分库分表后，不带用户分片键查询的危害。</p><p>由于登录时没有带用户名，导致无法确定用户的分片键，使得<font color="red">系统无法直接锁定用户的数据位于哪个数据库或者哪张表中</font>。为了找到用户的数据，<font color="red">只能进行全库全表扫描查询</font>，这就造成了所谓的 “读请求扩散” 问题。</p><p>也就是说，原本读请求可以直接定位到某个数据库某张表，现在却要多处查询，无疑大大增加了系统的查询负载。</p><p>一旦出现了读请求扩散问题，势必会导致用户的登录请求响应时间变长，严重的话还可能造成登录超时。</p><p>为了解决这个问题，<strong>我们引入了两张路由表：用户手机号表、用户邮箱表</strong>。这些表的核心字段是手机号和邮箱，以及它们对应的用户名。通过这样的设计，我们能够在用户登录时，灵活地使用手机号、邮箱或用户名来进行认证。</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_user_mail<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ID'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>mail<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>deletion_time<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'注销时间戳'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>del_flag<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'删除标识'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_mail<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>mail<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>deletion_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'用户邮箱表'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_user_phone<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ID'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>phone<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>deletion_time<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'注销时间戳'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>del_flag<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'删除标识'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_phone<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>phone<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>deletion_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'用户号码表'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h6 id="路由表是什么"><a class="anchor" href="#路由表是什么">#</a> 路由表是什么</h6><p>在分库分表中，路由表（Routing Table）是一个<font color="red">用于映射用户数据在分片库和分片表中位置</font>的特殊表。它记录了用户按照特定分片键（例如用户名、邮箱、手机号等）拆分后在哪个分片库的哪张分片表中。</p><p>路由表的存在使得系统可以根据不同的登录方式（用户名、邮箱、手机号）来准确地定位到用户数据所在的分片位置，从而能够在查询时快速找到对应的数据。</p><h6 id="路由表优点"><a class="anchor" href="#路由表优点">#</a> 路由表优点</h6><p>通过路由表的映射，<font color="red">系统可以快速定位用户数据所在的分片位置，从而实现按照不同的登录方式进行查询</font>。这样，无论用户是通过用户名、邮箱还是手机号登录，系统都能准确地找到对应的数据所在位置，从而提高了查询的效率和准确性。</p><p><font color="red">拿手机号登录方式来说，我们通过手机号定位到路由表中的某一条用户数据，拿到对应的用户名，再根据用户名去查询真实的用户数据。这样就很好避免了读扩散问题</font>。</p><h6 id="路由表缺点"><a class="anchor" href="#路由表缺点">#</a> 路由表缺点</h6><p>当然，路由表也不是万能的，同样存在着一些不好的点，比如：</p><ul><li><font color="red">查询性能</font>：在进行用户登录或其他需要根据分片键查找数据的操作时，需要先访问路由表，根据分片键的取值范围定位到对应的分片位置，然后再去实际的分片库和分片表中查询数据。这样的查询过程会引入额外的查询开销，可能影响系统的查询性能。</li><li><font color="red">维护成本</font>：随着系统数据量的增加和业务发展，路由表的大小和复杂度可能会不断增加，维护路由表将会变得越来越复杂。对于大规模分库分表系统，路由表的维护成本可能会很高。</li></ul><p>整体来说，为了实现多种方式用户登陆需求，路由表的设计算是比较折中的，也是大规模应用生产系统。</p><h5 id="其他操作"><a class="anchor" href="#其他操作">#</a> 其他操作</h5><p>在用户注册后，该用户名将不再可用，因此我们需要<font color="red">将注册成功后的用户名添加到布隆过滤器中，以防止其他人在后续尝试注册时再次使用</font>。</p><p>另外，还需考虑用户注册文章中提到的用户名注销后可复用的问题。我们特意设计了一张可复用用户名表 <code>t_user_reuse</code> ，并且在布隆过滤器后新增了一个 Redis Set 结构，来缓存已注销、可复用的用户名，方便被其他用户再次使用。</p><blockquote><p>参考本文：[12306 的解决方案](#12306 的解决方案)</p></blockquote><p>这意味着，我们<font color="red">需要将可复用用户名对应的数据库表和 Redis Set 缓存中一并删除</font>。一旦删除完成，后续用户将无法使用该用户名。这样的设计保证了用户名的合理复用，同时确保已注销用户名的信息不会对后续用户产生影响。</p><h4 id="小结-13"><a class="anchor" href="#小结-13">#</a> 小结</h4><p>12306 系统对用户数据进行了分库分表操作，将用户表拆分为多张表，通过用户名进行分片，以应对大量用户数据的存储和查询需求。同时，为了提供更多登录方式的支持，系统扩充了手机号和邮箱登录方式，使用户可以根据任意一种方式搭配密码进行登录，增加了系统的灵活性和用户友好性。</p><p><font color="red">用户注册流程详细描述</font>：包括了注册请求参数合规性验证、用户信息的插入操作，以及手机号和邮箱信息的处理。在用户注册后，系统将注册的用户名添加到布隆过滤器中，防止后续再被其他人注册。为了解决已注销用户名的可复用问题，相关缓存和数据库表也会被删除，确保用户名的合理复用和数据的一致性。</p><p>在分库分表的实现中，引入了<font color="red">两张路由表</font>：用户手机号表和用户邮箱表。这些表记录了用户数据按照特定分片键进行拆分后的位置信息，从而在查询时能够准确地定位到用户数据所在的分片位置，避免了读扩散问题，提高了查询性能和系统的响应速度。</p><p>尽管分库分表带来了查询性能的提升和数据存储的分散，但也面临着一些挑战，例如维护路由表的成本随着数据量增加而增加，查询时需要额外访问路由表，可能影响查询性能。因此，在系统设计中需要综合考虑分库分表带来的利弊，并做出合理的权衡和优化。</p><p>总体而言，通过分库分表和扩充登录方式，12306 系统有效地应对了海量用户数据和多样化登录需求，提升了系统的可扩展性和性能，为用户提供了更好的使用体验。不过在大规模分库分表系统中，仍需注意维护成本和查询性能等方面的优化，以确保系统持续稳定高效运行。</p><h3 id="用户数据分库分表"><a class="anchor" href="#用户数据分库分表">#</a> 用户数据分库分表</h3><h4 id="分库分表介绍"><a class="anchor" href="#分库分表介绍">#</a> 分库分表介绍</h4><p>很多情况下，分库分表并不是从系统设计开始就存在的，而是系统运行过程中，出现数据量庞大或者查询性能慢等问题延伸而来。</p><h5 id="概念"><a class="anchor" href="#概念">#</a> 概念</h5><p>从原理上说，分库是将原本的单库拆分为多个库，分表是将原来的单表拆分为多个表。</p><p>分库有两种模式：</p><ul><li><code>垂直拆库</code> ：电商库 MallDB，业务拆分后就是 UserDB、OrderDB、PayDB...</li><li><code>分片拆库</code> ：用户库 UserDB，分片库后就是 UserDB_0、UserDB_1、UserDB_xx</li></ul><p>分表也有两种模式：</p><ul><li><code>垂直拆分</code> ：订单表 OrderTable，拆分后就是 OrderTable 以及 OrderExtTable。</li><li><code>水平拆分</code> ：订单表 OrderTable，拆分后就是 OrderTable_0、 OrderTable_xxx。</li></ul><h5 id="场景"><a class="anchor" href="#场景">#</a> 场景</h5><p><strong>1）什么场景下分表？</strong></p><p>Q：多少数据量进行分表？</p><p>A：单表 1000w 是否要分表？回答不够标准。</p><p>假设一个表里 15 个字段，没有特别大的值（不包含 text 或其它超长度的列），数据量超过 5000 万了，依然很丝滑，因为走索引。</p><p>真正需要考虑的是：<font color="red">业务的增长量以及历史数量 </font>。</p><p>Q：<font color="red">物理文件过大 </font>，会有什么问题？</p><p>A：会影响公司对数据库表的一个备份。数据库表文件过大，也间接证明表数据过大，增加或删除字段导致锁表的时间过长。</p><p><strong>2）什么场景下分库？</strong></p><p><font color="red">当数据库的连接不够客户端使用时 </font>，可以考虑分库或读写分离。</p><p>如果说当数据库的 <font color="red">QPS 越来越高 </font>以及数据量越来越大的时候，就需要考虑分库分表。</p><p>Q：为什么说连接不够用？</p><p>A：假设 MySQL Server 能支持 4000 个数据库连接。我们有 10 个服务，40 个节点，一个节点呢数据库连接池最多 10 个。这样就把一个 MySQL Server 的连接数压榨干净了。</p><p>当 MySQL 连接不够用时，可能会报错 <code>&quot;Too many connections&quot;</code> 或者类似的错误。这是 <font color="red">因为 MySQL 服务器同时可以处理的连接数量是有限制的 </font>，当连接数达到这个限制时，服务器就会拒绝新的连接请求，并返回这个错误消息。</p><p><strong>3）什么场景下分库又分表？</strong></p><ul><li><font color="red">高并发写入 </font>：当应用面临高并发的写入请求时，单一数据库可能无法满足写入压力，此时可以将数据按照一定规则拆分到多个数据库中，每个数据库处理部分数据的写入请求，从而提高写入性能。</li><li><font color="red">数据量巨大 </font>：随着数据量的不断增加，单一数据库的存储和查询性能可能逐渐下降。此时，可以将数据按照一定的规则拆分到多个表中，每个表存储部分数据，从而分散数据的存储压力，提高查询性能。</li></ul><h4 id="分库分表组件"><a class="anchor" href="#分库分表组件">#</a> 分库分表组件</h4><p>选择 <code>ShardingSphere</code> 进行分库分表，原因如下：</p><ul><li>拥有活跃的社区，能够提供及时的技术支持和更新；</li><li>代码质量极高，经过严格测试和验证，稳定可靠；</li><li>提供丰富的功能，满足多样化的业务需求。</li></ul><p>可以阅读<a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0">中间件学习</a>中的介绍。</p><p><strong><font color="red">前提条件：ShardingSphere 需要依赖已有的数据库表结构来进行分库分表操作，因此在使用它之前需要确保表结构已经按照分库分表规则创建好 </font></strong>。</p><p>具体地，以下是其中一个用户分表的建表 SQL ：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">USE</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">12306</span>_user_0<span class="token punctuation">;</span> <span class="token comment"># 用户分库</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_user_0<span class="token punctuation">`</span></span> <span class="token comment"># 用户分表</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>            <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ID'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span>      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span>      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'密码'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>real_name<span class="token punctuation">`</span></span>     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'真实姓名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>region<span class="token punctuation">`</span></span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci   <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'国家/地区'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>id_type<span class="token punctuation">`</span></span>       <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'证件类型'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>id_card<span class="token punctuation">`</span></span>       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'证件号'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>phone<span class="token punctuation">`</span></span>         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>telephone<span class="token punctuation">`</span></span>     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'固定电话'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>mail<span class="token punctuation">`</span></span>          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>user_type<span class="token punctuation">`</span></span>     <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'旅客类型'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>verify_status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'审核状态'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>post_code<span class="token punctuation">`</span></span>     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci   <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'邮编'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span>       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'地址'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>deletion_time<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'注销时间戳'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>   <span class="token keyword">datetime</span>                                 <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span>   <span class="token keyword">datetime</span>                                 <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token identifier"><span class="token punctuation">`</span>del_flag<span class="token punctuation">`</span></span>      <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'删除标识'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_username<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>deletion_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'用户表'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>注意到，其中的下面这句，定义了一个名为 <code>idx_username</code> 的<strong>唯一索引（Unique Key）</strong>，该索引包含两列： <code>username</code> 和 <code>deletion_time</code> ，并且使用了 B-tree 索引结构。目的确保在 <code>username</code> 和 <code>deletion_time</code> 这两列的组合上的数值是唯一的。</p><p>也就是说，在表中不能存在两行具有相同的 <code>username</code> 和 <code>deletion_time</code> 值的数据，但允许 <code>username</code> 相同， <code>deletion_time</code> 不同的数据存在。</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_username<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>deletion_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span></pre></td></tr></table></figure><h5 id="shardingsphere-jdbc"><a class="anchor" href="#shardingsphere-jdbc">#</a> ShardingSphere-JDBC</h5><p>定位为 <font color="red">轻量级 </font>Java 框架，<font color="red">在 Java 的 JDBC 层提供的额外服务 </font>。它使用客户端直连数据库，<font color="red">以 jar 包形式提供服务，无需额外部署和依赖 </font>，可理解为增强版的 JDBC 驱动，完全兼容 JDBC 和各种 ORM 框架。</p><ul><li>适用于任何基于 JDBC 的 ORM 框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template 或直接使用 JDBC；</li><li>支持任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, HikariCP 等；</li><li>支持任意实现 JDBC 规范的数据库，目前支持 MySQL，PostgreSQL，Oracle，SQLServer 以及任何可使用 JDBC 访问的数据库。</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240327200822485.png" alt="image-20240327200822485"></p><h5 id="shardingsphere-proxy"><a class="anchor" href="#shardingsphere-proxy">#</a> ShardingSphere-Proxy</h5><p>定位为透明化的数据库代理端，通过实现数据库二进制协议，对异构语言提供支持。 目前提供 MySQL 和 PostgreSQL 协议，<font color="red">透明化数据库操作 </font>，对 DBA 更加友好。</p><ul><li>向应用程序完全透明，<font color="red">可直接当做 MySQL/PostgreSQL 使用 </font>；</li><li>兼容 MariaDB 等基于 MySQL 协议的数据库，以及 openGauss 等基于 PostgreSQL 协议的数据库；</li><li>适用于任何兼容 MySQL/PostgreSQL 协议的的客户端，如：MySQL Command Client, MySQL Workbench, Navicat 等。</li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240327201027413.png" alt="image-20240327201027413"></p><h5 id="二者对比"><a class="anchor" href="#二者对比">#</a> 二者对比</h5><p><code>ShardingSphere-JDBC</code> ：</p><ul><li>优点：<ul><li>性能较高，通过 JDBC 直接向 MySQL 发起请求调用</li><li>使用较为简单，理论上无需修改代码，仅需使用 ShardingSphere 的配置即可</li></ul></li><li>缺点：<ul><li><font color="red">需要修改项目配置，并引入 Jar 包</font></li><li>对应用的内存有一定影响</li></ul></li></ul><p><code>ShardingSphere-Proxy</code> ：</p><ul><li>优点：<ul><li><font color="red">无需对现有项目做任何配置或代码变更，将数据库的地址改为 Proxy 的地址即可</font></li><li><font color="red">对 Java 应用内存没有任何影响</font></li><li>分片后无法知道一条数据记录到底在那张表，<font color="red">屏蔽了分片逻辑，可直接操作逻辑表</font></li></ul></li><li>缺点：<ul><li>JDBC 操作 MySQL 是点对点的，但是 Proxy 多了一层链路</li></ul></li></ul><p><strong><font color="#1aaaaa">本项目中采取的是 ShardingSphere-JDBC 。</font></strong></p><h4 id="用户数据的分库分表策略"><a class="anchor" href="#用户数据的分库分表策略">#</a> 用户数据的分库分表策略</h4><p>根据 2022 年的全国人口统计数据，现有 14 亿多总人口，每年新生人口约 956 万。为便于后续业务数据规模的判断，本文先基于这一人口总量和增长数据进行估算。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690195510129-f5e52c9b-459b-412e-b98b-695d32fca81e.png" alt="img"></p><p>根据系统设计的假设，12306 的注册用户规模约为 10 亿，每年新增用户约 1000 万。</p><p>在用户数据分库或分表之前，我们需要 <font color="red">先考虑拆分成多少个库或表才能达到最优性能 </font>。为了进行这样的决策，我们可以预估单个表的最大数据量。根据过去的经验，通常我们会 <font color="red">选择单个表的最大数据量为 2000 万，作为一个经验值 </font>。这个数据量既不会过小，同时又能保证增删改查等操作相对流畅。</p><p>根据当前用户的数量为 10 亿，并且每年新增 1000 万用户，预估未来系统的生命周期较长，数据量大概会达到 30 亿左右。<font color="red">基于这个数据量，我们预估单表的数据量在 2000 万左右，因此需要分大约 150 张表来容纳这些数据 </font>。</p><p>在进行分库分表容量评估时，我们通常会尽可能多地进行评估。这样做的好处是，即使每张表的数据量不多，也能及早发现拆分后是否存在数据问题，以便及时进行调整和优化。</p><p>此外，需要特别指出的是，我们对表数据量考虑的阈值相对较小，这是因为我们的系统具备良好的可扩展性，可以轻松应对大量的数据增长。因此，基于这种情况的分库分表策略，即使在几百年后，这个分库分表依然能够处理数据，并且不会出现性能问题。这为我们的系统提供了稳定可靠的性能保障。</p><h4 id="选择用户分片键"><a class="anchor" href="#选择用户分片键">#</a> 选择用户分片键</h4><p><font color="red">在进行数据分片时，系统会根据  <code>分片键（Sharding Key）</code> 的值将数据分发到不同的数据库实例或数据表中 </font>。因此选择分库分表中的分片键是一个关键决策，它直接影响了分库分表的性能和可扩展性。以下是一些选择分片键的关键因素：</p><ol><li><strong><font color="red">访问频率 </font></strong>：选择分片键应考虑数据的访问频率。<font color="red">将经常访问的数据集合放在同一个分片上 </font>，可以提高查询性能和降低跨分片查询的开销。</li><li><strong><font color="red">数据均匀性 </font></strong>：分片键应该保证数据均匀分布在各个分片上，<font color="red">避免出现热点数据集中在某个分片上的情况 </font>。</li><li><strong><font color="red">业务关联性 </font></strong>：分片键应该与业务关联紧密，这样可以避免跨分片查询和跨库事务的复杂性。</li><li><strong><font color="red">数据不可变 </font></strong>：一旦选择了分片键，<font color="red">分片键应该是不可变的，不能随着业务的变化而频繁修改 </font>。</li></ol><p>基于以上考虑，<strong><font color="#1aaaaa">本项目选择使用 用户名 作为分片键 </font></strong>。</p><h4 id="改造用户分库分表"><a class="anchor" href="#改造用户分库分表">#</a> 改造用户分库分表</h4><p>如果你没有使用过 ShardingSphere 分库分表操作，可以查看官网<span class="exturl" data-url="aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnL2RvY3VtZW50LzUuMy4yL2NuL2ZlYXR1cmVzL3NoYXJkaW5nLw==">数据分片 :: ShardingSphere</span> 进行一些前置条件理解。</p><h5 id="引入-shardingsphere-jdbc-依赖"><a class="anchor" href="#引入-shardingsphere-jdbc-依赖">#</a> 引入 ShardingSphere-JDBC 依赖</h5><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>shardingsphere-jdbc-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="定义分片规则"><a class="anchor" href="#定义分片规则">#</a> 定义分片规则</h5><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  	<span class="token comment"># ShardingSphere 对 Driver 自定义，实现分库分表等隐藏逻辑</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> org.apache.shardingsphere.driver.ShardingSphereDriver</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment"># ShardingSphere 配置文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>shardingsphere<span class="token punctuation">:</span>classpath<span class="token punctuation">:</span>shardingsphere<span class="token punctuation">-</span>config.yaml</pre></td></tr></table></figure><p>配置文件路径信息如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690862608819-ad91212a-c24f-4884-aa56-021bb2c3b87f.png" alt="img"></p><h5 id="用户分片配置"><a class="anchor" href="#用户分片配置">#</a> 用户分片配置</h5><p>因为 12306 更多的是向大家演示分库分表，<strong><font color="1aaaaa">这里仅展示用户表的分片配置：分 2 个库、各自 16 张表 </font></strong>。</p><p><code>shardingsphere-config.yaml</code> ：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 数据源集合</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">dataSources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">ds_0</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/12306_user_0<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;rewriteBatchedStatements=true&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">ds_1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/12306_user_1<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;rewriteBatchedStatements=true&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">-</span> <span class="token tag">!SHARDING</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">tables</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">t_user</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment"># 真实数据节点，比如数据库源以及数据库在数据库中真实存在的</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds_$<span class="token punctuation">&#123;</span>0..1<span class="token punctuation">&#125;</span>.t_user_$<span class="token punctuation">&#123;</span>0..15<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment"># 分库策略</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token comment"># 用于单分片键的标准分片场景</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">standard</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment"># 分片键</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> username</pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token comment"># 分片算法，对应 rules [0].shardingAlgorithms</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> user_database_hash_mod</pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment"># 分表策略</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token comment"># 用于单分片键的标准分片场景</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token key atrule">standard</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token comment"># 分片键</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> username</pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment"># 分片算法，对应 rules [0].shardingAlgorithms</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> user_table_hash_mod</pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment"># 分片算法</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token key atrule">shardingAlgorithms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token comment"># 数据库分片算法</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token key atrule">user_database_hash_mod</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment"># 根据分片键 Hash 分片</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token key atrule">type</span><span class="token punctuation">:</span> HASH_MOD</pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment"># 分片数量</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token key atrule">sharding-count</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token comment"># 数据表分片算法</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token key atrule">user_table_hash_mod</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment"># 根据分片键 Hash 分片</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token key atrule">type</span><span class="token punctuation">:</span> HASH_MOD</pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token comment"># 分片数量</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>          <span class="token key atrule">sharding-count</span><span class="token punctuation">:</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># 展现逻辑 SQL &amp; 真实 SQL</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr></table></figure><p>写好以上配置后，就可以愉快使用数据库分库分表了。</p><p><code>props.sql-show</code> 配置尽量打开，它能打印应用的 <font color="red">逻辑 SQL </font>以及真正查询数据库的 <font color="red">真实 SQL </font>。</p><h4 id="小结-14"><a class="anchor" href="#小结-14">#</a> 小结</h4><p>分库分表是一种数据库架构设计和优化手段，用于应对大规模数据量和高并发访问的情况。它将原本的单库单表拆分为多个数据库或表，从而分散数据存储和查询压力，提高系统的性能和可扩展性。分库分表的场景通常是在系统运行过程中，出现数据量庞大或查询性能慢等问题时引入的。</p><p>分库分表主要有两种模式：</p><ul><li><font color="cornflowerblue">垂直拆分 </font>：将原本的单库 <font color="red">按照业务 </font>拆分为多个数据库，每个数据库存储特定的业务数据，如用户库、订单库等。</li><li><font color="cornflowerblue">水平拆分 </font>：将原本的单表拆分为多个表，每个表存储 <font color="red">部分数据 </font>，如订单表拆分为 OrderTable_0、OrderTable_1 等。</li></ul><p>在选择分库分表的关键因素中，需要考虑数据的访问频率、数据均匀性、业务关联性和分片键的不可变性。<font color="red">分片键 </font>是用于决定数据分片的字段，合理选择分片键可以提高查询性能和降低跨分片查询的开销。</p><p>对于用户数据分库分表的场景，我们根据当前用户表的数据量和每年新增用户数，预估了未来的数据量。选择了适当的分片键，并进行了分库分表的配置，保证了系统在未来较长时间内的性能和可扩展性。</p><p>我们选择了使用 <font color="red">ShardingSphere </font>来实现分库分表，因为 ShardingSphere 拥有活跃的社区，高质量的代码和丰富的功能，能够满足多样化的业务需求。根据实际情况，我们可以选择 ShardingSphere 的 JDBC 或 Proxy 模式来进行分库分表操作，根据项目的具体需求选择最适合的方式。</p><p>总的来说，分库分表是一种重要的数据库优化策略，可以帮助解决大规模数据和高并发访问带来的性能问题。在设计分库分表方案时，需要考虑系统的实际情况和未来的数据增长，合理选择分片键和分片策略，以保证系统的稳定性和可扩展性。同时，选择一个可靠的分库分表工具，如 ShardingSphere，可以帮助我们更加便捷地实现分库分表操作。</p><h3 id="用户注册如何防止缓存穿透"><a class="anchor" href="#用户注册如何防止缓存穿透">#</a> 用户注册如何防止缓存穿透</h3><h4 id="缓存穿透的概念"><a class="anchor" href="#缓存穿透的概念">#</a> 缓存穿透的概念</h4><p>缓存穿透是指在使用缓存系统时，恶意或频繁地请求一个不存在于缓存中的数据，导致每次请求都需要查询数据库或其他数据存储系统，从而绕过了缓存的效果，严重影响系统性能。</p><p>这种情况通常发生在恶意攻击、大量请求缓存中不存在的数据或缓存数据过期后的高并发访问。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/redis-cache-penetration.png" alt="缓存穿透"></p><p>缓存穿透会导致以下问题：</p><ol><li>频繁的查询数据库或其他数据存储系统，<font color="red">增加了数据库负载 </font>，降低了系统的吞吐量。</li><li>大量的缓存不存在的数据请求 <font color="red">可能会导致缓存服务器的内存被耗尽 </font>，影响其他正常的缓存操作。</li><li>用户体验下降，因为请求的数据无法从缓存中获取，<font color="red">导致响应时间延长 </font>。</li></ol><h4 id="用户注册的缓存穿透场景以及常见解决方案"><a class="anchor" href="#用户注册的缓存穿透场景以及常见解决方案">#</a> 用户注册的缓存穿透场景以及常见解决方案</h4><p>参考文档：<a href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">用户注册缓存穿透</a></p><h4 id="12306-的解决方案"><a class="anchor" href="#12306-的解决方案">#</a> 12306 的解决方案</h4><p>如果没有<strong>用户名注销后可重复使用的需求</strong>，布隆过滤器无疑是最好的解决方案。但是考虑到企业的需求多样化，我们在设计时需要做好全方面的准备。</p><p>设计时需要考虑一个问题，<font color="red">布隆过滤器虽然可以快速判断一个元素是否不存在，很适合用于快速判断用户名是否已被使用。<strong>但是布隆过滤器无法删除元素</strong>，如果用户名已经被添加进去的用户名，无疑是无法再次复用的 </font>。</p><p>为此，我们可以通过 **<font color="#B32015">在布隆过滤器后面再加一层 Redis Set 缓存结构（以及一张数据库表），缓存记录被注销的可复用的用户名</font>**，来解决这个问题。</p><h5 id="什么是布隆过滤器"><a class="anchor" href="#什么是布隆过滤器">#</a> 什么是布隆过滤器</h5><p>布隆过滤器（Bloom Filter）是一种高效的数据结构，用于判断一个元素是否存在于一个集合中。它利用 <font color="cornflowerblue">位数组 </font>和 <font color="cornflowerblue">多个哈希函数 </font>来实现快速的成员查询。</p><p>布隆过滤器的核心思想：</p><ul><li>用一个位数组（通常用二进制位表示）来表示一个集合，初始时所有位都置为 0。</li><li>对于每个要加入集合的元素，<font color="red">通过多个哈希函数计算出多个哈希值，然后将位数组中的多个对应位置置为 1 </font>。</li><li>判断一个元素是否存在于集合时，同样使用多个哈希函数计算出对应的哈希值，然后检查位数组中对应的位置是否都为 1？<ul><li><font color="red">如果有任意一个位置为 0，则说明该元素不存在于集合中 </font>；</li><li><font color="red">如果所有位置都为 1，则该元素<strong>可能存在</strong>于集合中 </font>（因为有可能发生哈希碰撞），需要进一步查询底层数据结构来确认。</li></ul></li></ul><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690116774811-aca0ef5f-7c14-4b59-bd15-7b9cdc231569.png" alt="img"></p><p>1）关于布隆过滤器删除。</p><p>布隆过滤器在删除元素方面存在一定的限制，<font color="red">因为多个元素可能哈希到布隆过滤器的同一批位置，直接删除该位置的元素可能会影响其他元素的判断，因此布隆过滤器并不直接支持元素的删除操作 </font>。</p><p>2）关于布隆过滤器查询误判。</p><p>由于布隆过滤器使用多个哈希函数来映射元素到不同的位置，并且使用二进制位来表示元素的存在状态，这就导致了误判的可能性。具体来说，以下几个因素会导致误判：</p><ol><li><font color="red">哈希碰撞 </font>：不同的元素经过哈希函数计算可能映射到相同的二进制位，导致不同元素在布隆过滤器中产生了冲突，从而可能被误判为存在于集合中。</li><li>容量限制：布隆过滤器使用有限的二进制位数组来表示集合，当集合中元素数量较多时，可能会导致位的重复使用，从而增加误判的概率。</li></ol><p>虽然查询元素是否存在有这误判率，但是如果 **<font color="red">查询元素是否不存在，则没有误判率 </font>**。</p><h5 id="最终解决方案"><a class="anchor" href="#最终解决方案">#</a> 最终解决方案</h5><p><strong><font color="#B32015">在布隆过滤器后面再加一层 Redis Set 缓存结构（以及一张数据库表），缓存记录被注销的、可复用的用户名 </font></strong>，来解决布隆过滤器无法删除的问题。具体流程如下图所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1690116774752-3c50ae17-b694-4cf0-bd0f-cce27edce229.png" alt="img"></p><p>假设我们有一条用户名为 &quot;mading&quot; 的数据，注册后是如何不被重复注册，以及注销后又是如何能被再次使用的。</p><ol><li><p>用户名 &quot;mading&quot; 成功注册后，将其添加至布隆过滤器。</p></li><li><p>当其他用户查询 &quot;mading&quot; 是否已被使用时，首先检查布隆过滤器是否包含该用户名。</p></li><li><p><font color="red">如果布隆过滤器中不存在该用户名，根据布隆过滤器的特点，可以确认该用户名一定没有被使用过，因此返回成功，证明该用户名可用 </font>。</p></li><li><p><strong><font color="red">如果布隆过滤器中存在该用户名，进一步检查 Redis Set 结构中是否包含该用户名。如果存在则证明该用户名已被注销，同样可被再次使用 </font></strong>。</p></li><li><p>如果布隆过滤器中存在该用户名，但 Redis Set 结构中不存在，说明该用户名已被使用且尚未被注销，因此不可用。</p><blockquote><p>但是，布隆过滤器不是只能判断该用户名可能存在吗（哈希冲突的原因）？也就是说，实际上可能并不存在该用户名，即该用户名其实是可用的。只能理解为这种情况为 <font color="red">小概率事件，涉及后文考虑的碰撞率评估问题，不得不牺牲这批少量的可用用户名 </font>。</p></blockquote></li></ol><p>1）Redis Set 结构是什么？</p><p>当用户注销后，系统会将其用户名放入缓存结构中。如果其他用户想要使用该用户名，会检查缓存是否存在该用户名。如果缓存中存在该用户名，就表示该用户名已被注销，可以被再次使用。</p><p>2）使用这种方式后，会面临以下问题：</p><ol><li><font color="red">查询性能消耗增加 </font>：由于采用了额外的 Redis Set 结构，查询过程需要进行两次查询，一次是查询布隆过滤器，另一次是查询 Redis Set 结构，这导致查询性能相比之前有所增加。</li><li><font color="red">存储损耗增加 </font>：相较于之前仅使用布隆过滤器的存储，现在需要额外存储 Redis Set 结构，这导致存储开销增加。</li></ol><p>3）上面这种方式真的是没有问题的么？</p><p>有一个问题可能会出现：<font color="red">如果用户频繁申请账号再注销，可能导致用户注销可复用的 Username Redis Set 结构变得庞大 </font>，增加了存储和查询的负担。</p><p>为了防止这种情况，我采取了以下解决方案：</p><ol><li><font color="red">异常行为限制 </font>：每次用户注销时，记录用户的证件号，并限制证件号仅可用于注销五次。超过这个限制的次数，将禁止该证件号再次用于注册账号。</li><li><font color="red">分片处理 </font>：对 Username Redis Set 结构进行分片。即使我们对异常行为进行了限制，如果有大量用户注销账户，存储这些数据在一个 Redis Set 结构中可能成为一个灾难，可能出现 Redis 大 Key 问题。因此，我将 Set 结构进行分片，根据用户名的 HashCode 进行取模操作，将数据分散存储在 1024 个 Set 结构中，从而有效地解决了这个问题。</li></ol><h4 id="布隆过滤器的容量设置以及碰撞率问题"><a class="anchor" href="#布隆过滤器的容量设置以及碰撞率问题">#</a> 布隆过滤器的容量设置以及碰撞率问题</h4><h5 id="容量评估"><a class="anchor" href="#容量评估">#</a> 容量评估</h5><p>不管任何业务或者任何技术的容量评估都不会是一拍脑门决定的。</p><p>如果淘宝商城第一年做业务时，他们可能很难预估订单量。因为他们不清楚运营会带给他们多少流量以及订单，也没有往年的相关数据参考。这种是比较难评估的。但是咱们 12306 的用户注册场景，明显不在这个范围内。</p><p>当面试官问布隆过滤器的大小时，我们可以先说一个容量评估思路。比如：用户注册场景下布隆过滤器的主要评估来源是使用 12306 的用户，从系统刚开始运行就开始估算，<font color="red">大概会有多少用户会注册该平台 </font>。</p><p>2013 年 12 月 8 日推出平台，同年国内人口约等于 14 亿，算上前几年大部分人不会使用系统，再加上国内每年的新增人口数量，估算出一个大概值即可。该题重点在一个解题思路，并不一定需要准备的数值。如果非要说的话，<font color="red">让不使用 12306 的人和未来十年的增长起一个对冲，设置 14 亿即可 </font>。意味着 10 年内 14 亿这个数据量不会出问题。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1694524943769-4ee9146d-0b06-424b-b819-376d6a3de6bb.png" alt="img"></p><h5 id="碰撞率评估"><a class="anchor" href="#碰撞率评估">#</a> 碰撞率评估</h5><p>如果需要选择一个较低的碰撞率目标。通常情况下，布隆过滤器的碰撞率可以设置在非常低的范围内，例如 <font color="red">0.1% 或更低 </font>。</p><p>这从根本上来说是一个空间和重复碰撞的博弈。希望空间占用小，那就尽可能让碰撞率调高。<font color="red">如果希望碰撞率低，那就把空间调大 </font>。</p><p>布隆过滤器的内存需求（位数组的长度）可以通过以下公式来计算：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>m <span class="token operator">=</span> -<span class="token punctuation">(</span>n * ln<span class="token punctuation">(</span>p<span class="token punctuation">))</span> / <span class="token punctuation">(</span>ln<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>^2<span class="token punctuation">)</span></pre></td></tr></table></figure><p>其中：</p><ul><li>m 是所需要的位数。</li><li>n 是过滤器中元素的数量。</li><li>p 是期望的误报率。</li></ul><p>在给定的条件下，其中 n 是 10^9（10 亿），p 是 0.001（0.1%），我们可以将这些值带入公式中：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>m <span class="token operator">=</span> -<span class="token punctuation">(</span><span class="token number">10</span>^9 * ln<span class="token punctuation">(</span><span class="token number">0.001</span><span class="token punctuation">))</span> / <span class="token punctuation">(</span>ln<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>^2<span class="token punctuation">)</span></pre></td></tr></table></figure><p>运算后，我们得到的结果 m 大约为 2.88*10^10 位。为了将位转换为字节（1 字节 = 8 位），我们需要除以 8：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>m_in_bytes <span class="token operator">=</span> m / <span class="token number">8</span></pre></td></tr></table></figure><p>这将得到大约 3.6*10^9 字节，或者说 <font color="red">约 3.6 GB 的内存需求 </font>。</p><p>但是请注意，这是一个理想的估计值。实际上，在实际设备和实现中，布隆过滤器可能需要稍微多一些的内存。例如，Redis 的布隆过滤器插件（如 RedisBloom）可能需要一些额外的内存来维护元数据和内部结构。</p><h5 id="初始容量评估不够用时怎么办"><a class="anchor" href="#初始容量评估不够用时怎么办">#</a> 初始容量评估不够用时怎么办</h5><p>如果随着国内人口的越来越多，之前评估的布隆过滤器容量不够了怎么办？</p><p>我们可以 <font color="red">设置定时任务，每天统计已注册人数有多少，和布隆过滤器的预期值差值还有多少，达到一定阈值时就扩大布隆过滤器的容量 </font>。假设布隆过滤器容量设置 14 亿，当已注册人数达到这个数量 80% 时，我们通过后台任务重建布隆过滤器，在 14 亿的基础上再增加一定的数量即可。</p><h4 id="小结-15"><a class="anchor" href="#小结-15">#</a> 小结</h4><p>缓存穿透是指在使用缓存系统时，恶意或频繁地请求一个既不存在于缓存也不存在于数据库中的数据，导致每次请求都需要查询数据库，严重影响系统性能。在高并发的用户注册场景下，可能会出现缓存穿透问题。</p><p>为了解决这个问题，我们可以采取多种解决方案，但每种方案都存在一些弊端。</p><ul><li>对不存在的 Key 进行缓存值设为 Null：虽然可以避免重复查询数据库，但对用户体验不友好，且可能会导致数据库压力增加。</li><li>布隆过滤器：虽然可以快速判断是否存在于集合中，但无法处理删除元素的情况，且存在哈希碰撞导致误判的可能性。</li><li>Redis Set 存储已注册用户名：占用内存较多且复杂度较高，不适合实际应用。</li><li>分布式锁：虽然可以解决并发查询数据库的问题，但影响用户注册的响应时间，不友好的用户体验。</li></ul><p>最终，我们可以 <font color="red">采用 布隆过滤器 + 缓存 的方式 </font>来解决缓存穿透问题。通过布隆过滤器判断用户名是否可能存在，再通过缓存来确认是否真的存在，避免了对数据库的频繁查询。为了解决布隆过滤器无法删除的问题，我们 <font color="red">再加一层 Redis Set 缓存 </font>来存储已注销用户名，实现了用户名的可复用性。此外，为了防止缓存结构过大带来的问题，我们对缓存进行了分片处理，有效减轻了存储和查询的负担。</p><p>综上所述，综合考虑业务需求和系统性能，采用布隆过滤器结合缓存的解决方案是一个比较理想的解决方案，可以有效防止缓存穿透，并提升系统的性能和用户体验。</p><p>文中这些代码逻辑，可以查看以下方法：</p><ol><li><code>org.opengoofy.index12306.biz.userservice.controller.UserInfoController#hasUsername</code></li><li><code>org.opengoofy.index12306.biz.userservice.controller.UserInfoController#register</code></li><li><code>org.opengoofy.index12306.biz.userservice.controller.UserInfoController#deletion</code></li></ol><h3 id="敏感信息脱敏展示"><a class="anchor" href="#敏感信息脱敏展示">#</a> 敏感信息脱敏展示</h3><h4 id="业务需求"><a class="anchor" href="#业务需求">#</a> 业务需求</h4><p>将用户敏感信息脱敏展示到前端是出于保护用户隐私和信息安全的考虑。</p><p>敏感信息包括但不限于<font color="red">手机号码、身份证号、银行卡号等</font>，这些信息泄露可能导致用户个人信息的滥用、身份盗用等严重问题。脱敏是一种常用的保护用户隐私的方式，它的目的是减少潜在的风险，同时保持一定的用户信息可读性。</p><p>比如咱们在选择用户信息以及展示选座信息时，用户证件号码的脱敏展示。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414135202.png" alt="image.png"></p><h4 id="项目实战-2"><a class="anchor" href="#项目实战-2">#</a> 项目实战</h4><h5 id="技术选型"><a class="anchor" href="#技术选型">#</a> 技术选型</h5><p>网上很多教程都是在说，<font color="cornflowerblue">通过 AOP、自定义注解和反射的方式</font>完成字段脱敏功能。但是这种方式有点重量级且性能一般，遇到高并发场景存在性能瓶颈。</p><p>我举个循环嵌套的例子：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">B</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">C</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">D</span> d<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">D</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    @自定义的加密注解</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>    </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><font color="red">按照反射的逻辑，就需要一层一层地解析嵌套对象直到找到自定义加密注解进行脱敏，性能可想而知</font>。</p><p>为此，我想是否存在一种更为轻量级的脱敏技术实现？在网上搜索后，找到了一种比较符合我预期的实现方案：<font color="cornflowerblue">Jackson 序列化方案</font>。</p><h5 id="实现思路"><a class="anchor" href="#实现思路">#</a> 实现思路</h5><p>在 SpringMVC 返回响应数据时，通过默认的 Jackson 序列化器进行指定，替换为咱们已经包装后的自定义 Jackson 序列化器，这样就能依赖现有解决方案，降低技术复杂度。</p><h5 id="代码实现"><a class="anchor" href="#代码实现">#</a> 代码实现</h5><p>定义手机号和证件号的 Jackson 自定义序列化器，并<font color="red">在对应需要脱敏的敏感字段上指定自定义序列化器</font>。</p><p>1）身份证号脱敏序列化器</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>serialize</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">DesensitizedUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonGenerator</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">JsonSerializer</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">SerializerProvider</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre> * 身份证号脱敏序列化器</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdCardDesensitizationSerializer</span> <span class="token keyword">extends</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 继承 JsonSerializer 类，实现自定义序列化</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> idCard<span class="token punctuation">,</span> <span class="token class-name">JsonGenerator</span> jsonGenerator<span class="token punctuation">,</span> <span class="token class-name">SerializerProvider</span> serializerProvider<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">String</span> idCardDesensitization <span class="token operator">=</span> <span class="token class-name">DesensitizedUtil</span><span class="token punctuation">.</span><span class="token function">idCardNum</span><span class="token punctuation">(</span>idCard<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        jsonGenerator<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>idCardDesensitization<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2）手机号序列化器</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>serialize</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">DesensitizedUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonGenerator</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">JsonSerializer</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">SerializerProvider</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre> * 手机号脱敏序列化器</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneDesensitizationSerializer</span> <span class="token keyword">extends</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">JsonGenerator</span> jsonGenerator<span class="token punctuation">,</span> <span class="token class-name">SerializerProvider</span> serializerProvider<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">String</span> phoneDesensitization <span class="token operator">=</span> <span class="token class-name">DesensitizedUtil</span><span class="token punctuation">.</span><span class="token function">mobilePhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        jsonGenerator<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>phoneDesensitization<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3）敏感字段上自定义序列化器</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>resp</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonFormat</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonSerialize</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token class-name">Accessors</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>serialize<span class="token punctuation">.</span></span><span class="token class-name">IdCardDesensitizationSerializer</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>serialize<span class="token punctuation">.</span></span><span class="token class-name">PhoneDesensitizationSerializer</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre> * 乘车人返回参数</pre></td></tr><tr><td data-num="14"></td><td><pre> */</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PassengerRespDTO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     * 乘车人 id</pre></td></tr><tr><td data-num="21"></td><td><pre>     */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="25"></td><td><pre>     * 用户名</pre></td></tr><tr><td data-num="26"></td><td><pre>     */</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     * 真实姓名</pre></td></tr><tr><td data-num="31"></td><td><pre>     */</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> realName<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>     * 证件类型</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> idType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="40"></td><td><pre>     * 证件号码</pre></td></tr><tr><td data-num="41"></td><td><pre>     */</pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token annotation punctuation">@JsonSerialize</span><span class="token punctuation">(</span>using <span class="token operator">=</span> <span class="token class-name">IdCardDesensitizationSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// @JsonSerialize 注解，指定自定义序列化器</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> idCard<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="46"></td><td><pre>     * 真实证件号码</pre></td></tr><tr><td data-num="47"></td><td><pre>     */</pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> actualIdCard<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="51"></td><td><pre>     * 优惠类型</pre></td></tr><tr><td data-num="52"></td><td><pre>     */</pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> discountType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="56"></td><td><pre>     * 手机号</pre></td></tr><tr><td data-num="57"></td><td><pre>     */</pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token annotation punctuation">@JsonSerialize</span><span class="token punctuation">(</span>using <span class="token operator">=</span> <span class="token class-name">PhoneDesensitizationSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="62"></td><td><pre>     * 真实手机号</pre></td></tr><tr><td data-num="63"></td><td><pre>     */</pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> actualPhone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="67"></td><td><pre>     * 添加日期</pre></td></tr><tr><td data-num="68"></td><td><pre>     */</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">,</span> timezone <span class="token operator">=</span> <span class="token string">"GMT+8"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Date</span> createDate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="73"></td><td><pre>     * 审核状态</pre></td></tr><tr><td data-num="74"></td><td><pre>     */</pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> verifyStatus<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>完成上述步骤后，前端调用 HTTP 请求获取数据时，SpringMVC 通过 Jackson 进行序列化数据时，操作证件号码和手机号两个字段就会采用咱们自定义的序列化器，完成敏感信息脱敏功能。</p><h4 id="扩展思考"><a class="anchor" href="#扩展思考">#</a> 扩展思考</h4><p>对接前端的敏感数据脱敏展示功能做到上面这些就已经实现了。但是总感觉哪里不对，因为咱们在购票服务中，下单接口会调用乘车人详细信息接口获取到手机号、证件号等信息保存入库。</p><p><font color="red">如果我在后端服务里去调用乘车人的信息接口，那岂不是也是脱敏的？</font>这样的话，存储到数据库的数据就不准确了，期望是真实的数据，但是实际是脱敏后的。</p><p>基于这种真实情况，目前 12306 中的做法是<font color="red">拆分一个新的实体，叫做 <code>PassengerActualRespDTO</code> ，返回的信息是不脱敏的</font>。其实本质上就是复制了一个乘车人实体，但是在证件号和手机号字段上不添加 <code>@JsonSerialize</code> 注解，以此满足业务需求。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>resp</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonFormat</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token class-name">Accessors</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * 乘车人真实返回参数，不包含脱敏信息</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PassengerActualRespDTO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 乘车人 id</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * 用户名</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="27"></td><td><pre>     * 真实姓名</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> realName<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="32"></td><td><pre>     * 证件类型</pre></td></tr><tr><td data-num="33"></td><td><pre>     */</pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> idType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="37"></td><td><pre>     * 证件号码</pre></td></tr><tr><td data-num="38"></td><td><pre>     */</pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> idCard<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="42"></td><td><pre>     * 优惠类型</pre></td></tr><tr><td data-num="43"></td><td><pre>     */</pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> discountType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="47"></td><td><pre>     * 手机号</pre></td></tr><tr><td data-num="48"></td><td><pre>     */</pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="52"></td><td><pre>     * 添加日期</pre></td></tr><tr><td data-num="53"></td><td><pre>     */</pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">,</span> timezone <span class="token operator">=</span> <span class="token string">"GMT+8"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Date</span> createDate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="58"></td><td><pre>     * 审核状态</pre></td></tr><tr><td data-num="59"></td><td><pre>     */</pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> verifyStatus<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="敏感信息加密存储"><a class="anchor" href="#敏感信息加密存储">#</a> 敏感信息加密存储</h3><h4 id="需求背景"><a class="anchor" href="#需求背景">#</a> 需求背景</h4><p>安全控制一直是治理的重要环节，数据加密属于安全控制的范畴。 无论对互联网公司还是传统行业来说，数据安全一直是极为重视和敏感的话题。 数据加密是指对某些敏感信息通过加密规则进行数据的变形，实现敏感隐私数据的可靠保护。 涉及客户安全数据或者一些商业性敏感数据，如身份证号、手机号、卡号、客户号等个人信息按照相关部门规定，都需要进行数据加密。</p><p>对于数据加密的需求，在现实的业务场景中存在如下情况：</p><ul><li><font color="red">安全部门规定须将涉及用户敏感信息，例如银行、手机号码等进行加密后存储到数据库，在使用的时候再进行解密处理</font>。</li></ul><p>在真实业务场景中，相关业务开发团队则往往需要针对公司安全部门需求，<font color="red">自行实行并维护一套加解密系统</font>。 而当加密场景发生改变时，自行维护的加密系统往往又面临着重构或修改风险。 此外，对于已经上线的业务，在不修改业务逻辑和 SQL 的情况下，透明化、安全低风险地实现无缝进行加密改造也相对复杂。</p><h4 id="项目实战-3"><a class="anchor" href="#项目实战-3">#</a> 项目实战</h4><p>我们以用户表举例，用户表中存在证件号、手机号、邮箱以及地址等敏感字段，需要在数据库中进行加密存储。</p><p>代码实战查看 <code>/services/user-service</code> 。</p><h5 id="引入-shardingsphere"><a class="anchor" href="#引入-shardingsphere">#</a> 引入 ShardingSphere</h5><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>shardingsphere-jdbc-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="新增加密配置"><a class="anchor" href="#新增加密配置">#</a> 新增加密配置</h5><p>修改 <code>application.yaml</code> 配置文件，将数据库驱动变更为 ShardingSphere Driver。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> org.apache.shardingsphere.driver.ShardingSphereDriver</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>shardingsphere<span class="token punctuation">:</span>classpath<span class="token punctuation">:</span>shardingsphere<span class="token punctuation">-</span>config.yaml</pre></td></tr></table></figure><p>并配置 <code>shardingsphere-config.yaml</code> 相关配置。为了方便大家理解，我把分库分表的相关配置删除了，仅保留了加密相关的配置。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 配置数据源，底层被 ShardingSphere 进行了代理</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">dataSources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">ds_0</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/12306_user_0<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;rewriteBatchedStatements=true&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 数据加密存储规则</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">-</span> <span class="token tag">!ENCRYPT</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment"># 需要加密的表集合</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">tables</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token comment"># 用户表</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">t_user</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment"># 用户表中哪些字段需要进行加密</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">columns</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token comment"># 身份证字段，逻辑字段，不一定是在数据库中真实存在</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token key atrule">id_card</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment"># 身份证字段存储的密文字段，这个是数据库中真实存在的字段</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token key atrule">cipherColumn</span><span class="token punctuation">:</span> id_card</pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment"># 身份证字段加密算法</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token key atrule">encryptorName</span><span class="token punctuation">:</span> common_encryptor</pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token key atrule">phone</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token key atrule">cipherColumn</span><span class="token punctuation">:</span> phone</pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token key atrule">encryptorName</span><span class="token punctuation">:</span> common_encryptor</pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token key atrule">mail</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token key atrule">cipherColumn</span><span class="token punctuation">:</span> mail</pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token key atrule">encryptorName</span><span class="token punctuation">:</span> common_encryptor</pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token key atrule">address</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token key atrule">cipherColumn</span><span class="token punctuation">:</span> address</pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token key atrule">encryptorName</span><span class="token punctuation">:</span> common_encryptor</pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment"># 是否按照密文字段查询</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token key atrule">queryWithCipherColumn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment"># 加密算法</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token key atrule">encryptors</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token comment"># 自定义加密算法名称</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token key atrule">common_encryptor</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment"># 加密算法类型</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token key atrule">type</span><span class="token punctuation">:</span> AES</pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          <span class="token comment"># AES 加密密钥</span></pre></td></tr><tr><td data-num="44"></td><td><pre>          <span class="token key atrule">aes-key-value</span><span class="token punctuation">:</span> d6oadClrrb9A3GWo</pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr></table></figure><h5 id="效果展示"><a class="anchor" href="#效果展示">#</a> 效果展示</h5><p>咱们新插入一条用户信息，在应用程序里还是明文，经过 ShardingSphere 代理后，存储数据库时，就已经是密文的了。</p><p>原始 SQL：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">insert</span> <span class="token keyword">into</span> t_user <span class="token punctuation">(</span>id_card<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> mail<span class="token punctuation">,</span> address<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'34020xx023081xx338'</span><span class="token punctuation">,</span> <span class="token string">'1x60111xx983'</span><span class="token punctuation">,</span> <span class="token string">'mading@axxche.org'</span><span class="token punctuation">,</span> <span class="token string">'xx东城x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>修改后的 SQL：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">insert</span> <span class="token keyword">into</span> t_user <span class="token punctuation">(</span>id_card<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> mail<span class="token punctuation">,</span> address<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'YUvr+8Xf17VCgGonU2WXqmKuhB5FMazUEbh3y+h0B38='</span><span class="token punctuation">,</span> <span class="token string">'MZObk+5TeYPLHtP2A6+aiw=='</span><span class="token punctuation">,</span> <span class="token string">'vX/5iWTyfAvMJMt+ioipj9vd6cnZ4rz4qKBAXQ9C9oU='</span><span class="token punctuation">,</span> <span class="token string">'vX/5iWTyfAvMJMt+ioipj9vd6cnZ4rz4qKBAXQ9C9oU='</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>可能有小伙伴比较疑问，存储到数据库是密文，那查询时展示不就有问题了吗？<strong>ShardingSphere 在执行查询语句时，如果涉及到相关加密表，会自动将加密数据转换为明文数据</strong>，也就是会把 <code>YUvr+8Xf17VCgGonU2WXqmKuhB5FMazUEbh3y+h0B38=</code> 转换为 <code>34020xx023081xx338</code> 。</p><p>这样就能形成一个加密敏感信息落库闭环。</p><h4 id="实现原理"><a class="anchor" href="#实现原理">#</a> 实现原理</h4><p><font color="red">加密模块会拦截用户发起的 SQL ，并通过 SQL 语法解析器进行解析、理解 SQL 行为，再依据用户传入的加密规则，找出需要加密的字段和所使用的加解密算法对目标字段进行加解密处理后，再与底层数据库进行交互</font>。</p><p>Apache ShardingSphere 会将用户请求的明文进行加密后存储到底层数据库；并在用户查询时，将密文从数据库中取出进行解密后返回给终端用户。 通过屏蔽对数据的加密处理，使用户无需感知解析 SQL、数据加密、数据解密的处理过程，就像在使用普通数据一样使用加密数据。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414143144.png" alt="image.png"></p><h4 id="加密功能扩展"><a class="anchor" href="#加密功能扩展">#</a> 加密功能扩展</h4><p>如果大家理解了上面说的加密逻辑，我们假设有个新上线的业务，使用这种模型是完全没有问题的。但是，我们再深度思考个问题，<font color="red">如果说数据库表中已经有这种明文的敏感信息了，如何解决？</font></p><p>首先需要对这个敏感信息清洗成密文的数据，其次为了保障业务可能，需要是不停机清洗的那种。</p><p>参考链接：</p><p><a href="#%E5%A6%82%E4%BD%95%E4%B8%BA%E6%98%8E%E6%96%87%E7%9A%84%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86%E6%94%B9%E9%80%A0">如何为明文的敏感数据进行加密改造</a></p><p><span class="exturl" data-url="aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnL2RvY3VtZW50L2N1cnJlbnQvY24vcmVmZXJlbmNlL2VuY3J5cHQv">https://shardingsphere.apache.org/document/current/cn/reference/encrypt/</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnL2RvY3VtZW50L2N1cnJlbnQvY24vZmVhdHVyZXMvZW5jcnlwdC8=">https://shardingsphere.apache.org/document/current/cn/features/encrypt/</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9zaGFyZGluZ3NwaGVyZS5hcGFjaGUub3JnL2RvY3VtZW50L2N1cnJlbnQvY24vdXNlci1tYW51YWwvc2hhcmRpbmdzcGhlcmUtamRiYy95YW1sLWNvbmZpZy9ydWxlcy9lbmNyeXB0Lw==">https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-jdbc/yaml-config/rules/encrypt/</span></p><h3 id="乘车人模块开发"><a class="anchor" href="#乘车人模块开发">#</a> 乘车人模块开发</h3><h4 id="乘车人表结构"><a class="anchor" href="#乘车人表结构">#</a> 乘车人表结构</h4><p>以下表结构为乘车人原始表结构，而大家执行过建表语句后，看到数据库中大多为 <code>t_passenger_0-15</code> 的表名。这是因为，考虑到乘车人数据量过大，对乘车人表进行了分库分表处理。</p><p>UML 图见：<a href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%95%B0%E6%8D%AE">乘车人数据</a>。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240128004043880.png" alt="image-20240128004043880"></p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_passenger<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ID'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>real_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'真实姓名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>id_type<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'证件类型'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>id_card<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'证件号码'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>discount_type<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠类型'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>phone<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>create_date<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'添加日期'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>verify_status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'审核状态'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token identifier"><span class="token punctuation">`</span>del_flag<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'删除标识'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_id_card<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id_card<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'乘车人表'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="分库分表策略-2"><a class="anchor" href="#分库分表策略-2">#</a> 分库分表策略</h4><p>参见：<a href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%95%B0%E6%8D%AE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">乘车人数据分库分表</a></p><h4 id="敏感数据脱敏展示"><a class="anchor" href="#敏感数据脱敏展示">#</a> 敏感数据脱敏展示</h4><p>乘车人敏感信息，比如身份证、手机号等数据查询脱敏展示，相关参考：<a href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E8%84%B1%E6%95%8F%E5%B1%95%E7%A4%BA">敏感信息脱敏展示</a>。</p><h4 id="技术亮点"><a class="anchor" href="#技术亮点">#</a> 技术亮点</h4><p>本章节通过乘车人查询和修改接口，给大家带来 HTTP 接口防重复提交、SpEL、缓存与数据一致性等核心技术点。</p><h5 id="直连数据库"><a class="anchor" href="#直连数据库">#</a> 直连数据库</h5><p>根据用户名查询乘车人数据接口：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Controller</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/api/user-service/passenger/query"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">PassengerRespDTO</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">listPassengerQueryByUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>passengerService<span class="token punctuation">.</span><span class="token function">listPassengerQueryByUsername</span><span class="token punctuation">(</span><span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// Service Impl</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerRespDTO</span><span class="token punctuation">></span></span> <span class="token function">listPassengerQueryByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerDO</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerDO</span><span class="token punctuation">></span></span> passengerDOList <span class="token operator">=</span> passengerMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>passengerDOList<span class="token punctuation">,</span> <span class="token class-name">PassengerRespDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>修改乘车人相关信息接口：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Controller</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/api/user-service/passenger/update"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">updatePassenger</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PassengerReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    passengerService<span class="token punctuation">.</span><span class="token function">updatePassenger</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// Service Impl</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatePassenger</span><span class="token punctuation">(</span><span class="token class-name">PassengerReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">PassengerDO</span> passengerDO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">,</span> <span class="token class-name">PassengerDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerDO</span><span class="token punctuation">></span></span> updateWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token comment">// TODO 用户名和当前用户比对</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    passengerMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>passengerDO<span class="token punctuation">,</span> updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="http-防重复提交"><a class="anchor" href="#http-防重复提交">#</a> HTTP 防重复提交</h5><p>假设，我在新增乘车人时，快速且连续点击了两次或者多次，数据库中可能会出现多条一摸一样的数据，这就是重复提交问题。</p><h6 id="防重复提交是什么"><a class="anchor" href="#防重复提交是什么">#</a> 防重复提交是什么</h6><p>HTTP 接口防重复提交是一种机制，用于防止在某个请求还未完成处理或响应返回之前，重复提交相同的请求。防重复提交的目的是<font color="red">确保每个请求只被处理一次</font>，避免因重复提交而引起的数据重复处理、重复写入等问题。</p><p><font color="red">这种问题可以通过前端来一定程度上避免，比如发出一次请求后，请求没有响应就不让再点击</font>。类似于这种，如下图所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414202821.png" alt="image.png"></p><p>但是这只能一定程度上解决问题，因为如果绕过前端，直接请求后端接口，这个就起不到防护作用。</p><p>为了防止用户快速操作以及接口被恶意请求这种行为，需要针对购票接口做 HTTP 防重复提交处理。因为我们在<font color="red">前文已经针对 HTTP API 的防重复调用和消息队列的防重复消费做了封装，所以直接引入幂等组件库使用即可</font>。参考<a href="#==%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6==">接口幂等组件</a>：</p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/1710828294307-0a5fd82d-7334-4b46-836e-c0cfc40bcedc.png" alt="img"><h6 id="引入幂等组件"><a class="anchor" href="#引入幂等组件">#</a> 引入幂等组件</h6><p>在购票服务中引入幂等组件的 Maven Jar 坐标：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.opengoofy.index12306<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>index12306-idempotent-spirng-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">&lt;!-- 因为购票服务和幂等组件库使用的都是一个版本，直接取购票服务版本号即可 --></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;project.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h6 id="接口添加防重复提交的注解"><a class="anchor" href="#接口添加防重复提交的注解">#</a> 接口添加防重复提交的注解</h6><p>添加防重复提交注解之前，思考一个问题，防重复提交的运行原理是什么？是不是加一把锁就能解决了，运行原理如下所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414204112.png" alt="image.png"></p><p>我们在控制层新增乘车人接口上添加组件中的幂等注解（采用 SpEL 表达式方式），来防止请求的重复提交：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        uniqueKeyPrefix <span class="token operator">=</span> <span class="token string">"index12306-user:lock_passenger-alter:"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        key <span class="token operator">=</span> <span class="token string">"T(org.opengoofy.index12306.frameworks.starter.user.core.UserContext).getUsername()"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        type <span class="token operator">=</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">SPEL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        scene <span class="token operator">=</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">RESTAPI</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        message <span class="token operator">=</span> <span class="token string">"正在新增乘车人，请稍后再试..."</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/api/user-service/passenger/save"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">savePassenger</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PassengerReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    passengerService<span class="token punctuation">.</span><span class="token function">savePassenger</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>简单描述下这个注解的一些参数：</p><ul><li>scene：最开始和大家说过，组件库封了两种方案，HTTP 和消息队列，如果是 HTTP 选择使用 RESTAPI。</li><li>type：HTTP 防重复提交有多种实现方案，如何构建唯一标识呢？SPEL 就是通过 key 参数运行时生成。</li><li>key：<font color="red">SpEL 表达式</font>，运行时通过填写的 SpEL 表达式构建唯一的锁标识。</li><li>uniqueKeyPrefix：区分业务的前缀，<font color="red">拼接上 key 参数用来生成真正唯一的锁标识</font>。可不指定。</li><li>message：满足防重复提交条件后，开始触发抛异常行为，<font color="red">异常中的提示信息</font>。可不指定。</li></ul><p>SpEL 表达式的介绍可以参看 [SpEL 表达式](#SpEL 表达式)。</p><p>这里解析下上面这个接口的 SpEL 表达式的含义：通过 UserContext 容器获取当前登录用户的用户名。</p><pre><code>T(org.opengoofy.index12306.frameworks.starter.user.core.UserContext).getUsername()
</code></pre><h5 id="缓存与数据库的一致性"><a class="anchor" href="#缓存与数据库的一致性">#</a> 缓存与数据库的一致性</h5><h6 id="从缓存读取乘车人数据"><a class="anchor" href="#从缓存读取乘车人数据">#</a> 从缓存读取乘车人数据</h6><p>通过<a href="#%E7%9B%B4%E8%BF%9E%E6%95%B0%E6%8D%AE%E5%BA%93">直连数据库版本</a>得知，咱们<font color="red">根据用户名查询乘车人都是全部直接调用数据库的，这种模式在高并发海量流量的场景下，数据库会秒挂</font>。</p><p>为此，我们需要通过缓存来防止请求直接打到数据库。<strong>封装的缓存组件 <code>safeGet</code> 的作用就是：如果缓存中有，那么就从缓存中返回；如果缓存中没有，就查询数据库，并将查询数据库的结果同步到缓存中</strong>。</p><p>这里会涉及到一个缓存击穿的问题，底层原理具体可以看我们这篇文章：<a href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E4%B9%8B%E5%8F%8C%E9%87%8D%E5%88%A4%E5%AE%9A%E9%94%81%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%E6%80%A7%E8%83%BD%EF%BC%9F">缓存击穿之双重判定锁如何优化性能？</a>。总之，在这里我们<font color="red">使用 双重判定锁 来解决缓存击穿问题</font>。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     * 以一种 "安全" 的方式获取缓存，如查询结果为空，调用 &#123;@link CacheLoader&#125; 加载缓存</pre></td></tr><tr><td data-num="3"></td><td><pre>     * 通过此方式防止程序中可能出现的：缓存击穿、缓存雪崩场景，适用于不被外部直接调用的接口</pre></td></tr><tr><td data-num="4"></td><td><pre>     *</pre></td></tr><tr><td data-num="5"></td><td><pre>     * @param key              缓存 key</pre></td></tr><tr><td data-num="6"></td><td><pre>     * @param clazz            缓存 value 类型</pre></td></tr><tr><td data-num="7"></td><td><pre>     * @param cacheLoader      缓存加载器（当缓存不存在时，调用此方法查询数据库，并将查询结果存入缓存）</pre></td></tr><tr><td data-num="8"></td><td><pre>     * @param timeout          缓存超时时间</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @param timeUnit         缓存超时时间单位</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @param bloomFilter      布隆过滤器</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @param cacheGetFilter   缓存获取过滤器</pre></td></tr><tr><td data-num="12"></td><td><pre>     * @param cacheGetIfAbsent 缓存获取后置函数</pre></td></tr><tr><td data-num="13"></td><td><pre>     * @param &lt;T></pre></td></tr><tr><td data-num="14"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">safeGet</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> cacheLoader<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                         <span class="token class-name">RBloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> bloomFilter<span class="token punctuation">,</span> <span class="token class-name">CacheGetFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> cacheGetFilter<span class="token punctuation">,</span> <span class="token class-name">CacheGetIfAbsent</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> cacheGetIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 根据 key 从缓存中获取数据</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 缓存结果不是空或空字符串，则直接返回数据；</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 为了适配布隆过滤器无法删除的场景，通过函数判断是否返回空；</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 两者都不成立时，判断布隆过滤器是否存在，不存在返回空</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">isNullOrBlank</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token operator">||</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cacheGetFilter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> each<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token operator">||</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>bloomFilter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token operator">!</span>each<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 获取分布式锁</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">SAFE_GET_DISTRIBUTED_LOCK_KEY_PREFIX</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 双重判定锁，减轻获得分布式锁后线程访问数据库压力</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">isNullOrBlank</span><span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token comment">// 如果访问 cacheLoader （即数据库）仍然返回空，执行后置函数操作</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">isNullOrBlank</span><span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token function">loadAndSet</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> cacheLoader<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> timeUnit<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> bloomFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cacheGetIfAbsent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>each <span class="token operator">-></span> each<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>采用双重判定锁来防止缓存击穿问题后，根据用户查询乘车人的接口如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">CollUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson2<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>update<span class="token punctuation">.</span></span><span class="token class-name">LambdaUpdateWrapper</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">Wrappers</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">SqlHelper</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">RequiredArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>common<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">VerifyStatusEnum</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">PassengerDO</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">PassengerMapper</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>req<span class="token punctuation">.</span></span><span class="token class-name">PassengerRemoveReqDTO</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>req<span class="token punctuation">.</span></span><span class="token class-name">PassengerReqDTO</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>resp<span class="token punctuation">.</span></span><span class="token class-name">PassengerActualRespDTO</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>resp<span class="token punctuation">.</span></span><span class="token class-name">PassengerRespDTO</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">PassengerService</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">DistributedCache</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>common<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">BeanUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">ClientException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>convention<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">ServiceException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>frameworks<span class="token punctuation">.</span>starter<span class="token punctuation">.</span>user<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">UserContext</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">PlatformTransactionManager</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionDefinition</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionStatus</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">DefaultTransactionDefinition</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>opengoofy<span class="token punctuation">.</span>index12306<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>userservice<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">RedisKeyConstant</span><span class="token punctuation">.</span><span class="token static">USER_PASSENGER_LIST</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="41"></td><td><pre> * 乘车人接口实现层</pre></td></tr><tr><td data-num="42"></td><td><pre> */</pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PassengerServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">PassengerService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PassengerMapper</span> passengerMapper<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DistributedCache</span> distributedCache<span class="token punctuation">;</span> <span class="token comment">// 分布式缓存</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerRespDTO</span><span class="token punctuation">></span></span> <span class="token function">listPassengerQueryByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token comment">// 通过缓存获取乘车人列表</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token class-name">String</span> actualUserPassengerListStr <span class="token operator">=</span> <span class="token function">getActualUserPassengerListStr</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>actualUserPassengerListStr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> <span class="token class-name">PassengerDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> <span class="token class-name">PassengerRespDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getActualUserPassengerListStr</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token comment">// 通过双重判定锁来查询缓存、数据库，防止缓存击穿</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">return</span> distributedCache<span class="token punctuation">.</span><span class="token function">safeGet</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token constant">USER_PASSENGER_LIST</span> <span class="token operator">+</span> username<span class="token punctuation">,</span> <span class="token comment">// 缓存的 key（用户名）</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token comment">// 缓存的 value 类型</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 缓存加载器，当缓存不存在时，调用此方法查询数据库，并将查询结果存入缓存</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerDO</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerDO</span><span class="token punctuation">></span></span> passengerDOList <span class="token operator">=</span> passengerMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                    <span class="token keyword">return</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>passengerDOList<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>passengerDOList<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 缓存超时时间</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span> <span class="token comment">// 缓存超时时间单位</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>	<span class="token comment">// ......</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>思考一个问题，我们在抢票前，一般是不会查询乘车人数据的。那这就会造成一个问题，抢票时会有大量请求去读读取数据库获取乘车人信息，进而造成数据库压力增加。这种问题如何解决？</p><p>是否能够在节假日前，把所有用户的乘车人数据加载到缓存？</p><p>不行。因为这种数据信息会非常大，对 Redis 内存的压力会变大，并且这些数据不够精准，因为大部分不会进行购票使用。</p><p>我想到一个方案，那就是<font color="red">当用户登录 12306 系统时，可以执行一个异步任务，让这个异步任务去读取数据库的乘车人数据，并放入缓存</font>。这样的话，既不影响登录操作，又可以减轻高并发情况下数据库的负载，完美。</p><h6 id="乘车人数据发生变更时怎么办"><a class="anchor" href="#乘车人数据发生变更时怎么办">#</a> 乘车人数据发生变更时怎么办？</h6><p>既然我们已经把乘车人数据放到了缓存里，而且用户还能修改乘车人的数据信息。那就不得不面对一个问题，<strong>缓存和数据库的数据一致性如何保证？</strong></p><p>因为我们已经写了比较详细的缓存与数据库数据一致性文档，这里就不再赘述。直接说 **<font color="red">解决方案：先写数据库，后删除缓存</font>**。</p><p>具体的缓存与数据库一致性方案查看核心技术文档：<a href="#%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F">缓存与数据库一致性如何解决？</a>。</p><p>因此，修改乘车人相关信息接口的代码如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Controller</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     * 修改乘车人</pre></td></tr><tr><td data-num="4"></td><td><pre>     */</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span> <span class="token comment">// 幂等校验注解</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            uniqueKeyPrefix <span class="token operator">=</span> <span class="token string">"index12306-user:lock_passenger-alter:"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            key <span class="token operator">=</span> <span class="token string">"T(org.opengoofy.index12306.frameworks.starter.user.core.UserContext).getUsername()"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            type <span class="token operator">=</span> <span class="token class-name">IdempotentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">SPEL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            scene <span class="token operator">=</span> <span class="token class-name">IdempotentSceneEnum</span><span class="token punctuation">.</span><span class="token constant">RESTAPI</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            message <span class="token operator">=</span> <span class="token string">"正在修改乘车人，请稍后再试..."</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/api/user-service/passenger/update"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">updatePassenger</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PassengerReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        passengerService<span class="token punctuation">.</span><span class="token function">updatePassenger</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// Service Impl</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     * 修改乘车人（为了确保缓存与数据库的一致性，采用【先更新数据库，再删除缓存】的方式，因此需要使用事务）</pre></td></tr><tr><td data-num="21"></td><td><pre>     *</pre></td></tr><tr><td data-num="22"></td><td><pre>     * @param requestParam 乘车人信息</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatePassenger</span><span class="token punctuation">(</span><span class="token class-name">PassengerReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 定义事务</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">TransactionDefinition</span> transactionDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 开启一个事务</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">TransactionStatus</span> transactionStatus <span class="token operator">=</span> transactionManager<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>transactionDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 先修改数据库</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token class-name">PassengerDO</span> passengerDO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">,</span> <span class="token class-name">PassengerDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            passengerDO<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PassengerDO</span><span class="token punctuation">></span></span> updateWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span> <span class="token comment">// 根据用户名</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PassengerDO</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据乘车人 ID</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">int</span> updated <span class="token operator">=</span> passengerMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>passengerDO<span class="token punctuation">,</span> updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">SqlHelper</span><span class="token punctuation">.</span><span class="token function">retBool</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 更新失败</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s] 修改乘车人失败"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token comment">// 更新成功，提交事务</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            transactionManager<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>transactionStatus<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">ServiceException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;，请求参数：&#123;&#125;"</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] 修改乘车人失败，请求参数：&#123;&#125;"</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment">// 更新失败，回滚事务</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            transactionManager<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>transactionStatus<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">// 再删除缓存</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token function">delUserPassengerCache</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="乘车人数据分库分表"><a class="anchor" href="#乘车人数据分库分表">#</a> 乘车人数据分库分表</h3><p>分库分表的相关理论可以参考<a href="#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">用户数据分库分表</a>。</p><h4 id="乘车人数据分库分表策略"><a class="anchor" href="#乘车人数据分库分表策略">#</a> 乘车人数据分库分表策略</h4><p>由 UML 图可知，乘车人的数据严重依赖于用户数据。每个用户至少需要有一个对应的乘车人，即自己本人。当然，也有可能是其他人，因为允许用户注册账号后为他人购票的情况。这种关联确保了用户和乘车人之间的正确映射，使系统能够准确地处理购票和相关信息。</p><p>根据上述前提，让我们进行一些分析，来看看哪些因素会影响乘车人数据量：</p><ol><li>首先，每个用户至少会有一个对应的乘车人信息。因此，乘车人数据量至少等于用户数据量。</li><li>对于情侣购票用户，有两种情况：一种是普通场景下只有一人购票，另一种是在极端情况下，双方都添加乘车人信息，以便更方便地抢票。</li><li>家庭购票用户可能会在一次购票中为全家人购买车票。不过，也有可能其他家庭成员并没有注册 12306 账号。</li><li>职场购票用户中，可能会有一人代表多名员工出差，购买所有人员的车票。</li></ol><p>当然，上述因素并不能穷举所有情况。因此，在系统设计时，我们<font color="red">综合考虑各种情况得出一个经验值，即乘车人数据量约为用户数据量的 4 倍</font>。虽然这个估算可能不是完全准确，但我们希望能在容量规划时考虑到一定的宽裕余量。</p><p>对于分库分表容量评估，我们通常会尽可能地进行全面的评估。这样做的好处是，即使每张表的数据量不大，也能及早发现拆分后是否存在数据问题，以便及时进行调整和优化。</p><p>需要特别指出的是，我们对表数据量的考虑阈值相对较小，这是因为我们的系统具备良好的可扩展性，能够轻松应对大量的数据增长。因此，基于这样的分库分表策略，即使在几百年后，这个分库分表仍能处理数据且不会出现性能问题。这为我们的系统提供了稳定可靠的性能保障。</p><h4 id="选择乘车人分片键"><a class="anchor" href="#选择乘车人分片键">#</a> 选择乘车人分片键</h4><p>乘车人数据的查询必然会涉及到用户信息，而我们的用户表是按照 username 进行分片的。鉴于这些因素，我们决定将 <code>username</code> 作为乘车人表的分片键。</p><h4 id="改造乘车人分库分表"><a class="anchor" href="#改造乘车人分库分表">#</a> 改造乘车人分库分表</h4><h5 id="引入-shardingsphere-依赖"><a class="anchor" href="#引入-shardingsphere-依赖">#</a> 引入 ShardingSphere 依赖</h5><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>shardingsphere-jdbc-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h5 id="定义分片规则-2"><a class="anchor" href="#定义分片规则-2">#</a> 定义分片规则</h5><p>用户和乘车人都在 <code>user-service</code> 服务中，所以两者共用一个配置文件。</p><pre><code>spring:
  datasource:
  	# ShardingSphere 对 Driver 自定义，实现分库分表等隐藏逻辑
    driver-class-name: org.apache.shardingsphere.driver.ShardingSphereDriver
    # ShardingSphere 配置文件路径
    url: jdbc:shardingsphere:classpath:shardingsphere-config.yaml
</code></pre><p>配置文件的地址信息如下：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240414170320.png" alt="image.png"></p><h5 id="乘车人分片配置"><a class="anchor" href="#乘车人分片配置">#</a> 乘车人分片配置</h5><p>因为 12306 更多的是向大家演示分库分表，所以分 2 个库以及对应业务 16 张表。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 数据源集合</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">dataSources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">ds_0</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/12306_user_0<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;rewriteBatchedStatements=true&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">ds_1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">dataSourceClassName</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/12306_user_1<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;rewriteBatchedStatements=true&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">-</span> <span class="token tag">!SHARDING</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">tables</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">t_passenger</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment"># 真实数据节点，比如数据库源以及数据库在数据库中真实存在的</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds_$<span class="token punctuation">&#123;</span>0..1<span class="token punctuation">&#125;</span>.t_user_$<span class="token punctuation">&#123;</span>0..15<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment"># 分库策略</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token comment"># 用于单分片键的标准分片场景</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">standard</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment"># 分片键</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> username</pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token comment"># 分片算法，对应 rules [0].shardingAlgorithms</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> passenger_database_hash_mod</pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment"># 分表策略</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token comment"># 用于单分片键的标准分片场景</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token key atrule">standard</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token comment"># 分片键</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> username</pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment"># 分片算法，对应 rules [0].shardingAlgorithms</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> passenger_table_hash_mod</pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment"># 分片算法</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token key atrule">shardingAlgorithms</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token comment"># 数据库分片算法</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token key atrule">passenger_database_hash_mod</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment"># 根据分片键 Hash 分片</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token key atrule">type</span><span class="token punctuation">:</span> HASH_MOD</pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment"># 分片数量</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token key atrule">sharding-count</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token comment"># 数据表分片算法</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token key atrule">passenger_table_hash_mod</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment"># 根据分片键 Hash 分片</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token key atrule">type</span><span class="token punctuation">:</span> HASH_MOD</pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token comment"># 分片数量</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>          <span class="token key atrule">sharding-count</span><span class="token punctuation">:</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment"># 展现逻辑 SQL &amp; 真实 SQL</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token key atrule">props</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr></table></figure><p>写好以上配置后，就可以愉快使用数据库分库分表了。</p><p><code>props.sql-show</code> 配置尽量打开，它能打印应用的逻辑 SQL 以及真正查询数据库的真实 SQL。</p><h3 id="列车数据检索"><a class="anchor" href="#列车数据检索">#</a> 列车数据检索</h3><p>12306 项目中列车数据检索接口路径是： <code>TicketController#pageListTicketQuery</code> ，分为两个版本。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 车票控制层</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TicketController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TicketService</span> ticketService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * 根据条件，分页查询车票（这里调用的是 v1 版本的查询接口，不是 v2 高性能版本）</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/api/ticket-service/ticket/query"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketPageQueryRespDTO</span><span class="token punctuation">></span></span> <span class="token function">pageListTicketQuery</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Results</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>ticketService<span class="token punctuation">.</span><span class="token function">pageListTicketQueryV1</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="列车表结构"><a class="anchor" href="#列车表结构">#</a> 列车表结构</h4><p>与列车相关的表有：列车数据表 <code>t_train</code> 、车厢表 <code>t_carriage</code> 、车站表 <code>t_station</code> 、列车站点表 <code>t_train_station</code> 、列车站点关系表 <code>t_train_station_relation</code> 、列车站点价格表 <code>t_train_station_price</code> 、座位表 <code>t_seat</code> 。详细的表结构说明参见<a href="#%E5%88%97%E8%BD%A6%E7%AE%A1%E7%90%86">列车管理</a>。</p><p>对应的 UML 图如下所示：</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/image-20240128010858945.png" alt="image-20240128010858945"></p><h4 id="列车数据检索接口"><a class="anchor" href="#列车数据检索接口">#</a> 列车数据检索接口</h4><blockquote><p>这块存个疑，逻辑太复杂了...</p></blockquote><p>以下是 Service Impl 中根据条件，分页查询车票（版本 1）接口的代码：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     * 根据条件，分页查询车票（v1）</pre></td></tr><tr><td data-num="3"></td><td><pre>     *</pre></td></tr><tr><td data-num="4"></td><td><pre>     * @param requestParam 分页查询车票请求参数</pre></td></tr><tr><td data-num="5"></td><td><pre>     * @return 查询车票返回结果</pre></td></tr><tr><td data-num="6"></td><td><pre>     */</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">TicketPageQueryRespDTO</span> <span class="token function">pageListTicketQueryV1</span><span class="token punctuation">(</span><span class="token class-name">TicketPageQueryReqDTO</span> requestParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 责任链模式，车票查询过滤器，依次验证以下内容</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 1. 非空验证：出发地、目的地、出发日期不能为空</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 2. 基础数据验证：出发日期不能小于当前日期、出发地和目的地不能相同</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 3. 城市名称是否存在：出发地、目的地是否存在</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        ticketPageQueryAbstractChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">TRAIN_QUERY_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">)</span> distributedCache<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 列车查询逻辑较为复杂，详细解析文章查看 https://nageoffer.com/12306/question</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">//v1 版本存在严重的性能深渊问题，v2 版本完美的解决了该问题。通过 Jmeter 压测聚合报告得知，性能提升在 300% - 500%+</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> stationDetails <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">long</span> count <span class="token operator">=</span> stationDetails<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                stationDetails <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                count <span class="token operator">=</span> stationDetails<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StationDO</span><span class="token punctuation">></span></span> stationDOList <span class="token operator">=</span> stationMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">emptyWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> regionTrainStationMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    stationDOList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>each <span class="token operator">-></span> regionTrainStationMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getRegionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> regionTrainStationMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    stationDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    stationDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>regionTrainStationMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                    stationDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>regionTrainStationMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TicketListDTO</span><span class="token punctuation">></span></span> seatResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token class-name">String</span> buildRegionTrainStationHashKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> regionTrainStationAllMap <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>buildRegionTrainStationHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>regionTrainStationAllMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_REGION_TRAIN_STATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                regionTrainStationAllMap <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>buildRegionTrainStationHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>regionTrainStationAllMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationRelationDO</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">TrainStationRelationDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationRelationDO</span><span class="token operator">::</span><span class="token function">getStartRegion</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationRelationDO</span><span class="token operator">::</span><span class="token function">getEndRegion</span><span class="token punctuation">,</span> stationDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationRelationDO</span><span class="token punctuation">></span></span> trainStationRelationList <span class="token operator">=</span> trainStationRelationMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TrainStationRelationDO</span> each <span class="token operator">:</span> trainStationRelationList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                        <span class="token class-name">TrainDO</span> trainDO <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">safeGet</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                                <span class="token constant">TRAIN_INFO</span> <span class="token operator">+</span> each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                                <span class="token class-name">TrainDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> trainMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                                <span class="token constant">ADVANCE_TICKET_DAY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token class-name">TicketListDTO</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TicketListDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setTrainId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setTrainNumber</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setDepartureTime</span><span class="token punctuation">(</span><span class="token function">convertDateToLocalTime</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setArrivalTime</span><span class="token punctuation">(</span><span class="token function">convertDateToLocalTime</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getArrivalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setDuration</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">calculateHourDifference</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrivalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setDeparture</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setArrival</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setDepartureFlag</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setArrivalFlag</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getArrivalFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setTrainType</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setTrainBrand</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                            result<span class="token punctuation">.</span><span class="token function">setTrainTags</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getTrainTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                        <span class="token keyword">long</span> betweenDay <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span>DateUtil</span><span class="token punctuation">.</span><span class="token function">betweenDay</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getDepartureTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrivalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setDaysArrived</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> betweenDay<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setSaleStatus</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getSaleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                        result<span class="token punctuation">.</span><span class="token function">setSaleTime</span><span class="token punctuation">(</span><span class="token function">convertDateToLocalTime</span><span class="token punctuation">(</span>trainDO<span class="token punctuation">.</span><span class="token function">getSaleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MM-dd HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                        seatResults<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                        regionTrainStationAllMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheUtil</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>buildRegionTrainStationHashKey<span class="token punctuation">,</span> regionTrainStationAllMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        seatResults <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                <span class="token operator">?</span> regionTrainStationAllMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>each <span class="token operator">-></span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TicketListDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                <span class="token operator">:</span> seatResults<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        seatResults <span class="token operator">=</span> seatResults<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeStringComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TicketListDTO</span> each <span class="token operator">:</span> seatResults<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token class-name">String</span> trainStationPriceStr <span class="token operator">=</span> distributedCache<span class="token punctuation">.</span><span class="token function">safeGet</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">TRAIN_STATION_PRICE</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">></span></span> trainStationPriceQueryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token operator">::</span><span class="token function">getDeparture</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token operator">::</span><span class="token function">getArrival</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TrainStationPriceDO</span><span class="token operator">::</span><span class="token function">getTrainId</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>trainStationPriceMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>trainStationPriceQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                    <span class="token constant">ADVANCE_TICKET_DAY</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span></pre></td></tr><tr><td data-num="105"></td><td><pre>            <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">></span></span> trainStationPriceDOList <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>trainStationPriceStr<span class="token punctuation">,</span> <span class="token class-name">TrainStationPriceDO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeatClassDTO</span><span class="token punctuation">></span></span> seatClassList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>            trainStationPriceDOList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                <span class="token class-name">String</span> seatType <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSeatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                <span class="token class-name">Object</span> quantityObj <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">TRAIN_STATION_REMAINING_TICKET</span> <span class="token operator">+</span> keySuffix<span class="token punctuation">,</span> seatType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                <span class="token keyword">int</span> quantity <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>quantityObj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token operator">::</span><span class="token function">toString</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">parseInt</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> seatMarginMap <span class="token operator">=</span> seatMarginCacheLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getTrainId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seatType<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getDeparture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getArrival</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>                            <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>seatMarginMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSeatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">parseInt</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>                seatClassList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SeatClassDTO</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSeatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantity<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>            each<span class="token punctuation">.</span><span class="token function">setSeatClassList</span><span class="token punctuation">(</span>seatClassList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">TicketPageQueryRespDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">trainList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="125"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">departureStationList</span><span class="token punctuation">(</span><span class="token function">buildDepartureStationList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="126"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">arrivalStationList</span><span class="token punctuation">(</span><span class="token function">buildArrivalStationList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="127"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">trainBrandList</span><span class="token punctuation">(</span><span class="token function">buildTrainBrandList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">seatClassTypeList</span><span class="token punctuation">(</span><span class="token function">buildSeatClassList</span><span class="token punctuation">(</span>seatResults<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="129"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="责任链模式验证请求参数"><a class="anchor" href="#责任链模式验证请求参数">#</a> 责任链模式验证请求参数</h5><p>上述接口的第一行代码，就是通过责任链模式来验证车票查询的请求参数，包括非空验证、基础数据验证、城市名称是否存在。详情可以查看<a href="#%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E4%B8%AD%E5%BA%94%E7%94%A8%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F">具体业务中应用责任链模式</a>。</p><p><s>如果对责任链模式不太熟悉的小伙伴，欢迎查看 <span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL21hZ2VzdGFjay8xMjMwNi9nZ2cydHh6YmZnZnFwNnRt">手摸手之实现用户购票责任链验证</span> 了解前置知识。</s></p><p>非常简单的一行代码，通过责任链上下文容器，按序依次调用<a href="#%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E7%9A%84%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%B1%BB">具体业务的责任链处理器实现类</a>：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>ticketPageQueryAbstractChainContext<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">TicketChainMarkEnum</span><span class="token punctuation">.</span><span class="token constant">TRAIN_QUERY_FILTER</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h5 id="加载城市数据"><a class="anchor" href="#加载城市数据">#</a> 加载城市数据</h5><p>12306 站点查询实际功能中，比如你搜索了北京南到杭州东的搜索条件，它会帮你列出北京到杭州所有的列车车次。这个很好实现，<font color="red">直接通过站点关联到城市，通过城市查询列车即可</font>。</p><p><font color="red">在 Redis 缓存中，有一个 Hash 结构数据，专门负责保存列车站点 Code 值与城市之间的关联关系</font>。可能很多老板会问，为什么列车站点存的是 Code 值，城市存的是名称？这个是为了方便大家查看，最初写 MySQL 数据库中的记录都是使用城市名称，而不是 Code 值，所以大家知道即可。</p><p><img data-src="https://raw.githubusercontent.com/hjx159/picture-bed/main/img/20240417135109.png" alt="image.png"></p><p>城市数据加载逻辑如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 通过批量查询方式获取出发站点和到达站点对应的城市集合</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> stationDetails <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 判断为空问题，同上验证查询数据</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">long</span> count <span class="token operator">=</span> stationDetails<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 如果城市数据为空，代表缓存中没有这个值，需要从数据库加载</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 避免缓存击穿，通过分布式锁方式解决该问题</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 双重判定锁，规避数据库无效请求</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        stationDetails <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        count <span class="token operator">=</span> stationDetails<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token comment">// 查询列车站点数据与城市信息</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StationDO</span><span class="token punctuation">></span></span> stationDOList <span class="token operator">=</span> stationMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">emptyWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> regionTrainStationMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            stationDOList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>each <span class="token operator">-></span> regionTrainStationMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>each<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getRegionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">// 通过 putAll 批量保存方式存入 Redis，避免多次 put 网络 IO 消耗</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">REGION_TRAIN_STATION_MAPPING</span><span class="token punctuation">,</span> regionTrainStationMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            stationDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            stationDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>regionTrainStationMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getFromStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            stationDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>regionTrainStationMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">.</span><span class="token function">getToStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="面试系列"><a class="anchor" href="#面试系列">#</a> 面试系列</h1><h2 id="如何写在简历上-内推"><a class="anchor" href="#如何写在简历上-内推">#</a> 如何写在简历上 &amp; 内推</h2><h2 id="面经"><a class="anchor" href="#面经">#</a> 面经</h2><h2 id="常见问题与解答"><a class="anchor" href="#常见问题与解答">#</a> 常见问题与解答</h2><h1 id="项目启动中的常见问题"><a class="anchor" href="#项目启动中的常见问题">#</a> 项目启动中的常见问题</h1></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-04-17 14:00:04" itemprop="dateModified" datetime="2024-04-17T14:00:04+08:00">2024-04-17</time> </span><span id="project/railway/12306项目学习笔记/" class="item leancloud_visitors" data-flag-title="12306项目学习笔记" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>范特东东东 <i class="ic i-at"><em>@</em></i>水文 & 摄影</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/project/railway/12306%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="12306项目学习笔记">http://example.com/project/railway/12306项目学习笔记/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/distributed-microservices/API%E7%BD%91%E5%85%B3&SpringCloud%20Gateway/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;hjx159&#x2F;picture-bed&#x2F;main&#x2F;img&#x2F;spring-cloud-gateway-workflow.png" title="API网关 &amp; SpringCloud Gateway"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 分布式微服务</span><h3>API网关 & SpringCloud Gateway</h3></a></div><div class="item right"><a href="/docker/docker-javaguide/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;65a9ebfb871b83018a3cb132.jpg" title="docker-javaguide"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> docker</span><h3>docker-javaguide</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">项目介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">项目简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E9%80%89%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">技术架构选型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.</span> <span class="toc-text">接口文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF"><span class="toc-number">1.4.</span> <span class="toc-text">学习路线</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%BA%93%E5%BC%80%E5%8F%91"><span class="toc-number">1.4.1.</span> <span class="toc-text">组件库开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86"><span class="toc-number">1.4.2.</span> <span class="toc-text">业务梳理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91"><span class="toc-number">1.4.3.</span> <span class="toc-text">系统开发</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">2.</span> <span class="toc-text">快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%8B%E9%9A%86%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.1.</span> <span class="toc-text">克隆项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">拉取项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97%E5%88%97%E8%A1%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">服务模块列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#springboot-%E5%8D%95%E4%BD%93%E7%89%88%E6%9C%AC"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">SpringBoot 单体版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#springcloud-%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%88%E6%9C%AC"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">SpringCloud 分布式版本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.3.</span> <span class="toc-text">项目工程的目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-jdk-%E7%89%88%E6%9C%AC"><span class="toc-number">2.1.4.</span> <span class="toc-text">设置 JDK 版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.2.</span> <span class="toc-text">数据库初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-mysql-5736"><span class="toc-number">2.2.1.</span> <span class="toc-text">安装 MySQL 5.7.36</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-navicat-idea-%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.2.2.</span> <span class="toc-text">通过 Navicat &#x2F; IDEA 建立数据库连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.3.</span> <span class="toc-text">建库建表 &amp; 初始化数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E4%B8%AD%E4%B8%8E-mysql-%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.4.</span> <span class="toc-text">修改项目代码中与 MySQL 相关的配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%90%8E%E7%AB%AF%E7%8E%AF%E5%A2%83%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.3.</span> <span class="toc-text">安装后端环境（中间件）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%E4%BA%91%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">2.3.1.</span> <span class="toc-text">方式一：云中间件环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BA%91%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%9F%9F%E5%90%8D"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">获取云中间件的域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-vm-%E5%8F%82%E6%95%B0"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">添加 VM 参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%E5%9C%A8-linux-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.2.</span> <span class="toc-text">方式二：在 Linux 服务器上安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-latest"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">Redis Latest</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rocketmq-451"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">RocketMQ 4.5.1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-nameserver"><span class="toc-number">2.3.2.2.1.</span> <span class="toc-text">安装 NameServer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-brocker"><span class="toc-number">2.3.2.2.2.</span> <span class="toc-text">安装 Brocker</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-rocketmq-%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">2.3.2.2.3.</span> <span class="toc-text">安装 rocketmq 控制台</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nacos-212"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">Nacos 2.1.2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-vm-%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">添加 VM 启动参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%90%8E%E7%AB%AF"><span class="toc-number">2.4.</span> <span class="toc-text">启动后端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-gateway-service-%E9%85%8D%E7%BD%AE%E4%B8%BA%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">将 gateway-service 配置为分布式方式启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.4.2.</span> <span class="toc-text">启动后端服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">2.4.3.</span> <span class="toc-text">登录中间件控制台</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83nodejs"><span class="toc-number">2.5.</span> <span class="toc-text">安装前端环境（Nodejs）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%89%8D%E7%AB%AF"><span class="toc-number">2.6.</span> <span class="toc-text">启动前端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%B0%83%E8%AF%95"><span class="toc-number">2.7.</span> <span class="toc-text">问题调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pay-service-%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84-payserviceapplicationjava-%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%AB"><span class="toc-number">2.7.1.</span> <span class="toc-text">pay-service 目录下的 PayServiceApplication.java 启动类无法识别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-pay-service-%E6%97%B6%E9%81%87%E5%88%B0-tomcat-%E7%89%88%E6%9C%AC%E4%B8%8D%E5%85%BC%E5%AE%B9%E7%9A%84-erroran-incompatible-version-1231-of-the-apache-tomcat-native-library-is-installed-while-tomcat-requires-version-1234"><span class="toc-number">2.7.2.</span> <span class="toc-text">启动 pay-service 时遇到 Tomcat 版本不兼容的 ERROR：An incompatible version [1.2.31] of the Apache Tomcat Native library is installed, while Tomcat requires version [1.2.34]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-pay-service-%E6%97%B6%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96-hikari-%E6%B1%A0%E6%97%B6%E9%81%87%E5%88%B0-errorhikaripool-3-exception-during-pool-initialization"><span class="toc-number">2.7.3.</span> <span class="toc-text">启动 pay-service 时在初始化 hikari 池时遇到 ERROR：HikariPool-3 - Exception during pool initialization.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#windows-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%94%AF%E4%BB%98%E6%9C%8D%E5%8A%A1%E6%97%B6%E6%8A%A5%E9%94%99-command-line-is-too-long-shorten-the-command-line-and-rerun"><span class="toc-number">2.7.4.</span> <span class="toc-text">Windows 系统启动支付服务时报错 Command line is too long Shorten the command line and rerun</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3%E6%97%A0%E6%B3%95%E9%80%9A%E8%BF%87-docker-%E8%BF%90%E8%A1%8C-mysql"><span class="toc-number">2.7.5.</span> <span class="toc-text">Linux 服务器的磁盘空间不足，无法通过 docker 运行 MySQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%B0%86-12306-%E9%83%A8%E7%BD%B2%E5%9C%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A"><span class="toc-number">2.8.</span> <span class="toc-text">如何将 12306 部署在云服务器上？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.8.1.</span> <span class="toc-text">准备云服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E6%94%BE%E9%98%B2%E7%81%AB%E5%A2%99%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.8.2.</span> <span class="toc-text">开放防火墙端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-number">2.8.3.</span> <span class="toc-text">云服务器环境安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jdk-%E7%8E%AF%E5%A2%83"><span class="toc-number">2.8.3.1.</span> <span class="toc-text">JDK 环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-%E8%BD%AF%E4%BB%B6"><span class="toc-number">2.8.3.2.</span> <span class="toc-text">Nginx 软件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.8.4.</span> <span class="toc-text">项目打包上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E7%BD%91%E5%85%B3%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.8.4.1.</span> <span class="toc-text">聚合 &amp; 网关项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.8.4.2.</span> <span class="toc-text">前端项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">2.8.4.3.</span> <span class="toc-text">安装中间件环境</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.8.5.</span> <span class="toc-text">启动项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.8.5.1.</span> <span class="toc-text">启动后端项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-%E6%8C%82%E8%BD%BD%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.8.5.2.</span> <span class="toc-text">Nginx 挂载前端项目</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E7%BD%91%E8%AE%BF%E9%97%AE"><span class="toc-number">2.8.6.</span> <span class="toc-text">公网访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE%E6%A6%82%E8%A6%81"><span class="toc-number">3.</span> <span class="toc-text">用户体系建设概要</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">业务分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E5%91%98%E7%94%A8%E6%88%B7"><span class="toc-number">3.1.1.</span> <span class="toc-text">会员用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA"><span class="toc-number">3.1.2.</span> <span class="toc-text">乘车人</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%9A%BE%E7%82%B9"><span class="toc-number">3.2.</span> <span class="toc-text">业务难点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E4%BF%A1%E6%81%AF%E7%9C%9F%E5%AE%9E"><span class="toc-number">3.2.1.</span> <span class="toc-text">如何确定信息真实</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E5%8D%81%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E9%87%8F"><span class="toc-number">3.2.2.</span> <span class="toc-text">数十亿级数据量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E5%91%98%E5%A4%9A%E7%A7%8D%E7%99%BB%E5%BD%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.2.3.</span> <span class="toc-text">会员多种登录类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">3.2.4.</span> <span class="toc-text">用户注册缓存穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%A9%BF%E9%80%8F%E5%9C%BA%E6%99%AF"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">用户注册穿透场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%8F%8A%E5%85%B6%E5%BC%8A%E7%AB%AF"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">常见解决方案及其弊端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2"><span class="toc-number">3.2.5.</span> <span class="toc-text">敏感信息泄露</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0"><span class="toc-number">4.</span> <span class="toc-text">中间件学习</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3"><span class="toc-number">5.</span> <span class="toc-text">核心技术文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E7%94%9F%E6%88%90%E5%88%86%E5%B8%83%E5%BC%8F-id"><span class="toc-number">5.1.</span> <span class="toc-text">雪花算法生成分布式 ID</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95snowflake"><span class="toc-number">5.1.1.</span> <span class="toc-text">雪花算法（Snowflake）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E6%88%90"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">适用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90-id-%E9%87%8D%E5%A4%8D%E9%97%AE%E9%A2%98"><span class="toc-number">5.1.2.</span> <span class="toc-text">生成 ID 重复问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E8%AF%86%E4%BD%8D%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">标识位如何定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E6%A0%87%E8%AF%86%E4%BD%8D"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">分配标识位</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%84%E5%88%86%E9%85%8D"><span class="toc-number">5.1.2.2.1.</span> <span class="toc-text">预分配</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%88%86%E9%85%8D"><span class="toc-number">5.1.2.2.2.</span> <span class="toc-text">动态分配</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E5%88%86%E5%B8%83%E5%BC%8F-id-%E6%A1%86%E6%9E%B6"><span class="toc-number">5.1.3.</span> <span class="toc-text">开源分布式 ID 框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-number">5.1.4.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%85%A8%E5%B1%80%E6%8B%A6%E6%88%AA%E5%BC%82%E5%B8%B8"><span class="toc-number">5.2.</span> <span class="toc-text">如何全局拦截异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">5.2.1.</span> <span class="toc-text">异常是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB"><span class="toc-number">5.2.2.</span> <span class="toc-text">异常分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%BC%82%E5%B8%B8"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">抽象异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E5%B8%B8"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">客户端异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E5%B8%B8"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">服务端异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%BC%82%E5%B8%B8"><span class="toc-number">5.2.2.4.</span> <span class="toc-text">远程调用异常</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E7%A0%81%E5%AE%9A%E4%B9%89"><span class="toc-number">5.2.3.</span> <span class="toc-text">异常码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%A0%81"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">如何定义异常码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">异常码示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E7%A0%81%E5%B0%8F%E7%BB%93"><span class="toc-number">5.2.3.3.</span> <span class="toc-text">异常码小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8"><span class="toc-number">5.2.4.</span> <span class="toc-text">统一处理异常</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%90%8E%E7%AB%AF%E5%BA%94%E7%94%A8%E7%9A%84%E5%85%A8%E5%B1%80%E5%93%8D%E5%BA%94%E5%AF%B9%E8%B1%A1"><span class="toc-number">5.3.</span> <span class="toc-text">抽象后端应用的全局响应对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E5%93%8D%E5%BA%94%E5%AF%B9%E8%B1%A1"><span class="toc-number">5.3.1.</span> <span class="toc-text">定义全局响应对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A5%BD%E5%A4%84"><span class="toc-number">5.3.2.</span> <span class="toc-text">好处</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E7%A0%81"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">返回码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%B6%88%E6%81%AF"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">返回消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">返回数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82id"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">请求 ID</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%9F%E5%AE%9E%E8%AF%B7%E6%B1%82%E6%A1%88%E4%BE%8B"><span class="toc-number">5.3.3.</span> <span class="toc-text">真实请求案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hutool%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8builder%E6%A8%A1%E5%BC%8F%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">5.4.</span> <span class="toc-text">Hutool 如何使用 Builder 模式创建线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">5.4.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#builder-%E6%A8%A1%E5%BC%8F%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">5.4.2.</span> <span class="toc-text">Builder 模式应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hutool-builder-%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">5.4.3.</span> <span class="toc-text">Hutool Builder 创建线程池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#builder-%E6%A8%A1%E5%BC%8F%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">5.4.4.</span> <span class="toc-text">Builder 模式不同的实现方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-3"><span class="toc-number">5.4.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">5.5.</span> <span class="toc-text">责任链模式是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">5.5.1.</span> <span class="toc-text">责任链模式的概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E4%B8%80%E6%89%80%E6%9C%89%E5%A4%84%E7%90%86%E5%99%A8%E9%83%BD%E8%BF%87%E4%B8%80%E9%81%8D"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">类型一：所有处理器都过一遍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E4%BA%8C%E6%9F%90%E4%B8%80%E5%A4%84%E7%90%86%E5%99%A8%E5%8F%91%E7%94%9F%E9%98%BB%E6%96%AD%E5%89%A9%E4%BD%99%E5%A4%84%E7%90%86%E5%99%A8%E4%B8%8D%E5%86%8D%E6%89%A7%E8%A1%8C"><span class="toc-number">5.5.1.2.</span> <span class="toc-text">类型二：某一处理器发生阻断，剩余处理器不再执行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.5.2.</span> <span class="toc-text">责任链业务场景设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">5.5.3.</span> <span class="toc-text">责任链模式的好处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B5%E5%95%86%E4%B8%8B%E5%8D%95%E5%9C%BA%E6%99%AF%E5%AE%9E%E6%88%98"><span class="toc-number">5.5.4.</span> <span class="toc-text">电商下单场景实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E5%8D%95%E5%89%8D%E7%BD%AE%E6%A0%A1%E9%AA%8C"><span class="toc-number">5.5.4.1.</span> <span class="toc-text">下单前置校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E9%87%8D%E6%9E%84"><span class="toc-number">5.5.4.2.</span> <span class="toc-text">责任链重构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mybatis-interceptor-%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.5.5.</span> <span class="toc-text">Mybatis Interceptor 底层实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.6.</span> <span class="toc-text">如何抽象责任链模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.6.1.</span> <span class="toc-text">抽象责任链处理器接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E4%B8%8A%E4%B8%8B%E6%96%87%E7%B1%BB"><span class="toc-number">5.6.2.</span> <span class="toc-text">抽象责任链上下文类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E4%B8%AD%E5%BA%94%E7%94%A8%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.6.3.</span> <span class="toc-text">具体业务中应用责任链模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E7%9A%84%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.6.3.1.</span> <span class="toc-text">具体业务的责任链处理器接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E7%9A%84%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">5.6.3.2.</span> <span class="toc-text">具体业务的责任链处理器实现类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E7%A9%BA%E9%AA%8C%E8%AF%81-%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">5.6.3.2.1.</span> <span class="toc-text">非空验证 - 责任链处理器实现类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81-%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">5.6.3.2.2.</span> <span class="toc-text">基础数据验证 - 责任链处理器实现类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%8E%E5%B8%82%E5%AD%98%E5%9C%A8%E9%AA%8C%E8%AF%81-%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">5.6.3.2.3.</span> <span class="toc-text">城市存在验证 - 责任链处理器实现类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E4%B8%AD%E8%B0%83%E7%94%A8"><span class="toc-number">5.6.3.3.</span> <span class="toc-text">在具体业务逻辑中调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">5.7.</span> <span class="toc-text">策略模式是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">5.7.1.</span> <span class="toc-text">策略模式的概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.7.2.</span> <span class="toc-text">策略模式示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E7%9C%9F%E5%AE%9E%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">5.7.3.</span> <span class="toc-text">项目中的真实应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">5.7.4.</span> <span class="toc-text">策略模式的优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%BA%94%E7%94%A8"><span class="toc-number">5.7.5.</span> <span class="toc-text">框架源码中的设计模式应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-4"><span class="toc-number">5.7.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8A%BD%E8%B1%A1%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.8.</span> <span class="toc-text">如何抽象策略模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-dubbo-%E5%AE%9E%E7%8E%B0%E5%BF%AB%E9%80%9F%E6%B6%88%E8%B4%B9%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">5.9.</span> <span class="toc-text">参考 Dubbo 实现快速消费线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%8F%8A%E5%8F%82%E6%95%B0"><span class="toc-number">5.9.1.</span> <span class="toc-text">线程池的构造方法及参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">5.9.2.</span> <span class="toc-text">线程池执行任务的流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dubbo-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%BF%AB%E9%80%9F%E6%B6%88%E8%B4%B9"><span class="toc-number">5.9.3.</span> <span class="toc-text">❓Dubbo 中实现的快速消费</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-mybatis-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9D%A5%E6%89%A9%E5%B1%95%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="toc-number">5.10.</span> <span class="toc-text">参考 Mybatis 动态代理来扩展拒绝策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%8B%92%E7%BB%9D%E6%B5%81%E7%A8%8B"><span class="toc-number">5.10.1.</span> <span class="toc-text">任务拒绝流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.10.2.</span> <span class="toc-text">代理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">5.10.2.1.</span> <span class="toc-text">扩展线程池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="toc-number">5.10.2.2.</span> <span class="toc-text">扩展拒绝策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">5.10.3.</span> <span class="toc-text">静态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">5.10.4.</span> <span class="toc-text">❓动态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86"><span class="toc-number">5.10.5.</span> <span class="toc-text">动态代理扩展知识</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E5%A6%82%E4%BD%95%E5%80%9F%E5%8A%A9%E5%B9%82%E7%AD%89%E6%A0%A1%E9%AA%8C%E6%9D%A5%E8%A7%A3%E5%86%B3%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98"><span class="toc-number">5.11.</span> <span class="toc-text">消息队列中如何借助幂等校验来解决重复消费问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">5.11.1.</span> <span class="toc-text">问题背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">5.11.2.</span> <span class="toc-text">消息幂等性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.11.3.</span> <span class="toc-text">幂等设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E9%80%BB%E8%BE%91"><span class="toc-number">5.11.3.1.</span> <span class="toc-text">消息发送逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">5.11.3.2.</span> <span class="toc-text">❓幂等处理逻辑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%B9%82%E7%AD%89%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6"><span class="toc-number">5.11.4.</span> <span class="toc-text">抽象幂等通用组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%B9%82%E7%AD%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.11.4.1.</span> <span class="toc-text">定义幂等注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-aop-%E5%A2%9E%E5%BC%BA"><span class="toc-number">5.11.4.2.</span> <span class="toc-text">定义 AOP 增强</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="toc-number">5.11.4.3.</span> <span class="toc-text">在项目中使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%A4%8D%E6%9D%82%E7%9A%84%E5%B9%82%E7%AD%89%E5%9C%BA%E6%99%AF"><span class="toc-number">5.11.5.</span> <span class="toc-text">更复杂的幂等场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E4%BB%B7%E5%80%BC"><span class="toc-number">5.11.5.1.</span> <span class="toc-text">通用方法实现价值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8E%BB%E9%87%8D%E7%9A%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">5.11.5.2.</span> <span class="toc-text">消息去重的建议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-5"><span class="toc-number">5.11.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%B8%BA%E6%98%8E%E6%96%87%E7%9A%84%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86%E6%94%B9%E9%80%A0"><span class="toc-number">5.12.</span> <span class="toc-text">如何为明文的敏感数据进行加密改造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E8%83%8C%E6%99%AF"><span class="toc-number">5.12.1.</span> <span class="toc-text">业务背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E9%80%89%E5%9E%8B"><span class="toc-number">5.12.2.</span> <span class="toc-text">技术方案选型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-shardingsphere"><span class="toc-number">5.12.2.1.</span> <span class="toc-text">1、ShardingSphere</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86"><span class="toc-number">5.12.2.1.1.</span> <span class="toc-text">加密原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E8%A7%84%E5%88%99"><span class="toc-number">5.12.2.1.2.</span> <span class="toc-text">加密规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">5.12.2.1.3.</span> <span class="toc-text">举例说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%80%E5%8F%91"><span class="toc-number">5.12.2.2.</span> <span class="toc-text">2、自定义开发</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E5%AE%9E%E6%96%BD"><span class="toc-number">5.12.3.</span> <span class="toc-text">数据加密实施</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="toc-number">5.12.3.1.</span> <span class="toc-text">准备阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5"><span class="toc-number">5.12.3.2.</span> <span class="toc-text">开发阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E6%B4%97%E9%98%B6%E6%AE%B5"><span class="toc-number">5.12.3.3.</span> <span class="toc-text">清洗阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E9%98%B6%E6%AE%B5"><span class="toc-number">5.12.3.4.</span> <span class="toc-text">切换阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E5%AE%8C%E6%88%90"><span class="toc-number">5.12.3.5.</span> <span class="toc-text">最终完成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">5.12.4.</span> <span class="toc-text">问题解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sql-%E8%A7%A3%E6%9E%90%E5%99%A8%E9%A2%84%E7%83%AD"><span class="toc-number">5.12.4.1.</span> <span class="toc-text">SQL 解析器预热</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97%E4%B8%8D%E8%AF%86%E5%88%AB"><span class="toc-number">5.12.4.2.</span> <span class="toc-text">关键字不识别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql-%E4%B8%AD%E7%9A%84%E4%B8%8D%E5%85%BC%E5%AE%B9%E9%A1%B9"><span class="toc-number">5.12.4.3.</span> <span class="toc-text">SQL 中的不兼容项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-6"><span class="toc-number">5.12.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E4%B9%8B%E5%8F%8C%E9%87%8D%E5%88%A4%E5%AE%9A%E9%94%81%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%E6%80%A7%E8%83%BD"><span class="toc-number">5.13.</span> <span class="toc-text">缓存击穿之双重判定锁如何优化性能？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E7%9A%84%E6%A6%82%E5%BF%B5%E4%BB%A5%E5%8F%8A%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">5.13.1.</span> <span class="toc-text">缓存击穿的概念以及常见解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="toc-number">5.13.2.</span> <span class="toc-text">如何解决缓存击穿问题？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%97%B6%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.13.2.1.</span> <span class="toc-text">方案一：查询缓存不存在时，请求数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E4%BA%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">5.13.2.2.</span> <span class="toc-text">思路二：分布式锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E4%B8%89%E5%8F%8C%E9%87%8D%E5%88%A4%E5%AE%9A%E9%94%81"><span class="toc-number">5.13.2.3.</span> <span class="toc-text">思路三：双重判定锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-7"><span class="toc-number">5.13.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3"><span class="toc-number">5.14.</span> <span class="toc-text">缓存与数据库的一致性如何解决？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-number">5.14.1.</span> <span class="toc-text">背景知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E7%BC%93%E5%AD%98%E4%BB%A5%E6%8F%90%E9%AB%98%E8%AF%BB%E6%80%A7%E8%83%BD"><span class="toc-number">5.14.1.1.</span> <span class="toc-text">引入缓存以提高读性能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%88%A9%E7%94%A8%E7%8E%87-%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">5.14.1.2.</span> <span class="toc-text">缓存利用率 &amp; 数据一致性问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E5%BC%95%E8%B5%B7%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">5.14.1.3.</span> <span class="toc-text">并发引起的一致性问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%E4%B9%9F%E4%B8%8D%E4%B8%80%E5%AE%9A%E4%BF%9D%E8%AF%81%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">5.14.1.4.</span> <span class="toc-text">删除缓存也不一定保证一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%BC%93%E5%AD%98%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%B8%A4%E6%AD%A5%E6%93%8D%E4%BD%9C%E9%83%BD%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F"><span class="toc-number">5.14.1.5.</span> <span class="toc-text">如何保证缓存和数据库的两步操作都执行成功</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%BA%93%E5%BB%B6%E8%BF%9F-%E5%BB%B6%E8%BF%9F%E5%8F%8C%E5%88%A0%E9%97%AE%E9%A2%98"><span class="toc-number">5.14.1.6.</span> <span class="toc-text">主从库延迟 &amp; 延迟双删问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E4%B8%80%E8%87%B4%E5%BE%88%E9%9A%BE%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.14.1.7.</span> <span class="toc-text">强一致很难实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-8"><span class="toc-number">5.14.1.8.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">5.14.1.9.</span> <span class="toc-text">后记</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E8%83%8C%E6%99%AF-2"><span class="toc-number">5.14.2.</span> <span class="toc-text">业务背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">5.14.3.</span> <span class="toc-text">技术方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%E5%85%88%E5%86%99%E7%BC%93%E5%AD%98%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.14.3.1.</span> <span class="toc-text">方案一：先写缓存，再写数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%8D%E5%86%99%E7%BC%93%E5%AD%98"><span class="toc-number">5.14.3.2.</span> <span class="toc-text">方案二：先写数据库，再写缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%89%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.14.3.3.</span> <span class="toc-text">方案三：先删除缓存，再写数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%9B%9B%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98"><span class="toc-number">5.14.3.4.</span> <span class="toc-text">方案四：先写数据库，再删除缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%94%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98%E5%86%8D%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%8D%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98"><span class="toc-number">5.14.3.5.</span> <span class="toc-text">方案五：先删除缓存，再写数据库，再删除缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%85%AD%E5%85%88%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%8D%E9%80%9A%E8%BF%87binlog%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98"><span class="toc-number">5.14.3.6.</span> <span class="toc-text">方案六：先写数据库，再通过 BinLog 异步更新缓存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E5%B0%8F%E7%BB%93"><span class="toc-number">5.14.4.</span> <span class="toc-text">技术方案小结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E6%96%B9%E6%A1%88"><span class="toc-number">5.14.4.1.</span> <span class="toc-text">推荐方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%88%A0%E9%99%A4%E5%92%8C-binlog-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E7%9A%84%E5%9D%91"><span class="toc-number">5.14.4.2.</span> <span class="toc-text">缓存删除和 Binlog 异步处理的坑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-9"><span class="toc-number">5.14.5.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E0%E5%88%B01%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">从 0 到 1 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E6%95%99%E5%AD%A6"><span class="toc-number">6.1.</span> <span class="toc-text">项目基础教学</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A2%B3%E7%90%86%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1"><span class="toc-number">6.1.1.</span> <span class="toc-text">梳理核心业务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-number">6.1.2.</span> <span class="toc-text">初始化数据库表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A2%B3%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="toc-number">6.1.3.</span> <span class="toc-text">梳理数据库表关系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-number">6.1.3.1.</span> <span class="toc-text">用户管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%9A%E5%91%98%E6%95%B0%E6%8D%AE"><span class="toc-number">6.1.3.1.1.</span> <span class="toc-text">会员数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">6.1.3.1.2.</span> <span class="toc-text">乘车人数据</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%BD%A6%E7%AE%A1%E7%90%86"><span class="toc-number">6.1.3.2.</span> <span class="toc-text">列车管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86"><span class="toc-number">6.1.3.3.</span> <span class="toc-text">订单管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E7%AE%A1%E7%90%86"><span class="toc-number">6.1.3.4.</span> <span class="toc-text">支付管理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.1.4.</span> <span class="toc-text">工程目录结构设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-springboot-%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="toc-number">6.1.5.</span> <span class="toc-text">创建 SpringBoot 单模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA-springboot-%E9%A1%B9%E7%9B%AE"><span class="toc-number">6.1.5.1.</span> <span class="toc-text">搭建 SpringBoot 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E7%9B%AE%E5%BD%95"><span class="toc-number">6.1.5.1.1.</span> <span class="toc-text">结构目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pomxml-%E6%96%87%E4%BB%B6"><span class="toc-number">6.1.5.1.2.</span> <span class="toc-text">pom.xml 文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#application"><span class="toc-number">6.1.5.1.3.</span> <span class="toc-text">Application</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA-controller"><span class="toc-number">6.1.5.1.4.</span> <span class="toc-text">编写一个 Controller</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.5.2.</span> <span class="toc-text">属性配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-10"><span class="toc-number">6.1.5.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-springboot-%E5%A4%9A%E6%A8%A1%E5%9D%97"><span class="toc-number">6.1.6.</span> <span class="toc-text">创建 SpringBoot 多模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E7%A1%AC%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">6.1.6.1.</span> <span class="toc-text">软硬件环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-springboot-%E9%A1%B9%E7%9B%AE"><span class="toc-number">6.1.6.2.</span> <span class="toc-text">创建 SpringBoot 项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%AD%90-module"><span class="toc-number">6.1.6.3.</span> <span class="toc-text">构建子 Module</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E7%88%B6%E5%AD%90-module-%E4%BE%9D%E8%B5%96"><span class="toc-number">6.1.6.4.</span> <span class="toc-text">建立父子 Module 依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-parent-%E9%A1%B9%E7%9B%AE-packaging"><span class="toc-number">6.1.6.4.1.</span> <span class="toc-text">修改 Parent 项目 packaging</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-module-pomxml-%E4%BF%A1%E6%81%AF"><span class="toc-number">6.1.6.4.2.</span> <span class="toc-text">修改 Module Pom.xml 信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E4%B8%8D%E5%BF%85%E8%A6%81%E6%96%87%E4%BB%B6"><span class="toc-number">6.1.6.4.3.</span> <span class="toc-text">删除不必要文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="toc-number">6.1.6.5.</span> <span class="toc-text">项目继承关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83-web-%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.1.6.6.</span> <span class="toc-text">发布 WEB 服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83"><span class="toc-number">6.2.</span> <span class="toc-text">项目开发规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83"><span class="toc-number">6.2.1.</span> <span class="toc-text">编程规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%91%BD%E5%90%8D"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">方法命名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95%E7%94%A8-get-%E4%BD%9C%E5%89%8D%E7%BC%80"><span class="toc-number">6.2.1.1.1.</span> <span class="toc-text">获取单个对象的方法用 get 作前缀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%A4%9A%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95%E7%94%A8-list-%E4%BD%9C%E5%89%8D%E7%BC%80"><span class="toc-number">6.2.1.1.2.</span> <span class="toc-text">获取多个对象的方法用 list 作前缀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BB%9F%E8%AE%A1%E5%80%BC%E7%9A%84%E6%96%B9%E6%B3%95%E7%94%A8-count-%E4%BD%9C%E5%89%8D%E7%BC%80"><span class="toc-number">6.2.1.1.3.</span> <span class="toc-text">获取统计值的方法用 count 作前缀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E7%9A%84%E6%96%B9%E6%B3%95%E7%94%A8-save-%E4%BD%9C%E5%89%8D%E7%BC%80"><span class="toc-number">6.2.1.1.4.</span> <span class="toc-text">插入的方法用 save 作前缀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%9A%84%E6%96%B9%E6%B3%95%E7%94%A8-remove-%E4%BD%9C%E5%89%8D%E7%BC%80"><span class="toc-number">6.2.1.1.5.</span> <span class="toc-text">删除的方法用 remove 作前缀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%9A%84%E6%96%B9%E6%B3%95%E7%94%A8-update-%E4%BD%9C%E5%89%8D%E7%BC%80"><span class="toc-number">6.2.1.1.6.</span> <span class="toc-text">修改的方法用 update 作前缀</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8B%E5%91%BD%E5%90%8D%E8%A7%84%E7%BA%A6"><span class="toc-number">6.2.1.2.</span> <span class="toc-text">领域模型命名规约</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.1.2.1.</span> <span class="toc-text">数据对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.1.2.2.</span> <span class="toc-text">数据传输对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%95%E7%A4%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.1.2.3.</span> <span class="toc-text">展示对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">6.2.1.2.4.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#api-%E8%B7%AF%E5%BE%84%E8%A7%84%E7%BA%A6"><span class="toc-number">6.2.1.3.</span> <span class="toc-text">API 路径规约</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#get-%E6%96%B9%E6%B3%95%E5%B0%BD%E9%87%8F%E6%8A%8A-id-%E7%AD%89%E5%8F%98%E9%87%8F%E6%94%BE%E5%88%B0%E8%B7%AF%E5%BE%84%E4%B8%8A"><span class="toc-number">6.2.1.3.1.</span> <span class="toc-text">Get 方法尽量把 ID 等变量放到路径上。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E4%B8%8D%E5%8F%AF%E5%88%86%E5%89%B2%E7%9A%84%E5%8D%95%E8%AF%8D%E4%BD%BF%E7%94%A8%E4%B8%AD%E5%88%92%E7%BA%BF%E6%8B%BC%E6%8E%A5"><span class="toc-number">6.2.1.3.2.</span> <span class="toc-text">多个不可分割的单词，使用中划线拼接。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E4%BD%BF%E7%94%A8%E9%A9%BC%E5%B3%B0%E6%8B%BC%E5%86%99"><span class="toc-number">6.2.1.3.3.</span> <span class="toc-text">参数使用驼峰拼写。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%90%91%E9%9B%86%E5%90%88%E7%9A%84%E5%A4%8D%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="toc-number">6.2.1.3.4.</span> <span class="toc-text">指向集合的复数名称。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8%E5%8A%A8%E8%AF%8D%E5%AE%9A%E4%B9%89-url"><span class="toc-number">6.2.1.3.5.</span> <span class="toc-text">不要使用动词定义 URL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E9%9D%9E%E8%B5%84%E6%BA%90-url-%E4%BD%BF%E7%94%A8%E5%8A%A8%E8%AF%8D"><span class="toc-number">6.2.1.3.6.</span> <span class="toc-text">对非资源 URL 使用动词</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E5%B5%8C%E5%A5%97%E8%B5%84%E6%BA%90%E7%9A%84-url-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%85%B3%E7%B3%BB"><span class="toc-number">6.2.1.3.7.</span> <span class="toc-text">在嵌套资源的 URL 中使用关系</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E8%A7%84%E8%8C%83"><span class="toc-number">6.2.1.4.</span> <span class="toc-text">注释规范</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E8%AF%B4%E6%98%8E%E6%84%8F%E5%9B%BE%E5%8D%B3%E5%8F%AF%E6%97%A0%E9%9C%80%E8%A1%A5%E5%85%85%E5%86%97%E4%BD%99%E5%AD%97%E6%AE%B5"><span class="toc-number">6.2.1.4.1.</span> <span class="toc-text">注释说明意图即可，无需补充冗余字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%8A%E9%9C%80%E8%A6%81%E6%B7%BB%E5%8A%A0%E6%B3%A8%E9%87%8A"><span class="toc-number">6.2.1.4.2.</span> <span class="toc-text">方法上需要添加注释</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%9D%97%E5%86%85%E9%83%A8%E6%B3%A8%E9%87%8A%E8%A7%84%E8%8C%83"><span class="toc-number">6.2.1.4.3.</span> <span class="toc-text">方法块内部注释规范</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%91%BD%E5%90%8D%E8%AF%B4%E6%98%8E%E6%96%B9%E6%B3%95%E6%9C%AC%E8%BA%AB%E6%84%8F%E5%9B%BE"><span class="toc-number">6.2.1.4.4.</span> <span class="toc-text">方法命名说明方法本身意图</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E8%A7%84%E7%BA%A6"><span class="toc-number">6.2.1.5.</span> <span class="toc-text">代码开发规约</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%A0%BC%E5%BC%8F%E5%8C%96spotless"><span class="toc-number">6.2.2.</span> <span class="toc-text">代码格式化（Spotless）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#spotless"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">Spotless</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">使用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-number">6.2.2.2.1.</span> <span class="toc-text">项目实战</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A-maven-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">6.2.2.2.2.</span> <span class="toc-text">绑定 Maven 生命周期</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#idea-%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-number">6.2.2.2.3.</span> <span class="toc-text">IDEA 格式化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">6.2.2.3.</span> <span class="toc-text">常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#spotless-%E4%B8%8E-checkstyle-%E5%86%B2%E7%AA%81"><span class="toc-number">6.2.2.3.1.</span> <span class="toc-text">Spotless 与 Checkstyle 冲突</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#crlf-%E4%B8%8E-lf-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%86%B2%E7%AA%81"><span class="toc-number">6.2.2.3.2.</span> <span class="toc-text">CRLF 与 LF 格式化冲突</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-11"><span class="toc-number">6.2.2.4.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5checkstyle"><span class="toc-number">6.2.3.</span> <span class="toc-text">代码检查（CheckStyle）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%89%AB%E6%8F%8F%E8%A7%84%E5%88%99"><span class="toc-number">6.2.3.1.</span> <span class="toc-text">定义扫描规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8"><span class="toc-number">6.2.3.2.</span> <span class="toc-text">如何使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#idea-%E6%8F%92%E4%BB%B6"><span class="toc-number">6.2.3.2.1.</span> <span class="toc-text">IDEA 插件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#maven-%E6%8F%92%E4%BB%B6"><span class="toc-number">6.2.3.2.2.</span> <span class="toc-text">Maven 插件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">6.2.4.</span> <span class="toc-text">如何正确使用消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="toc-number">6.2.4.1.</span> <span class="toc-text">命名规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E8%A7%84%E8%8C%83"><span class="toc-number">6.2.4.2.</span> <span class="toc-text">申请规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83"><span class="toc-number">6.2.4.3.</span> <span class="toc-text">使用规范</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">6.2.4.3.1.</span> <span class="toc-text">发送消息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF"><span class="toc-number">6.2.4.3.2.</span> <span class="toc-text">消费消息</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">6.3.</span> <span class="toc-text">基础组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E0%E5%88%B01%E5%86%99%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">6.3.1.</span> <span class="toc-text">从 0 到 1 写组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#springboot-starter"><span class="toc-number">6.3.1.1.</span> <span class="toc-text">SpringBoot Starter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#starter-%E5%AE%9A%E4%B9%89"><span class="toc-number">6.3.1.1.1.</span> <span class="toc-text">Starter 定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#starter-%E5%A5%BD%E5%A4%84"><span class="toc-number">6.3.1.1.2.</span> <span class="toc-text">Starter 好处</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-starter"><span class="toc-number">6.3.1.2.</span> <span class="toc-text">自定义 Starter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#starter-%E5%91%BD%E5%90%8D"><span class="toc-number">6.3.1.2.1.</span> <span class="toc-text">Starter 命名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-springboot-%E9%A1%B9%E7%9B%AE-2"><span class="toc-number">6.3.1.2.2.</span> <span class="toc-text">创建 SpringBoot 项目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pom-%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.1.2.3.</span> <span class="toc-text">Pom 依赖配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">6.3.1.2.4.</span> <span class="toc-text">自动配置类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#springfactories"><span class="toc-number">6.3.1.2.5.</span> <span class="toc-text">spring.factories</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E5%8C%85%E9%A1%B9%E7%9B%AE%E5%8F%91%E5%B8%83%E4%BB%93%E5%BA%93"><span class="toc-number">6.3.1.2.6.</span> <span class="toc-text">打包项目，发布仓库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-starter"><span class="toc-number">6.3.1.2.7.</span> <span class="toc-text">测试 Starter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%8F%92%E6%8B%94-starter"><span class="toc-number">6.3.1.3.</span> <span class="toc-text">可插拔 Starter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%AF%E6%8F%92%E6%8B%94-starter"><span class="toc-number">6.3.1.3.1.</span> <span class="toc-text">自定义可插拔 Starter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zuul-%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%8F%92%E6%8B%94%E5%8E%9F%E7%90%86"><span class="toc-number">6.3.1.3.2.</span> <span class="toc-text">Zuul 实现可插拔原理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">6.3.1.4.</span> <span class="toc-text">配置元数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mybatis-starter-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.3.1.5.</span> <span class="toc-text">MyBatis Starter 如何实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.2.</span> <span class="toc-text">基础组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F-%E7%BB%84%E4%BB%B6%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">全局变量 &amp; 组件执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%94%A8%E6%88%B7%E5%B8%B8%E9%87%8F"><span class="toc-number">6.3.2.1.1.</span> <span class="toc-text">全局用户常量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E5%B8%B8%E9%87%8F%E7%B1%BB"><span class="toc-number">6.3.2.1.2.</span> <span class="toc-text">全局过滤器顺序执行常量类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spring-%E5%AE%B9%E5%99%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">Spring 容器上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fastjson-%E5%AE%89%E5%85%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.2.3.</span> <span class="toc-text">FastJSON 安全模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%8B%E4%BB%B6"><span class="toc-number">6.3.2.4.</span> <span class="toc-text">安全初始化事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E5%AF%B9%E8%B1%A1%E5%AE%B9%E5%99%A8"><span class="toc-number">6.3.2.5.</span> <span class="toc-text">单例对象容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E7%BA%A6%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.3.</span> <span class="toc-text">规约组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E7%A0%81"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">异常码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%BC%82%E5%B8%B8%E4%BD%93%E7%B3%BB"><span class="toc-number">6.3.3.2.</span> <span class="toc-text">抽象异常体系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%88%86%E9%A1%B5%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.3.3.3.</span> <span class="toc-text">封装分页对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%85%A8%E5%B1%80%E5%93%8D%E5%BA%94%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.3.3.4.</span> <span class="toc-text">封装全局响应对象</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.4.</span> <span class="toc-text">用户基础组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jwt-token-%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">6.3.4.1.</span> <span class="toc-text">JWT Token 生成器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E7%94%A8%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">6.3.4.2.</span> <span class="toc-text">封装用户上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">6.3.4.3.</span> <span class="toc-text">用户上下文拦截器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.5.</span> <span class="toc-text">设计模式组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E6%9E%84%E5%BB%BA%E8%80%85builder%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.5.1.</span> <span class="toc-text">封装构建者（Builder）模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E8%B4%A3%E4%BB%BB%E9%93%BEchain%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.5.2.</span> <span class="toc-text">封装责任链（Chain）模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E7%AD%96%E7%95%A5strategy%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.5.3.</span> <span class="toc-text">封装策略（Strategy）模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E5%85%B1%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.6.</span> <span class="toc-text">公共组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%B8%B8%E7%94%A8%E6%9E%9A%E4%B8%BE"><span class="toc-number">6.3.6.1.</span> <span class="toc-text">抽象常用枚举</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">6.3.6.2.</span> <span class="toc-text">封装线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%BF%AB%E9%80%9F%E6%B6%88%E8%B4%B9%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">6.3.6.2.1.</span> <span class="toc-text">封装快速消费线程池</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E6%8B%92%E7%BB%9D%E6%88%96%E9%A5%B1%E5%92%8C%E7%AD%96%E7%95%A5"><span class="toc-number">6.3.6.2.2.</span> <span class="toc-text">通过动态代理实现拒绝（或饱和）策略</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">6.3.6.3.</span> <span class="toc-text">常用工具类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%B1%82%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.7.</span> <span class="toc-text">持久层组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mybatisplus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.3.7.1.</span> <span class="toc-text">MybatisPlus 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E5%9F%BA%E7%A1%80%E5%B1%9E%E6%80%A7"><span class="toc-number">6.3.7.2.</span> <span class="toc-text">实体基础属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">6.3.7.3.</span> <span class="toc-text">元数据处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">6.3.7.4.</span> <span class="toc-text">分页转换器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95"><span class="toc-number">6.3.7.5.</span> <span class="toc-text">自定义雪花算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F-id-%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.8.</span> <span class="toc-text">分布式 ID 组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">6.3.8.1.</span> <span class="toc-text">雪花算法生成器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">6.3.8.2.</span> <span class="toc-text">雪花算法工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E6%88%96%E5%88%86%E8%A1%A8%E5%9F%BA%E5%9B%A0%E7%AE%97%E6%B3%95"><span class="toc-number">6.3.8.3.</span> <span class="toc-text">分库或分表基因算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.9.</span> <span class="toc-text">日志打印组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.3.9.1.</span> <span class="toc-text">日志打印注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%8F%82%E6%95%B0dto"><span class="toc-number">6.3.9.2.</span> <span class="toc-text">日志打印参数 DTO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%B3%A8%E8%A7%A3-aop-%E6%89%AB%E6%8F%8F%E7%B1%BB"><span class="toc-number">6.3.9.3.</span> <span class="toc-text">日志注解 AOP 扫描类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E7%B1%BB"><span class="toc-number">6.3.9.4.</span> <span class="toc-text">日志自动装配类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.10.</span> <span class="toc-text">接口幂等组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E9%97%AE%E9%A2%98%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.3.10.1.</span> <span class="toc-text">幂等问题是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E8%B0%83%E7%94%A8"><span class="toc-number">6.3.10.1.1.</span> <span class="toc-text">接口防重复提交 &#x2F; 调用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%98%B2%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="toc-number">6.3.10.1.2.</span> <span class="toc-text">消息队列防重复消费</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.3.10.2.</span> <span class="toc-text">幂等问题的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">6.3.10.2.1.</span> <span class="toc-text">分布式锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#token-%E4%BB%A4%E7%89%8C"><span class="toc-number">6.3.10.2.2.</span> <span class="toc-text">Token 令牌</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%BB%E9%87%8D%E8%A1%A8"><span class="toc-number">6.3.10.2.3.</span> <span class="toc-text">去重表</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.3.10.3.</span> <span class="toc-text">幂等组件的设计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.3.10.3.1.</span> <span class="toc-text">幂等注解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%B3%A8%E8%A7%A3%E7%9A%84-aop-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">6.3.10.3.2.</span> <span class="toc-text">幂等注解的 AOP 拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%89%A7%E8%A1%8C%E5%A4%84%E7%90%86%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-number">6.3.10.3.2.1.</span> <span class="toc-text">幂等执行处理器工厂</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%B9%82%E7%AD%89%E6%89%A7%E8%A1%8C%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">6.3.10.3.2.2.</span> <span class="toc-text">抽象幂等执行处理器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E5%B9%82%E7%AD%89%E8%B5%84%E6%BA%90"><span class="toc-number">6.3.10.3.2.3.</span> <span class="toc-text">释放幂等资源</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BE%8B%E5%AD%90%E9%98%B2%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="toc-number">6.3.10.3.3.</span> <span class="toc-text">项目中的例子：防重复消费</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#spel-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">6.3.10.3.3.1.</span> <span class="toc-text">SpEL 表达式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#mq-%E5%9C%BA%E6%99%AF%E4%B8%8B-spel-%E6%96%B9%E5%BC%8F%E7%9A%84%E5%B9%82%E7%AD%89%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">6.3.10.3.3.2.</span> <span class="toc-text">MQ 场景下 SpEL 方式的幂等处理逻辑</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%83%BD%E4%BF%9D%E9%9A%9C%E6%B0%B8%E4%B9%85%E5%B9%82%E7%AD%89%E5%90%97"><span class="toc-number">6.3.10.3.3.3.</span> <span class="toc-text">能保障永久幂等吗？</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%8A%B6%E6%80%81%E4%B8%BA%E5%B7%B2%E5%AE%8C%E6%88%90"><span class="toc-number">6.3.10.3.3.4.</span> <span class="toc-text">设置状态为已完成</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qa"><span class="toc-number">6.3.10.4.</span> <span class="toc-text">Q&amp;A</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.11.</span> <span class="toc-text">消息队列幂等组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web-%E7%BB%84%E4%BB%B6"><span class="toc-number">6.3.12.</span> <span class="toc-text">Web 组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">6.3.12.1.</span> <span class="toc-text">全局异常处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%93%8D%E5%BA%94%E5%AF%B9%E8%B1%A1%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-number">6.3.12.2.</span> <span class="toc-text">全局响应对象构造器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E9%A1%B9%E7%9B%AE%E5%88%9D%E6%AC%A1%E8%B0%83%E7%94%A8%E5%93%8D%E5%BA%94"><span class="toc-number">6.3.12.3.</span> <span class="toc-text">优化项目初次调用响应</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.4.</span> <span class="toc-text">核心业务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8F%91%E8%B5%B7%E4%B8%80%E7%AC%94%E6%94%AF%E4%BB%98"><span class="toc-number">6.4.1.</span> <span class="toc-text">如何发起一笔支付</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B"><span class="toc-number">6.4.1.1.</span> <span class="toc-text">支付流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%8F%91%E8%B5%B7%E6%94%AF%E4%BB%98"><span class="toc-number">6.4.1.1.1.</span> <span class="toc-text">用户发起支付</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E5%9B%9E%E8%B0%83"><span class="toc-number">6.4.1.1.2.</span> <span class="toc-text">支付结果回调</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.1.2.</span> <span class="toc-text">支付配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">6.4.1.2.1.</span> <span class="toc-text">内网穿透</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E6%94%AF%E4%BB%98%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80"><span class="toc-number">6.4.1.2.2.</span> <span class="toc-text">替换支付回调地址</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%B5%B7%E6%94%AF%E4%BB%98"><span class="toc-number">6.4.1.3.</span> <span class="toc-text">发起支付</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E5%88%97%E8%BD%A6%E8%B4%AD%E7%A5%A8"><span class="toc-number">6.4.1.3.1.</span> <span class="toc-text">选择列车购票</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="toc-number">6.4.1.3.2.</span> <span class="toc-text">提交订单</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BB%98%E6%AC%BE"><span class="toc-number">6.4.1.3.3.</span> <span class="toc-text">支付宝付款</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E5%9B%9E%E8%B0%83"><span class="toc-number">6.4.1.3.4.</span> <span class="toc-text">支付回调</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%A6%E7%A5%A8%E6%90%9C%E7%B4%A2%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8-redis-%E8%80%8C%E4%B8%8D%E6%98%AF-es"><span class="toc-number">6.4.2.</span> <span class="toc-text">车票搜索为什么用 Redis 而不是 ES ？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12306-%E5%88%97%E8%BD%A6%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.4.2.1.</span> <span class="toc-text">12306 列车搜索条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%90%9C%E7%B4%A2%E6%A1%86%E6%9E%B6"><span class="toc-number">6.4.2.2.</span> <span class="toc-text">数据搜索框架</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E4%B8%AD%E9%97%B4%E4%BB%B6-elasticsearch"><span class="toc-number">6.4.2.2.1.</span> <span class="toc-text">搜索中间件 ElasticSearch</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%B8%AD%E9%97%B4%E4%BB%B6-redis"><span class="toc-number">6.4.2.2.2.</span> <span class="toc-text">缓存中间件 Redis</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-redis"><span class="toc-number">6.4.2.3.</span> <span class="toc-text">为什么使用 Redis？</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%80%A7%E8%83%BD"><span class="toc-number">6.4.2.3.1.</span> <span class="toc-text">实时性能</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD"><span class="toc-number">6.4.2.3.2.</span> <span class="toc-text">并发性能</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%88%90%E6%9C%AC"><span class="toc-number">6.4.2.3.3.</span> <span class="toc-text">部署成本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6%E6%8B%86%E8%A7%A3"><span class="toc-number">6.4.2.3.4.</span> <span class="toc-text">搜索条件拆解</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-12"><span class="toc-number">6.4.2.4.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3"><span class="toc-number">6.4.3.</span> <span class="toc-text">注册用户接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">6.4.3.1.</span> <span class="toc-text">用户表结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%AD%96%E7%95%A5"><span class="toc-number">6.4.3.2.</span> <span class="toc-text">分库分表策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98"><span class="toc-number">6.4.3.3.</span> <span class="toc-text">缓存穿透问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3"><span class="toc-number">6.4.3.4.</span> <span class="toc-text">用户注册接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E6%A0%A1%E9%AA%8C"><span class="toc-number">6.4.3.4.1.</span> <span class="toc-text">责任链模式校验</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%82"><span class="toc-number">6.4.3.4.1.1.</span> <span class="toc-text">确定方法执行入参</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%9A%E5%8A%A1%E7%9A%84%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%8E%A5%E5%8F%A3"><span class="toc-number">6.4.3.4.1.2.</span> <span class="toc-text">定义业务的责任链接口</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%9A%E5%8A%A1%E7%9A%84%E5%85%B7%E4%BD%93%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">6.4.3.4.1.3.</span> <span class="toc-text">定义业务的具体责任链处理器</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%A1%A8%E7%9B%B8%E5%85%B3%E6%96%B0%E5%A2%9E"><span class="toc-number">6.4.3.4.2.</span> <span class="toc-text">用户表相关新增</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A1%A8%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.4.3.4.2.1.</span> <span class="toc-text">路由表是什么</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A1%A8%E4%BC%98%E7%82%B9"><span class="toc-number">6.4.3.4.2.2.</span> <span class="toc-text">路由表优点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A1%A8%E7%BC%BA%E7%82%B9"><span class="toc-number">6.4.3.4.2.3.</span> <span class="toc-text">路由表缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="toc-number">6.4.3.4.3.</span> <span class="toc-text">其他操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-13"><span class="toc-number">6.4.3.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">6.4.4.</span> <span class="toc-text">用户数据分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.4.4.1.</span> <span class="toc-text">分库分表介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">6.4.4.1.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-number">6.4.4.1.2.</span> <span class="toc-text">场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%BB%84%E4%BB%B6"><span class="toc-number">6.4.4.2.</span> <span class="toc-text">分库分表组件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#shardingsphere-jdbc"><span class="toc-number">6.4.4.2.1.</span> <span class="toc-text">ShardingSphere-JDBC</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#shardingsphere-proxy"><span class="toc-number">6.4.4.2.2.</span> <span class="toc-text">ShardingSphere-Proxy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E8%80%85%E5%AF%B9%E6%AF%94"><span class="toc-number">6.4.4.2.3.</span> <span class="toc-text">二者对比</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%AD%96%E7%95%A5"><span class="toc-number">6.4.4.3.</span> <span class="toc-text">用户数据的分库分表策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E7%94%A8%E6%88%B7%E5%88%86%E7%89%87%E9%94%AE"><span class="toc-number">6.4.4.4.</span> <span class="toc-text">选择用户分片键</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E7%94%A8%E6%88%B7%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">6.4.4.5.</span> <span class="toc-text">改造用户分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-shardingsphere-jdbc-%E4%BE%9D%E8%B5%96"><span class="toc-number">6.4.4.5.1.</span> <span class="toc-text">引入 ShardingSphere-JDBC 依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%88%86%E7%89%87%E8%A7%84%E5%88%99"><span class="toc-number">6.4.4.5.2.</span> <span class="toc-text">定义分片规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.4.5.3.</span> <span class="toc-text">用户分片配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-14"><span class="toc-number">6.4.4.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">6.4.5.</span> <span class="toc-text">用户注册如何防止缓存穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">6.4.5.1.</span> <span class="toc-text">缓存穿透的概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%9A%84%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%9C%BA%E6%99%AF%E4%BB%A5%E5%8F%8A%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.4.5.2.</span> <span class="toc-text">用户注册的缓存穿透场景以及常见解决方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12306-%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.4.5.3.</span> <span class="toc-text">12306 的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">6.4.5.3.1.</span> <span class="toc-text">什么是布隆过滤器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.4.5.3.2.</span> <span class="toc-text">最终解决方案</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E5%AE%B9%E9%87%8F%E8%AE%BE%E7%BD%AE%E4%BB%A5%E5%8F%8A%E7%A2%B0%E6%92%9E%E7%8E%87%E9%97%AE%E9%A2%98"><span class="toc-number">6.4.5.4.</span> <span class="toc-text">布隆过滤器的容量设置以及碰撞率问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E9%87%8F%E8%AF%84%E4%BC%B0"><span class="toc-number">6.4.5.4.1.</span> <span class="toc-text">容量评估</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A2%B0%E6%92%9E%E7%8E%87%E8%AF%84%E4%BC%B0"><span class="toc-number">6.4.5.4.2.</span> <span class="toc-text">碰撞率评估</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%AE%B9%E9%87%8F%E8%AF%84%E4%BC%B0%E4%B8%8D%E5%A4%9F%E7%94%A8%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">6.4.5.4.3.</span> <span class="toc-text">初始容量评估不够用时怎么办</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-15"><span class="toc-number">6.4.5.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E8%84%B1%E6%95%8F%E5%B1%95%E7%A4%BA"><span class="toc-number">6.4.6.</span> <span class="toc-text">敏感信息脱敏展示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%9C%80%E6%B1%82"><span class="toc-number">6.4.6.1.</span> <span class="toc-text">业务需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98-2"><span class="toc-number">6.4.6.2.</span> <span class="toc-text">项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">6.4.6.2.1.</span> <span class="toc-text">技术选型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">6.4.6.2.2.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.4.6.2.3.</span> <span class="toc-text">代码实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%80%9D%E8%80%83"><span class="toc-number">6.4.6.3.</span> <span class="toc-text">扩展思考</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8"><span class="toc-number">6.4.7.</span> <span class="toc-text">敏感信息加密存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF"><span class="toc-number">6.4.7.1.</span> <span class="toc-text">需求背景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98-3"><span class="toc-number">6.4.7.2.</span> <span class="toc-text">项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-shardingsphere"><span class="toc-number">6.4.7.2.1.</span> <span class="toc-text">引入 ShardingSphere</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.7.2.2.</span> <span class="toc-text">新增加密配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">6.4.7.2.3.</span> <span class="toc-text">效果展示</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">6.4.7.3.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="toc-number">6.4.7.4.</span> <span class="toc-text">加密功能扩展</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91"><span class="toc-number">6.4.8.</span> <span class="toc-text">乘车人模块开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">6.4.8.1.</span> <span class="toc-text">乘车人表结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%AD%96%E7%95%A5-2"><span class="toc-number">6.4.8.2.</span> <span class="toc-text">分库分表策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%B1%95%E7%A4%BA"><span class="toc-number">6.4.8.3.</span> <span class="toc-text">敏感数据脱敏展示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E4%BA%AE%E7%82%B9"><span class="toc-number">6.4.8.4.</span> <span class="toc-text">技术亮点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E8%BF%9E%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">6.4.8.4.1.</span> <span class="toc-text">直连数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http-%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4"><span class="toc-number">6.4.8.4.2.</span> <span class="toc-text">HTTP 防重复提交</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.4.8.4.2.1.</span> <span class="toc-text">防重复提交是什么</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6"><span class="toc-number">6.4.8.4.2.2.</span> <span class="toc-text">引入幂等组件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B7%BB%E5%8A%A0%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E7%9A%84%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.4.8.4.2.3.</span> <span class="toc-text">接口添加防重复提交的注解</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">6.4.8.4.3.</span> <span class="toc-text">缓存与数据库的一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%8E%E7%BC%93%E5%AD%98%E8%AF%BB%E5%8F%96%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">6.4.8.4.3.1.</span> <span class="toc-text">从缓存读取乘车人数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E6%9B%B4%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">6.4.8.4.3.2.</span> <span class="toc-text">乘车人数据发生变更时怎么办？</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%95%B0%E6%8D%AE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">6.4.9.</span> <span class="toc-text">乘车人数据分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%95%B0%E6%8D%AE%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%AD%96%E7%95%A5"><span class="toc-number">6.4.9.1.</span> <span class="toc-text">乘车人数据分库分表策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E4%B9%98%E8%BD%A6%E4%BA%BA%E5%88%86%E7%89%87%E9%94%AE"><span class="toc-number">6.4.9.2.</span> <span class="toc-text">选择乘车人分片键</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E4%B9%98%E8%BD%A6%E4%BA%BA%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">6.4.9.3.</span> <span class="toc-text">改造乘车人分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-shardingsphere-%E4%BE%9D%E8%B5%96"><span class="toc-number">6.4.9.3.1.</span> <span class="toc-text">引入 ShardingSphere 依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%88%86%E7%89%87%E8%A7%84%E5%88%99-2"><span class="toc-number">6.4.9.3.2.</span> <span class="toc-text">定义分片规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.9.3.3.</span> <span class="toc-text">乘车人分片配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E8%BD%A6%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2"><span class="toc-number">6.4.10.</span> <span class="toc-text">列车数据检索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%BD%A6%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">6.4.10.1.</span> <span class="toc-text">列车表结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%BD%A6%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2%E6%8E%A5%E5%8F%A3"><span class="toc-number">6.4.10.2.</span> <span class="toc-text">列车数据检索接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E9%AA%8C%E8%AF%81%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-number">6.4.10.2.1.</span> <span class="toc-text">责任链模式验证请求参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%9F%8E%E5%B8%82%E6%95%B0%E6%8D%AE"><span class="toc-number">6.4.10.2.2.</span> <span class="toc-text">加载城市数据</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E7%B3%BB%E5%88%97"><span class="toc-number">7.</span> <span class="toc-text">面试系列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%86%99%E5%9C%A8%E7%AE%80%E5%8E%86%E4%B8%8A-%E5%86%85%E6%8E%A8"><span class="toc-number">7.1.</span> <span class="toc-text">如何写在简历上 &amp; 内推</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E7%BB%8F"><span class="toc-number">7.2.</span> <span class="toc-text">面经</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E7%AD%94"><span class="toc-number">7.3.</span> <span class="toc-text">常见问题与解答</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text">项目启动中的常见问题</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/project/railway/12306%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="bookmark" title="12306项目学习笔记">12306项目学习笔记</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="范特东东东" data-src="/images/avatar.jpg"><p class="name" itemprop="name">范特东东东</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">65</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">23</span> <span class="name">分类</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hqeDE1OQ==" title="https:&#x2F;&#x2F;github.com&#x2F;hjx159"><i class="ic i-github"></i></span> <span class="exturl item xiaohongshu" data-url="aHR0cHM6Ly93d3cueGlhb2hvbmdzaHUuY29tL3VzZXIvcHJvZmlsZS81ZTAyYzhhZDAwMDAwMDAwMDEwMDFmM2U=" title="https:&#x2F;&#x2F;www.xiaohongshu.com&#x2F;user&#x2F;profile&#x2F;5e02c8ad0000000001001f3e"><i class="ic i-xiaohongshu2"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjgxMjE0MzI4MEBxcS5jb20=" title="mailto:812143280@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/categories/photography/" rel="section"><i class="ic i-photography"></i>摄影</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于我</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/distributed-microservices/API%E7%BD%91%E5%85%B3&SpringCloud%20Gateway/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/docker/docker-javaguide/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/database/" title="分类于 数据库">数据库</a> <i class="ic i-angle-right"></i> <a href="/categories/database/mysql/" title="分类于 MySQL">MySQL</a></div><span><a href="/database/mysql/MySQL-JavaGuide/" title="MySQL-JavaGuide">MySQL-JavaGuide</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/database/" title="分类于 数据库">数据库</a> <i class="ic i-angle-right"></i> <a href="/categories/database/redis/" title="分类于 Redis">Redis</a></div><span><a href="/database/redis/Redis-JavaGuide/" title="Redis-JavaGuide">Redis-JavaGuide</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/" title="分类于 Java基础">Java基础</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/java-knowledge/" title="分类于 Java基础-知识点">Java基础-知识点</a></div><span><a href="/java/java-se/java-knowledge/%E5%B0%9A%E7%A1%85%E8%B0%B7_%E5%AE%8B%E7%BA%A2%E5%BA%B7_%E7%AC%AC18%E7%AB%A0_JDK8-17%E6%96%B0%E7%89%B9%E6%80%A7%EF%BC%88%E4%B8%8B%EF%BC%89/" title="宋红康_第18章_JDK8-17新特性（下）">宋红康_第18章_JDK8-17新特性（下）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/" title="分类于 Java基础">Java基础</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/java-knowledge/" title="分类于 Java基础-知识点">Java基础-知识点</a></div><span><a href="/java/java-se/java-knowledge/%E5%B0%9A%E7%A1%85%E8%B0%B7_%E5%AE%8B%E7%BA%A2%E5%BA%B7_%E7%AC%AC08%E7%AB%A0_%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%EF%BC%88%E9%AB%98%E7%BA%A7%EF%BC%89/" title="宋红康_第08章_面向对象编程(高级)">宋红康_第08章_面向对象编程(高级)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/" title="分类于 Java基础">Java基础</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/java-knowledge/" title="分类于 Java基础-知识点">Java基础-知识点</a></div><span><a href="/java/java-se/java-knowledge/%E5%B0%9A%E7%A1%85%E8%B0%B7_%E5%AE%8B%E7%BA%A2%E5%BA%B7_%E7%AC%AC07%E7%AB%A0_%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%EF%BC%88%E8%BF%9B%E9%98%B6%EF%BC%89/" title="宋红康_第07章_面向对象编程(进阶)">宋红康_第07章_面向对象编程(进阶)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/mq/" title="分类于 消息队列">消息队列</a></div><span><a href="/mq/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" title="消息队列">消息队列</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/" title="分类于 Java基础">Java基础</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/java-excise/" title="分类于 Java基础-真题">Java基础-真题</a></div><span><a href="/java/java-se/java-excise/%E7%AC%AC02%E7%AB%A0%EF%BC%9A%E9%9A%8F%E5%A0%82%E5%A4%8D%E4%B9%A0%E4%B8%8E%E4%BC%81%E4%B8%9A%E7%9C%9F%E9%A2%98%EF%BC%88%E5%8F%98%E9%87%8F%E4%B8%8E%E8%BF%90%E7%AE%97%E7%AC%A6%EF%BC%89/" title="宋红康_第02章：变量与运算符">宋红康_第02章：变量与运算符</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/" title="分类于 Java基础">Java基础</a> <i class="ic i-angle-right"></i> <a href="/categories/java/java-se/java-excise/" title="分类于 Java基础-真题">Java基础-真题</a></div><span><a href="/java/java-se/java-excise/%E7%AC%AC11%E7%AB%A0%EF%BC%9A%E9%9A%8F%E5%A0%82%E5%A4%8D%E4%B9%A0%E4%B8%8E%E4%BC%81%E4%B8%9A%E7%9C%9F%E9%A2%98%EF%BC%88%E5%B8%B8%E7%94%A8%E7%B1%BB%E4%B8%8E%E5%9F%BA%E7%A1%80API%EF%BC%89/" title="宋红康_第11章：常用类与基础API">宋红康_第11章：常用类与基础API</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/distributed-microservices/" title="分类于 分布式微服务">分布式微服务</a></div><span><a href="/distributed-microservices/%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA&%E7%AE%97%E6%B3%95&%E5%8D%8F%E8%AE%AE/" title="分布式理论&amp;算法&amp;协议">分布式理论&算法&协议</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/distributed-microservices/" title="分类于 分布式微服务">分布式微服务</a></div><span><a href="/distributed-microservices/%E5%88%86%E5%B8%83%E5%BC%8FID&%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81&%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1&%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/" title="分布式ID&amp;分布式锁&amp;分布式事务&amp;分布式配置中心">分布式ID&分布式锁&分布式事务&分布式配置中心</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">范特东东东 @ fantedong</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">2.2m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">33:19</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"project/railway/12306项目学习笔记/",favicon:{show:"(●´3｀●)欢迎回来",hide:"(〃＞皿＜)你快回来"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->